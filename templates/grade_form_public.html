{% extends "base.html" %}

{% block title %}
{% if error %}ข้อผิดพลาด{% elif session %}{{ session.title }}{% else %}แบบฟอร์มกรอกเกรด{% endif %} - ระบบทำนายความสำเร็จของนักศึกษา
{% endblock %}

{% block custom_css %}
<style>
    /* ====== Hero Header ====== */
    .hero-header {
        background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
        border-radius: 24px;
        padding: 3rem 2rem;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(14, 165, 233, 0.4);
    }
    .hero-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: heroRotate 20s linear infinite;
    }
    @keyframes heroRotate { to { transform: rotate(360deg); } }
    .hero-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: white;
        position: relative;
        z-index: 1;
        text-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .hero-header p {
        color: rgba(255,255,255,0.9);
        font-size: 1.1rem;
        position: relative;
        z-index: 1;
        margin-bottom: 0;
    }

    /* ====== Glass Card ====== */
    .glass-card {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        border: 1px solid rgba(255,255,255,0.3);
        transition: all 0.3s ease;
    }
    .glass-card:hover {
        box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    }

    /* ====== Error Page ====== */
    .error-container {
        text-align: center;
        padding: 4rem 2rem;
    }
    .error-icon {
        font-size: 5rem;
        color: var(--danger, #ef4444);
        margin-bottom: 1.5rem;
        animation: errorPulse 2s ease-in-out infinite;
    }
    @keyframes errorPulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }
    .error-container h2 { font-weight: 800; color: var(--gray-800, #1f2937); margin-bottom: 1rem; }
    .error-container p { color: var(--gray-500, #6b7280); font-size: 1.1rem; margin-bottom: 2rem; }

    /* ====== Student Info Section ====== */
    .student-info-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    @media (max-width: 576px) {
        .student-info-section { grid-template-columns: 1fr; }
    }

    /* ====== Sticky Stats Bar ====== */
    .stats-bar {
        position: sticky;
        top: 80px;
        z-index: 100;
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        transition: all 0.3s ease;
    }
    @media (max-width: 576px) {
        .stats-bar { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
    }
    .stat-item { text-align: center; }
    .stat-item .stat-value {
        font-size: 1.75rem;
        font-weight: 800;
        line-height: 1.2;
    }
    .stat-item .stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--gray-500, #6b7280);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.15rem;
    }
    .stat-value.gpa-color { color: var(--primary, #4f46e5); }
    .stat-value.credits-color { color: var(--info, #0ea5e9); }
    .stat-value.passed-color { color: var(--success, #10b981); }
    .stat-value.failed-color { color: var(--danger, #ef4444); }

    /* ====== Term Card ====== */
    .term-card {
        margin-bottom: 2rem;
        overflow: hidden;
    }
    .term-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 20px 20px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .term-header h5 { margin: 0; font-weight: 700; font-size: 1.1rem; }
    .term-header .term-badge {
        background: rgba(255,255,255,0.2);
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .term-body {
        padding: 1.5rem;
        border-radius: 0 0 20px 20px;
    }

    /* ====== Course Grid ====== */
    .course-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
    }
    .course-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        border-left: 4px solid var(--primary, #4f46e5);
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        transition: all 0.3s ease;
    }
    .course-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .course-card .course-title {
        font-weight: 700;
        color: var(--gray-800, #1f2937);
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
        line-height: 1.4;
    }
    .course-card .course-id {
        font-size: 0.8rem;
        color: var(--gray-500, #6b7280);
        font-family: 'Inter', monospace;
    }
    .course-card .course-credit {
        font-size: 0.8rem;
        color: var(--primary, #4f46e5);
        font-weight: 600;
    }
    .course-card .course-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .grade-select {
        width: 100%;
        margin-top: 0.75rem;
        border: 2px solid var(--gray-200, #e5e7eb);
        border-radius: 8px;
        padding: 0.5rem;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.2s;
        background: white;
        cursor: pointer;
    }
    .grade-select:focus {
        border-color: var(--primary, #4f46e5);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        outline: none;
    }
    .grade-select.grade-a { border-color: #10b981; background: #ecfdf5; }
    .grade-select.grade-b { border-color: #3b82f6; background: #eff6ff; }
    .grade-select.grade-c { border-color: #f59e0b; background: #fffbeb; }
    .grade-select.grade-d { border-color: #f97316; background: #fff7ed; }
    .grade-select.grade-f { border-color: #ef4444; background: #fef2f2; }
    .grade-select.grade-w,
    .grade-select.grade-i { border-color: #6b7280; background: #f3f4f6; }

    /* ====== Submit Section ====== */
    .submit-section { text-align: center; margin: 2.5rem 0; }
    .btn-submit {
        background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
        color: white;
        border: none;
        padding: 1rem 3rem;
        border-radius: 50px;
        font-size: 1.15rem;
        font-weight: 700;
        box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4);
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
    }
    .btn-submit:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 12px 40px rgba(14, 165, 233, 0.5);
        color: white;
    }
    .btn-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* ====== Upload Zone ====== */
    .upload-zone {
        border: 3px dashed var(--gray-300, #d1d5db);
        border-radius: 20px;
        padding: 2.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(255,255,255,0.95);
    }
    .upload-zone:hover, .upload-zone.dragover {
        border-color: var(--primary, #4f46e5);
        background: rgba(79, 70, 229, 0.05);
        transform: translateY(-2px);
    }
    .upload-zone .icon { font-size: 3rem; color: var(--gray-400, #9ca3af); margin-bottom: 0.75rem; }

    /* ====== Result Section ====== */
    .result-section {
        display: none;
        animation: fadeInUp 0.6s ease;
    }
    .result-section.show { display: block; }
    @keyframes fadeInUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .result-gpa-display {
        font-size: 4rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    .prediction-bar-container {
        background: var(--gray-100, #f3f4f6);
        border-radius: 50px;
        height: 32px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    .prediction-bar-fill {
        height: 100%;
        border-radius: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.85rem;
        transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        min-width: fit-content;
        padding: 0 1rem;
    }
    .prediction-pass { background: linear-gradient(135deg, #10b981, #34d399); }
    .prediction-fail { background: linear-gradient(135deg, #ef4444, #f87171); }

    /* ====== Dark Mode ====== */
    [data-theme="dark"] .glass-card {
        background: rgba(30, 30, 40, 0.95);
        border-color: rgba(255,255,255,0.05);
    }
    [data-theme="dark"] .stats-bar {
        background: rgba(30, 30, 40, 0.95);
        border-color: rgba(255,255,255,0.05);
    }
    [data-theme="dark"] .course-card {
        background: rgba(40, 40, 55, 0.95);
        border-left-color: var(--primary-light, #818cf8);
    }
    [data-theme="dark"] .course-title { color: var(--gray-100, #f3f4f6); }
    [data-theme="dark"] .grade-select {
        background: rgba(15, 23, 42, 0.8);
        border-color: var(--gray-600, #4b5563);
        color: var(--gray-100, #f3f4f6);
    }
    [data-theme="dark"] .upload-zone {
        background: rgba(30, 30, 40, 0.95);
        border-color: rgba(255,255,255,0.15);
    }
    [data-theme="dark"] .stat-label { color: var(--gray-400, #9ca3af); }
    [data-theme="dark"] .term-body { background: rgba(30, 30, 40, 0.6); }
    [data-theme="dark"] .error-container h2 { color: var(--gray-100, #f3f4f6); }
    [data-theme="dark"] .error-container p { color: var(--gray-400, #9ca3af); }
    [data-theme="dark"] .prediction-bar-container { background: rgba(255,255,255,0.1); }
    [data-theme="dark"] .grade-select.grade-a { background: rgba(16,185,129,0.15); }
    [data-theme="dark"] .grade-select.grade-b { background: rgba(59,130,246,0.15); }
    [data-theme="dark"] .grade-select.grade-c { background: rgba(245,158,11,0.15); }
    [data-theme="dark"] .grade-select.grade-d { background: rgba(249,115,22,0.15); }
    [data-theme="dark"] .grade-select.grade-f { background: rgba(239,68,68,0.15); }
    [data-theme="dark"] .grade-select.grade-w,
    [data-theme="dark"] .grade-select.grade-i { background: rgba(107,114,128,0.15); }
</style>
{% endblock %}

{% block content %}
{% if error %}
{# ==================== ERROR PAGE ==================== #}
<div class="glass-card p-0 mt-4" data-aos="fade-up">
    <div class="error-container">
        <div class="error-icon">
            <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <h2>ไม่สามารถเปิดแบบฟอร์มได้</h2>
        <p>{{ error }}</p>
        <a href="/" class="btn btn-primary btn-lg rounded-pill">
            <i class="bi bi-house me-2"></i> กลับหน้าหลัก
        </a>
    </div>
</div>

{% else %}
{# ==================== GRADE FORM ==================== #}

<!-- Hero Header -->
<div class="hero-header" data-aos="fade-down">
    <h1><i class="bi bi-journal-check me-2"></i>{{ session.title }}</h1>
    {% if session.description %}
    <p class="mt-2">{{ session.description }}</p>
    {% endif %}
</div>

<!-- Student Info -->
<div class="glass-card p-4 mb-4" data-aos="fade-up">
    <h5 class="fw-bold mb-3"><i class="bi bi-person-badge me-2 text-primary"></i>ข้อมูลนักศึกษา</h5>
    <div class="student-info-section">
        <div>
            <label class="form-label fw-bold">รหัสนักศึกษา <span class="text-danger">*</span></label>
            <input type="text" id="studentId" class="form-control" placeholder="เช่น 6301001" required>
        </div>
        <div>
            <label class="form-label fw-bold">ชื่อ-นามสกุล</label>
            <input type="text" id="studentName" class="form-control" placeholder="เช่น สมชาย ใจดี (ไม่บังคับ)">
        </div>
    </div>
</div>

<!-- Sticky Stats Bar -->
<div class="stats-bar" id="statsBar" data-aos="fade-up" data-aos-delay="50">
    <div class="stat-item">
        <div class="stat-value gpa-color" id="statGpa">0.00</div>
        <div class="stat-label">GPA</div>
    </div>
    <div class="stat-item">
        <div class="stat-value credits-color" id="statCredits">0</div>
        <div class="stat-label">หน่วยกิต</div>
    </div>
    <div class="stat-item">
        <div class="stat-value passed-color" id="statPassed">0</div>
        <div class="stat-label">ผ่าน</div>
    </div>
    <div class="stat-item">
        <div class="stat-value failed-color" id="statFailed">0</div>
        <div class="stat-label">ไม่ผ่าน</div>
    </div>
</div>

<!-- Term Sections Container -->
<div id="termsContainer"></div>

<!-- Submit Button -->
<div class="submit-section" data-aos="fade-up">
    <button class="btn-submit" id="submitBtn" onclick="submitGrades()">
        <i class="bi bi-send-fill"></i> ส่งข้อมูลเกรด
    </button>
    <p class="text-muted small mt-2">กรุณาตรวจสอบข้อมูลให้ถูกต้องก่อนกดส่ง</p>
</div>

<!-- CSV/Excel Upload Section -->
<div class="glass-card p-4 mb-4" data-aos="fade-up">
    <a class="text-decoration-none d-block" data-bs-toggle="collapse" href="#uploadSection" role="button">
        <h5 class="fw-bold mb-0">
            <i class="bi bi-cloud-arrow-up me-2 text-info"></i>หรืออัปโหลดไฟล์ CSV/Excel
            <i class="bi bi-chevron-down float-end"></i>
        </h5>
    </a>
    <div class="collapse mt-3" id="uploadSection">
        <div class="upload-zone" id="uploadZone">
            <div class="icon"><i class="bi bi-file-earmark-arrow-up"></i></div>
            <h5 class="fw-bold">ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์</h5>
            <p class="text-muted mb-0">รองรับ CSV, XLSX, XLS</p>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="d-none">
        </div>
        <div id="fileInfo" class="mt-3 d-none">
            <div class="alert alert-info mb-0">
                <i class="bi bi-file-earmark-check me-2"></i>
                <span id="fileInfoText"></span>
                <button class="btn btn-sm btn-info ms-2 rounded-pill" onclick="handleFileUpload()">
                    <i class="bi bi-upload me-1"></i> อัปโหลดและส่ง
                </button>
            </div>
        </div>
        <div class="mt-3">
            <a href="#" onclick="downloadTemplate(); return false;" class="text-decoration-none">
                <i class="bi bi-download me-1"></i> ดาวน์โหลดไฟล์เทมเพลต (CSV)
            </a>
        </div>
    </div>
</div>

<!-- Result Section -->
<div class="result-section" id="resultSection">
    <div class="glass-card p-4 text-center" data-aos="fade-up">
        <div class="mb-3">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;" id="resultIcon"></i>
        </div>
        <h4 class="fw-bold mb-3" id="resultMessage">บันทึกข้อมูลเรียบร้อยแล้ว</h4>

        <div class="row justify-content-center g-4 mb-4">
            <div class="col-auto">
                <div class="text-center">
                    <div class="result-gpa-display text-primary" id="resultGpa">0.00</div>
                    <div class="text-muted fw-bold">GPA ที่คำนวณได้</div>
                </div>
            </div>
            <div class="col-auto">
                <div class="text-center">
                    <div class="result-gpa-display text-info" id="resultCredits" style="font-size: 3rem;">0</div>
                    <div class="text-muted fw-bold">หน่วยกิตรวม</div>
                </div>
            </div>
        </div>

        <!-- Prediction Result (hidden by default) -->
        <div id="predictionResult" class="d-none">
            <hr>
            <h5 class="fw-bold mb-3"><i class="bi bi-cpu me-2"></i>ผลการทำนาย AI</h5>
            <div class="mb-3">
                <span class="badge rounded-pill fs-5 px-4 py-2" id="predictionBadge"></span>
            </div>
            <div class="mx-auto" style="max-width: 500px;">
                <div class="d-flex justify-content-between mb-1">
                    <small class="fw-bold text-danger">ไม่ผ่าน</small>
                    <small class="fw-bold" id="predictionProbText">0%</small>
                    <small class="fw-bold text-success">ผ่าน</small>
                </div>
                <div class="prediction-bar-container">
                    <div class="prediction-bar-fill" id="predictionBar" style="width: 0%"></div>
                </div>
            </div>
            <p class="text-muted small mt-3" id="predictionNote"></p>
        </div>

        <div class="mt-4">
            <button class="btn btn-primary rounded-pill px-4" onclick="resetForm()">
                <i class="bi bi-arrow-clockwise me-2"></i> กรอกใหม่อีกครั้ง
            </button>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block custom_js %}
{% if not error %}
<script>
// ========================================
// Configuration / Data from Server
// ========================================
const FORM_TOKEN = "{{ session.token }}";
const RESOLVED_TERMS = JSON.parse('{{ resolved_terms | safe }}');
const GRADE_MAPPING = JSON.parse('{{ gradeMapping | safe }}');
const SHOW_PREDICTION = {{ 'true' if session.show_prediction else 'false' }};

const GRADE_OPTIONS = [
    { value: '', label: '-- \u0e40\u0e25\u0e37\u0e2d\u0e01\u0e40\u0e01\u0e23\u0e14 --' },
    { value: 'A', label: 'A' },
    { value: 'B+', label: 'B+' },
    { value: 'B', label: 'B' },
    { value: 'C+', label: 'C+' },
    { value: 'C', label: 'C' },
    { value: 'D+', label: 'D+' },
    { value: 'D', label: 'D' },
    { value: 'F', label: 'F' },
    { value: 'W', label: 'W' },
    { value: 'I', label: 'I' },
    { value: 'skip', label: '\u0e22\u0e31\u0e07\u0e44\u0e21\u0e48\u0e44\u0e14\u0e49\u0e40\u0e23\u0e35\u0e22\u0e19' }
];

// ========================================
// Initialization
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    initForm();
    setupUploadZone();
});

function initForm() {
    const container = document.getElementById('termsContainer');
    if (!container) return;
    container.innerHTML = '';

    RESOLVED_TERMS.forEach((termData, index) => {
        const section = createTermSection(termData, index);
        container.appendChild(section);
    });

    updateLiveStats();
}

// ========================================
// Term Section Builder
// ========================================
function createTermSection(termData, termIndex) {
    const wrapper = document.createElement('div');
    wrapper.className = 'glass-card term-card p-0';
    wrapper.setAttribute('data-aos', 'fade-up');
    wrapper.setAttribute('data-aos-delay', String(termIndex * 50 + 100));

    // Term header
    const header = document.createElement('div');
    header.className = 'term-header';
    header.innerHTML = `
        <h5><i class="bi bi-calendar3 me-2"></i>\u0e1b\u0e35\u0e17\u0e35\u0e48 ${termData.year} \u0e40\u0e17\u0e2d\u0e21 ${termData.term}</h5>
        <span class="term-badge">${termData.courses.length} \u0e27\u0e34\u0e0a\u0e32</span>
    `;

    // Term body with course grid
    const body = document.createElement('div');
    body.className = 'term-body';

    const grid = document.createElement('div');
    grid.className = 'course-grid';

    termData.courses.forEach(course => {
        const card = createCourseCard(course);
        grid.appendChild(card);
    });

    body.appendChild(grid);
    wrapper.appendChild(header);
    wrapper.appendChild(body);

    return wrapper;
}

// ========================================
// Course Card Builder
// ========================================
function createCourseCard(course) {
    const card = document.createElement('div');
    card.className = 'course-card';

    // Course info
    const title = document.createElement('div');
    title.className = 'course-title';
    title.textContent = course.thaiName || course.id;

    const meta = document.createElement('div');
    meta.className = 'course-meta';

    const idSpan = document.createElement('span');
    idSpan.className = 'course-id';
    idSpan.textContent = course.id;

    const creditSpan = document.createElement('span');
    creditSpan.className = 'course-credit';
    creditSpan.innerHTML = `<i class="bi bi-bookmark-fill me-1"></i>${course.credit || 3} \u0e2b\u0e19\u0e48\u0e27\u0e22\u0e01\u0e34\u0e15`;

    meta.appendChild(idSpan);
    meta.appendChild(creditSpan);

    // Grade select
    const select = document.createElement('select');
    select.className = 'grade-select';
    select.id = `grade-${course.id}`;
    select.dataset.courseId = course.id;
    select.dataset.credit = course.credit || 3;

    GRADE_OPTIONS.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        select.appendChild(option);
    });

    select.addEventListener('change', function() {
        applyGradeStyle(this);
        updateLiveStats();
    });

    card.appendChild(title);
    card.appendChild(meta);
    card.appendChild(select);

    return card;
}

// ========================================
// Grade Select Styling
// ========================================
function applyGradeStyle(selectEl) {
    selectEl.classList.remove('grade-a', 'grade-b', 'grade-c', 'grade-d', 'grade-f', 'grade-w', 'grade-i');
    const val = selectEl.value.toUpperCase();
    if (val === 'A') selectEl.classList.add('grade-a');
    else if (val === 'B+' || val === 'B') selectEl.classList.add('grade-b');
    else if (val === 'C+' || val === 'C') selectEl.classList.add('grade-c');
    else if (val === 'D+' || val === 'D') selectEl.classList.add('grade-d');
    else if (val === 'F') selectEl.classList.add('grade-f');
    else if (val === 'W') selectEl.classList.add('grade-w');
    else if (val === 'I') selectEl.classList.add('grade-i');
}

// ========================================
// Live Stats Update
// ========================================
function updateLiveStats() {
    const selects = document.querySelectorAll('.grade-select');
    let totalPoints = 0;
    let totalCredits = 0;
    let passedCount = 0;
    let failedCount = 0;

    selects.forEach(sel => {
        const val = sel.value;
        if (!val || val === 'skip') return;

        const credit = parseFloat(sel.dataset.credit) || 3;
        const gradePoint = GRADE_MAPPING[val.toUpperCase()];

        if (gradePoint === undefined || gradePoint === null) return;

        // W and I do not count toward GPA
        const upperVal = val.toUpperCase();
        if (upperVal === 'W' || upperVal === 'I') return;

        totalPoints += gradePoint * credit;
        totalCredits += credit;

        if (gradePoint >= 1.0) {
            passedCount++;
        } else {
            failedCount++;
        }
    });

    const gpa = totalCredits > 0 ? (totalPoints / totalCredits) : 0;

    document.getElementById('statGpa').textContent = gpa.toFixed(2);
    document.getElementById('statCredits').textContent = totalCredits;
    document.getElementById('statPassed').textContent = passedCount;
    document.getElementById('statFailed').textContent = failedCount;
}

// ========================================
// Collect Grade Data
// ========================================
function collectGrades() {
    const grades = {};
    const selects = document.querySelectorAll('.grade-select');
    selects.forEach(sel => {
        const courseId = sel.dataset.courseId;
        const val = sel.value;
        if (val && val !== 'skip' && val !== '') {
            grades[courseId] = val;
        }
    });
    return grades;
}

// ========================================
// Submit Grades
// ========================================
async function submitGrades() {
    const studentId = document.getElementById('studentId').value.trim();
    if (!studentId) {
        showAlert('\u0e01\u0e23\u0e38\u0e13\u0e32\u0e01\u0e23\u0e2d\u0e01\u0e23\u0e2b\u0e31\u0e2a\u0e19\u0e31\u0e01\u0e28\u0e36\u0e01\u0e29\u0e32', 'warning');
        document.getElementById('studentId').focus();
        return;
    }

    const grades = collectGrades();
    if (Object.keys(grades).length === 0) {
        showAlert('\u0e01\u0e23\u0e38\u0e13\u0e32\u0e40\u0e25\u0e37\u0e2d\u0e01\u0e40\u0e01\u0e23\u0e14\u0e2d\u0e22\u0e48\u0e32\u0e07\u0e19\u0e49\u0e2d\u0e22 1 \u0e27\u0e34\u0e0a\u0e32', 'warning');
        return;
    }

    const studentName = document.getElementById('studentName').value.trim();

    const payload = {
        student_id: studentId,
        student_name: studentName,
        grades: grades
    };

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    showLoading('\u0e01\u0e33\u0e25\u0e31\u0e07\u0e1a\u0e31\u0e19\u0e17\u0e36\u0e01\u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25...');

    try {
        const res = await fetch(`/api/grade-forms/submit/${FORM_TOKEN}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await res.json();
        hideLoading();
        submitBtn.disabled = false;

        if (data.success) {
            showResult(data);
        } else {
            showAlert(data.error || '\u0e40\u0e01\u0e34\u0e14\u0e02\u0e49\u0e2d\u0e1c\u0e34\u0e14\u0e1e\u0e25\u0e32\u0e14', 'danger');
        }
    } catch (e) {
        hideLoading();
        submitBtn.disabled = false;
        showAlert('\u0e44\u0e21\u0e48\u0e2a\u0e32\u0e21\u0e32\u0e23\u0e16\u0e40\u0e0a\u0e37\u0e48\u0e2d\u0e21\u0e15\u0e48\u0e2d\u0e40\u0e0b\u0e34\u0e23\u0e4c\u0e1f\u0e40\u0e27\u0e2d\u0e23\u0e4c\u0e44\u0e14\u0e49: ' + e.message, 'danger');
    }
}

// ========================================
// File Upload
// ========================================
function setupUploadZone() {
    const zone = document.getElementById('uploadZone');
    const input = document.getElementById('fileInput');
    if (!zone || !input) return;

    zone.addEventListener('click', () => input.click());
    zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            input.files = e.dataTransfer.files;
            handleFileSelected(e.dataTransfer.files[0]);
        }
    });
    input.addEventListener('change', (e) => {
        if (e.target.files.length) handleFileSelected(e.target.files[0]);
    });
}

function handleFileSelected(file) {
    const info = document.getElementById('fileInfo');
    const infoText = document.getElementById('fileInfoText');
    const sizeStr = file.size < 1024 * 1024
        ? (file.size / 1024).toFixed(1) + ' KB'
        : (file.size / 1024 / 1024).toFixed(2) + ' MB';
    infoText.textContent = `\u0e44\u0e1f\u0e25\u0e4c: ${file.name} (${sizeStr})`;
    info.classList.remove('d-none');
}

async function handleFileUpload() {
    const studentId = document.getElementById('studentId').value.trim();
    if (!studentId) {
        showAlert('\u0e01\u0e23\u0e38\u0e13\u0e32\u0e01\u0e23\u0e2d\u0e01\u0e23\u0e2b\u0e31\u0e2a\u0e19\u0e31\u0e01\u0e28\u0e36\u0e01\u0e29\u0e32\u0e01\u0e48\u0e2d\u0e19\u0e2d\u0e31\u0e1b\u0e42\u0e2b\u0e25\u0e14\u0e44\u0e1f\u0e25\u0e4c', 'warning');
        document.getElementById('studentId').focus();
        return;
    }

    const fileInput = document.getElementById('fileInput');
    if (!fileInput.files.length) {
        showAlert('\u0e01\u0e23\u0e38\u0e13\u0e32\u0e40\u0e25\u0e37\u0e2d\u0e01\u0e44\u0e1f\u0e25\u0e4c', 'warning');
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('student_id', studentId);
    formData.append('student_name', document.getElementById('studentName').value.trim());

    showLoading('\u0e01\u0e33\u0e25\u0e31\u0e07\u0e2d\u0e31\u0e1b\u0e42\u0e2b\u0e25\u0e14\u0e41\u0e25\u0e30\u0e1b\u0e23\u0e30\u0e21\u0e27\u0e25\u0e1c\u0e25...');

    try {
        const res = await fetch(`/api/grade-forms/submit-file/${FORM_TOKEN}`, {
            method: 'POST',
            body: formData
        });

        const data = await res.json();
        hideLoading();

        if (data.success) {
            showResult(data);
        } else {
            let errMsg = data.error || '\u0e40\u0e01\u0e34\u0e14\u0e02\u0e49\u0e2d\u0e1c\u0e34\u0e14\u0e1e\u0e25\u0e32\u0e14';
            if (data.detected_columns) {
                errMsg += '\n\u0e04\u0e2d\u0e25\u0e31\u0e21\u0e19\u0e4c\u0e17\u0e35\u0e48\u0e1e\u0e1a: ' + data.detected_columns.join(', ');
            }
            showAlert(errMsg, 'danger');
        }
    } catch (e) {
        hideLoading();
        showAlert('\u0e44\u0e21\u0e48\u0e2a\u0e32\u0e21\u0e32\u0e23\u0e16\u0e2d\u0e31\u0e1b\u0e42\u0e2b\u0e25\u0e14\u0e44\u0e1f\u0e25\u0e4c\u0e44\u0e14\u0e49: ' + e.message, 'danger');
    }
}

// ========================================
// Download Template CSV
// ========================================
function downloadTemplate() {
    let csv = '\uFEFF';  // BOM for Excel compatibility
    csv += 'COURSE_CODE,GRADE\n';

    RESOLVED_TERMS.forEach(term => {
        term.courses.forEach(course => {
            csv += `${course.id},\n`;
        });
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'grade_template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ========================================
// Show Result
// ========================================
function showResult(data) {
    const section = document.getElementById('resultSection');
    section.classList.add('show');

    // Update icon and message
    const icon = document.getElementById('resultIcon');
    const message = document.getElementById('resultMessage');
    icon.className = 'bi bi-check-circle-fill text-success';
    icon.style.fontSize = '3rem';
    message.textContent = data.message || '\u0e1a\u0e31\u0e19\u0e17\u0e36\u0e01\u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25\u0e40\u0e23\u0e35\u0e22\u0e1a\u0e23\u0e49\u0e2d\u0e22\u0e41\u0e25\u0e49\u0e27';

    // Update GPA & credits
    document.getElementById('resultGpa').textContent = (data.gpa || 0).toFixed(2);
    document.getElementById('resultCredits').textContent = data.total_credits || 0;

    // Prediction
    const predSection = document.getElementById('predictionResult');
    if (data.prediction && SHOW_PREDICTION) {
        predSection.classList.remove('d-none');

        const pred = data.prediction;
        const isPass = pred.prediction === '\u0e1c\u0e48\u0e32\u0e19';
        const prob = ((pred.probability || 0) * 100).toFixed(1);

        const badge = document.getElementById('predictionBadge');
        badge.textContent = pred.prediction || (isPass ? '\u0e1c\u0e48\u0e32\u0e19' : '\u0e44\u0e21\u0e48\u0e1c\u0e48\u0e32\u0e19');
        badge.className = `badge rounded-pill fs-5 px-4 py-2 bg-${isPass ? 'success' : 'danger'}`;

        document.getElementById('predictionProbText').textContent = prob + '%';

        const bar = document.getElementById('predictionBar');
        bar.style.width = '0%';
        bar.className = `prediction-bar-fill ${isPass ? 'prediction-pass' : 'prediction-fail'}`;
        bar.textContent = prob + '%';
        // Animate
        setTimeout(() => { bar.style.width = prob + '%'; }, 100);

        const note = document.getElementById('predictionNote');
        if (pred.recommendation) {
            note.textContent = pred.recommendation;
        } else if (pred.risk_level) {
            note.textContent = `\u0e23\u0e30\u0e14\u0e31\u0e1a\u0e04\u0e27\u0e32\u0e21\u0e40\u0e2a\u0e35\u0e48\u0e22\u0e07: ${pred.risk_level}`;
        } else {
            note.textContent = '';
        }
    } else {
        predSection.classList.add('d-none');
    }

    // Scroll to result
    setTimeout(() => {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 200);
}

// ========================================
// Reset Form
// ========================================
function resetForm() {
    // Hide result
    document.getElementById('resultSection').classList.remove('show');
    document.getElementById('predictionResult').classList.add('d-none');

    // Reset all grade selects
    document.querySelectorAll('.grade-select').forEach(sel => {
        sel.value = '';
        sel.classList.remove('grade-a', 'grade-b', 'grade-c', 'grade-d', 'grade-f', 'grade-w', 'grade-i');
    });

    // Reset student fields
    document.getElementById('studentId').value = '';
    document.getElementById('studentName').value = '';

    // Reset file upload
    const fileInput = document.getElementById('fileInput');
    if (fileInput) fileInput.value = '';
    const fileInfo = document.getElementById('fileInfo');
    if (fileInfo) fileInfo.classList.add('d-none');

    // Reset stats
    updateLiveStats();

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
{% endif %}
{% endblock %}
