{% extends "base.html" %}

{% block title %}‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á - {{ super() }}{% endblock %}

{% block custom_css %}
<style>
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• */
    .term-section {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .term-header {
        background: var(--primary-gradient);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        margin: -25px -25px 20px -25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .term-header h3 {
        margin: 0;
        font-size: 1.2rem;
    }

    .term-header.locked {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    .course-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .course-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
        position: relative;
    }

    .course-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .course-card.locked {
        background: #fff5f5;
        border-left-color: #dc3545;
        opacity: 0.9;
    }

    .course-card.locked::after {
        content: "üîí";
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.2rem;
    }

    .course-card.future {
        background: #e8f4f8;
        border-left-color: #17a2b8;
    }

    .course-card.future::before {
        content: "‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï";
        position: absolute;
        top: 10px;
        right: 10px;
        color: #17a2b8;
        font-size: 0.75rem;
        font-weight: bold;
        background: white;
        padding: 2px 8px;
        border-radius: 10px;
    }

    .course-card.repeated {
        background: #fff9e6;
        border-left-color: #ffc107;
    }

    .course-card.repeated::before {
        content: "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥";
        position: absolute;
        top: 10px;
        right: 10px;
        color: #ffc107;
        font-size: 0.75rem;
        font-weight: bold;
        background: white;
        padding: 2px 8px;
        border-radius: 10px;
    }

    .course-info {
        margin-bottom: 10px;
    }

    .course-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
        font-size: 0.95rem;
    }

    .course-code {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .course-prereq {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 5px;
    }

    .grade-select {
        width: 100%;
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 0.95rem;
        margin-top: 10px;
        transition: border-color 0.3s;
    }

    .grade-select:focus {
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .grade-select:disabled {
        background: #e9ecef;
        cursor: not-allowed;
    }

    .remove-btn {
        margin-top: 10px;
        width: 100%;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .remove-btn:hover {
        background: #c82333;
    }

    .lock-reason {
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 10px;
        padding: 8px;
        background: #fff;
        border-radius: 5px;
        border: 1px solid #f5c6cb;
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 800px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        color: #2c3e50;
    }

    .modal-close {
        font-size: 1.5rem;
        cursor: pointer;
        color: #6c757d;
        transition: color 0.3s;
        background: none;
        border: none;
    }

    .modal-close:hover {
        color: #dc3545;
    }

    .course-selection-list {
        margin: 20px 0;
    }

    .course-selection-group {
        margin-bottom: 30px;
    }

    .course-selection-group h4 {
        color: #495057;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }

    .course-select-item {
        padding: 12px;
        margin: 8px 0;
        background: #f8f9fa;
        border-radius: 8px;
        display: flex;
        align-items: center;
        transition: all 0.3s;
    }

    .course-select-item:hover {
        background: #e9ecef;
    }

    .course-select-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f8d7da;
    }

    .course-select-item input[type="checkbox"] {
        margin-right: 15px;
        transform: scale(1.2);
    }

    .course-select-item input[type="checkbox"]:disabled {
        cursor: not-allowed;
    }

    .course-select-info {
        flex: 1;
    }

    .course-select-reason {
        color: #dc3545;
        font-size: 0.85rem;
        margin-left: 35px;
        margin-top: 5px;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }

    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .btn-load-term {
        background: var(--primary-gradient);
        color: white;
    }

    .btn-add-future {
        background: var(--info-gradient);
        color: white;
    }

    .btn-add-failed {
        background: var(--warning-gradient);
        color: white;
    }

    .btn-analyze {
        background: var(--success-gradient);
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    /* Results Section */
    .analysis-results {
        margin-top: 40px;
        padding: 30px;
        background: rgba(255,255,255,0.95);
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        height: 100%;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
    }

    .stat-label {
        color: #6c757d;
        margin-top: 5px;
    }

    .progress-container {
        margin: 30px 0;
    }

    .progress {
        height: 30px;
        border-radius: 15px;
        background: #e9ecef;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: var(--success-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        transition: width 0.5s ease;
    }

    .progress-bar.warning {
        background: var(--warning-gradient);
    }

    .progress-bar.danger {
        background: var(--danger-gradient);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .course-grid {
            grid-template-columns: 1fr;
        }
        .action-buttons {
            flex-direction: column;
        }
        .btn-action {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div id="alertContainer"></div>
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 text-center text-white">
            <h1 class="display-4 fw-bold mb-3">
                <i class="bi bi-graph-up-arrow"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
            </h1>
            <p class="lead">
                ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç Prerequisite ‡πÅ‡∏ö‡∏ö Real-time
            </p>
        </div>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
    <div class="term-section">
        <div class="term-header">
            <h3><i class="bi bi-person-badge"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
        </div>
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" class="form-control" id="studentName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <div class="col-md-4">
                <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</label>
                <select class="form-select" id="modelSelect">
                    <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î</label>
                <div class="form-control" readonly id="loadedTermsInfo">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°</div>
            </div>
        </div>
    </div>

    <!-- Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ó‡∏≠‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ -->
    <div id="termsContainer"></div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
    <div class="action-buttons">
        <button class="btn-action btn-load-term" id="loadNextTermBtn">
            <i class="bi bi-plus-circle"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        </button>
        <button class="btn-action btn-add-future" id="addFutureCoursesBtn">
            <i class="bi bi-calendar-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
        </button>
        <button class="btn-action btn-add-failed" id="addFailedCoursesBtn">
            <i class="bi bi-arrow-repeat"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥
        </button>
        <button class="btn-action btn-analyze" id="analyzeBtn">
            <i class="bi bi-bar-chart-line"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•
        </button>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï -->
    <div class="modal-overlay" id="futureCoursesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-calendar-plus"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°</h3>
                <button class="modal-close" onclick="closeFutureModal()">&times;</button>
            </div>
            <div id="futureCoursesContent"></div>
            <div class="action-buttons">
                <button class="btn-action btn-add-future" onclick="addSelectedFutureCourses()">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                </button>
                <button class="btn-action btn-secondary" onclick="closeFutureModal()">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥ -->
    <div class="modal-overlay" id="failedCoursesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-arrow-repeat"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥</h3>
                <button class="modal-close" onclick="closeFailedModal()">&times;</button>
            </div>
            <div id="failedCoursesContent"></div>
            <div class="action-buttons">
                <button class="btn-action btn-add-failed" onclick="addSelectedFailedCourses()">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                </button>
                <button class="btn-action btn-secondary" onclick="closeFailedModal()">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå -->
    <div class="analysis-results d-none" id="analysisResults">
        <h2 class="text-center mb-4">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
        
        <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="statGPA">0.00</div>
                    <div class="stat-label">GPA ‡∏£‡∏ß‡∏°</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="statCredits">0</div>
                    <div class="stat-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="statFailed">0</div>
                    <div class="stat-label">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="statBlocked">0</div>
                    <div class="stat-label">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å</div>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <h5>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h5>
            <div class="progress">
                <div class="progress-bar" id="completionProgress" style="width: 0%">0%</div>
            </div>
            <p class="mt-2" id="graduationStatus"></p>
        </div>

        <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
        <div class="row mt-4">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-danger text-white">
                        <i class="bi bi-x-circle"></i> ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å
                    </div>
                    <div class="card-body" id="failedCoursesList">
                        <p class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-lock"></i> ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å
                    </div>
                    <div class="card-body" id="blockedCoursesList">
                        <p class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <i class="bi bi-lightbulb"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            </div>
            <div class="card-body" id="recommendations">
                <p class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
            </div>
        </div>

        <!-- ‡∏Å‡∏£‡∏≤‡∏ü GPA -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> ‡∏Å‡∏£‡∏≤‡∏ü GPA ‡∏£‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°
            </div>
            <div class="card-body">
                <canvas id="gpaChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
// ==========================================
// ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤
// ==========================================
const coursesData = {{ coursesData|tojson }};
const allTermsData = {{ allTermsData|tojson }};
const gradeMapping = {{ gradeMapping|tojson }};

// ==========================================
// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ State
// ==========================================
let loadedTermsCount = 0;
let repeatedCourses = [];
let futureCourses = [];
let courseGrades = {};
let availableModels = [];
let gpaChart = null;

// ==========================================
// Initialize ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

async function initializeApp() {
    // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
    await loadModels();
    
    // ‡∏ú‡∏π‡∏Å Event Listeners
    document.getElementById('loadNextTermBtn').addEventListener('click', loadNextTerm);
    document.getElementById('addFutureCoursesBtn').addEventListener('click', openFutureCoursesModal);
    document.getElementById('addFailedCoursesBtn').addEventListener('click', openFailedCoursesModal);
    document.getElementById('analyzeBtn').addEventListener('click', analyzeProgress);

    // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡πÅ‡∏£‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    loadNextTerm();
}

// ==========================================
// ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•
// ==========================================
async function loadModels() {
    try {
        const response = await fetch('/api/models');
        const data = await response.json();
        const modelSelect = document.getElementById('modelSelect');
        
        if (data.success && data.models.length > 0) {
            availableModels = data.models.filter(m => m.data_format === 'subject_based');
            modelSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) --</option>';
            
            availableModels.forEach(model => {
                const accuracy = model.performance.accuracy ? 
                    (model.performance.accuracy * 100).toFixed(1) : 'N/A';
                const option = document.createElement('option');
                option.value = model.filename;
                option.textContent = `${model.filename} (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${accuracy}%)`;
                modelSelect.appendChild(option);
            });
        } else {
            modelSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏≤‡∏° Prerequisite ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</option>';
        }
    } catch (error) {
        console.error('Error loading models:', error);
        document.getElementById('modelSelect').innerHTML = '<option value="">‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>';
    }
}

// ==========================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
// ==========================================
function loadNextTerm() {
    if (loadedTermsCount >= allTermsData.length) {
        showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß', 'warning');
        return;
    }

    // Lock ‡πÄ‡∏ó‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    lockPreviousTerms();

    const termData = allTermsData[loadedTermsCount];
    loadedTermsCount++;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡∏≠‡∏°‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î
    updateLoadedTermsInfo();

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà
    const termSection = createTermSection(termData, loadedTermsCount);
    document.getElementById('termsContainer').appendChild(termSection);

    // Update prerequisites
    updateAllPrerequisites();
}

// ==========================================
// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡∏≠‡∏°‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î
// ==========================================
function updateLoadedTermsInfo() {
    const infoDiv = document.getElementById('loadedTermsInfo');
    if (loadedTermsCount === 0) {
        infoDiv.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°';
    } else {
        const lastTerm = allTermsData[loadedTermsCount - 1];
        infoDiv.textContent = `‡πÇ‡∏´‡∏•‡∏î‡∏ñ‡∏∂‡∏á‡∏õ‡∏µ ${lastTerm.year} ‡πÄ‡∏ó‡∏≠‡∏° ${lastTerm.term} (${loadedTermsCount}/${allTermsData.length} ‡πÄ‡∏ó‡∏≠‡∏°)`;
    }
}

// ==========================================
// ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ó‡∏≠‡∏°
// ==========================================
function createTermSection(termData, termNumber) {
    const section = document.createElement('div');
    section.className = 'term-section';
    section.id = `term-${termNumber}`;
    
    const header = document.createElement('div');
    header.className = 'term-header';
    header.innerHTML = `
        <h3>‡∏õ‡∏µ ${termData.year} ‡πÄ‡∏ó‡∏≠‡∏° ${termData.term}</h3>
        <span class="badge bg-light text-dark">${termData.ids.length} ‡∏ß‡∏¥‡∏ä‡∏≤</span>
    `;
    section.appendChild(header);

    const grid = document.createElement('div');
    grid.className = 'course-grid';
    grid.id = `term-${termNumber}-grid`;
    
    termData.ids.forEach(courseId => {
        const course = coursesData.find(c => c.id === courseId);
        if (course) {
            const courseCard = createCourseCard(course, false, false);
            grid.appendChild(courseCard);
        }
    });

    section.appendChild(grid);
    return section;
}

// ==========================================
// ‡∏™‡∏£‡πâ‡∏≤‡∏á Card ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤
// ==========================================
function createCourseCard(course, isFuture = false, isRepeated = false) {
    const card = document.createElement('div');
    card.className = 'course-card';
    card.id = `course-${course.id}${isFuture ? '-future' : ''}${isRepeated ? '-repeated' : ''}`;
    card.dataset.courseId = course.id;
    
    if (isFuture) card.classList.add('future');
    if (isRepeated) card.classList.add('repeated');

    const prereqText = course.prereq.length > 0 
        ? course.prereq.map(p => {
            const prereqCourse = coursesData.find(c => c.id === p);
            return prereqCourse ? prereqCourse.thaiName : p;
        }).join(', ')
        : '‡πÑ‡∏°‡πà‡∏°‡∏µ';

    card.innerHTML = `
        <div class="course-info">
            <div class="course-name">${course.thaiName}</div>
            <div class="course-code">${course.id} (${course.credit} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï)</div>
            <div class="course-prereq">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ${prereqText}</div>
        </div>
        <select class="grade-select" data-course-id="${course.id}" onchange="updateGrade('${course.id}', this.value)">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏£‡∏î --</option>
            ${Object.keys(gradeMapping).map(grade => 
                `<option value="${grade}">${grade}</option>`
            ).join('')}
        </select>
        ${(isFuture || isRepeated) ? `
            <button class="remove-btn" onclick="removeCourse('${course.id}', ${isFuture}, ${isRepeated})">
                <i class="bi bi-x"></i> ‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ
            </button>
        ` : ''}
    `;

    return card;
}

// ==========================================
// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Å‡∏£‡∏î
// ==========================================
function updateGrade(courseId, grade) {
    courseGrades[courseId] = grade;
    updateAllPrerequisites();
}

// ==========================================
// ‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ (future/repeated)
// ==========================================
function removeCourse(courseId, isFuture, isRepeated) {
    if (isFuture) {
        futureCourses = futureCourses.filter(c => c.id !== courseId);
        document.getElementById(`course-${courseId}-future`)?.remove();
    }
    if (isRepeated) {
        repeatedCourses = repeatedCourses.filter(c => c.id !== courseId);
        document.getElementById(`course-${courseId}-repeated`)?.remove();
    }
    
    delete courseGrades[courseId];
    updateAllPrerequisites();
}

// ==========================================
// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Prerequisites ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
// ==========================================
function updateAllPrerequisites() {
    const allCourseCards = document.querySelectorAll('.course-card');
    
    allCourseCards.forEach(card => {
        const courseId = card.dataset.courseId;
        const course = coursesData.find(c => c.id === courseId);
        const select = card.querySelector('.grade-select');
        
        if (!course || !select) return;

        // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å lock ‡πÅ‡∏•‡πâ‡∏ß
        const termSection = card.closest('.term-section');
        if (termSection && termSection.querySelector('.locked-badge')) {
            return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Prerequisites
       const prereqCheck = checkPrerequisites(course, courseGrades);
       
       // ‡∏•‡∏ö lock reason ‡πÄ‡∏Å‡πà‡∏≤
       const oldReason = card.querySelector('.lock-reason');
       if (oldReason) oldReason.remove();

       if (!prereqCheck.passed) {
           card.classList.add('locked');
           select.disabled = true;
           select.value = '';
           
           // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å lock
           if (prereqCheck.reason) {
               const reasonDiv = document.createElement('div');
               reasonDiv.className = 'lock-reason';
               reasonDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${prereqCheck.reason}`;
               card.appendChild(reasonDiv);
           }
       } else {
           card.classList.remove('locked');
           select.disabled = false;
       }
   });
}

// ==========================================
// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Prerequisites
// ==========================================
function checkPrerequisites(course, grades) {
   if (!course.prereq || course.prereq.length === 0) {
       return { passed: true };
   }

   const currentTermCourseIds = getCurrentTermCourseIds();
   
   for (let prereqId of course.prereq) {
       const prereqCourse = coursesData.find(c => c.id === prereqId);
       
       // ‡∏ñ‡πâ‡∏≤ prerequisite ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
       if (currentTermCourseIds.includes(prereqId)) {
           // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
           if (!canTakeTogether(course, prereqCourse, grades)) {
               return {
                   passed: false,
                   reason: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö ${prereqCourse.thaiName} ‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ`
               };
           }
       } else {
           // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ prerequisite ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
           const grade = grades[prereqId];
           if (!grade || grade === 'F' || grade === 'W' || grade === 'I') {
               return {
                   passed: false,
                   reason: `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ ${prereqCourse ? prereqCourse.thaiName : prereqId}`
               };
           }
       }
   }

   return { passed: true };
}

// ==========================================
// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏õ)
// ==========================================
function canTakeTogether(courseA, courseB, grades) {
   const labKeywords = ['‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£', '‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å'];
   
   function isLabCourse(course) {
       return labKeywords.some(keyword => course.thaiName.includes(keyword));
   }

   const AIsLab = isLabCourse(courseA);
   const BIsLab = isLabCourse(courseB);

   // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏§‡∏©‡∏é‡∏µ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
   if (AIsLab === BIsLab) return false;

   // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡∏õ‡∏Å‡∏±‡∏ö‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ‡∏≠‡∏≤‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
   const labCourse = AIsLab ? courseA : courseB;
   const theoryCourse = AIsLab ? courseB : courseA;
   
   // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏§‡∏©‡∏é‡∏µ‡πÄ‡∏õ‡πá‡∏ô prerequisite ‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
   if (labCourse.prereq.includes(theoryCourse.id)) {
       // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ prerequisite ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡∏õ‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
       const otherPrereqs = labCourse.prereq.filter(p => p !== theoryCourse.id);
       for (let prereqId of otherPrereqs) {
           if (!grades[prereqId] || grades[prereqId] === 'F' || grades[prereqId] === 'W') {
               return false;
           }
       }
       return true;
   }

   return false;
}

// ==========================================
// ‡∏î‡∏∂‡∏á Course IDs ‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
// ==========================================
function getCurrentTermCourseIds() {
   const currentTermNumber = loadedTermsCount;
   const currentTermSection = document.getElementById(`term-${currentTermNumber}`);
   if (!currentTermSection) return [];
   
   const selects = currentTermSection.querySelectorAll('.grade-select');
   return Array.from(selects).map(select => select.dataset.courseId);
}

// ==========================================
// Lock ‡πÄ‡∏ó‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
// ==========================================
function lockPreviousTerms() {
   for (let i = 1; i < loadedTermsCount; i++) {
       const termSection = document.getElementById(`term-${i}`);
       if (termSection) {
           const selects = termSection.querySelectorAll('.grade-select');
           selects.forEach(select => {
               select.disabled = true;
           });
           
           // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° locked
           const header = termSection.querySelector('.term-header');
           if (header && !header.querySelector('.locked-badge')) {
               header.classList.add('locked');
               const badge = document.createElement('span');
               badge.className = 'badge bg-secondary locked-badge ms-2';
               badge.textContent = 'üîí ‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
               header.querySelector('h3').appendChild(badge);
           }
       }
   }
}

// ==========================================
// ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
// ==========================================
function openFutureCoursesModal() {
   renderFutureCoursesList();
   document.getElementById('futureCoursesModal').classList.add('show');
}

function closeFutureModal() {
   document.getElementById('futureCoursesModal').classList.remove('show');
}

// ==========================================
// ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
// ==========================================
function renderFutureCoursesList() {
   const content = document.getElementById('futureCoursesContent');
   content.innerHTML = '';

   // ‡∏î‡∏∂‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î
   const futureTermCourses = [];
   for (let i = loadedTermsCount; i < allTermsData.length; i++) {
       allTermsData[i].ids.forEach(courseId => {
           if (!futureCourses.find(c => c.id === courseId)) {
               const course = coursesData.find(c => c.id === courseId);
               if (course) {
                   futureTermCourses.push({
                       ...course,
                       fromTerm: `‡∏õ‡∏µ ${allTermsData[i].year} ‡πÄ‡∏ó‡∏≠‡∏° ${allTermsData[i].term}`
                   });
               }
           }
       });
   }

   if (futureTermCourses.length === 0) {
       content.innerHTML = '<p class="text-muted text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
       return;
   }

   // ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
   const canTake = [];
   const cannotTake = [];

   futureTermCourses.forEach(course => {
       const prereqCheck = checkPrerequisites(course, courseGrades);
       if (prereqCheck.passed) {
           canTake.push(course);
       } else {
           cannotTake.push({ ...course, reason: prereqCheck.reason });
       }
   });

   // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÑ‡∏î‡πâ
   if (canTake.length > 0) {
       const canTakeGroup = document.createElement('div');
       canTakeGroup.className = 'course-selection-group';
       canTakeGroup.innerHTML = '<h4>‚úÖ ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÑ‡∏î‡πâ (‡∏ú‡πà‡∏≤‡∏ô Prerequisite ‡πÅ‡∏•‡πâ‡∏ß)</h4>';
       
       canTake.forEach(course => {
           const item = document.createElement('div');
           item.className = 'course-select-item';
           item.innerHTML = `
               <input type="checkbox" id="future-${course.id}" value="${course.id}">
               <div class="course-select-info">
                   <strong>${course.thaiName}</strong><br>
                   <small class="text-muted">${course.id} (${course.credit} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï) - ${course.fromTerm}</small>
               </div>
           `;
           canTakeGroup.appendChild(item);
       });
       content.appendChild(canTakeGroup);
   }

   // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
   if (cannotTake.length > 0) {
       const cannotTakeGroup = document.createElement('div');
       cannotTakeGroup.className = 'course-selection-group';
       cannotTakeGroup.innerHTML = '<h4>‚ùå ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</h4>';
       
       cannotTake.forEach(course => {
           const item = document.createElement('div');
           item.className = 'course-select-item disabled';
           item.innerHTML = `
               <input type="checkbox" disabled>
               <div class="course-select-info">
                   <strong>${course.thaiName}</strong><br>
                   <small class="text-muted">${course.id} (${course.credit} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï) - ${course.fromTerm}</small>
                   <div class="course-select-reason">${course.reason}</div>
               </div>
           `;
           cannotTakeGroup.appendChild(item);
       });
       content.appendChild(cannotTakeGroup);
   }
}

// ==========================================
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
// ==========================================
function addSelectedFutureCourses() {
   const checkboxes = document.querySelectorAll('#futureCoursesContent input[type="checkbox"]:checked');
   const currentTermGrid = document.getElementById(`term-${loadedTermsCount}-grid`);
   
   if (!currentTermGrid) {
       showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô', 'warning');
       closeFutureModal();
       return;
   }

   checkboxes.forEach(checkbox => {
       const courseId = checkbox.value;
       const course = coursesData.find(c => c.id === courseId);
       
       if (course && !futureCourses.find(c => c.id === courseId)) {
           futureCourses.push(course);
           const courseCard = createCourseCard(course, true, false);
           currentTermGrid.appendChild(courseCard);
       }
   });

   updateAllPrerequisites();
   closeFutureModal();
}

// ==========================================
// ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥
// ==========================================
function openFailedCoursesModal() {
   renderFailedCoursesList();
   document.getElementById('failedCoursesModal').classList.add('show');
}

function closeFailedModal() {
   document.getElementById('failedCoursesModal').classList.remove('show');
}

// ==========================================
// ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥
// ==========================================
function renderFailedCoursesList() {
   const content = document.getElementById('failedCoursesContent');
   content.innerHTML = '';

   // ‡∏´‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏£‡∏î F ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
   const failedOrIncomplete = [];
   
   for (let i = 0; i < loadedTermsCount - 1; i++) {
       const termData = allTermsData[i];
       termData.ids.forEach(courseId => {
           const grade = courseGrades[courseId];
           if (!grade || grade === 'F' || grade === 'W' || grade === 'I') {
               // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
               if (!repeatedCourses.find(c => c.id === courseId)) {
                   const course = coursesData.find(c => c.id === courseId);
                   if (course) {
                       failedOrIncomplete.push({
                           ...course,
                           fromTerm: `‡∏õ‡∏µ ${termData.year} ‡πÄ‡∏ó‡∏≠‡∏° ${termData.term}`,
                           currentGrade: grade || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
                       });
                   }
               }
           }
       });
   }

   if (failedOrIncomplete.length === 0) {
       content.innerHTML = '<p class="text-muted text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥</p>';
       return;
   }

   const group = document.createElement('div');
   group.className = 'course-selection-group';
   group.innerHTML = '<h4>‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ</h4>';
   
   failedOrIncomplete.forEach(course => {
       const item = document.createElement('div');
       item.className = 'course-select-item';
       item.innerHTML = `
           <input type="checkbox" id="repeat-${course.id}" value="${course.id}">
           <div class="course-select-info">
               <strong>${course.thaiName}</strong><br>
               <small class="text-muted">${course.id} (${course.credit} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï)</small><br>
               <small class="text-danger">‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏î‡∏¥‡∏°: ${course.currentGrade} - ‡∏à‡∏≤‡∏Å${course.fromTerm}</small>
           </div>
       `;
       group.appendChild(item);
   });
   
   content.appendChild(group);
}

// ==========================================
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥
// ==========================================
function addSelectedFailedCourses() {
   const checkboxes = document.querySelectorAll('#failedCoursesContent input[type="checkbox"]:checked');
   const currentTermGrid = document.getElementById(`term-${loadedTermsCount}-grid`);
   
   if (!currentTermGrid) {
       showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô', 'warning');
       closeFailedModal();
       return;
   }

   checkboxes.forEach(checkbox => {
       const courseId = checkbox.value;
       const course = coursesData.find(c => c.id === courseId);
       
       if (course && !repeatedCourses.find(c => c.id === courseId)) {
           repeatedCourses.push(course);
           const courseCard = createCourseCard(course, false, true);
           currentTermGrid.appendChild(courseCard);
       }
   });

   updateAllPrerequisites();
   closeFailedModal();
}

// ==========================================
// ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
// ==========================================
async function analyzeProgress() {
   const studentName = document.getElementById('studentName').value || '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
   const modelFilename = document.getElementById('modelSelect').value;
   
   // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì GPA ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡πà‡∏≤‡∏á‡πÜ
   const analysis = calculateAnalysis();
   
   // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
   displayAnalysisResults(analysis);
   
   // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÇ‡∏°‡πÄ‡∏î‡∏• ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢
   if (modelFilename) {
       try {
           const response = await fetch('/api/analyze_curriculum', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({
                   student_name: studentName,
                   current_grades: courseGrades,
                   loaded_terms_count: loadedTermsCount,
                   repeated_courses_in_this_term_ids: repeatedCourses.map(c => c.id),
                   model_filename: modelFilename
               })
           });
           
           const result = await response.json();
           if (result.success && result.prediction_result) {
               enhanceResultsWithPrediction(result.prediction_result);
           }
       } catch (error) {
           console.error('Prediction error:', error);
       }
   }
   
   // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü GPA
   drawGPAChart();
}

// ==========================================
// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
// ==========================================
function calculateAnalysis() {
   let totalPoints = 0;
   let totalCredits = 0;
   let completedCredits = 0;
   const failedCourses = [];
   const blockedCourses = [];
   const incompleteCourses = [];
   
   // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì GPA ‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å
   Object.entries(courseGrades).forEach(([courseId, grade]) => {
       const course = coursesData.find(c => c.id === courseId);
       if (!course) return;
       
       if (grade && grade !== '') {
           const gradePoint = gradeMapping[grade] || 0;
           totalPoints += gradePoint * course.credit;
           totalCredits += course.credit;
           
           if (grade !== 'F' && grade !== 'W' && grade !== 'I') {
               completedCredits += course.credit;
           } else if (grade === 'F') {
               failedCourses.push(course);
           }
       }
   });
   
   // ‡∏´‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å
   const allLoadedCourses = [];
   for (let i = 0; i < loadedTermsCount; i++) {
       allTermsData[i].ids.forEach(courseId => {
           const course = coursesData.find(c => c.id === courseId);
           if (course) allLoadedCourses.push(course);
       });
   }
   
   // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ (future/repeated)
   allLoadedCourses.push(...futureCourses, ...repeatedCourses);
   
   allLoadedCourses.forEach(course => {
       const prereqCheck = checkPrerequisites(course, courseGrades);
       if (!prereqCheck.passed && !courseGrades[course.id]) {
           blockedCourses.push({
               course: course,
               reason: prereqCheck.reason
           });
       }
       
       // ‡∏´‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
       if (!courseGrades[course.id] || courseGrades[course.id] === '') {
           incompleteCourses.push(course);
       }
   });
   
   const gpa = totalCredits > 0 ? totalPoints / totalCredits : 0;
   const totalRequiredCredits = coursesData.reduce((sum, c) => sum + c.credit, 0);
   const completionRate = (completedCredits / totalRequiredCredits) * 100;
   
   return {
       gpa: gpa,
       completedCredits: completedCredits,
       totalCredits: totalRequiredCredits,
       completionRate: completionRate,
       failedCourses: failedCourses,
       blockedCourses: blockedCourses,
       incompleteCourses: incompleteCourses
   };
}

// ==========================================
// ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
// ==========================================
function displayAnalysisResults(analysis) {
   // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
   document.getElementById('analysisResults').classList.remove('d-none');
   
   // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
   document.getElementById('statGPA').textContent = analysis.gpa.toFixed(2);
   document.getElementById('statCredits').textContent = `${analysis.completedCredits}/${analysis.totalCredits}`;
   document.getElementById('statFailed').textContent = analysis.failedCourses.length;
   document.getElementById('statBlocked').textContent = analysis.blockedCourses.length;
   
   // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Progress Bar
   const progressBar = document.getElementById('completionProgress');
   progressBar.style.width = `${analysis.completionRate}%`;
   progressBar.textContent = `${analysis.completionRate.toFixed(1)}%`;
   
   // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
   progressBar.className = 'progress-bar';
   if (analysis.completionRate < 50) {
       progressBar.classList.add('danger');
   } else if (analysis.completionRate < 75) {
       progressBar.classList.add('warning');
   }
   
   // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
   const status = determineGraduationStatus(analysis);
   document.getElementById('graduationStatus').textContent = status;
   
   // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å
   const failedList = document.getElementById('failedCoursesList');
   if (analysis.failedCourses.length > 0) {
       failedList.innerHTML = '<ul class="list-unstyled mb-0">';
       analysis.failedCourses.forEach(course => {
           failedList.innerHTML += `<li><i class="bi bi-x-circle text-danger"></i> ${course.thaiName} (${course.id})</li>`;
       });
       failedList.innerHTML += '</ul>';
   } else {
       failedList.innerHTML = '<p class="text-muted mb-0">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å</p>';
   }
   
   // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å
   const blockedList = document.getElementById('blockedCoursesList');
   if (analysis.blockedCourses.length > 0) {
       blockedList.innerHTML = '<ul class="list-unstyled mb-0">';
       analysis.blockedCourses.forEach(item => {
           blockedList.innerHTML += `
               <li>
                   <i class="bi bi-lock text-warning"></i> ${item.course.thaiName} (${item.course.id})
                   <br><small class="text-muted ms-3">${item.reason}</small>
               </li>
           `;
       });
       blockedList.innerHTML += '</ul>';
   } else {
       blockedList.innerHTML = '<p class="text-muted mb-0">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å</p>';
   }
   
   // ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
   const recommendations = generateRecommendations(analysis);
   const recList = document.getElementById('recommendations');
   if (recommendations.length > 0) {
       recList.innerHTML = '<ul class="mb-0">';
       recommendations.forEach(rec => {
           recList.innerHTML += `<li>${rec}</li>`;
       });
       recList.innerHTML += '</ul>';
   } else {
       recList.innerHTML = '<p class="text-muted mb-0">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡∏µ</p>';
   }
   
   // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
   document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
}

// ==========================================
// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
// ==========================================
function determineGraduationStatus(analysis) {
   const isAllTermsLoaded = loadedTermsCount === allTermsData.length;
   
   if (analysis.gpa < 2.0 && analysis.gpa > 0) {
       return '‚ö†Ô∏è GPA ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (2.00) ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏î‡πâ';
   }
   
   if (analysis.failedCourses.length > 0) {
       return `‚ùå ‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å ${analysis.failedCourses.length} ‡∏ß‡∏¥‡∏ä‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà`;
   }
   
   if (analysis.blockedCourses.length > 0) {
       return `üîí ‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å ${analysis.blockedCourses.length} ‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô Prerequisite`;
   }
   
   if (isAllTermsLoaded) {
       if (analysis.incompleteCourses.length > 0) {
           return `üìö ‡∏¢‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${analysis.incompleteCourses.length} ‡∏ß‡∏¥‡∏ä‡∏≤`;
       }
       return '‚úÖ ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô';
   } else {
       return `üìä ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (${analysis.completionRate.toFixed(1)}% ‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£)`;
   }
}

// ==========================================
// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
// ==========================================
function generateRecommendations(analysis) {
   const recommendations = [];
   
   if (analysis.gpa < 2.0 && analysis.gpa > 0) {
       recommendations.push('‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á GPA ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ 2.00 ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡πà‡∏≥');
       recommendations.push('‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ó‡∏≠‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô');
   } else if (analysis.gpa < 2.5) {
       recommendations.push('‡∏Ñ‡∏ß‡∏£‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á GPA ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô');
   }
   
   if (analysis.failedCourses.length > 0) {
       recommendations.push('‡∏Ñ‡∏ß‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î');
       recommendations.push('‡∏´‡∏≤‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤');
   }
   
   if (analysis.blockedCourses.length > 0) {
       recommendations.push('‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ Prerequisite ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏î‡πâ');
       recommendations.push('‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å');
   }
   
   if (analysis.completionRate < 25 * loadedTermsCount / 8) {
       recommendations.push('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡πà‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô');
   }
   
   if (recommendations.length === 0 && analysis.gpa >= 3.0) {
       recommendations.push('‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÑ‡∏õ');
       recommendations.push('‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°');
   }
   
   return recommendations;
}

// ==========================================
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•
// ==========================================
function enhanceResultsWithPrediction(prediction) {
   const statusElement = document.getElementById('graduationStatus');
   const currentStatus = statusElement.textContent;
   
   const predictionBadge = document.createElement('div');
   predictionBadge.className = 'mt-2';
   predictionBadge.innerHTML = `
       <span class="badge ${prediction.prediction === '‡∏à‡∏ö' ? 'bg-success' : 'bg-danger'} me-2">
           ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢: ${prediction.prediction}
       </span>
       <span class="badge bg-secondary">
           ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô: ${(prediction.confidence * 100).toFixed(1)}%
       </span>
   `;
   
   statusElement.appendChild(predictionBadge);
}

// ==========================================
// ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü GPA
// ==========================================
function drawGPAChart() {
   const ctx = document.getElementById('gpaChart').getContext('2d');
   
   // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì GPA ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ó‡∏≠‡∏°
   const termGPAs = [];
   const labels = [];
   
   for (let i = 0; i < loadedTermsCount; i++) {
       const termData = allTermsData[i];
       let termPoints = 0;
       let termCredits = 0;
       
       termData.ids.forEach(courseId => {
           const grade = courseGrades[courseId];
           if (grade && grade !== '') {
               const course = coursesData.find(c => c.id === courseId);
               if (course) {
                   const gradePoint = gradeMapping[grade] || 0;
                   termPoints += gradePoint * course.credit;
                   termCredits += course.credit;
               }
           }
       });
       
       const termGPA = termCredits > 0 ? termPoints / termCredits : 0;
       termGPAs.push(termGPA);
       labels.push(`‡∏õ‡∏µ ${termData.year} ‡πÄ‡∏ó‡∏≠‡∏° ${termData.term}`);
   }
   
   // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
   if (gpaChart) {
       gpaChart.destroy();
   }
   
   // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà
   gpaChart = new Chart(ctx, {
       type: 'line',
       data: {
           labels: labels,
           datasets: [{
               label: 'GPA ‡∏£‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°',
               data: termGPAs,
               borderColor: 'rgb(102, 126, 234)',
               backgroundColor: 'rgba(102, 126, 234, 0.1)',
               tension: 0.1,
               fill: true
           }, {
               label: '‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (2.00)',
               data: Array(labels.length).fill(2.0),
               borderColor: 'rgb(255, 99, 132)',
               borderDash: [5, 5],
               fill: false
           }]
       },
       options: {
           responsive: true,
           plugins: {
               legend: {
                   display: true,
                   position: 'top',
               },
               title: {
                   display: false
               }
           },
           scales: {
               y: {
                   beginAtZero: true,
                   max: 4.0,
                   ticks: {
                       stepSize: 0.5
                   }
               }
           }
       }
   });
}

// ==========================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Alert
// ==========================================
function showAlert(message, type = 'info') {
   const alertContainer = document.getElementById('alertContainer');
   const alertDiv = document.createElement('div');
   alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
   alertDiv.innerHTML = `
       <i class="bi bi-info-circle-fill me-2"></i>
       ${message}
       <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
   `;
   
   alertContainer.appendChild(alertDiv);
   
   // ‡∏•‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
   setTimeout(() => {
       alertDiv.remove();
   }, 5000);
}
</script>
{% endblock %}
