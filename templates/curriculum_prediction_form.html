{% extends "base.html" %}

{% block title %}‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• - {{ super() }}{% endblock %}

{% block custom_css %}
<style>
    /* ====== Modern Design System ====== */
    :root {
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --gradient-danger: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --gradient-dark: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        --glass-bg: rgba(255, 255, 255, 0.9);
        --glass-border: rgba(255, 255, 255, 0.3);
    }

    /* Main Container */
    .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    /* Hero Header */
    .hero-header {
        background: var(--gradient-primary);
        border-radius: 24px;
        padding: 3rem 2rem;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
    }

    .hero-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: pulse 4s ease-in-out infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
            opacity: 0.5;
        }

        50% {
            transform: scale(1.1);
            opacity: 0.3;
        }
    }

    .hero-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: white;
        position: relative;
        z-index: 1;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .hero-header p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
        position: relative;
        z-index: 1;
    }

    /* Glass Cards */
    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }

    .glass-card:hover {
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
    }

    /* Input Section */
    .input-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .input-group-modern {
        position: relative;
    }

    .input-group-modern label {
        display: block;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .input-group-modern .form-control,
    .input-group-modern .form-select {
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s;
        background: white;
    }

    .input-group-modern .form-control:focus,
    .input-group-modern .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 992px) {
        .stats-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 576px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .stat-box {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 16px;
        padding: 1.25rem;
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }

    .stat-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-light);
    }

    .stat-box .stat-value {
        font-size: 2rem;
        font-weight: 800;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        line-height: 1.2;
    }

    .stat-box .stat-label {
        font-size: 0.8rem;
        color: var(--gray-500);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.25rem;
    }

    /* Progress Bar */
    .progress-container {
        background: var(--gray-100);
        border-radius: 50px;
        height: 24px;
        overflow: hidden;
        margin-top: 1rem;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .progress-fill {
        height: 100%;
        background: var(--gradient-success);
        border-radius: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.85rem;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        min-width: fit-content;
        padding: 0 1rem;
    }

    /* Term Cards */
    .term-card {
        background: white;
        border-radius: 16px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        border: 1px solid var(--gray-200);
    }

    .term-header {
        background: var(--gradient-dark);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .term-header.locked {
        background: var(--gray-400);
    }

    .term-body {
        padding: 1.5rem;
    }

    /* Course Grid */
    .course-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
    }

    .course-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        border-left: 4px solid var(--primary);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: all 0.3s ease;
    }

    .course-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .course-card.locked {
        background: #fef2f2;
        border-left-color: var(--danger);
        opacity: 0.85;
    }

    .course-card.future {
        background: #eff6ff;
        border-left-color: var(--info);
    }

    .course-card.repeated {
        background: #fffbeb;
        border-left-color: var(--warning);
    }

    .course-title {
        font-weight: 700;
        color: var(--gray-800);
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
    }

    .course-id {
        font-size: 0.8rem;
        color: var(--gray-500);
    }

    .course-credit {
        font-size: 0.85rem;
        color: var(--primary);
        font-weight: 600;
    }

    .grade-select {
        margin-top: 0.75rem;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        padding: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .grade-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Gemini Panel */
    .gemini-panel {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .gemini-panel::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(167, 139, 250, 0.3) 0%, transparent 70%);
        pointer-events: none;
    }

    .gemini-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .gemini-header h4 {
        margin: 0;
        font-weight: 700;
        background: linear-gradient(90deg, #a78bfa, #f472b6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .gemini-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .gemini-action-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 1.5rem;
        transition: all 0.3s;
    }

    .gemini-action-card:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-3px);
    }

    .gemini-action-card h5 {
        color: white;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .gemini-action-card p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    /* Gemini Result */
    .gemini-result {
        background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3e 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-top: 1.5rem;
        border: 1px solid rgba(167, 139, 250, 0.3);
    }

    .gemini-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .gemini-metric {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
    }

    .gemini-metric .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #a78bfa;
    }

    .gemini-metric .label {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
        text-transform: uppercase;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        margin: 2rem 0;
    }

    .btn-action {
        padding: 0.875rem 2rem;
        border-radius: 50px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .btn-action:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .btn-action.btn-primary {
        background: var(--gradient-primary);
        color: white;
    }

    .btn-action.btn-success {
        background: var(--gradient-success);
        color: white;
    }

    .btn-action.btn-predict {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 1rem 3rem;
        font-size: 1.1rem;
    }

    /* Mode Toggle */
    .mode-toggle {
        background: white;
        border-radius: 50px;
        padding: 0.5rem;
        display: inline-flex;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .mode-toggle .btn-check+label {
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
    }

    .mode-toggle .btn-check:checked+label {
        background: var(--gradient-primary);
        color: white;
    }

    /* Results Section */
    .results-section {
        background: white;
        border-radius: 24px;
        padding: 2.5rem;
        margin-top: 2rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    }

    .result-hero {
        text-align: center;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
    }

    .result-hero.success {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border: 2px solid #10b981;
    }

    .result-hero.danger {
        background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
        border: 2px solid #ef4444;
    }

    .result-hero.warning {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border: 2px solid #f59e0b;
    }

    .result-hero h2 {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
    }

    .result-hero.success h2 {
        color: #059669;
    }

    .result-hero.danger h2 {
        color: #dc2626;
    }

    .result-hero.warning h2 {
        color: #d97706;
    }

    .probability-bar {
        height: 40px;
        border-radius: 20px;
        overflow: hidden;
        display: flex;
        margin: 1.5rem 0;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .probability-bar .pass {
        background: var(--gradient-success);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        transition: width 1s ease;
    }

    .probability-bar .fail {
        background: var(--gradient-danger);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        transition: width 1s ease;
    }

    /* Stats Cards */
    .result-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .result-stat-card {
        background: var(--gray-50);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s;
    }

    .result-stat-card:hover {
        background: white;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .result-stat-card .icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.5rem;
    }

    .result-stat-card .value {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--gray-800);
    }

    .result-stat-card .label {
        font-size: 0.85rem;
        color: var(--gray-500);
        font-weight: 600;
    }

    /* AI Insights Card */
    .ai-insights-card {
        background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3e 100%);
        border-radius: 20px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
    }

    .ai-insights-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .ai-insights-header h5 {
        margin: 0;
        font-weight: 700;
    }

    .feature-importance-list {
        display: grid;
        gap: 0.75rem;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

    .feature-item .rank {
        width: 28px;
        height: 28px;
        background: var(--gradient-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.8rem;
    }

    .feature-item .name {
        flex: 1;
        font-size: 0.9rem;
    }

    .feature-item .bar {
        width: 100px;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .feature-item .bar-fill {
        height: 100%;
        background: var(--gradient-primary);
        border-radius: 4px;
    }

    .feature-item .value {
        width: 50px;
        text-align: right;
        font-weight: 600;
        color: #a78bfa;
    }

    /* Recommendations */
    .recommendations-grid {
        display: grid;
        gap: 1rem;
    }

    .recommendation-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem 1.25rem;
        border-radius: 12px;
        background: white;
        border-left: 4px solid;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .recommendation-item.danger {
        border-left-color: var(--danger);
        background: #fef2f2;
    }

    .recommendation-item.warning {
        border-left-color: var(--warning);
        background: #fffbeb;
    }

    .recommendation-item.success {
        border-left-color: var(--success);
        background: #ecfdf5;
    }

    .recommendation-item .icon {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    /* Charts */
    .chart-container {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
    }

    .chart-container h6 {
        font-weight: 700;
        color: var(--gray-700);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Modal Overlay */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal-content-custom {
        background: white;
        border-radius: 24px;
        padding: 3rem;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(79, 70, 229, 0.1);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .hero-header h1 {
            font-size: 1.75rem;
        }

        .glass-card {
            padding: 1.5rem;
        }

        .results-section {
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">

    <!-- Hero Header -->
    <div class="hero-header" data-aos="fade-down">
        <h1>
            <i class="bi bi-person-check-fill me-2"></i>‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
        </h1>
        <p>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏ß‡∏¢ AI ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</p>
    </div>

    <!-- Control Panel -->
    <div class="glass-card" data-aos="fade-up">
        <div class="input-section">
            <div class="input-group-modern">
                <label><i class="bi bi-person me-1"></i>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" class="form-control" id="studentName" placeholder="‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö"
                    value="‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö">
            </div>
            <div class="input-group-modern">
                <label><i class="bi bi-card-text me-1"></i>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                <input type="text" class="form-control" id="studentId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
            </div>
            <div class="input-group-modern">
                <label><i class="bi bi-cpu me-1"></i>‡πÇ‡∏°‡πÄ‡∏î‡∏• AI</label>
                <select class="form-select" id="modelSelect">
                    <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
                </select>
            </div>
            <div class="input-group-modern">
                <label><i class="bi bi-clock-history me-1"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                <div class="form-control bg-light" id="loadedTermsInfo">
                    <i class="bi bi-hourglass-split me-1"></i> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°
                </div>
            </div>
        </div>

        <div class="d-flex flex-wrap gap-2 justify-content-center">
            <button class="btn btn-primary rounded-pill px-4" id="loadAllTermsBtn">
                <i class="bi bi-lightning-fill me-1"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏≠‡∏°
            </button>
            <button class="btn btn-outline-success rounded-pill px-4" id="fillSampleGradesBtn">
                <i class="bi bi-magic me-1"></i> ‡πÉ‡∏™‡πà‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
            </button>
            <button class="btn btn-outline-secondary rounded-pill px-4" id="saveCurrentStateBtn">
                <i class="bi bi-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
            <button class="btn btn-outline-danger rounded-pill px-4" id="clearAllGradesBtn">
                <i class="bi bi-eraser-fill me-1"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="glass-card" data-aos="fade-up" data-aos-delay="100">
        <h5 class="mb-4 fw-bold" style="color: var(--primary);">
            <i class="bi bi-speedometer2 me-2"></i>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö Real-time
        </h5>

        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value" id="statGPA">0.00</div>
                <div class="stat-label">GPA</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statCredits">0</div>
                <div class="stat-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #10b981;" id="statPassed">0</div>
                <div class="stat-label">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #ef4444;" id="statFailed">0</div>
                <div class="stat-label">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #f59e0b;" id="statBlocked">0</div>
                <div class="stat-label">‡∏ï‡∏¥‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #06b6d4;" id="statProgress">0%</div>
                <div class="stat-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-fill" id="mainProgressBar" style="width: 0%">0%</div>
        </div>
    </div>

    <!-- Gemini AI Panel -->
    <div class="gemini-panel" data-aos="fade-up" data-aos-delay="200">
        <div class="gemini-header">
            <i class="bi bi-stars fs-3 text-warning"></i>
            <h4>Gemini AI Copilot</h4>
            <span id="geminiStatusBadge" class="badge bg-success ms-auto">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
        </div>

        <div class="gemini-grid">
            <div class="gemini-action-card">
                <h5><i class="bi bi-file-earmark-bar-graph me-2"></i>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡∏£‡∏î</h5>
                <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV/Excel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</p>
                <input class="form-control form-control-sm mb-2" type="file" id="geminiCsvInput"
                    accept=".csv,.xlsx,.xls"
                    style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                <input type="text" class="form-control form-control-sm mb-2" id="geminiFileGoalInput"
                    placeholder="‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡πâ‡∏ô (Optional)"
                    style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                <button class="btn btn-light w-100" id="geminiAnalyzeFileBtn">
                    <i class="bi bi-stars me-1"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ü‡∏•‡πå
                </button>
            </div>
            <div class="gemini-action-card">
                <h5><i class="bi bi-person-lines-fill me-2"></i>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h5>
                <p>‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏£‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</p>
                <textarea class="form-control form-control-sm mb-2" rows="2" id="geminiLiveGoalInput"
                    placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° GPA ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á"
                    style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;"></textarea>
                <button class="btn btn-warning w-100" id="geminiLiveAnalyzeBtn">
                    <i class="bi bi-robot me-1"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>

        <div id="geminiLoadingState" class="text-center mt-4 d-none">
            <div class="spinner-border text-light" role="status"></div>
            <p class="mt-2 text-light">Gemini ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
        </div>

        <div id="geminiResultCard" class="gemini-result d-none">
            <!-- Header: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏à‡∏ö/‡πÑ‡∏°‡πà‡∏à‡∏ö -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex gap-2 flex-wrap">
                    <span class="badge bg-primary" id="geminiOutcomeBadge">
                        <i class="bi bi-mortarboard-fill me-1"></i>
                        <span id="geminiOutcomeLabel">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</span>
                    </span>
                    <span class="badge bg-warning text-dark">
                        <i class="bi bi-shield-check me-1"></i>
                        <span id="geminiRiskLevel">-</span>
                    </span>
                </div>
                <button class="btn btn-sm btn-outline-light rounded-circle" id="geminiClearBtn">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <!-- Metrics: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç -->
            <div class="gemini-metrics" id="geminiKeyMetrics"></div>

            <!-- Graduation Prediction Summary -->
            <div id="geminiGraduationSummary" class="mb-3 p-3 rounded"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                <div class="text-center">
                    <h5 class="mb-2" id="geminiGradPredText" style="color: #a78bfa;">
                        <i class="bi bi-stars me-1"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢
                    </h5>
                    <p class="mb-0 text-light opacity-75" id="geminiGradPredDetail">-</p>
                </div>
            </div>

            <!-- Analysis Content -->
            <div
                style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.5rem; max-height: 400px; overflow-y: auto;">
                <div class="markdown-body text-light" id="geminiMarkdownResult"></div>
            </div>

            <!-- Recommendations -->
            <div class="mt-3" id="geminiRecommendationsContainer" style="display: none;">
                <h6 class="text-uppercase text-white-50 mb-2">
                    <i class="bi bi-lightbulb-fill text-warning me-1"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                </h6>
                <ul class="list-unstyled text-light" id="geminiRecommendationsList"></ul>
            </div>
        </div>
    </div>

    <!-- Terms Container -->
    <div id="termsContainer"></div>

    <!-- Prediction Mode & Action -->
    <div class="text-center my-4" data-aos="fade-up">
        <div class="mode-toggle mb-4">
            <input type="radio" class="btn-check" name="predictionMode" id="modeNormal" value="normal" checked>
            <label class="btn" for="modeNormal">
                <i class="bi bi-cpu me-1"></i> AI Model
            </label>

            <input type="radio" class="btn-check" name="predictionMode" id="modeGemini" value="gemini">
            <label class="btn" for="modeGemini">
                <i class="bi bi-stars me-1"></i> Gemini AI
            </label>

            <input type="radio" class="btn-check" name="predictionMode" id="modeCombined" value="combined">
            <label class="btn" for="modeCombined">
                <i class="bi bi-diagram-3 me-1"></i> ‡∏ú‡∏™‡∏°‡∏ú‡∏™‡∏≤‡∏ô
            </label>
        </div>

        <div id="geminiModeConfig" class="mb-4" style="display: none; max-width: 500px; margin: 0 auto;">
            <textarea class="form-control" rows="2" id="geminiModeGoalInput"
                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Gemini ‡πÄ‡∏ô‡πâ‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå..."></textarea>
        </div>

        <div class="action-buttons">
            <button class="btn-action btn-primary" id="loadNextTermBtn">
                <i class="bi bi-plus-circle"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            </button>
            <button class="btn-action btn-success" id="openFutureCoursesModalBtn">
                <i class="bi bi-calendar-plus"></i> ‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
            </button>
            <button class="btn-action btn-predict" id="analyzeAndPredictBtn">
                <i class="bi bi-graph-up-arrow"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢
            </button>
        </div>
    </div>

    <!-- Results Section -->
    <div class="results-section d-none" id="resultsSection">
        <!-- Result Hero -->
        <div id="resultHero" class="result-hero success">
            <h2><i class="bi bi-check-circle-fill me-2"></i>‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
            <p class="mb-0">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: <strong>85%</strong></p>
        </div>

        <!-- Probability Bar -->
        <div class="probability-bar" id="probabilityBar">
            <div class="pass" style="width: 85%">‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏à‡∏ö 85%</div>
            <div class="fail" style="width: 15%">15%</div>
        </div>

        <!-- Graduation Prediction Card - ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏ö/‡πÑ‡∏°‡πà‡∏à‡∏ö ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• -->
        <div class="chart-container mb-4" id="graduationReasonCard"
            style="border: 2px solid; border-radius: 16px; overflow: hidden;">
            <div id="graduationPredictionHeader" class="p-3 text-center"
                style="background: linear-gradient(135deg, #10b981, #059669);">
                <h4 class="mb-1 text-white fw-bold" id="graduationPredictionTitle">
                    <i class="bi bi-mortarboard-fill me-2"></i>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢
                </h4>
                <p class="text-white mb-0 opacity-75" id="graduationPredictionSubtitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</p>
            </div>
            <div class="p-3">
                <h6 class="mb-3"><i class="bi bi-info-circle text-primary"></i> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</h6>
                <div id="graduationReasonContent"></div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="result-stats" id="resultStats">
            <!-- Will be filled by JavaScript -->
        </div>

        <!-- Graduation Analysis Card -->
        <div class="chart-container mb-4" id="graduationAnalysisCard"
            style="display: none; border-left: 4px solid #f59e0b;">
            <h6 class="mb-3"><i class="bi bi-clipboard-data text-warning"></i> ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h6>
            <div class="row">
                <div class="col-md-3 text-center mb-3">
                    <div class="p-3 rounded-3" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0);">
                        <div class="fs-3 fw-bold" id="analysisCurrentGpa" style="color: var(--primary);">0.00</div>
                        <small class="text-muted">GPA ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</small>
                    </div>
                </div>
                <div class="col-md-3 text-center mb-3">
                    <div class="p-3 rounded-3" style="background: linear-gradient(135deg, #ecfdf5, #d1fae5);">
                        <div class="fs-3 fw-bold text-success" id="analysisGradProb">0%</div>
                        <small class="text-muted">‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏à‡∏ö</small>
                    </div>
                </div>
                <div class="col-md-3 text-center mb-3">
                    <div class="p-3 rounded-3" style="background: linear-gradient(135deg, #fef2f2, #fecaca);">
                        <div class="fs-3 fw-bold text-danger" id="analysisRiskLevel">-</div>
                        <small class="text-muted">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</small>
                    </div>
                </div>
                <div class="col-md-3 text-center mb-3">
                    <div class="p-3 rounded-3" style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                        <div class="fs-3 fw-bold text-info" id="analysisCredits">0</div>
                        <small class="text-muted">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</small>
                    </div>
                </div>
            </div>

            <!-- Risk Factors -->
            <div class="mt-3" id="riskFactorsSection" style="display: none;">
                <h6 class="text-danger mb-2"><i class="bi bi-exclamation-triangle-fill me-1"></i> ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h6>
                <div id="riskFactorsList" class="p-3 rounded-3" style="background: #fef2f2;"></div>
            </div>

            <!-- Improvement Suggestions -->
            <div class="mt-3" id="improvementSection" style="display: none;">
                <h6 class="text-success mb-2"><i class="bi bi-lightbulb-fill me-1"></i> ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h6>
                <div id="improvementList" class="p-3 rounded-3" style="background: #ecfdf5;"></div>
            </div>
        </div>

        <!-- AI Insights -->
        <div class="ai-insights-card" id="aiInsightsCard" style="display: none;">
            <div class="ai-insights-header">
                <i class="bi bi-robot fs-4"></i>
                <h5>AI Analysis Insights</h5>
                <span class="badge bg-primary ms-auto" id="predictionMethodBadge">AI Model</span>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6 class="text-white-50 text-uppercase mb-3">‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</h6>
                    <div id="modelsUsedList"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-white-50 text-uppercase mb-3">‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Top 5)</h6>
                    <div class="feature-importance-list" id="featureImportanceList"></div>
                </div>
            </div>
        </div>

        <!-- Problem & Blocked Courses -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="chart-container h-100" style="border-left: 4px solid #ef4444;">
                    <h6><i class="bi bi-exclamation-circle text-danger"></i> ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h6>
                    <div id="problemCourses"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container h-100" style="border-left: 4px solid #f59e0b;">
                    <h6><i class="bi bi-lock text-warning"></i> ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ï‡∏¥‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</h6>
                    <div id="blockedCoursesDetail"></div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="chart-container mb-4">
            <h6><i class="bi bi-lightbulb text-success"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h6>
            <div class="recommendations-grid" id="personalRecommendations"></div>
        </div>

        <!-- 3-Line Chart (GPA Trajectory) -->
        <div class="chart-container mb-4" id="threeLineChartContainer" style="display: none;">
            <h6><i class="bi bi-graph-up-arrow text-primary"></i> ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á GPA (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ vs ‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á vs ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢)</h6>
            <div style="height: 350px;">
                <canvas id="threeLineChart"></canvas>
            </div>
            <div class="d-flex justify-content-center gap-4 mt-3 flex-wrap">
                <span><span
                        style="display: inline-block; width: 30px; height: 4px; background: #10b981; border-radius: 2px; vertical-align: middle;"></span>
                    ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (GPA 3.0)</span>
                <span><span
                        style="display: inline-block; width: 30px; height: 4px; background: #3b82f6; border-radius: 2px; vertical-align: middle;"></span>
                    ‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á</span>
                <span><span
                        style="display: inline-block; width: 30px; height: 4px; background: #f59e0b; border-radius: 2px; vertical-align: middle; border-style: dashed;"></span>
                    ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</span>
            </div>
        </div>

        <!-- Charts -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="chart-container">
                    <h6><i class="bi bi-bar-chart-line"></i> GPA ‡∏£‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°</h6>
                    <canvas id="gpaChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h6><i class="bi bi-pie-chart"></i> ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÄ‡∏Å‡∏£‡∏î</h6>
                    <canvas id="gradeDistChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Export Buttons -->
        <div class="text-center mt-4">
            <button class="btn btn-outline-secondary me-2" id="exportExcelBtn">
                <i class="bi bi-file-excel me-1"></i> Excel
            </button>
            <button class="btn btn-outline-secondary" id="printResultsBtn">
                <i class="bi bi-printer me-1"></i> Print
            </button>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal-overlay" id="customLoadingModal">
    <div class="modal-content-custom">
        <div class="loading-spinner"></div>
        <h5 class="fw-bold mb-2" id="customLoadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</h5>
        <p class="text-muted mb-0">‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
    </div>
</div>

<!-- Future Courses Modal -->
<div class="modal fade" id="futureCoursesModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-calendar-plus me-2"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="futureCoursesContent" style="max-height: 60vh; overflow-y: auto;"></div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                <button type="button" class="btn btn-primary rounded-pill px-4"
                    id="addFutureCoursesBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // ===== Global State =====
    let coursesData = [];
    let allTermsData = [];
    let gradeMapping = {};
    let loadedTermsCount = 0;
    let courseGrades = {};
    let charts = {};
    let isInitialized = false;
    let currentAnalysisController = null;
    let geminiEnabled = false;

    // ===== Initialization =====
    document.addEventListener('DOMContentLoaded', async function () {
        console.log('üöÄ Starting initialization...');
        try {
            const configLoaded = await loadConfigFromAPI();
            console.log('üì¶ Config loaded:', configLoaded);

            if (validateData()) {
                console.log('‚úÖ Data validated, initializing app...');
                await initializeApp();
                console.log('üéâ App initialized successfully');
            } else {
                console.error('‚ùå Data validation failed');
                console.log('coursesData:', coursesData?.length || 0);
                console.log('allTermsData:', allTermsData?.length || 0);
                console.log('gradeMapping:', Object.keys(gradeMapping || {}).length);
                showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤', 'danger');
            }
        } catch (error) {
            console.error('‚ùå Initialization failed:', error);
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'danger');
        }
    });

    async function loadConfigFromAPI() {
        console.log('üì° Fetching config from API...');
        try {
            const response = await fetch('/api/config');
            console.log('üì° Response status:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('üì° Config data received:', data.success);

            if (data.success) {
                coursesData = data.COURSES_DATA || [];
                allTermsData = data.ALL_TERMS_DATA || [];
                gradeMapping = data.GRADE_MAPPING || {};
                geminiEnabled = Boolean(data.GEMINI_ENABLED);

                console.log('üìö Courses loaded:', coursesData.length);
                console.log('üìÖ Terms loaded:', allTermsData.length);
                console.log('üìä Grade mapping keys:', Object.keys(gradeMapping).length);

                updateGeminiStatus();
                return true;
            }
            throw new Error('Config API returned success: false');
        } catch (error) {
            console.error('‚ùå loadConfigFromAPI error:', error);
            throw error;
        }
    }

    function validateData() {
        const valid = coursesData.length > 0 && allTermsData.length > 0 && Object.keys(gradeMapping).length > 0;
        console.log('üîç validateData:', valid);
        return valid;
    }

    async function initializeApp() {
        if (isInitialized) {
            console.log('‚ö†Ô∏è App already initialized');
            return;
        }

        console.log('üîß Setting up event listeners...');
        setupEventListeners();

        console.log('üìä Loading models...');
        await loadModels();

        console.log('üìà Updating live stats...');
        updateLiveStats();

        isInitialized = true;
        console.log('‚úÖ App initialization complete');
    }

    // ===== Event Listeners =====
    function setupEventListeners() {
        const handlers = {
            'loadNextTermBtn': loadNextTerm,
            'loadAllTermsBtn': loadAllTerms,
            'fillSampleGradesBtn': fillSampleGrades,
            'clearAllGradesBtn': clearAllGrades,
            'saveCurrentStateBtn': saveCurrentState,
            'analyzeAndPredictBtn': analyzeAndPredict,
            'openFutureCoursesModalBtn': openFutureCoursesModal,
            'addFutureCoursesBtn': addSelectedFutureCourses,
            'exportExcelBtn': () => exportResults('excel'),
            'printResultsBtn': printResults,
            'geminiAnalyzeFileBtn': analyzeCsvWithGemini,
            'geminiLiveAnalyzeBtn': analyzeLiveGradesWithGemini,
            'geminiClearBtn': clearGeminiResult
        };

        let attachedCount = 0;
        for (const [id, handler] of Object.entries(handlers)) {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('click', function (e) {
                    console.log(`üñ±Ô∏è Button clicked: ${id}`);
                    try {
                        handler(e);
                    } catch (err) {
                        console.error(`‚ùå Error in handler for ${id}:`, err);
                        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'danger');
                    }
                });
                attachedCount++;
                console.log(`‚úÖ Event listener attached: ${id}`);
            } else {
                console.warn(`‚ö†Ô∏è Element not found: ${id}`);
            }
        }
        console.log(`üìù Total event listeners attached: ${attachedCount}/${Object.keys(handlers).length}`);

        document.querySelectorAll('input[name="predictionMode"]').forEach(input => {
            input.addEventListener('change', updatePredictionModeUI);
        });

        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('grade-select')) {
                courseGrades[e.target.dataset.courseId] = e.target.value;
                updateLiveStats();
                updatePrerequisites();
            }
        });
    }

    // ===== Models =====
    async function loadModels() {
        const modelSelect = document.getElementById('modelSelect');
        try {
            const response = await fetch('/api/models');
            const data = await response.json();

            modelSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• AI --</option>';

            if (data.success && data.models?.length > 0) {
                data.models.forEach(model => {
                    const date = new Date(model.created_at);
                    const dateStr = date.toLocaleDateString('th-TH', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const option = document.createElement('option');
                    option.value = model.filename;
                    option.textContent = dateStr;
                    modelSelect.appendChild(option);
                });
                modelSelect.value = data.models[0].filename;
            }
        } catch (error) {
            modelSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏î‡πâ</option>';
        }
    }

    // ===== Term Management =====
    function loadNextTerm() {
        if (loadedTermsCount >= allTermsData.length) {
            showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß', 'warning');
            return;
        }

        lockPreviousTerms();
        const termData = allTermsData[loadedTermsCount];
        loadedTermsCount++;

        createTermSection(termData, loadedTermsCount);
        updateLoadedTermsInfo();
        updateLiveStats();
        updatePrerequisites();
    }

    function loadAllTerms() {
        document.getElementById('termsContainer').innerHTML = '';
        loadedTermsCount = 0;
        courseGrades = {};

        while (loadedTermsCount < allTermsData.length) {
            loadNextTerm();
        }
        showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    }

    function createTermSection(termData, termNumber) {
        const container = document.getElementById('termsContainer');
        const section = document.createElement('div');
        section.className = 'term-card animate__animated animate__fadeInUp';
        section.id = `term-${termNumber}`;

        let coursesHtml = '';
        termData.ids.forEach(courseId => {
            const course = coursesData.find(c => c.id === courseId);
            if (course) {
                coursesHtml += createCourseCardHtml(course);
            }
        });

        section.innerHTML = `
        <div class="term-header">
            <h6 class="mb-0 fw-bold">‡∏õ‡∏µ ${termData.year} ‡πÄ‡∏ó‡∏≠‡∏° ${termData.term}</h6>
            <span class="badge bg-light text-dark">${termData.ids.length} ‡∏ß‡∏¥‡∏ä‡∏≤</span>
        </div>
        <div class="term-body">
            <div class="course-grid">${coursesHtml}</div>
        </div>
    `;
        container.appendChild(section);
    }

    function createCourseCardHtml(course, isFuture = false, isRepeated = false) {
        const prereqText = course.prereq?.length > 0
            ? course.prereq.map(p => {
                const pc = coursesData.find(c => c.id === p);
                return pc ? pc.thaiName : p;
            }).join(', ')
            : '‡πÑ‡∏°‡πà‡∏°‡∏µ';

        let className = 'course-card';
        if (isFuture) className += ' future';
        if (isRepeated) className += ' repeated';

        return `
        <div class="${className}" data-course-id="${course.id}">
            <div class="course-title">${course.thaiName}</div>
            <div class="course-id">${course.id}</div>
            <div class="course-credit">${course.credit} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</div>
            <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                <i class="bi bi-link-45deg"></i> ${prereqText}
            </small>
            <select class="grade-select form-select form-select-sm" data-course-id="${course.id}">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏£‡∏î --</option>
                ${Object.keys(gradeMapping).map(g => `<option value="${g}">${g}</option>`).join('')}
            </select>
        </div>
    `;
    }

    function lockPreviousTerms() {
        for (let i = 1; i < loadedTermsCount; i++) {
            const section = document.getElementById(`term-${i}`);
            if (section) {
                section.querySelectorAll('.grade-select').forEach(s => s.disabled = true);
                const header = section.querySelector('.term-header');
                if (header) header.classList.add('locked');
            }
        }
    }

    // ===== Stats =====
    function updateLiveStats() {
        let totalPoints = 0, totalCredits = 0, passedCredits = 0, passedCount = 0, failedCount = 0;

        Object.entries(courseGrades).forEach(([courseId, grade]) => {
            if (grade) {
                const course = coursesData.find(c => c.id === courseId);
                if (course) {
                    const gradePoint = gradeMapping[grade] || 0;
                    if (grade !== 'W' && grade !== 'I') {
                        totalPoints += gradePoint * course.credit;
                        totalCredits += course.credit;
                    }
                    if (gradePoint > 0) {
                        passedCredits += course.credit;
                        passedCount++;
                    } else if (grade === 'F') {
                        failedCount++;
                    }
                }
            }
        });

        const gpa = totalCredits > 0 ? totalPoints / totalCredits : 0;
        const totalRequired = coursesData.reduce((sum, c) => sum + c.credit, 0);
        const progress = totalRequired > 0 ? (passedCredits / totalRequired) * 100 : 0;

        document.getElementById('statGPA').textContent = gpa.toFixed(2);
        document.getElementById('statCredits').textContent = passedCredits;
        document.getElementById('statPassed').textContent = passedCount;
        document.getElementById('statFailed').textContent = failedCount;
        document.getElementById('statProgress').textContent = Math.round(progress) + '%';

        const progressBar = document.getElementById('mainProgressBar');
        progressBar.style.width = Math.min(100, progress) + '%';
        progressBar.textContent = Math.round(progress) + '%';

        let blockedCount = document.querySelectorAll('.course-card.locked').length;
        document.getElementById('statBlocked').textContent = blockedCount;
    }

    function updateLoadedTermsInfo() {
        const info = document.getElementById('loadedTermsInfo');
        if (loadedTermsCount === 0) {
            info.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°';
        } else {
            const lastTerm = allTermsData[loadedTermsCount - 1];
            info.innerHTML = `<i class="bi bi-check-circle-fill text-success me-1"></i> ‡∏õ‡∏µ ${lastTerm.year} ‡πÄ‡∏ó‡∏≠‡∏° ${lastTerm.term} (${loadedTermsCount}/${allTermsData.length})`;
        }
    }

    function updatePrerequisites() {
        document.querySelectorAll('.grade-select').forEach(select => {
            const courseCard = select.closest('.course-card');
            const courseId = select.dataset.courseId;
            const course = coursesData.find(c => c.id === courseId);
            if (!course) return;

            const oldWarning = courseCard.querySelector('.prerequisite-warning');
            if (oldWarning) oldWarning.remove();

            let isBlocked = false;
            let unmetPrereqs = [];

            if (course.prereq?.length > 0) {
                for (let prereqId of course.prereq) {
                    const prereqGrade = courseGrades[prereqId];
                    if (!prereqGrade || gradeMapping[prereqGrade] === 0) {
                        isBlocked = true;
                        const pc = coursesData.find(c => c.id === prereqId);
                        unmetPrereqs.push(pc ? pc.thaiName : prereqId);
                    }
                }
            }

            if (isBlocked) {
                courseCard.classList.add('locked');
                select.disabled = true;
                select.value = '';
                delete courseGrades[courseId];

                const warning = document.createElement('div');
                warning.className = 'prerequisite-warning small text-danger mt-2';
                warning.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-1"></i> ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô: ${unmetPrereqs.join(', ')}`;
                courseCard.appendChild(warning);
            } else {
                courseCard.classList.remove('locked');
                select.disabled = false;
            }
        });
    }

    // ===== Sample Data =====
    function fillSampleGrades() {
        const grades = ['A', 'B+', 'B', 'C+', 'C', 'D+', 'D'];
        document.querySelectorAll('.grade-select').forEach(select => {
            if (!select.disabled && !select.value) {
                const randomGrade = grades[Math.floor(Math.random() * grades.length)];
                select.value = randomGrade;
                courseGrades[select.dataset.courseId] = randomGrade;
            }
        });
        updateLiveStats();
        updatePrerequisites();
        showAlert('‡πÉ‡∏™‡πà‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    }

    function clearAllGrades() {
        if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏£‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;

        document.querySelectorAll('.grade-select').forEach(select => {
            if (!select.disabled) select.value = '';
        });

        const newGrades = {};
        Object.entries(courseGrades).forEach(([id, grade]) => {
            const select = document.querySelector(`.grade-select[data-course-id="${id}"]`);
            if (select?.disabled) newGrades[id] = grade;
        });
        courseGrades = newGrades;

        updateLiveStats();
        updatePrerequisites();
        showAlert('‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'info');
    }

    function saveCurrentState() {
        const state = {
            studentName: document.getElementById('studentName').value,
            studentId: document.getElementById('studentId').value,
            loadedTermsCount,
            courseGrades,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('studentPredictionState', JSON.stringify(state));
        showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    }

    // ===== Prediction =====
    function getSelectedPredictionMode() {
        return document.querySelector('input[name="predictionMode"]:checked')?.value || 'normal';
    }

    function updatePredictionModeUI() {
        const mode = getSelectedPredictionMode();
        const config = document.getElementById('geminiModeConfig');
        config.style.display = (mode === 'gemini' || mode === 'combined') ? 'block' : 'none';
    }

    function updateGeminiStatus() {
        const badge = document.getElementById('geminiStatusBadge');
        const geminiRadio = document.getElementById('modeGemini');
        const combinedRadio = document.getElementById('modeCombined');

        if (geminiEnabled) {
            badge.className = 'badge bg-success ms-auto';
            badge.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            if (geminiRadio) geminiRadio.disabled = false;
            if (combinedRadio) combinedRadio.disabled = false;
        } else {
            badge.className = 'badge bg-danger ms-auto';
            badge.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            if (geminiRadio) geminiRadio.disabled = true;
            if (combinedRadio) combinedRadio.disabled = true;
        }
    }

    async function analyzeAndPredict() {
        if (Object.keys(courseGrades).length === 0) {
            showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏Å‡∏£‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏¥‡∏ä‡∏≤', 'warning');
            return;
        }

        const studentName = document.getElementById('studentName').value || '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
        const modelSelect = document.getElementById('modelSelect');
        let modelFilename = modelSelect?.value || '';

        if (!modelFilename) {
            try {
                const resp = await fetch('/api/models');
                const data = await resp.json();
                if (data.success && data.models?.length > 0) {
                    modelFilename = data.models[0].filename;
                }
            } catch (e) { }
        }

        const mode = getSelectedPredictionMode();

        if (mode === 'gemini' && geminiEnabled) {
            await analyzeWithGemini(studentName, modelFilename);
            return;
        }

        if (mode === 'combined' && geminiEnabled) {
            await analyzeCombined(studentName, modelFilename);
            return;
        }

        showCustomLoadingModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏ß‡∏¢ AI Model...');
        currentAnalysisController = new AbortController();

        try {
            const response = await fetch('/api/analyze_curriculum', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_name: studentName,
                    current_grades: courseGrades,
                    loaded_terms_count: loadedTermsCount,
                    model_filename: modelFilename
                }),
                signal: currentAnalysisController.signal
            });

            const result = await response.json();

            if (result.success) {
                displayResults(result);
                showAlert('‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
            } else {
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'danger');
            }
        } catch (error) {
            if (error.name !== 'AbortError') {
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'danger');
            }
        } finally {
            hideCustomLoadingModal();
            currentAnalysisController = null;
        }
    }

    async function analyzeCombined(studentName, modelFilename) {
        showCustomLoadingModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏ß‡∏¢ AI Model + Gemini...');

        try {
            // Step 1: Run trained model prediction
            const modelResponse = await fetch('/api/analyze_curriculum', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_name: studentName,
                    current_grades: courseGrades,
                    loaded_terms_count: loadedTermsCount,
                    model_filename: modelFilename
                })
            });
            const modelResult = await modelResponse.json();

            if (modelResult.success) {
                displayResults(modelResult);
            }

            // Step 2: Send model prediction + grades to Gemini for enhanced analysis
            const goalInput = document.getElementById('geminiModeGoalInput');
            const geminiPayload = {
                student_name: studentName,
                course_grades: courseGrades,
                loaded_terms_count: loadedTermsCount,
                model_filename: modelFilename,
                model_prediction: modelResult.success ? modelResult.prediction_result : null,
                graduation_analysis: modelResult.success ? modelResult.graduation_analysis : null,
                avg_gpa: modelResult.success ? modelResult.avg_gpa : null,
                combined_mode: true
            };
            if (goalInput?.value.trim()) {
                geminiPayload.analysis_goal = goalInput.value.trim();
            }

            const geminiResponse = await fetch('/api/gemini/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(geminiPayload)
            });
            const geminiResult = await geminiResponse.json();

            if (geminiResult.success) {
                displayGeminiResult(geminiResult);
                showAlert('‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏™‡∏°‡∏ú‡∏™‡∏≤‡∏ô AI Model + Gemini ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
            } else {
                showAlert(geminiResult.error || 'Gemini ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ', 'warning');
                if (modelResult.success) {
                    showAlert('‚úÖ ‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏à‡∏≤‡∏Å AI Model ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'info');
                }
            }
        } catch (error) {
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'danger');
        } finally {
            hideCustomLoadingModal();
        }
    }

    async function analyzeWithGemini(studentName, modelFilename) {
        if (!geminiEnabled) {
            showAlert('Gemini ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning');
            return;
        }

        const goalInput = document.getElementById('geminiModeGoalInput');
        const payload = {
            student_name: studentName,
            course_grades: courseGrades,
            loaded_terms_count: loadedTermsCount,
            model_filename: modelFilename
        };
        if (goalInput?.value.trim()) {
            payload.analysis_goal = goalInput.value.trim();
        }

        showCustomLoadingModal('Gemini ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...');

        try {
            const response = await fetch('/api/gemini/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.success) {
                displayGeminiResult(result);
                showAlert('‚ú® Gemini ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
            } else {
                showAlert(result.error || 'Gemini ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ', 'danger');
            }
        } catch (error) {
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'danger');
        } finally {
            hideCustomLoadingModal();
        }
    }

    // ===== Display Results =====
    function displayResults(data) {
        const resultsSection = document.getElementById('resultsSection');
        resultsSection.classList.remove('d-none');

        const pred = data.prediction_result;
        const isPass = pred?.prediction === '‡∏à‡∏ö';
        const probPass = pred ? Math.min(100, (pred.prob_pass * 100)).toFixed(1) : 50;
        const probFail = pred ? Math.min(100, (pred.prob_fail * 100)).toFixed(1) : 50;
        const confidence = pred ? Math.min(100, (pred.confidence * 100)).toFixed(1) : 50;

        // Result Hero - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å graduation_analysis ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ AI Model
        const resultHero = document.getElementById('resultHero');
        const gradAnalysis = data.graduation_analysis;
        const willGraduate = gradAnalysis?.will_graduate || isPass;
        const predictionMethod = gradAnalysis?.prediction_method || data.prediction_result?.method || 'Rule-based';
        const aiPredictionUsed = gradAnalysis?.ai_prediction_used || false;
        const modelConfidence = gradAnalysis?.model_confidence || (pred?.confidence || 0.5);

        resultHero.className = `result-hero ${willGraduate ? 'success' : 'danger'}`;
        resultHero.innerHTML = `
        <h2><i class="bi bi-${willGraduate ? 'mortarboard-fill' : 'exclamation-triangle-fill'} me-2"></i>${willGraduate ? 'üéì ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤' : '‚ö†Ô∏è ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'}</h2>
        <p class="mb-0">
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: <strong>${(modelConfidence * 100).toFixed(0)}%</strong> | 
            GPA: <strong>${(data.avg_gpa || 0).toFixed(2)}</strong> |
            ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏à‡∏ö: <strong>${probPass}%</strong>
        </p>
        <p class="mb-0 mt-2">
            <span class="badge ${aiPredictionUsed ? 'bg-primary' : 'bg-secondary'} px-3 py-1">
                <i class="bi bi-${aiPredictionUsed ? 'cpu-fill' : 'calculator'} me-1"></i>
                ${aiPredictionUsed ? 'AI Model Prediction' : 'Rule-based Analysis'}
            </span>
            ${gradAnalysis?.graduation_status ? `<span class="badge ${willGraduate ? 'bg-success' : 'bg-danger'} px-3 py-1 ms-2">${gradAnalysis.graduation_status}</span>` : ''}
        </p>
    `;

        // Probability Bar
        const probBar = document.getElementById('probabilityBar');
        probBar.innerHTML = `
        <div class="pass" style="width: ${probPass}%">‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏à‡∏ö ${probPass}%</div>
        <div class="fail" style="width: ${probFail}%">${probFail}%</div>
    `;

        // Graduation Prediction Card - ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏ö/‡πÑ‡∏°‡πà‡∏à‡∏ö ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
        const reasonCard = document.getElementById('graduationReasonContent');
        const predHeader = document.getElementById('graduationPredictionHeader');
        const predTitle = document.getElementById('graduationPredictionTitle');
        const predSubtitle = document.getElementById('graduationPredictionSubtitle');

        if (reasonCard) {
            // Use gradAnalysis already defined above
            let reasonHtml = '';

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏ö/‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏à‡∏≤‡∏Å graduation_analysis
            const willGraduate = gradAnalysis?.will_graduate || isPass;
            const predictionText = gradAnalysis?.graduation_prediction_text || (willGraduate ? 'üéì ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤' : '‚ö†Ô∏è ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
            const predictionDetail = gradAnalysis?.graduation_prediction_detail || '';

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Header ‡∏Ç‡∏≠‡∏á Graduation Prediction Card
            if (predHeader) {
                if (willGraduate) {
                    predHeader.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    predHeader.style.borderColor = '#10b981';
                } else {
                    predHeader.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    predHeader.style.borderColor = '#ef4444';
                }
            }
            if (predTitle) {
                predTitle.innerHTML = willGraduate
                    ? '<i class="bi bi-mortarboard-fill me-2"></i>üéì ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'
                    : '<i class="bi bi-exclamation-triangle-fill me-2"></i>‚ö†Ô∏è ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
            }
            if (predSubtitle) {
                const aiUsed = gradAnalysis?.ai_prediction_used ? 'ü§ñ AI Model' : 'üìä Rule-based';
                const methodInfo = gradAnalysis?.prediction_method ? ` (${gradAnalysis.prediction_method})` : '';
                predSubtitle.textContent = `${aiUsed}${methodInfo} | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${(gradAnalysis?.model_confidence * 100 || confidence).toFixed(0)}% | GPA: ${(data.avg_gpa || 0).toFixed(2)}`;
            }

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ border color ‡∏Ç‡∏≠‡∏á card
            const graduationCard = document.getElementById('graduationReasonCard');
            if (graduationCard) {
                graduationCard.style.borderColor = willGraduate ? '#10b981' : '#ef4444';
            }

            if (willGraduate) {
                // ========== ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ==========
                const reasonsForGrad = gradAnalysis?.reasons_for_graduation || [];
                let passReasons = [];

                // ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏≤‡∏Å backend ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (reasonsForGrad.length > 0) {
                    passReasons = reasonsForGrad.map(r => ({
                        icon: r.icon || '‚úÖ',
                        title: r.title,
                        description: r.description,
                        type: r.type || 'success'
                    }));
                } else {
                    // Fallback: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                    if (data.avg_gpa >= 2.0) passReasons.push({ icon: '‚úÖ', title: 'GPA ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå', description: `GPA ‡∏™‡∏∞‡∏™‡∏° ${(data.avg_gpa || 0).toFixed(2)} ‚â• 2.00`, type: 'success' });
                    if ((data.failed_courses?.length || 0) === 0) passReasons.push({ icon: '‚úÖ', title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å', description: '‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', type: 'success' });
                    if ((data.blocked_courses?.length || 0) === 0) passReasons.push({ icon: '‚úÖ', title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ï‡∏¥‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç', description: '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô', type: 'success' });
                    if ((data.completion_rate || 0) > 50) passReasons.push({ icon: 'üìà', title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏µ', description: `‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô ${(data.completion_rate || 0).toFixed(1)}%`, type: 'success' });
                }

                if (passReasons.length === 0) passReasons.push({ icon: '‚úÖ', title: '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏µ', description: '‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ', type: 'success' });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• AI Model ‡πÉ‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
                if (gradAnalysis?.ai_prediction_used) {
                    passReasons.unshift({
                        icon: 'ü§ñ',
                        title: 'AI Model ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö',
                        description: `‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏à‡∏ö ${(gradAnalysis?.model_prob_pass * 100 || probPass).toFixed(0)}% (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ${(gradAnalysis?.model_confidence * 100).toFixed(0)}%)`,
                        type: 'success'
                    });
                }

                reasonHtml = `
                <div class="alert alert-success mb-0 border-0" style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-radius: 12px;">
                    <h6 class="alert-heading fw-bold text-success mb-3">
                        <i class="bi bi-check-circle-fill me-2"></i>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                        ${gradAnalysis?.ai_prediction_used ? '<span class="badge bg-primary ms-2"><i class="bi bi-cpu-fill me-1"></i>AI Model</span>' : ''}
                    </h6>
                    <div class="row g-2">
                        ${passReasons.map(r => `
                            <div class="col-md-6">
                                <div class="d-flex align-items-start p-2 rounded" style="background: rgba(255,255,255,0.8); border-left: 4px solid #10b981;">
                                    <span class="me-2" style="font-size: 1.2rem;">${r.icon}</span>
                                    <div>
                                        <div class="fw-bold text-success">${r.title}</div>
                                        <small class="text-muted">${r.description}</small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${predictionDetail ? `<div class="mt-3 p-2 rounded text-center" style="background: rgba(16,185,129,0.2); border-radius: 8px;"><i class="bi bi-info-circle-fill text-success me-1"></i> ${predictionDetail}</div>` : ''}
                    ${gradAnalysis?.graduation_status ? `<div class="mt-2 p-2 rounded text-center" style="background: rgba(16,185,129,0.3); border-radius: 8px;"><i class="bi bi-trophy-fill text-success me-1"></i> <strong>${gradAnalysis.graduation_status}</strong></div>` : ''}
                </div>
            `;
            } else {
                // ========== ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ==========
                const reasonsForNotGrad = gradAnalysis?.reasons_for_not_graduation || [];
                let failReasons = [];

                // ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏≤‡∏Å backend ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (reasonsForNotGrad.length > 0) {
                    failReasons = reasonsForNotGrad.map(r => ({
                        icon: r.icon || '‚ùå',
                        title: r.title,
                        description: r.description,
                        type: r.type || 'critical',
                        courses: r.courses || []
                    }));
                }

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏≤‡∏Å graduation_analysis.reasons (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                if (gradAnalysis?.reasons?.length > 0) {
                    gradAnalysis.reasons.forEach(r => {
                        if (!failReasons.some(fr => fr.title === r.title)) {
                            failReasons.push({
                                icon: r.type === 'critical' ? '‚ùå' : '‚ö†Ô∏è',
                                title: r.title,
                                description: r.description || '',
                                type: r.type
                            });
                        }
                    });
                }

                // Fallback: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
                if (data.avg_gpa < 2.0 && !failReasons.some(r => r.title?.includes('GPA'))) {
                    failReasons.push({ icon: '‚ùå', title: 'GPA ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå', description: `GPA ‡∏™‡∏∞‡∏™‡∏° ${(data.avg_gpa || 0).toFixed(2)} < 2.00 ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥`, type: 'critical' });
                }
                if ((data.failed_courses?.length || 0) > 0 && !failReasons.some(r => r.title?.includes('‡∏ï‡∏Å') || r.title?.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'))) {
                    failReasons.push({ icon: '‚ùå', title: `‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å ${data.failed_courses.length} ‡∏ß‡∏¥‡∏ä‡∏≤`, description: `‡∏ß‡∏¥‡∏ä‡∏≤: ${data.failed_courses.slice(0, 3).join(', ')}${data.failed_courses.length > 3 ? '...' : ''}`, type: 'critical', courses: data.failed_courses });
                }
                if ((data.blocked_courses?.length || 0) > 0 && !failReasons.some(r => r.title?.includes('‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç'))) {
                    failReasons.push({ icon: '‚ö†Ô∏è', title: `‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ï‡∏¥‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ${data.blocked_courses.length} ‡∏ß‡∏¥‡∏ä‡∏≤`, description: '‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô', type: 'warning' });
                }

                if (failReasons.length === 0) failReasons.push({ icon: '‚ö†Ô∏è', title: '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á', description: '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', type: 'warning' });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• AI Model ‡πÉ‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
                if (gradAnalysis?.ai_prediction_used) {
                    failReasons.unshift({
                        icon: 'ü§ñ',
                        title: 'AI Model ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö',
                        description: `‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏à‡∏ö ${(gradAnalysis?.model_prob_pass * 100 || probPass).toFixed(0)}% (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ${(gradAnalysis?.model_confidence * 100).toFixed(0)}%)`,
                        type: 'critical'
                    });
                }

                reasonHtml = `
                <div class="alert alert-danger mb-0 border-0" style="background: linear-gradient(135deg, #fef2f2, #fecaca); border-radius: 12px;">
                    <h6 class="alert-heading fw-bold text-danger mb-3">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                        ${gradAnalysis?.ai_prediction_used ? '<span class="badge bg-danger ms-2"><i class="bi bi-cpu-fill me-1"></i>AI Model</span>' : ''}
                    </h6>
                    <div class="row g-2">
                        ${failReasons.slice(0, 6).map(r => `
                            <div class="col-md-6">
                                <div class="d-flex align-items-start p-2 rounded" style="background: rgba(255,255,255,0.8); border-left: 4px solid ${r.type === 'critical' ? '#ef4444' : '#f59e0b'};">
                                    <span class="me-2" style="font-size: 1.2rem;">${r.icon}</span>
                                    <div>
                                        <div class="fw-bold ${r.type === 'critical' ? 'text-danger' : 'text-warning'}">${r.title}</div>
                                        <small class="text-muted">${r.description}</small>
                                        ${r.courses?.length > 0 ? `<div class="mt-1"><small class="text-danger"><i class="bi bi-list-ul me-1"></i>${r.courses.slice(0, 3).join(', ')}${r.courses.length > 3 ? '...' : ''}</small></div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${predictionDetail ? `<div class="mt-3 p-2 rounded text-center" style="background: rgba(239,68,68,0.2); border-radius: 8px;"><i class="bi bi-info-circle-fill text-danger me-1"></i> ${predictionDetail}</div>` : ''}
                    ${gradAnalysis?.risk_description ? `<div class="mt-2 p-2 rounded text-center" style="background: rgba(239,68,68,0.3); border-radius: 8px;"><i class="bi bi-exclamation-diamond-fill text-danger me-1"></i> <strong>${gradAnalysis.risk_description}</strong></div>` : ''}
                </div>
            `;
            }

            reasonCard.innerHTML = reasonHtml;
        }

        // Stats Cards
        const statsContainer = document.getElementById('resultStats');
        statsContainer.innerHTML = `
        <div class="result-stat-card">
            <div class="icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-speedometer2"></i></div>
            <div class="value">${(data.avg_gpa || 0).toFixed(2)}</div>
            <div class="label">GPA ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
        </div>
        <div class="result-stat-card">
            <div class="icon bg-success bg-opacity-10 text-success"><i class="bi bi-journal-check"></i></div>
            <div class="value">${data.completed_credits || 0}</div>
            <div class="label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô</div>
        </div>
        <div class="result-stat-card">
            <div class="icon bg-info bg-opacity-10 text-info"><i class="bi bi-percent"></i></div>
            <div class="value">${(data.completion_rate || 0).toFixed(1)}%</div>
            <div class="label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
        </div>
        <div class="result-stat-card">
            <div class="icon bg-danger bg-opacity-10 text-danger"><i class="bi bi-x-circle"></i></div>
            <div class="value">${data.failed_courses?.length || 0}</div>
            <div class="label">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å</div>
        </div>
    `;

        // Graduation Analysis Card
        // Use gradAnalysis already defined above
        if (gradAnalysis) {
            const analysisCard = document.getElementById('graduationAnalysisCard');
            analysisCard.style.display = 'block';

            document.getElementById('analysisCurrentGpa').textContent = (gradAnalysis.current_gpa || data.avg_gpa || 0).toFixed(2);
            document.getElementById('analysisGradProb').textContent = `${(gradAnalysis.graduation_probability || (parseFloat(probPass))).toFixed(0)}%`;
            document.getElementById('analysisRiskLevel').textContent = gradAnalysis.risk_level || (isPass ? '‡∏ï‡πà‡∏≥' : '‡∏™‡∏π‡∏á');

            // Calculate remaining credits (total required - passed)
            const remainingCredits = Math.max(0, 136 - (gradAnalysis.passed_credits || 0));
            document.getElementById('analysisCredits').textContent = remainingCredits || '-';

            // Risk Factors from reasons array
            const riskSection = document.getElementById('riskFactorsSection');
            const riskList = document.getElementById('riskFactorsList');
            const criticalReasons = gradAnalysis.reasons?.filter(r => r.type === 'critical' || r.type === 'warning') || [];

            if (criticalReasons.length > 0) {
                riskSection.style.display = 'block';
                riskList.innerHTML = criticalReasons.map(r => `
                <div class="d-flex align-items-start mb-2">
                    <i class="bi bi-exclamation-${r.type === 'critical' ? 'triangle' : 'circle'}-fill text-${r.type === 'critical' ? 'danger' : 'warning'} me-2 mt-1"></i>
                    <div>
                        <div class="fw-bold">${r.title}</div>
                        <small class="text-muted">${r.description}</small>
                        ${r.solution ? `<div class="mt-1"><small class="text-success"><i class="bi bi-lightbulb me-1"></i>${r.solution}</small></div>` : ''}
                    </div>
                </div>
            `).join('');
            } else {
                riskSection.style.display = 'none';
            }

            // Improvement Suggestions from recommendations array
            const improvementSection = document.getElementById('improvementSection');
            const improvementList = document.getElementById('improvementList');
            if (gradAnalysis.recommendations?.length > 0) {
                improvementSection.style.display = 'block';
                improvementList.innerHTML = gradAnalysis.recommendations.slice(0, 5).map(s =>
                    `<div class="d-flex align-items-start mb-2"><i class="bi bi-lightbulb-fill text-success me-2 mt-1"></i><span>${s}</span></div>`
                ).join('');
            } else {
                improvementSection.style.display = 'none';
            }
        }

        // AI Insights
        if (pred?.prediction_method === 'AI_MODEL' && pred?.feature_importance) {
            const aiCard = document.getElementById('aiInsightsCard');
            aiCard.style.display = 'block';

            document.getElementById('predictionMethodBadge').textContent = pred.prediction_method;

            // Models used
            const modelsList = document.getElementById('modelsUsedList');
            if (pred.models_used) {
                modelsList.innerHTML = pred.models_used.map(m =>
                    `<span class="badge bg-primary me-1 mb-1">${m.toUpperCase()}</span>`
                ).join('');
            }

            // Feature importance
            const featureList = document.getElementById('featureImportanceList');
            const features = Object.entries(pred.feature_importance).slice(0, 5);
            featureList.innerHTML = features.map(([name, imp], i) => `
            <div class="feature-item">
                <span class="rank">${i + 1}</span>
                <span class="name">${name}</span>
                <div class="bar"><div class="bar-fill" style="width: ${(imp * 100).toFixed(0)}%"></div></div>
                <span class="value">${(imp * 100).toFixed(1)}%</span>
            </div>
        `).join('');
        } else {
            document.getElementById('aiInsightsCard').style.display = 'none';
        }

        // Problem Courses
        const problemDiv = document.getElementById('problemCourses');
        if (data.failed_courses?.length > 0) {
            problemDiv.innerHTML = data.failed_courses.map(c =>
                `<div class="d-flex align-items-center mb-2"><i class="bi bi-x-circle-fill text-danger me-2"></i>${c}</div>`
            ).join('');
        } else {
            problemDiv.innerHTML = '<div class="text-success text-center py-3"><i class="bi bi-check-circle-fill fs-3 mb-2"></i><p class="mb-0">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å</p></div>';
        }

        // Blocked Courses
        const blockedDiv = document.getElementById('blockedCoursesDetail');
        if (data.blocked_courses_details?.length > 0) {
            blockedDiv.innerHTML = data.blocked_courses_details.map(c => `
            <div class="mb-2">
                <div class="fw-bold"><i class="bi bi-lock-fill text-warning me-2"></i>${c.name}</div>
                <small class="text-muted ms-4">‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô: ${c.unmet_prereqs.join(', ')}</small>
            </div>
        `).join('');
        } else {
            blockedDiv.innerHTML = '<div class="text-success text-center py-3"><i class="bi bi-unlock-fill fs-3 mb-2"></i><p class="mb-0">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ï‡∏¥‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p></div>';
        }

        // Recommendations
        const recsDiv = document.getElementById('personalRecommendations');
        if (data.recommendations?.length > 0) {
            recsDiv.innerHTML = data.recommendations.map(rec => {
                const type = rec.includes('‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô') || rec.includes('‡∏ï‡πà‡∏≥') ? 'danger' :
                    rec.includes('‡∏Ñ‡∏ß‡∏£') ? 'warning' : 'success';
                return `
                <div class="recommendation-item ${type}">
                    <span class="icon">${type === 'danger' ? '‚ö†Ô∏è' : type === 'warning' ? 'üí°' : '‚úÖ'}</span>
                    <span>${rec}</span>
                </div>
            `;
            }).join('');
        }

        // 3-Line Chart (Target vs Actual vs Prediction)
        if (data.chart_data) {
            displayThreeLineChart(data.chart_data);
        }

        // GPA Chart per Term
        displayGpaChart(data);

        // Grade Distribution Chart
        displayGradeDistChart(data);

        // Scroll to results
        setTimeout(() => resultsSection.scrollIntoView({ behavior: 'smooth' }), 100);
    }

    // ===== Three-Line Chart (‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢, ‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á, ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢) =====
    function displayThreeLineChart(chartData) {
        const container = document.getElementById('threeLineChartContainer');
        const canvas = document.getElementById('threeLineChart');

        if (!chartData || !chartData.terms || chartData.terms.length === 0) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';

        // Destroy existing chart if any
        if (window.threeLineChartInstance) {
            window.threeLineChartInstance.destroy();
        }

        const ctx = canvas.getContext('2d');

        const labels = chartData.terms || [];
        const targetLine = chartData.target_line || [];
        const actualLine = chartData.actual_line || [];
        const predictionLine = chartData.prediction_line || [];

        window.threeLineChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (GPA 3.0)',
                        data: targetLine,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        borderDash: [],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 4,
                        pointBackgroundColor: '#10b981'
                    },
                    {
                        label: '‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á',
                        data: actualLine,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 6,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢',
                        data: predictionLine,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 3,
                        borderDash: [8, 4],
                        fill: false,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: '#f59e0b',
                        pointStyle: 'triangle'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: { size: 12, family: "'Sarabun', sans-serif" }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: { size: 14 },
                        bodyFont: { size: 12 },
                        padding: 12,
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.parsed.y?.toFixed(2) || '-'}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '‡πÄ‡∏ó‡∏≠‡∏°',
                            font: { size: 12, weight: 'bold' }
                        },
                        grid: { display: false }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'GPA',
                            font: { size: 12, weight: 'bold' }
                        },
                        min: 0,
                        max: 4,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    // ===== GPA Chart per Term =====
    function displayGpaChart(data) {
        const canvas = document.getElementById('gpaChart');
        if (!canvas) return;

        // Destroy existing chart
        if (window.gpaChartInstance) {
            window.gpaChartInstance.destroy();
        }

        // Get actual GPAs from chart_data (filter out null values from prediction area)
        let termGpas = [];
        let terms = [];

        if (data.chart_data?.actual_line && data.chart_data?.terms) {
            // Use actual_line data (real cumulative GPA per term)
            for (let i = 0; i < data.chart_data.actual_line.length; i++) {
                const gpa = data.chart_data.actual_line[i];
                if (gpa !== null && gpa !== undefined) {
                    termGpas.push(gpa);
                    terms.push(data.chart_data.terms[i] || `‡πÄ‡∏ó‡∏≠‡∏° ${i + 1}`);
                }
            }
        }

        // Fallback: calculate from courseGrades
        if (termGpas.length === 0 && loadedTermsCount > 0) {
            for (let i = 0; i < loadedTermsCount; i++) {
                terms.push(`‡πÄ‡∏ó‡∏≠‡∏° ${i + 1}`);
                // Calculate term GPA from courseGrades
                const termCourses = allTermsData[i]?.ids || [];
                let termPoints = 0, termCredits = 0;
                termCourses.forEach(courseId => {
                    const grade = courseGrades[courseId];
                    const gp = gradeMapping[grade];
                    if (gp !== undefined && gp !== null) {
                        const course = coursesData.find(c => c.id === courseId);
                        const credit = course?.credit || 3;
                        termPoints += gp * credit;
                        termCredits += credit;
                    }
                });
                termGpas.push(termCredits > 0 ? termPoints / termCredits : 0);
            }
        }

        const gpas = termGpas;

        const ctx = canvas.getContext('2d');
        window.gpaChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: terms,
                datasets: [{
                    label: 'GPA ‡∏£‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°',
                    data: gpas,
                    backgroundColor: gpas.map(g => g >= 3.0 ? 'rgba(16, 185, 129, 0.7)' : g >= 2.0 ? 'rgba(245, 158, 11, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                    borderColor: gpas.map(g => g >= 3.0 ? '#10b981' : g >= 2.0 ? '#f59e0b' : '#ef4444'),
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 4,
                        ticks: { stepSize: 1 },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // ===== Grade Distribution Chart =====
    function displayGradeDistChart(data) {
        const canvas = document.getElementById('gradeDistChart');
        if (!canvas) return;

        // Destroy existing chart
        if (window.gradeDistChartInstance) {
            window.gradeDistChartInstance.destroy();
        }

        // Count grades from current data
        const gradeCounts = {};
        const grades = ['A', 'B+', 'B', 'C+', 'C', 'D+', 'D', 'F'];
        grades.forEach(g => gradeCounts[g] = 0);

        Object.values(courseGrades).forEach(grade => {
            if (grade && grades.includes(grade)) {
                gradeCounts[grade]++;
            }
        });

        const ctx = canvas.getContext('2d');
        window.gradeDistChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: grades,
                datasets: [{
                    data: grades.map(g => gradeCounts[g] || 0),
                    backgroundColor: [
                        '#10b981', // A - Green
                        '#34d399', // B+ - Light Green
                        '#60a5fa', // B - Blue
                        '#93c5fd', // C+ - Light Blue
                        '#fbbf24', // C - Yellow
                        '#f97316', // D+ - Orange
                        '#fb923c', // D - Light Orange
                        '#ef4444'  // F - Red
                    ],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: { size: 11 }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }

    function displayGeminiResult(result) {
        const card = document.getElementById('geminiResultCard');
        card.classList.remove('d-none');

        const gemini = result.gemini || {};
        const gradPrediction = gemini.graduation_prediction || {};

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏à‡∏ö/‡πÑ‡∏°‡πà‡∏à‡∏ö
        const willGraduate = gradPrediction.will_graduate || (gemini.outcome_summary?.status === 'graduated');
        const predictionText = gradPrediction.prediction_text || gemini.prediction || (willGraduate ? '‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö' : '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö');

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Outcome Label ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
        const outcomeLabel = document.getElementById('geminiOutcomeLabel');
        if (outcomeLabel) {
            outcomeLabel.innerHTML = willGraduate
                ? `<span class="text-success">üéì ${predictionText}</span>`
                : `<span class="text-danger">‚ö†Ô∏è ${predictionText}</span>`;
            outcomeLabel.parentElement.className = willGraduate ? 'badge bg-success' : 'badge bg-danger';
        }

        document.getElementById('geminiRiskLevel').textContent = gemini.risk_level || '-';

        const metricsDiv = document.getElementById('geminiKeyMetrics');
        const confidence = gradPrediction.confidence_percent || gemini.confidence || gemini.outcome_summary?.confidence * 100 || 0;

        metricsDiv.innerHTML = `
        <div class="gemini-metric">
            <div class="value" style="color: ${willGraduate ? '#10b981' : '#ef4444'};">
                ${willGraduate ? 'üéì' : '‚ö†Ô∏è'}
            </div>
            <div class="label">${willGraduate ? '‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏ö' : '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö'}</div>
        </div>
        <div class="gemini-metric">
            <div class="value">${(gemini.estimated_gpa || result.analysis?.estimated_gpa || 0).toFixed(2)}</div>
            <div class="label">GPA ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>
        </div>
        <div class="gemini-metric">
            <div class="value">${confidence.toFixed(0)}%</div>
            <div class="label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à</div>
        </div>
        <div class="gemini-metric">
            <div class="value">${gemini.risk_level || '-'}</div>
            <div class="label">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
        </div>
    `;

        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏ö/‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏à‡∏≤‡∏Å Gemini
        let graduationReasonHtml = '';
        if (willGraduate) {
            const reasonWhy = gradPrediction.reason_why_graduate || gemini.outcome_summary?.description || '';
            if (reasonWhy) {
                graduationReasonHtml = `
                <div class="p-3 rounded mb-3" style="background: rgba(16,185,129,0.2); border-left: 4px solid #10b981;">
                    <h6 class="text-success mb-2"><i class="bi bi-check-circle-fill me-1"></i> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö:</h6>
                    <p class="mb-0 text-light">${reasonWhy}</p>
                </div>
            `;
            }
        } else {
            const reasonWhyNot = gradPrediction.reason_why_not_graduate || gemini.outcome_summary?.description || '';
            if (reasonWhyNot) {
                graduationReasonHtml = `
                <div class="p-3 rounded mb-3" style="background: rgba(239,68,68,0.2); border-left: 4px solid #ef4444;">
                    <h6 class="text-danger mb-2"><i class="bi bi-exclamation-triangle-fill me-1"></i> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö:</h6>
                    <p class="mb-0 text-light">${reasonWhyNot}</p>
                </div>
            `;
            }
        }

        const mkDiv = document.getElementById('geminiMarkdownResult');
        let markdownContent = '';

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏ö/‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏Å‡πà‡∏≠‡∏ô
        if (graduationReasonHtml) {
            markdownContent += graduationReasonHtml;
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Analysis Markdown
        if (gemini.analysis_markdown) {
            const parsedMarkdown = typeof marked !== 'undefined' ? marked.parse(gemini.analysis_markdown) : gemini.analysis_markdown.replace(/\n/g, '<br>');
            markdownContent += `<div class="mt-2">${parsedMarkdown}</div>`;
        }

        mkDiv.innerHTML = markdownContent || '<p class="text-muted mb-0">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>';

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
        if (gemini.recommendations?.length > 0) {
            const recsContainer = document.getElementById('geminiRecommendationsContainer');
            const recsList = document.getElementById('geminiRecommendationsList');
            recsContainer.style.display = 'block';
            recsList.innerHTML = gemini.recommendations.map(r => `
            <li class="mb-2 d-flex align-items-start">
                <i class="bi bi-lightbulb-fill text-warning me-2 mt-1"></i>
                <span>${r}</span>
            </li>
        `).join('');
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Graduation Summary Section
        const gradSummary = document.getElementById('geminiGraduationSummary');
        const gradPredText = document.getElementById('geminiGradPredText');
        const gradPredDetail = document.getElementById('geminiGradPredDetail');

        if (gradSummary && gradPredText && gradPredDetail) {
            if (willGraduate) {
                gradSummary.style.background = 'rgba(16,185,129,0.2)';
                gradSummary.style.borderColor = '#10b981';
                gradPredText.innerHTML = '<i class="bi bi-mortarboard-fill me-2"></i>üéì ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
                gradPredText.style.color = '#10b981';
            } else {
                gradSummary.style.background = 'rgba(239,68,68,0.2)';
                gradSummary.style.borderColor = '#ef4444';
                gradPredText.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>‚ö†Ô∏è ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
                gradPredText.style.color = '#ef4444';
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
            const reasonDetail = willGraduate
                ? (gradPrediction.reason_why_graduate || gemini.outcome_summary?.description || '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ')
                : (gradPrediction.reason_why_not_graduate || gemini.outcome_summary?.description || '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
            gradPredDetail.textContent = reasonDetail;
        }

        // Scroll ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        setTimeout(() => {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }

    function clearGeminiResult() {
        document.getElementById('geminiResultCard').classList.add('d-none');
    }

    // ===== Gemini File Analysis =====
    async function analyzeCsvWithGemini() {
        const fileInput = document.getElementById('geminiCsvInput');
        if (!fileInput.files.length) {
            showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const goalInput = document.getElementById('geminiFileGoalInput');
        if (goalInput?.value.trim()) {
            formData.append('analysis_goal', goalInput.value.trim());
        }

        const loadingDiv = document.getElementById('geminiLoadingState');
        loadingDiv.classList.remove('d-none');

        try {
            const response = await fetch('/api/gemini/analyze_file', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                displayGeminiResult(result);
                showAlert('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
                showAlert(result.error, 'danger');
            }
        } catch (error) {
            showAlert(error.message, 'danger');
        } finally {
            loadingDiv.classList.add('d-none');
        }
    }

    async function analyzeLiveGradesWithGemini() {
        await analyzeWithGemini(
            document.getElementById('studentName').value,
            document.getElementById('modelSelect').value
        );
    }

    // ===== Modals =====
    function openFutureCoursesModal() {
        const content = document.getElementById('futureCoursesContent');
        let courseIds = [];

        for (let i = loadedTermsCount; i < allTermsData.length; i++) {
            courseIds.push(...allTermsData[i].ids);
        }

        if (courseIds.length === 0) {
            content.innerHTML = '<p class="text-muted text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
        } else {
            content.innerHTML = '<div class="row g-3">' + courseIds.map(id => {
                const course = coursesData.find(c => c.id === id);
                if (!course) return '';
                return `
                <div class="col-md-6">
                    <div class="form-check p-3 border rounded bg-light">
                        <input class="form-check-input" type="checkbox" value="${course.id}" id="future-${course.id}">
                        <label class="form-check-label w-100" for="future-${course.id}">
                            <div class="fw-bold">${course.thaiName}</div>
                            <small class="text-muted">${course.id} (${course.credit} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï)</small>
                        </label>
                    </div>
                </div>
            `;
            }).join('') + '</div>';
        }

        new bootstrap.Modal(document.getElementById('futureCoursesModal')).show();
    }

    function addSelectedFutureCourses() {
        const checkboxes = document.querySelectorAll('#futureCoursesContent input:checked');
        if (checkboxes.length === 0) return;

        if (loadedTermsCount === 0) {
            showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            return;
        }

        const grid = document.querySelector(`#term-${loadedTermsCount} .course-grid`);
        if (!grid) return;

        checkboxes.forEach(cb => {
            const course = coursesData.find(c => c.id === cb.value);
            if (course) {
                const temp = document.createElement('div');
                temp.innerHTML = createCourseCardHtml(course, true);
                grid.appendChild(temp.firstElementChild);
            }
        });

        bootstrap.Modal.getInstance(document.getElementById('futureCoursesModal')).hide();
        updateLiveStats();
        updatePrerequisites();
    }

    // ===== UI Helpers =====
    function showCustomLoadingModal(text) {
        document.getElementById('customLoadingText').textContent = text;
        document.getElementById('customLoadingModal').classList.add('show');
    }

    function hideCustomLoadingModal() {
        document.getElementById('customLoadingModal').classList.remove('show');
    }

    // showAlert ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å base.html (toast notification system)

    // ===== Export Functions =====
    function exportResults(format) {
        const studentName = document.getElementById('studentName').value || '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
        const gpa = document.getElementById('statGPA').textContent;
        const credits = document.getElementById('statCredits').textContent;

        let csvContent = 'data:text/csv;charset=utf-8,';
        csvContent += '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå\n\n';
        csvContent += `‡∏ä‡∏∑‡πà‡∏≠,${studentName}\n`;
        csvContent += `GPA,${gpa}\n`;
        csvContent += `‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï,${credits}\n\n`;
        csvContent += '‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤,‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤,‡πÄ‡∏Å‡∏£‡∏î\n';

        Object.entries(courseGrades).forEach(([id, grade]) => {
            const course = coursesData.find(c => c.id === id);
            if (course && grade) {
                csvContent += `${id},${course.thaiName},${grade}\n`;
            }
        });

        const link = document.createElement('a');
        link.setAttribute('href', encodeURI(csvContent));
        link.setAttribute('download', `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_${studentName}_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showAlert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function printResults() {
        const resultsSection = document.getElementById('resultsSection');
        if (resultsSection.classList.contains('d-none')) {
            showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå', 'warning');
            return;
        }

        const studentName = document.getElementById('studentName').value || '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
        const gpa = document.getElementById('statGPA').textContent;
        const credits = document.getElementById('statCredits').textContent;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô - ${studentName}</title>
            <style>
                body { font-family: 'Sarabun', sans-serif; padding: 40px; }
                h1 { color: #4f46e5; }
                .stat { display: inline-block; margin-right: 30px; }
                .stat-value { font-size: 24px; font-weight: bold; color: #4f46e5; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                th { background: #4f46e5; color: white; }
            </style>
        </head>
        <body>
            <h1>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h1>
            <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${studentName}</p>
            <div class="stat"><span class="stat-value">${gpa}</span><br>GPA</div>
            <div class="stat"><span class="stat-value">${credits}</span><br>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</div>
            <table>
                <tr><th>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</th><th>‡πÄ‡∏Å‡∏£‡∏î</th></tr>
                ${Object.entries(courseGrades).map(([id, grade]) => {
            const c = coursesData.find(x => x.id === id);
            return c && grade ? `<tr><td>${id}</td><td>${c.thaiName}</td><td>${grade}</td></tr>` : '';
        }).join('')}
            </table>
            <p style="margin-top: 30px; color: #999;">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date().toLocaleString('th-TH')}</p>
        </body>
        </html>
    `);
        printWindow.document.close();
        setTimeout(() => { printWindow.focus(); printWindow.print(); }, 500);
    }
</script>
{% endblock %}