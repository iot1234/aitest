{% extends "base.html" %}

{% block title %}‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• - {{ super() }}{% endblock %}

{% block custom_css %}
<style>
    /* Enhanced Styles */
    .main-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .header-section {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .control-panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .term-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .term-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        margin: -20px -20px 20px -20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .term-header.locked {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    .course-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
    }

    .course-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
        position: relative;
    }

    .course-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .course-card.locked {
        background: #fff5f5;
        border-left-color: #dc3545;
        opacity: 0.9;
    }

    .course-card.future {
        background: #e8f4f8;
        border-left-color: #17a2b8;
    }

    .course-card.repeated {
        background: #fff9e6;
        border-left-color: #ffc107;
    }

    .grade-select {
        width: 100%;
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 0.95rem;
        margin-top: 10px;
    }

    .grade-select:focus {
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .grade-select:disabled {
        background-color: #f1f1f1;
        cursor: not-allowed;
    }

    .stats-dashboard {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .stat-card {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 5px;
    }

    .progress-bar-container {
        background: #e9ecef;
        border-radius: 10px;
        height: 30px;
        overflow: hidden;
        margin: 20px 0;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        transition: width 0.5s ease;
    }

    .results-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-top: 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .prediction-badge {
        display: inline-block;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 1.3rem;
        font-weight: 600;
        margin: 10px 5px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .prediction-badge.pass {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .prediction-badge.fail {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        color: white;
    }

    .ai-prediction-section {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
        border: 2px solid rgba(102, 126, 234, 0.3);
    }

    .confidence-meter {
        background: #e9ecef;
        border-radius: 10px;
        height: 25px;
        overflow: hidden;
        margin: 10px 0;
    }

    .confidence-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .recommendation-card {
        background: #f8f9fa;
        border-left: 4px solid;
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
    }

    .recommendation-card.urgent {
        border-left-color: #dc3545;
        background: #fff5f5;
    }

    .recommendation-card.warning {
        border-left-color: #ffc107;
        background: #fff9e6;
    }

    .recommendation-card.success {
        border-left-color: #28a745;
        background: #f0fff4;
    }

    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-top: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .quick-action-btn {
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s;
        border: none;
        margin: 5px;
    }

    .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .prerequisite-warning {
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.3);
        border-radius: 5px;
        padding: 8px;
        margin-top: 5px;
        font-size: 0.8rem;
        color: #721c24;
    }

    .ai-model-status {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .model-accuracy {
        font-size: 1.1rem;
        font-weight: 600;
        color: #667eea;
    }

    .no-model-warning {
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.3);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
    }

    .risk-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .risk-low { background: #d4edda; color: #155724; }
    .risk-medium { background: #fff3cd; color: #856404; }
    .risk-high { background: #f8d7da; color: #721c24; }

    @media (max-width: 768px) {
        .course-grid {
            grid-template-columns: 1fr;
        }
        .stat-value {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div id="alertContainer"></div>
    
    <div class="header-section text-white text-center">
        <h1 class="display-4 fw-bold mb-3">
            <i class="bi bi-robot"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏î‡πâ‡∏ß‡∏¢ AI
        </h1>
        <p class="lead">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</p>
    </div>

    <!-- AI Model Status -->
    <div id="aiModelStatus" class="ai-model-status d-none">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h6 class="mb-1">ü§ñ ‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h6>
                <div id="selectedModelInfo" class="model-accuracy"></div>
            </div>
            <div class="text-end">
                <span class="badge bg-success">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            </div>
        </div>
    </div>

    <!-- No Model Warning -->
    <div id="noModelWarning" class="no-model-warning d-none">
        <h5 class="text-danger mb-3">
            <i class="bi bi-exclamation-triangle-fill"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• AI
        </h5>
        <p class="mb-3">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary">
            <i class="bi bi-cpu-fill"></i> ‡πÑ‡∏õ‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• AI
        </a>
    </div>

    <div class="control-panel">
        <div class="row">
            <div class="col-md-4">
                <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" class="form-control" id="studentName" 
                       placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" value="‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö">
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                <input type="text" class="form-control" id="studentId" 
                       placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</label>
                <select class="form-select" id="modelSelect">
                    <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...</option>
                </select>
            </div>
        </div>
        
        <div class="mt-3 text-center">
            <button class="quick-action-btn btn-primary" id="loadAllTermsBtn">
                <i class="bi bi-lightning-fill"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏≠‡∏°
            </button>
            <button class="quick-action-btn btn-success" id="fillSampleGradesBtn">
                <i class="bi bi-magic"></i> ‡πÉ‡∏™‡πà‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
            </button>
            <button class="quick-action-btn btn-warning" id="clearAllGradesBtn">
                <i class="bi bi-eraser-fill"></i> ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏£‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
            <button class="quick-action-btn btn-info" id="saveCurrentStateBtn">
                <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            </button>
        </div>
    </div>

    <div class="stats-dashboard">
        <h5 class="mb-3"><i class="bi bi-speedometer2"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö Real-time</h5>
        <div class="row">
            <div class="col-md-2 col-sm-4 col-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="statGPA">0.00</div>
                    <div class="stat-label">GPA</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 col-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="statCredits">0</div>
                    <div class="stat-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 col-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="statPassed">0</div>
                    <div class="stat-label">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 col-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="statFailed">0</div>
                    <div class="stat-label">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 col-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="statBlocked">0</div>
                    <div class="stat-label">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 col-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="statProgress">0%</div>
                    <div class="stat-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
                </div>
            </div>
        </div>
        
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="mainProgressBar" style="width: 0%">
                0% ‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
            </div>
        </div>
    </div>

    <div id="termsContainer"></div>

    <div class="text-center my-4">
        <button class="quick-action-btn btn-primary btn-lg" id="loadNextTermBtn">
            <i class="bi bi-plus-circle"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        </button>
        <button class="quick-action-btn btn-info btn-lg" id="openFutureCoursesModalBtn">
            <i class="bi bi-calendar-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
        </button>
        <button class="quick-action-btn btn-warning btn-lg" id="openFailedCoursesModalBtn">
            <i class="bi bi-arrow-repeat"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥
        </button>
        <button class="quick-action-btn btn-success btn-lg" id="analyzeAndPredictBtn" disabled>
            <i class="bi bi-robot"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ AI
        </button>
    </div>

    <div class="results-section d-none" id="resultsSection">
        <h3 class="text-center mb-4">
            <i class="bi bi-robot"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ AI
        </h3>
        
        <!-- AI Prediction Section -->
        <div class="ai-prediction-section" id="aiPredictionSection">
            <div class="text-center mb-4" id="mainPrediction">
                <!-- AI prediction results will be inserted here -->
            </div>
            
            <div class="row" id="aiDetailsRow">
                <div class="col-md-6">
                    <h6 class="fw-bold mb-3">üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô</h6>
                    <div id="probabilityBars">
                        <!-- Probability bars will be inserted here -->
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-bold mb-3">üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á AI</h6>
                    <div id="confidenceDetails">
                        <!-- Confidence details will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-graph-up"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </div>
                    <div class="card-body" id="studyStatus">
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-gear"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏°‡πÄ‡∏î‡∏• AI
                    </div>
                    <div class="card-body" id="modelInfo">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-danger text-white">
                        <i class="bi bi-x-circle"></i> ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                    </div>
                    <div class="card-body" id="problemCourses">
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-lock"></i> ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å
                    </div>
                    <div class="card-body" id="blockedCoursesDetail">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <i class="bi bi-lightbulb"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI
            </div>
            <div class="card-body" id="personalRecommendations">
            </div>
        </div>
        
        <div class="chart-container">
            <h5 class="mb-3"><i class="bi bi-graph-up"></i> ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h5>
            <div class="row">
                <div class="col-md-6">
                    <canvas id="gpaChart"></canvas>
                </div>
                <div class="col-md-6">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <button class="btn btn-outline-primary" id="exportPdfBtn">
                <i class="bi bi-file-pdf"></i> Export PDF
            </button>
            <button class="btn btn-outline-success" id="exportExcelBtn">
                <i class="bi bi-file-excel"></i> Export Excel
            </button>
            <button class="btn btn-outline-info" id="printResultsBtn">
                <i class="bi bi-printer"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏•
            </button>
        </div>
    </div>
</div>

<!-- Modals (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
<div class="modal fade" id="futureCoursesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="futureCoursesContent">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" id="addFutureCoursesBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="failedCoursesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="failedCoursesContent">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" id="addFailedCoursesBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <h5 id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h5>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Backend
let coursesData = {{ coursesData|safe }};
let allTermsData = {{ allTermsData|safe }};
let gradeMapping = {{ gradeMapping|safe }};

// State Management
let loadedTermsCount = 0;
let courseGrades = {};
let charts = {};
let selectedModel = null;

// Grade mapping for JavaScript
const GRADE_MAPPING = {
    'A': 4.0, 'B+': 3.5, 'B': 3.0, 'C+': 2.5, 'C': 2.0,
    'D+': 1.5, 'D': 1.0, 'F': 0.0, 'W': 0.0, 'I': 0.0,
    'WF': 0.0, 'WU': 0.0, 'AU': 0.0, 'P': 2.0, 'NP': 0.0
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing AI Prediction System...');
    initializeApp();
});

async function initializeApp() {
    try {
        if (!coursesData || !allTermsData || !gradeMapping) {
            console.error('‚ùå Missing curriculum data');
            showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÑ‡∏î‡πâ', 'danger');
            return;
        }
        
        showLoadingModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• AI...');
        await loadAIModels();
        setupEventListeners();
        updateLiveStats();
        hideLoadingModal();
        
        if (selectedModel) {
            showAlert('ü§ñ ‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!', 'success');
        }
    } catch (error) {
        console.error('‚ùå Initialization error:', error);
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'danger');
        hideLoadingModal();
    }
}

async function loadAIModels() {
    try {
        console.log('üîç Loading AI models...');
        const response = await fetch('/api/models');
        const data = await response.json();
        const modelSelect = document.getElementById('modelSelect');
        
        if (data.success && data.models.length > 0) {
            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏• subject_based ‡∏ó‡∏µ‡πà‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
            const aiModels = data.models.filter(m => 
                m.data_format === 'subject_based' && 
                m.performance && 
                m.performance.accuracy > 0
            );
            
            if (aiModels.length > 0) {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
                aiModels.sort((a, b) => (b.performance.accuracy || 0) - (a.performance.accuracy || 0));
                
                modelSelect.innerHTML = '';
                aiModels.forEach((model, index) => {
                    const accuracy = (model.performance.accuracy * 100).toFixed(1);
                    const option = document.createElement('option');
                    option.value = model.filename;
                    option.textContent = `${model.filename} (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${accuracy}%)`;
                    if (index === 0) option.selected = true; // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                    modelSelect.appendChild(option);
                });
                
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏£‡∏Å
                selectedModel = aiModels[0];
                updateModelStatus(selectedModel);
                document.getElementById('analyzeAndPredictBtn').disabled = false;
                
                console.log(`‚úÖ Loaded ${aiModels.length} AI models, selected: ${selectedModel.filename}`);
            } else {
                showNoModelWarning();
            }
        } else {
            showNoModelWarning();
        }
        
        // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•
        modelSelect.addEventListener('change', function() {
            const selectedFilename = this.value;
            const model = data.models.find(m => m.filename === selectedFilename);
            if (model) {
                selectedModel = model;
                updateModelStatus(model);
            }
        });
        
    } catch (error) {
        console.error('‚ùå Error loading AI models:', error);
        showNoModelWarning();
    }
}

function updateModelStatus(model) {
    const statusDiv = document.getElementById('aiModelStatus');
    const infoDiv = document.getElementById('selectedModelInfo');
    const noModelDiv = document.getElementById('noModelWarning');
    
    if (model && model.performance) {
        statusDiv.classList.remove('d-none');
        noModelDiv.classList.add('d-none');
        
        const accuracy = (model.performance.accuracy * 100).toFixed(1);
        const trainingType = model.training_type || 'standard';
        
        infoDiv.innerHTML = `
            <strong>${model.filename}</strong><br>
            <span class="text-muted">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${accuracy}% | ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${trainingType}</span>
        `;
    } else {
        statusDiv.classList.add('d-none');
        noModelDiv.classList.remove('d-none');
    }
}

function showNoModelWarning() {
    document.getElementById('aiModelStatus').classList.add('d-none');
    document.getElementById('noModelWarning').classList.remove('d-none');
    document.getElementById('analyzeAndPredictBtn').disabled = true;
    document.getElementById('modelSelect').innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• AI</option>';
    console.log('‚ö†Ô∏è No AI models found');
}

function setupEventListeners() {
    document.getElementById('loadNextTermBtn').addEventListener('click', loadNextTerm);
    document.getElementById('loadAllTermsBtn').addEventListener('click', loadAllTerms);
    document.getElementById('fillSampleGradesBtn').addEventListener('click', fillSampleGrades);
    document.getElementById('clearAllGradesBtn').addEventListener('click', clearAllGrades);
    document.getElementById('saveCurrentStateBtn').addEventListener('click', saveCurrentState);
    document.getElementById('analyzeAndPredictBtn').addEventListener('click', analyzeWithAI);
    
    document.getElementById('openFutureCoursesModalBtn').addEventListener('click', openFutureCoursesModal);
    document.getElementById('addFutureCoursesBtn').addEventListener('click', addSelectedFutureCourses);
    document.getElementById('openFailedCoursesModalBtn').addEventListener('click', openFailedCoursesModal);
    document.getElementById('addFailedCoursesBtn').addEventListener('click', addSelectedFailedCourses);

    // Export buttons
    if (document.getElementById('exportPdfBtn')) {
        document.getElementById('exportPdfBtn').addEventListener('click', () => exportResults('pdf'));
    }
    if (document.getElementById('exportExcelBtn')) {
        document.getElementById('exportExcelBtn').addEventListener('click', () => exportResults('excel'));
    }
    if (document.getElementById('printResultsBtn')) {
        document.getElementById('printResultsBtn').addEventListener('click', printResults);
    }

    // Grade change listener
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('grade-select')) {
            const courseId = e.target.dataset.courseId;
            courseGrades[courseId] = e.target.value;
            updateLiveStats();
            updatePrerequisites();
        }
    });
}

// Load Terms Functions (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
function loadNextTerm() {
    if (loadedTermsCount >= allTermsData.length) {
        showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß', 'warning');
        return;
    }
    
    lockPreviousTerms();
    const termData = allTermsData[loadedTermsCount];
    loadedTermsCount++;
    
    createTermSection(termData, loadedTermsCount);
    updateLoadedTermsInfo();
    updateLiveStats();
    updatePrerequisites();
}

function loadAllTerms() {
    const container = document.getElementById('termsContainer');
    container.innerHTML = '';
    loadedTermsCount = 0;
    while (loadedTermsCount < allTermsData.length) {
        loadNextTerm();
    }
}

function createTermSection(termData, termNumber) {
    const container = document.getElementById('termsContainer');
    const section = document.createElement('div');
    section.className = 'term-section';
    section.id = `term-${termNumber}`;
    
    let html = `
        <div class="term-header">
            <h5 class="mb-0">‡∏õ‡∏µ ${termData.year} ‡πÄ‡∏ó‡∏≠‡∏° ${termData.term}</h5>
            <span class="badge bg-light text-dark">${termData.ids.length} ‡∏ß‡∏¥‡∏ä‡∏≤</span>
        </div>
        <div class="course-grid">
    `;
    
    termData.ids.forEach(courseId => {
        const course = coursesData.find(c => c.id === courseId);
        if (course) {
            html += createCourseCardHtml(course);
        }
    });
    
    html += '</div>';
    section.innerHTML = html;
    container.appendChild(section);
}

function createCourseCardHtml(course, isFuture = false, isRepeated = false) {
    const prereqText = course.prereq.length > 0 
        ? course.prereq.map(p => {
            const prereqCourse = coursesData.find(c => c.id === p);
            return prereqCourse ? prereqCourse.thaiName : p;
        }).join(', ')
        : '‡πÑ‡∏°‡πà‡∏°‡∏µ';
    
    let classNames = 'course-card';
    if (isFuture) classNames += ' future';
    if (isRepeated) classNames += ' repeated';
    
    return `
        <div class="${classNames}" data-course-id="${course.id}">
            <div class="course-header d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h6 class="course-name fw-bold mb-1">${course.thaiName}</h6>
                    <small class="text-muted d-block">${course.id}</small>
                    <small class="text-primary">${course.credit} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</small>
                </div>
            </div>
            
            <div class="prerequisite-info mb-2">
                <small class="text-muted">
                    <i class="bi bi-link-45deg"></i> ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ${prereqText}
                </small>
            </div>
            
            <select class="grade-select form-select" data-course-id="${course.id}">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏£‡∏î --</option>
                ${Object.keys(gradeMapping).map(grade => 
                    `<option value="${grade}">${grade}</option>`
                ).join('')}
            </select>
        </div>
    `;
}

// AI Analysis Function
async function analyzeWithAI() {
    if (!selectedModel) {
        showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡πà‡∏≠‡∏ô', 'danger');
        return;
    }
    
    if (Object.keys(courseGrades).length === 0) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏Å‡∏£‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏¥‡∏ä‡∏≤', 'warning');
        return;
    }

    showLoadingModal('ü§ñ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏ß‡∏¢ AI...');
    const studentName = document.getElementById('studentName').value || '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
    
    try {
        console.log(`üéØ Making AI prediction with model: ${selectedModel.filename}`);
        
        const response = await fetch('/api/analyze_curriculum', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                student_name: studentName,
                current_grades: courseGrades,
                loaded_terms_count: loadedTermsCount,
                repeated_courses_in_this_term_ids: [],
                model_filename: selectedModel.filename
            })
        });
        
        const result = await response.json();
        hideLoadingModal();
        
        if (result.success) {
            if (result.prediction_result) {
                displayAIResults(performAnalysis(), result);
                showAlert('üéâ AI ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'success');
            } else {
                showAlert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• AI', 'warning');
            }
        } else {
            showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        hideLoadingModal();
        console.error('‚ùå AI analysis error:', error);
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + error.message, 'danger');
    }
}

function displayAIResults(analysis, result) {
    const resultsSection = document.getElementById('resultsSection');
    resultsSection.classList.remove('d-none');
    
    const predResult = result.prediction_result;
    
    // Main Prediction
    const mainPrediction = document.getElementById('mainPrediction');
    const predictionClass = predResult.prediction === '‡∏à‡∏ö' ? 'pass' : 'fail';
    const predictionIcon = predResult.prediction === '‡∏à‡∏ö' ? 'üéì' : '‚ö†Ô∏è';
    
    mainPrediction.innerHTML = `
        <div class="prediction-badge ${predictionClass}">
            ${predictionIcon} AI ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢: ${predResult.prediction}
        </div>
        <div class="mt-3">
            <strong>GPA:</strong> ${analysis.gpa.toFixed(2)} | 
            <strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤:</strong> ${analysis.completionRate.toFixed(0)}%
        </div>
        <div class="mt-2">
            <span class="risk-badge risk-${predResult.risk_level === '‡∏ï‡πà‡∏≥' ? 'low' : predResult.risk_level === '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' ? 'medium' : 'high'}">
                ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: ${predResult.risk_level}
            </span>
        </div>
    `;
    
    // Probability Bars
    const probabilityBars = document.getElementById('probabilityBars');
    probabilityBars.innerHTML = `
        <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
                <span>üéì ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>
                <span class="fw-bold">${(predResult.prob_pass * 100).toFixed(1)}%</span>
            </div>
            <div class="confidence-meter">
                <div class="confidence-fill" style="width: ${predResult.prob_pass * 100}%; background: linear-gradient(90deg, #28a745, #20c997);">
                    ${(predResult.prob_pass * 100).toFixed(1)}%
                </div>
            </div>
        </div>
        <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
                <span>‚ö†Ô∏è ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏°‡πà‡∏à‡∏ö</span>
                <span class="fw-bold">${(predResult.prob_fail * 100).toFixed(1)}%</span>
            </div>
            <div class="confidence-meter">
                <div class="confidence-fill" style="width: ${predResult.prob_fail * 100}%; background: linear-gradient(90deg, #dc3545, #e83e8c);">
                    ${(predResult.prob_fail * 100).toFixed(1)}%
                </div>
            </div>
        </div>
    `;
    
    // Confidence Details
    const confidenceDetails = document.getElementById('confidenceDetails');
    const confidencePercent = (predResult.confidence * 100).toFixed(1);
    const confidenceColor = predResult.confidence > 0.8 ? 'success' : predResult.confidence > 0.6 ? 'warning' : 'danger';
    
    confidenceDetails.innerHTML = `
        <div class="text-center">
            <div class="display-6 text-${confidenceColor} fw-bold">${confidencePercent}%</div>
            <small class="text-muted">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á AI</small>
        </div>
        <div class="mt-3">
            <div class="confidence-meter">
                <div class="confidence-fill bg-${confidenceColor}" style="width: ${confidencePercent}%;">
                    ${confidencePercent}%
                </div>
            </div>
        </div>
        <div class="mt-2 text-center">
            <small class="text-muted">
                ${predResult.confidence > 0.8 ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏™‡∏π‡∏á' : 
                  predResult.confidence > 0.6 ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏ï‡πà‡∏≥'}
            </small>
        </div>
    `;
    
    // Study Status
    const studyStatus = document.getElementById('studyStatus');
    studyStatus.innerHTML = `
        <p><strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô:</strong> ${analysis.passedCredits}/${analysis.totalCredits}</p>
        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å:</strong> ${analysis.failedCourses.length}</p>
        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å:</strong> ${analysis.blockedCourses.length}</p>
        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ GPA:</strong> ${analysis.gpa >= 2.0 ? 
            '<span class="text-success">‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span>' : 
            '<span class="text-danger">‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span>'}</p>
    `;
    
    // Model Info
    const modelInfo = document.getElementById('modelInfo');
    modelInfo.innerHTML = `
        <p><strong>‡πÇ‡∏°‡πÄ‡∏î‡∏• AI:</strong> ${selectedModel.filename}</p>
        <p><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥:</strong> ${(selectedModel.performance.accuracy * 100).toFixed(1)}%</p>
        <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${predResult.training_type || 'standard'}</p>
        <p><strong>Sub-models ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</strong> ${predResult.models_used || 1}</p>
        <div class="mt-2">
            <span class="badge bg-success">AI Powered</span>
        </div>
    `;
    
    // Problem Courses
    const problemCourses = document.getElementById('problemCourses');
    if (analysis.failedCourses.length > 0) {
        problemCourses.innerHTML = '<ul>' + 
            analysis.failedCourses.map(c => `<li>${c.thaiName} (${c.id})</li>`).join('') +
            '</ul>';
    } else {
        problemCourses.innerHTML = '<p class="text-success">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å</p>';
    }
    
    // Blocked Courses
    const blockedCoursesDetail = document.getElementById('blockedCoursesDetail');
    if (analysis.blockedCourses.length > 0) {
        blockedCoursesDetail.innerHTML = '<ul>' + 
            analysis.blockedCourses.slice(0, 5).map(c => `<li>${c.thaiName} (${c.id})</li>`).join('') +
            (analysis.blockedCourses.length > 5 ? `<li>‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${analysis.blockedCourses.length - 5} ‡∏ß‡∏¥‡∏ä‡∏≤...</li>` : '') +
            '</ul>';
    } else {
        blockedCoursesDetail.innerHTML = '<p class="text-success">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å</p>';
    }
    
    // AI-Enhanced Recommendations
    const recommendations = generateAIRecommendations(analysis, predResult);
    const personalRecommendations = document.getElementById('personalRecommendations');
    personalRecommendations.innerHTML = recommendations.map(rec => 
        `<div class="recommendation-card ${rec.type}">
            <i class="bi bi-${rec.icon}"></i> ${rec.text}
        </div>`
    ).join('');
    
    drawCharts(analysis);
    resultsSection.scrollIntoView({ behavior: 'smooth' });
}

function generateAIRecommendations(analysis, predResult) {
    const recommendations = [];
    
    // AI-based recommendations
    if (predResult.risk_level === '‡∏™‡∏π‡∏á') {
        recommendations.push({
            type: 'urgent',
            icon: 'robot',
            text: `ü§ñ AI ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á (${(predResult.confidence * 100).toFixed(1)}% ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô) - ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô`
        });
    } else if (predResult.risk_level === '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á') {
        recommendations.push({
            type: 'warning',
            icon: 'robot',
            text: `ü§ñ AI ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á - ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô`
        });
    } else {
        recommendations.push({
            type: 'success',
            icon: 'robot',
            text: `ü§ñ AI ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏µ ‡∏Ñ‡∏ß‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°`
        });
    }
    
    // Traditional recommendations
    if (analysis.gpa < 2.0) {
        recommendations.push({
            type: 'urgent',
            icon: 'exclamation-triangle',
            text: 'GPA ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 2.0 ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô - ‡∏•‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡πà‡∏≥'
        });
    }
    
    if (analysis.failedCourses.length > 0) {
        recommendations.push({
            type: 'urgent',
            icon: 'arrow-repeat',
            text: `‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥ ${analysis.failedCourses.length} ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å`
        });
    }
    
    if (analysis.blockedCourses.length > 0) {
        recommendations.push({
            type: 'warning',
            icon: 'lock',
            text: `‡∏°‡∏µ ${analysis.blockedCourses.length} ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÑ‡∏î‡πâ - ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô prerequisite ‡∏Å‡πà‡∏≠‡∏ô`
        });
    }
    
    // Positive reinforcement if doing well
    if (predResult.prediction === '‡∏à‡∏ö' && predResult.confidence > 0.8) {
        recommendations.push({
            type: 'success',
            icon: 'trophy',
            text: 'üèÜ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏ß‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'
        });
    }
    
    return recommendations;
}

// Update Functions (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)
function updateLiveStats() {
    let totalPoints = 0;
    let totalCredits = 0;
    let passedCredits = 0;
    let passedCount = 0;
    let failedCount = 0;
    
    Object.entries(courseGrades).forEach(([courseId, grade]) => {
        if (grade) {
            const course = coursesData.find(c => c.id === courseId);
            if (course) {
                const gradePoint = gradeMapping[grade] || 0;
                totalPoints += gradePoint * course.credit;
                totalCredits += course.credit;
                
                if (gradePoint > 0) {
                    passedCredits += course.credit;
                    passedCount++;
                } else {
                    failedCount++;
                }
            }
        }
    });
    
    const gpa = totalCredits > 0 ? totalPoints / totalCredits : 0;
    const totalRequiredCredits = coursesData.reduce((sum, c) => sum + c.credit, 0);
    const progress = (passedCredits / totalRequiredCredits) * 100;
    
    document.getElementById('statGPA').textContent = gpa.toFixed(2);
    document.getElementById('statCredits').textContent = passedCredits;
    document.getElementById('statPassed').textContent = passedCount;
    document.getElementById('statFailed').textContent = failedCount;
    document.getElementById('statProgress').textContent = progress.toFixed(0) + '%';
    
    const progressBar = document.getElementById('mainProgressBar');
    progressBar.style.width = progress + '%';
    progressBar.textContent = `${progress.toFixed(0)}% ‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£`;
    
    // Update progress bar color based on AI prediction if available
    if (progress < 50) {
        progressBar.style.background = 'linear-gradient(90deg, #dc3545 0%, #e83e8c 100%)';
    } else if (progress < 75) {
        progressBar.style.background = 'linear-gradient(90deg, #ffc107 0%, #fd7e14 100%)';
    } else {
        progressBar.style.background = 'linear-gradient(90deg, #28a745 0%, #20c997 100%)';
    }
    
    let blockedCount = 0;
    document.querySelectorAll('.course-card').forEach(card => {
        if (card.classList.contains('locked')) blockedCount++;
    });
    document.getElementById('statBlocked').textContent = blockedCount;
}

function updatePrerequisites() {
    const allSelects = document.querySelectorAll('.grade-select');
    
    allSelects.forEach(select => {
        const courseCard = select.closest('.course-card');
        const courseId = select.dataset.courseId;
        const course = coursesData.find(c => c.id === courseId);
        
        if (!course) return;
        
        const oldWarning = courseCard.querySelector('.prerequisite-warning');
        if (oldWarning) oldWarning.remove();
        
        let isBlocked = false;
        let unmetPrereqs = [];
        
        if (course.prereq && course.prereq.length > 0) {
            for (let prereqId of course.prereq) {
                const prereqGrade = courseGrades[prereqId];
                const prereqCourse = coursesData.find(c => c.id === prereqId);
                
                if (!prereqGrade || gradeMapping[prereqGrade] === 0) {
                    isBlocked = true;
                    unmetPrereqs.push(prereqCourse ? prereqCourse.thaiName : prereqId);
                }
            }
        }
        
        if (isBlocked && !courseGrades[courseId]) {
            courseCard.classList.add('locked');
            select.disabled = true;
            select.value = '';
            
            const warningDiv = document.createElement('div');
            warningDiv.className = 'prerequisite-warning alert alert-danger mt-2 p-2 small';
            warningDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>‡∏ß‡∏¥‡∏ä‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô ${unmetPrereqs.join(', ')} ‡∏Å‡πà‡∏≠‡∏ô
            `;
            courseCard.appendChild(warningDiv);
        } else {
            courseCard.classList.remove('locked');
            select.disabled = false;
        }
    });
    
    updateLiveStats();
}

// Analysis Function
function performAnalysis() {
    let totalPoints = 0;
    let totalCredits = 0;
    let passedCredits = 0;
    const failedCourses = [];
    const blockedCourses = [];
    const categoryGrades = {};
    
    Object.entries(courseGrades).forEach(([courseId, grade]) => {
        if (grade) {
            const course = coursesData.find(c => c.id === courseId);
            if (course) {
                const gradePoint = gradeMapping[grade] || 0;
                totalPoints += gradePoint * course.credit;
                totalCredits += course.credit;
                
                if (gradePoint > 0) {
                    passedCredits += course.credit;
                } else {
                    failedCourses.push(course);
                }
                
                const category = categorizeSubject(course.thaiName);
                if (!categoryGrades[category]) categoryGrades[category] = [];
                categoryGrades[category].push(gradePoint);
            }
        }
    });
    
    document.querySelectorAll('.course-card.locked').forEach(card => {
        const courseId = card.dataset.courseId;
        const course = coursesData.find(c => c.id === courseId);
        if (course) blockedCourses.push(course);
    });
    
    const gpa = totalCredits > 0 ? totalPoints / totalCredits : 0;
    const totalRequiredCredits = coursesData.reduce((sum, c) => sum + c.credit, 0);
    const completionRate = (passedCredits / totalRequiredCredits) * 100;
    
    return {
        gpa,
        passedCredits,
        totalCredits: totalRequiredCredits,
        completionRate,
        failedCourses,
        blockedCourses,
        categoryGrades
    };
}

function categorizeSubject(subjectName) {
    const categories = {
        '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå': ['‡∏Ñ‡∏ì‡∏¥‡∏ï', '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™', '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥'],
        '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå': ['‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå', '‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤'],
        '‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°': ['‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°', '‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'],
        '‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°': ['‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°', '‡∏ß‡∏á‡∏à‡∏£', '‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå'],
        '‡∏†‡∏≤‡∏©‡∏≤': ['‡∏†‡∏≤‡∏©‡∏≤', '‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', '‡πÑ‡∏ó‡∏¢', '‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£'],
        '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': ['‡∏™‡∏±‡∏á‡∏Ñ‡∏°', '‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°', '‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï']
    };
    
    for (const [category, keywords] of Object.entries(categories)) {
        if (keywords.some(kw => subjectName.includes(kw))) {
            return category;
        }
    }
    return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
}

// Sample Data Functions
function fillSampleGrades() {
    const grades = ['A', 'B+', 'B', 'C+', 'C', 'D+', 'D'];
    document.querySelectorAll('.grade-select').forEach((select) => {
        if (!select.disabled) {
            const randomGrade = grades[Math.floor(Math.random() * grades.length)];
            select.value = randomGrade;
            courseGrades[select.dataset.courseId] = randomGrade;
        }
    });
    updateLiveStats();
    updatePrerequisites();
    showAlert('‚úÖ ‡πÉ‡∏™‡πà‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
}

function clearAllGrades() {
    document.querySelectorAll('.grade-select').forEach(select => {
        select.value = '';
    });
    courseGrades = {};
    updateLiveStats();
    updatePrerequisites();
    showAlert('üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏£‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'info');
}

function saveCurrentState() {
    const state = {
        studentName: document.getElementById('studentName').value,
        studentId: document.getElementById('studentId').value,
        loadedTermsCount: loadedTermsCount,
        courseGrades: courseGrades,
        selectedModel: selectedModel ? selectedModel.filename : null,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem('aiStudentPredictionState', JSON.stringify(state));
    showAlert('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
}

// Chart Functions
function drawCharts(analysis) {
    const gpaCtx = document.getElementById('gpaChart')?.getContext('2d');
    if (gpaCtx) {
        if (charts.gpa) charts.gpa.destroy();
        
        const termGPAs = calculateTermGPAs();
        
        charts.gpa = new Chart(gpaCtx, {
            type: 'line',
            data: {
                labels: termGPAs.map(t => t.label),
                datasets: [{
                    label: 'GPA ‡∏£‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°',
                    data: termGPAs.map(t => t.gpa),
                    borderColor: 'rgb(102, 126, 234)',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.1,
                    fill: true
                }, {
                    label: '‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (2.0)',
                    data: Array(termGPAs.length).fill(2.0),
                    borderColor: 'rgb(255, 99, 132)',
                    borderDash: [5, 5],
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° GPA ‡∏£‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 4.0
                    }
                }
            }
        });
    }
    
    const categoryCtx = document.getElementById('categoryChart')?.getContext('2d');
    if (categoryCtx) {
        if (charts.category) charts.category.destroy();
        
        const categories = Object.keys(analysis.categoryGrades);
        const avgGrades = categories.map(cat => {
            const grades = analysis.categoryGrades[cat];
            return grades.length > 0 ? grades.reduce((a, b) => a + b) / grades.length : 0;
        });
        
        charts.category = new Chart(categoryCtx, {
            type: 'radar',
            data: {
                labels: categories,
                datasets: [{
                    label: '‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤',
                    data: avgGrades,
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgb(102, 126, 234)',
                    pointBackgroundColor: 'rgb(102, 126, 234)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },options: {
               responsive: true,
               plugins: {
                   title: {
                       display: true,
                       text: '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤'
                   }
               },
               scales: {
                   r: {
                       beginAtZero: true,
                       max: 4.0,
                       ticks: {
                           stepSize: 0.5
                       }
                   }
               }
           }
       });
   }
}

function calculateTermGPAs() {
   const termGPAs = [];
   
   for (let i = 0; i < loadedTermsCount; i++) {
       const termData = allTermsData[i];
       let totalPoints = 0;
       let totalCredits = 0;
       
       termData.ids.forEach(courseId => {
           const grade = courseGrades[courseId];
           if (grade) {
               const course = coursesData.find(c => c.id === courseId);
               if (course) {
                   const gradePoint = gradeMapping[grade] || 0;
                   totalPoints += gradePoint * course.credit;
                   totalCredits += course.credit;
               }
           }
       });
       
       const gpa = totalCredits > 0 ? totalPoints / totalCredits : 0;
       termGPAs.push({
           label: `‡∏õ‡∏µ ${termData.year} ‡πÄ‡∏ó‡∏≠‡∏° ${termData.term}`,
           gpa: gpa
       });
   }
   
   return termGPAs;
}

// Modal Functions
function openFutureCoursesModal() {
   const modal = new bootstrap.Modal(document.getElementById('futureCoursesModal'));
   renderCoursesInModal('future');
   modal.show();
}

function openFailedCoursesModal() {
   const modal = new bootstrap.Modal(document.getElementById('failedCoursesModal'));
   renderCoursesInModal('failed');
   modal.show();
}

function renderCoursesInModal(type) {
   const content = document.getElementById(`${type}CoursesContent`);
   content.innerHTML = '';
   
   let courseIds = [];
   if (type === 'future') {
       for (let i = loadedTermsCount; i < allTermsData.length; i++) {
           courseIds.push(...allTermsData[i].ids);
       }
   } else if (type === 'failed') {
       for (let i = 0; i < loadedTermsCount; i++) {
           allTermsData[i].ids.forEach(courseId => {
               const grade = courseGrades[courseId];
               if (grade && gradeMapping[grade] === 0) {
                   if (!courseIds.includes(courseId)) {
                       courseIds.push(courseId);
                   }
               }
           });
       }
   }
   
   if (courseIds.length === 0) {
       content.innerHTML = `<p class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>`;
       return;
   }
   
   let html = '<div class="row">';
   courseIds.forEach(courseId => {
       const course = coursesData.find(c => c.id === courseId);
       if (course) {
           const canTake = checkPrerequisites(course, courseGrades);
           const isDisabled = type === 'future' && !canTake;
           const originalGrade = type === 'failed' ? courseGrades[course.id] : '';

           html += `
               <div class="col-md-6 mb-2">
                   <div class="form-check ${isDisabled ? 'text-muted' : ''}">
                       <input class="form-check-input" type="checkbox" 
                              value="${course.id}" id="${type}-${course.id}"
                              ${isDisabled ? 'disabled' : ''}>
                       <label class="form-check-label" for="${type}-${course.id}">
                           ${course.thaiName} (${course.credit} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï)
                           ${isDisabled ? '<br><small class="text-danger">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô prerequisite</small>' : ''}
                           ${originalGrade ? `<br><small class="text-danger">‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏î‡∏¥‡∏°: ${originalGrade}</small>` : ''}
                       </label>
                   </div>
               </div>
           `;
       }
   });
   html += '</div>';
   content.innerHTML = html;
}

function addSelectedFutureCourses() {
   const checkboxes = document.querySelectorAll('#futureCoursesContent input:checked:not(:disabled)');
   
   if (checkboxes.length === 0) {
       showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏¥‡∏ä‡∏≤', 'warning');
       return;
   }
   
   if (loadedTermsCount === 0) {
       showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô', 'warning');
       return;
   }
   
   const currentTermGrid = document.querySelector(`#term-${loadedTermsCount} .course-grid`);
   if (!currentTermGrid) {
       showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤', 'warning');
       return;
   }
   
   let addedCount = 0;
   checkboxes.forEach(checkbox => {
       const courseId = checkbox.value;
       const course = coursesData.find(c => c.id === courseId);
       if (course) {
           const cardHtml = createCourseCardHtml(course, true, false);
           const tempDiv = document.createElement('div');
           tempDiv.innerHTML = cardHtml;
           currentTermGrid.appendChild(tempDiv.firstElementChild);
           addedCount++;
       }
   });
   
   if (addedCount > 0) {
       showAlert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ${addedCount} ‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
       updateLiveStats();
       updatePrerequisites();
   }
   
   const modal = bootstrap.Modal.getInstance(document.getElementById('futureCoursesModal'));
   if (modal) modal.hide();
}

function addSelectedFailedCourses() {
   const checkboxes = document.querySelectorAll('#failedCoursesContent input:checked:not(:disabled)');
   
   if (checkboxes.length === 0) {
       showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏¥‡∏ä‡∏≤', 'warning');
       return;
   }
   
   if (loadedTermsCount === 0) {
       showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô', 'warning');
       return;
   }
   
   const currentTermGrid = document.querySelector(`#term-${loadedTermsCount} .course-grid`);
   if (!currentTermGrid) {
       showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤', 'warning');
       return;
   }
   
   let addedCount = 0;
   checkboxes.forEach(checkbox => {
       const courseId = checkbox.value;
       const course = coursesData.find(c => c.id === courseId);
       if (course) {
           const cardHtml = createCourseCardHtml(course, false, true);
           const tempDiv = document.createElement('div');
           tempDiv.innerHTML = cardHtml;
           currentTermGrid.appendChild(tempDiv.firstElementChild);
           addedCount++;
       }
   });
   
   if (addedCount > 0) {
       showAlert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ${addedCount} ‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
       updateLiveStats();
       updatePrerequisites();
   }
   
   const modal = bootstrap.Modal.getInstance(document.getElementById('failedCoursesModal'));
   if (modal) modal.hide();
}

function checkPrerequisites(course, currentGrades) {
   if (!course.prereq || course.prereq.length === 0) {
       return true;
   }
   for (const prereqId of course.prereq) {
       const prereqGrade = currentGrades[prereqId];
       if (!prereqGrade || gradeMapping[prereqGrade] === 0) {
           return false;
       }
   }
   return true;
}

function removeCourse(courseId) {
   const card = document.querySelector(`.course-card[data-course-id="${courseId}"]`);
   if (card) card.remove();
   delete courseGrades[courseId];
   updateLiveStats();
   updatePrerequisites();
}

// Export Functions
function exportResults(format) {
   if (!selectedModel || !selectedModel.filename) {
       showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Export ‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏à‡∏≤‡∏Å AI', 'warning');
       return;
   }
   
   const analysis = performAnalysis();
   const exportData = {
       studentName: document.getElementById('studentName').value || '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤',
       timestamp: new Date().toLocaleString('th-TH'),
       modelUsed: selectedModel.filename,
       modelAccuracy: selectedModel.performance.accuracy,
       gpa: analysis.gpa,
       completionRate: analysis.completionRate,
       aiPrediction: document.getElementById('mainPrediction').textContent,
       grades: courseGrades,
       failedCourses: analysis.failedCourses.map(c => c.thaiName),
       blockedCourses: analysis.blockedCourses.map(c => c.thaiName)
   };
   
   if (format === 'pdf') {
       // PDF export would require additional library
       showAlert('üîÑ ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå Export PDF ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info');
   } else if (format === 'excel') {
       // Excel export would require additional library
       showAlert('üîÑ ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå Export Excel ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info');
   }
}

function printResults() {
   const printContent = document.getElementById('resultsSection').innerHTML;
   const printWindow = window.open('', '_blank');
   printWindow.document.write(`
       <html>
           <head>
               <title>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ AI - ${document.getElementById('studentName').value || '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤'}</title>
               <style>
                   body { font-family: 'Kanit', sans-serif; margin: 20px; }
                   .prediction-badge { padding: 10px 20px; border-radius: 15px; font-weight: bold; }
                   .pass { background: #28a745; color: white; }
                   .fail { background: #dc3545; color: white; }
                   .card { border: 1px solid #ddd; margin: 10px 0; padding: 15px; }
                   .card-header { background: #f8f9fa; padding: 10px; font-weight: bold; }
                   @media print { .no-print { display: none; } }
               </style>
           </head>
           <body>
               <h1>ü§ñ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ AI</h1>
               <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå:</strong> ${new Date().toLocaleString('th-TH')}</p>
               <p><strong>‡πÇ‡∏°‡πÄ‡∏î‡∏• AI:</strong> ${selectedModel ? selectedModel.filename : 'N/A'}</p>
               <hr>
               ${printContent}
           </body>
       </html>
   `);
   printWindow.document.close();
   printWindow.print();
}

// Additional Helper Functions
function updateLoadedTermsInfo() {
   // Update any term info displays if needed
   console.log(`üìö Loaded ${loadedTermsCount}/${allTermsData.length} terms`);
}

function lockPreviousTerms() {
   for (let i = 1; i < loadedTermsCount; i++) {
       const section = document.getElementById(`term-${i}`);
       if (section) {
           section.querySelectorAll('.grade-select').forEach(select => {
               select.disabled = true;
           });
           const header = section.querySelector('.term-header');
           if (header && !header.classList.contains('locked')) {
               header.classList.add('locked');
           }
       }
   }
}

// Helper Functions
function showAlert(message, type) {
   const alertContainer = document.getElementById('alertContainer');
   const alertDiv = document.createElement('div');
   alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
   alertDiv.innerHTML = `
       ${message}
       <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
   `;
   alertContainer.appendChild(alertDiv);
   
   setTimeout(() => {
       if (alertDiv.parentNode) {
           alertDiv.remove();
       }
   }, 5000);
}

function showLoadingModal(text) {
   const modalEl = document.getElementById('loadingModal');
   if (modalEl) {
       const loadingText = document.getElementById('loadingText');
       if (loadingText) loadingText.textContent = text || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
       
       const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
       bsModal.show();
   }
}

function hideLoadingModal() {
   const modalEl = document.getElementById('loadingModal');
   if (modalEl) {
       const bsModal = bootstrap.Modal.getInstance(modalEl);
       if (bsModal) {
           bsModal.hide();
       }
   }
}

// Load saved state on page load
window.addEventListener('load', function() {
   const savedState = localStorage.getItem('aiStudentPredictionState');
   if (savedState) {
       try {
           const state = JSON.parse(savedState);
           document.getElementById('studentName').value = state.studentName || '';
           document.getElementById('studentId').value = state.studentId || '';
           
           // Restore grades
           if (state.courseGrades) {
               Object.assign(courseGrades, state.courseGrades);
               
               // Apply grades to form elements
               Object.entries(state.courseGrades).forEach(([courseId, grade]) => {
                   const select = document.querySelector(`[data-course-id="${courseId}"]`);
                   if (select) {
                       select.value = grade;
                   }
               });
           }
           
           // Restore loaded terms count
           if (state.loadedTermsCount) {
               for (let i = 0; i < state.loadedTermsCount; i++) {
                   if (i < allTermsData.length) {
                       loadNextTerm();
                   }
               }
           }
           
           updateLiveStats();
           updatePrerequisites();
           
           showAlert('üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'info');
       } catch (e) {
           console.error('Error loading saved state:', e);
       }
   }
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
   // Auto-save current state
   const currentState = {
       studentName: document.getElementById('studentName').value,
       studentId: document.getElementById('studentId').value,
       loadedTermsCount: loadedTermsCount,
       courseGrades: courseGrades,
       selectedModel: selectedModel ? selectedModel.filename : null,
       timestamp: new Date().toISOString()
   };
   localStorage.setItem('aiStudentPredictionState', JSON.stringify(currentState));
});

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
   // Ctrl+Enter to analyze
   if (e.ctrlKey && e.key === 'Enter' && selectedModel && Object.keys(courseGrades).length > 0) {
       e.preventDefault();
       analyzeWithAI();
   }
   
   // Ctrl+S to save state
   if (e.ctrlKey && e.key === 's') {
       e.preventDefault();
       saveCurrentState();
   }
   
   // Ctrl+R to clear all
   if (e.ctrlKey && e.key === 'r') {
       e.preventDefault();
       clearAllGrades();
   }
});

console.log('ü§ñ AI Prediction System Loaded Successfully!');
</script>
{% endblock %}
