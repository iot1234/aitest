{% extends "base.html" %}

{% block title %}ทำนายรายบุคคล - {{ super() }}{% endblock %}

{% block custom_css %}
<style>
    /* ====== Modern Design System ====== */
    :root {
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --gradient-danger: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --gradient-dark: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        --glass-bg: rgba(255, 255, 255, 0.9);
        --glass-border: rgba(255, 255, 255, 0.3);
    }

    /* Main Container */
    .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    /* Hero Header */
    .hero-header {
        background: var(--gradient-primary);
        border-radius: 24px;
        padding: 3rem 2rem;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
    }

    .hero-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: pulse 4s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.1); opacity: 0.3; }
    }

    .hero-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: white;
        position: relative;
        z-index: 1;
        text-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .hero-header p {
        color: rgba(255,255,255,0.9);
        font-size: 1.1rem;
        position: relative;
        z-index: 1;
    }

    /* Glass Cards */
    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }

    .glass-card:hover {
        box-shadow: 0 12px 40px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }

    /* Input Section */
    .input-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .input-group-modern {
        position: relative;
    }

    .input-group-modern label {
        display: block;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .input-group-modern .form-control,
    .input-group-modern .form-select {
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s;
        background: white;
    }

    .input-group-modern .form-control:focus,
    .input-group-modern .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 992px) {
        .stats-grid { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 576px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }

    .stat-box {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 16px;
        padding: 1.25rem;
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }

    .stat-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-color: var(--primary-light);
    }

    .stat-box .stat-value {
        font-size: 2rem;
        font-weight: 800;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        line-height: 1.2;
    }

    .stat-box .stat-label {
        font-size: 0.8rem;
        color: var(--gray-500);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.25rem;
    }

    /* Progress Bar */
    .progress-container {
        background: var(--gray-100);
        border-radius: 50px;
        height: 24px;
        overflow: hidden;
        margin-top: 1rem;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }

    .progress-fill {
        height: 100%;
        background: var(--gradient-success);
        border-radius: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.85rem;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        min-width: fit-content;
        padding: 0 1rem;
    }

    /* Term Cards */
    .term-card {
        background: white;
        border-radius: 16px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        border: 1px solid var(--gray-200);
    }

    .term-header {
        background: var(--gradient-dark);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .term-header.locked {
        background: var(--gray-400);
    }

    .term-body {
        padding: 1.5rem;
    }

    /* Course Grid */
    .course-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
    }

    .course-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        border-left: 4px solid var(--primary);
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        transition: all 0.3s ease;
    }

    .course-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .course-card.locked {
        background: #fef2f2;
        border-left-color: var(--danger);
        opacity: 0.85;
    }

    .course-card.future {
        background: #eff6ff;
        border-left-color: var(--info);
    }

    .course-card.repeated {
        background: #fffbeb;
        border-left-color: var(--warning);
    }

    .course-title {
        font-weight: 700;
        color: var(--gray-800);
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
    }

    .course-id {
        font-size: 0.8rem;
        color: var(--gray-500);
    }

    .course-credit {
        font-size: 0.85rem;
        color: var(--primary);
        font-weight: 600;
    }

    .grade-select {
        margin-top: 0.75rem;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        padding: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .grade-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Gemini Panel */
    .gemini-panel {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .gemini-panel::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(167, 139, 250, 0.3) 0%, transparent 70%);
        pointer-events: none;
    }

    .gemini-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .gemini-header h4 {
        margin: 0;
        font-weight: 700;
        background: linear-gradient(90deg, #a78bfa, #f472b6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .gemini-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .gemini-action-card {
        background: rgba(255,255,255,0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 16px;
        padding: 1.5rem;
        transition: all 0.3s;
    }

    .gemini-action-card:hover {
        background: rgba(255,255,255,0.1);
        transform: translateY(-3px);
    }

    .gemini-action-card h5 {
        color: white;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .gemini-action-card p {
        color: rgba(255,255,255,0.7);
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    /* Gemini Result */
    .gemini-result {
        background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3e 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-top: 1.5rem;
        border: 1px solid rgba(167, 139, 250, 0.3);
    }

    .gemini-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .gemini-metric {
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
    }

    .gemini-metric .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #a78bfa;
    }

    .gemini-metric .label {
        font-size: 0.75rem;
        color: rgba(255,255,255,0.6);
        text-transform: uppercase;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        margin: 2rem 0;
    }

    .btn-action {
        padding: 0.875rem 2rem;
        border-radius: 50px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .btn-action:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .btn-action.btn-primary {
        background: var(--gradient-primary);
        color: white;
    }

    .btn-action.btn-success {
        background: var(--gradient-success);
        color: white;
    }

    .btn-action.btn-predict {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 1rem 3rem;
        font-size: 1.1rem;
    }

    /* Mode Toggle */
    .mode-toggle {
        background: white;
        border-radius: 50px;
        padding: 0.5rem;
        display: inline-flex;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .mode-toggle .btn-check + label {
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
    }

    .mode-toggle .btn-check:checked + label {
        background: var(--gradient-primary);
        color: white;
    }

    /* Results Section */
    .results-section {
        background: white;
        border-radius: 24px;
        padding: 2.5rem;
        margin-top: 2rem;
        box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }

    .result-hero {
        text-align: center;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
    }

    .result-hero.success {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border: 2px solid #10b981;
    }

    .result-hero.danger {
        background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
        border: 2px solid #ef4444;
    }

    .result-hero.warning {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border: 2px solid #f59e0b;
    }

    .result-hero h2 {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
    }

    .result-hero.success h2 { color: #059669; }
    .result-hero.danger h2 { color: #dc2626; }
    .result-hero.warning h2 { color: #d97706; }

    .probability-bar {
        height: 40px;
        border-radius: 20px;
        overflow: hidden;
        display: flex;
        margin: 1.5rem 0;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .probability-bar .pass {
        background: var(--gradient-success);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        transition: width 1s ease;
    }

    .probability-bar .fail {
        background: var(--gradient-danger);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        transition: width 1s ease;
    }

    /* Stats Cards */
    .result-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .result-stat-card {
        background: var(--gray-50);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s;
    }

    .result-stat-card:hover {
        background: white;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .result-stat-card .icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.5rem;
    }

    .result-stat-card .value {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--gray-800);
    }

    .result-stat-card .label {
        font-size: 0.85rem;
        color: var(--gray-500);
        font-weight: 600;
    }

    /* AI Insights Card */
    .ai-insights-card {
        background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3e 100%);
        border-radius: 20px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
    }

    .ai-insights-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .ai-insights-header h5 {
        margin: 0;
        font-weight: 700;
    }

    .feature-importance-list {
        display: grid;
        gap: 0.75rem;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
    }

    .feature-item .rank {
        width: 28px;
        height: 28px;
        background: var(--gradient-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.8rem;
    }

    .feature-item .name {
        flex: 1;
        font-size: 0.9rem;
    }

    .feature-item .bar {
        width: 100px;
        height: 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .feature-item .bar-fill {
        height: 100%;
        background: var(--gradient-primary);
        border-radius: 4px;
    }

    .feature-item .value {
        width: 50px;
        text-align: right;
        font-weight: 600;
        color: #a78bfa;
    }

    /* Recommendations */
    .recommendations-grid {
        display: grid;
        gap: 1rem;
    }

    .recommendation-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem 1.25rem;
        border-radius: 12px;
        background: white;
        border-left: 4px solid;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .recommendation-item.danger {
        border-left-color: var(--danger);
        background: #fef2f2;
    }

    .recommendation-item.warning {
        border-left-color: var(--warning);
        background: #fffbeb;
    }

    .recommendation-item.success {
        border-left-color: var(--success);
        background: #ecfdf5;
    }

    .recommendation-item .icon {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    /* Charts */
    .chart-container {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        margin-bottom: 1.5rem;
    }

    .chart-container h6 {
        font-weight: 700;
        color: var(--gray-700);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Modal Overlay */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal-content-custom {
        background: white;
        border-radius: 24px;
        padding: 3rem;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 25px 80px rgba(0,0,0,0.3);
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(79, 70, 229, 0.1);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .hero-header h1 { font-size: 1.75rem; }
        .glass-card { padding: 1.5rem; }
        .results-section { padding: 1.5rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div id="alertContainer"></div>
    
    <!-- Hero Header -->
    <div class="hero-header" data-aos="fade-down">
        <h1>
            <i class="bi bi-person-check-fill me-2"></i>ระบบทำนายรายบุคคล
        </h1>
        <p>วิเคราะห์เส้นทางการเรียนและทำนายโอกาสสำเร็จการศึกษาด้วย AI ขั้นสูง</p>
    </div>

    <!-- Control Panel -->
    <div class="glass-card" data-aos="fade-up">
        <div class="input-section">
            <div class="input-group-modern">
                <label><i class="bi bi-person me-1"></i>ชื่อ-นามสกุล</label>
                <input type="text" class="form-control" id="studentName" placeholder="นักศึกษาทดสอบ" value="นักศึกษาทดสอบ">
            </div>
            <div class="input-group-modern">
                <label><i class="bi bi-card-text me-1"></i>รหัสนักศึกษา</label>
                <input type="text" class="form-control" id="studentId" placeholder="รหัสนักศึกษา">
            </div>
            <div class="input-group-modern">
                <label><i class="bi bi-cpu me-1"></i>โมเดล AI</label>
                <select class="form-select" id="modelSelect">
                    <option value="">กำลังโหลด...</option>
                </select>
            </div>
            <div class="input-group-modern">
                <label><i class="bi bi-clock-history me-1"></i>สถานะ</label>
                <div class="form-control bg-light" id="loadedTermsInfo">
                    <i class="bi bi-hourglass-split me-1"></i> ยังไม่ได้โหลดเทอม
                </div>
            </div>
        </div>
        
        <div class="d-flex flex-wrap gap-2 justify-content-center">
            <button class="btn btn-primary rounded-pill px-4" id="loadAllTermsBtn">
                <i class="bi bi-lightning-fill me-1"></i> โหลดทุกเทอม
            </button>
            <button class="btn btn-outline-success rounded-pill px-4" id="fillSampleGradesBtn">
                <i class="bi bi-magic me-1"></i> ใส่เกรดตัวอย่าง
            </button>
            <button class="btn btn-outline-secondary rounded-pill px-4" id="saveCurrentStateBtn">
                <i class="bi bi-save me-1"></i> บันทึก
            </button>
            <button class="btn btn-outline-danger rounded-pill px-4" id="clearAllGradesBtn">
                <i class="bi bi-eraser-fill me-1"></i> ล้างข้อมูล
            </button>
        </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="glass-card" data-aos="fade-up" data-aos-delay="100">
        <h5 class="mb-4 fw-bold" style="color: var(--primary);">
            <i class="bi bi-speedometer2 me-2"></i>สถิติแบบ Real-time
        </h5>
        
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value" id="statGPA">0.00</div>
                <div class="stat-label">GPA</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statCredits">0</div>
                <div class="stat-label">หน่วยกิต</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #10b981;" id="statPassed">0</div>
                <div class="stat-label">วิชาที่ผ่าน</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #ef4444;" id="statFailed">0</div>
                <div class="stat-label">วิชาที่ตก</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #f59e0b;" id="statBlocked">0</div>
                <div class="stat-label">ติดเงื่อนไข</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #06b6d4;" id="statProgress">0%</div>
                <div class="stat-label">ความคืบหน้า</div>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-fill" id="mainProgressBar" style="width: 0%">0%</div>
        </div>
    </div>

    <!-- Gemini AI Panel -->
    <div class="gemini-panel" data-aos="fade-up" data-aos-delay="200">
        <div class="gemini-header">
            <i class="bi bi-stars fs-3 text-warning"></i>
            <h4>Gemini AI Copilot</h4>
            <span id="geminiStatusBadge" class="badge bg-success ms-auto">พร้อมใช้งาน</span>
        </div>
        
        <div class="gemini-grid">
            <div class="gemini-action-card">
                <h5><i class="bi bi-file-earmark-bar-graph me-2"></i>วิเคราะห์ไฟล์เกรด</h5>
                <p>อัปโหลดไฟล์ CSV/Excel เพื่อให้ AI วิเคราะห์ภาพรวม</p>
                <input class="form-control form-control-sm mb-2" type="file" id="geminiCsvInput" accept=".csv,.xlsx,.xls" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                <input type="text" class="form-control form-control-sm mb-2" id="geminiFileGoalInput" placeholder="สิ่งที่ต้องการเน้น (Optional)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                <button class="btn btn-light w-100" id="geminiAnalyzeFileBtn">
                    <i class="bi bi-stars me-1"></i> วิเคราะห์ไฟล์
                </button>
            </div>
            <div class="gemini-action-card">
                <h5><i class="bi bi-person-lines-fill me-2"></i>วิเคราะห์ผลการเรียนปัจจุบัน</h5>
                <p>ใช้ข้อมูลเกรดที่กรอกในระบบเพื่อทำนายเชิงลึก</p>
                <textarea class="form-control form-control-sm mb-2" rows="2" id="geminiLiveGoalInput" placeholder="เช่น ขอคำแนะนำในการเพิ่ม GPA หรือวิเคราะห์ความเสี่ยง" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;"></textarea>
                <button class="btn btn-warning w-100" id="geminiLiveAnalyzeBtn">
                    <i class="bi bi-robot me-1"></i> วิเคราะห์ข้อมูล
                </button>
            </div>
        </div>

        <div id="geminiLoadingState" class="text-center mt-4 d-none">
            <div class="spinner-border text-light" role="status"></div>
            <p class="mt-2 text-light">Gemini กำลังประมวลผล...</p>
        </div>

        <div id="geminiResultCard" class="gemini-result d-none">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex gap-2">
                    <span class="badge bg-primary"><i class="bi bi-activity me-1"></i> <span id="geminiOutcomeLabel">-</span></span>
                    <span class="badge bg-warning text-dark"><i class="bi bi-shield-check me-1"></i> <span id="geminiRiskLevel">-</span></span>
                </div>
                <button class="btn btn-sm btn-outline-light rounded-circle" id="geminiClearBtn"><i class="bi bi-x-lg"></i></button>
            </div>
            
            <div class="gemini-metrics" id="geminiKeyMetrics"></div>
            
            <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.5rem; max-height: 400px; overflow-y: auto;">
                <div class="markdown-body text-light" id="geminiMarkdownResult"></div>
            </div>
            
            <div class="mt-3" id="geminiRecommendationsContainer" style="display: none;">
                <h6 class="text-uppercase text-white-50 mb-2">คำแนะนำเพิ่มเติม</h6>
                <ul class="list-unstyled text-light" id="geminiRecommendationsList"></ul>
            </div>
        </div>
    </div>

    <!-- Terms Container -->
    <div id="termsContainer"></div>

    <!-- Prediction Mode & Action -->
    <div class="text-center my-4" data-aos="fade-up">
        <div class="mode-toggle mb-4">
            <input type="radio" class="btn-check" name="predictionMode" id="modeNormal" value="normal" checked>
            <label class="btn" for="modeNormal">
                <i class="bi bi-cpu me-1"></i> AI Model
            </label>
            
            <input type="radio" class="btn-check" name="predictionMode" id="modeGemini" value="gemini">
            <label class="btn" for="modeGemini">
                <i class="bi bi-stars me-1"></i> Gemini AI
            </label>
        </div>
        
        <div id="geminiModeConfig" class="mb-4" style="display: none; max-width: 500px; margin: 0 auto;">
            <textarea class="form-control" rows="2" id="geminiModeGoalInput" placeholder="ระบุสิ่งที่ต้องการให้ Gemini เน้นวิเคราะห์..."></textarea>
        </div>
        
        <div class="action-buttons">
            <button class="btn-action btn-primary" id="loadNextTermBtn">
                <i class="bi bi-plus-circle"></i> โหลดเทอมถัดไป
            </button>
            <button class="btn-action btn-success" id="openFutureCoursesModalBtn">
                <i class="bi bi-calendar-plus"></i> วิชาอนาคต
            </button>
            <button class="btn-action btn-predict" id="analyzeAndPredictBtn">
                <i class="bi bi-graph-up-arrow"></i> วิเคราะห์และทำนาย
            </button>
        </div>
    </div>

    <!-- Results Section -->
    <div class="results-section d-none" id="resultsSection">
        <!-- Result Hero -->
        <div id="resultHero" class="result-hero success">
            <h2><i class="bi bi-check-circle-fill me-2"></i>คาดว่าจะจบการศึกษา</h2>
            <p class="mb-0">ความมั่นใจ: <strong>85%</strong></p>
        </div>
        
        <!-- Probability Bar -->
        <div class="probability-bar" id="probabilityBar">
            <div class="pass" style="width: 85%">โอกาสจบ 85%</div>
            <div class="fail" style="width: 15%">15%</div>
        </div>
        
        <!-- Stats Cards -->
        <div class="result-stats" id="resultStats">
            <!-- Will be filled by JavaScript -->
        </div>
        
        <!-- AI Insights -->
        <div class="ai-insights-card" id="aiInsightsCard" style="display: none;">
            <div class="ai-insights-header">
                <i class="bi bi-robot fs-4"></i>
                <h5>AI Analysis Insights</h5>
                <span class="badge bg-primary ms-auto" id="predictionMethodBadge">AI Model</span>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6 class="text-white-50 text-uppercase mb-3">โมเดลที่ใช้</h6>
                    <div id="modelsUsedList"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-white-50 text-uppercase mb-3">ปัจจัยสำคัญ (Top 5)</h6>
                    <div class="feature-importance-list" id="featureImportanceList"></div>
                </div>
            </div>
        </div>
        
        <!-- Problem & Blocked Courses -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="chart-container h-100" style="border-left: 4px solid #ef4444;">
                    <h6><i class="bi bi-exclamation-circle text-danger"></i> วิชาที่มีปัญหา</h6>
                    <div id="problemCourses"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container h-100" style="border-left: 4px solid #f59e0b;">
                    <h6><i class="bi bi-lock text-warning"></i> วิชาติดเงื่อนไข</h6>
                    <div id="blockedCoursesDetail"></div>
                </div>
            </div>
        </div>
        
        <!-- Recommendations -->
        <div class="chart-container mb-4">
            <h6><i class="bi bi-lightbulb text-success"></i> คำแนะนำเฉพาะบุคคล</h6>
            <div class="recommendations-grid" id="personalRecommendations"></div>
        </div>
        
        <!-- Charts -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="chart-container">
                    <h6><i class="bi bi-graph-up"></i> แนวโน้ม GPA</h6>
                    <canvas id="gpaChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h6><i class="bi bi-pie-chart"></i> การกระจายเกรด</h6>
                    <canvas id="gradeDistChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Export Buttons -->
        <div class="text-center mt-4">
            <button class="btn btn-outline-secondary me-2" id="exportExcelBtn">
                <i class="bi bi-file-excel me-1"></i> Excel
            </button>
            <button class="btn btn-outline-secondary" id="printResultsBtn">
                <i class="bi bi-printer me-1"></i> Print
            </button>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal-overlay" id="customLoadingModal">
    <div class="modal-content-custom">
        <div class="loading-spinner"></div>
        <h5 class="fw-bold mb-2" id="customLoadingText">กำลังประมวลผล...</h5>
        <p class="text-muted mb-0">ระบบ AI กำลังวิเคราะห์ข้อมูล</p>
    </div>
</div>

<!-- Future Courses Modal -->
<div class="modal fade" id="futureCoursesModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-calendar-plus me-2"></i>เลือกวิชาอนาคต</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="futureCoursesContent" style="max-height: 60vh; overflow-y: auto;"></div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">ปิด</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" id="addFutureCoursesBtn">ยืนยันการเลือก</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// ===== Global State =====
let coursesData = [];
let allTermsData = [];
let gradeMapping = {};
let loadedTermsCount = 0;
let courseGrades = {};
let charts = {};
let isInitialized = false;
let currentAnalysisController = null;
let geminiEnabled = false;

// ===== Initialization =====
document.addEventListener('DOMContentLoaded', async function() {
    try {
        await loadConfigFromAPI();
        if (validateData()) {
            await initializeApp();
        }
    } catch (error) {
        console.error('Initialization failed:', error);
        showAlert('เกิดข้อผิดพลาด: ' + error.message, 'danger');
    }
});

async function loadConfigFromAPI() {
    const response = await fetch('/api/config');
    const data = await response.json();
    
    if (data.success) {
        coursesData = data.COURSES_DATA || [];
        allTermsData = data.ALL_TERMS_DATA || [];
        gradeMapping = data.GRADE_MAPPING || {};
        geminiEnabled = Boolean(data.GEMINI_ENABLED);
        updateGeminiStatus();
        return true;
    }
    throw new Error('Failed to load configuration');
}

function validateData() {
    return coursesData.length > 0 && allTermsData.length > 0 && Object.keys(gradeMapping).length > 0;
}

async function initializeApp() {
    if (isInitialized) return;
    
    setupEventListeners();
    loadModels();
    updateLiveStats();
    isInitialized = true;
}

// ===== Event Listeners =====
function setupEventListeners() {
    const handlers = {
        'loadNextTermBtn': loadNextTerm,
        'loadAllTermsBtn': loadAllTerms,
        'fillSampleGradesBtn': fillSampleGrades,
        'clearAllGradesBtn': clearAllGrades,
        'saveCurrentStateBtn': saveCurrentState,
        'analyzeAndPredictBtn': analyzeAndPredict,
        'openFutureCoursesModalBtn': openFutureCoursesModal,
        'addFutureCoursesBtn': addSelectedFutureCourses,
        'exportExcelBtn': () => exportResults('excel'),
        'printResultsBtn': printResults,
        'geminiAnalyzeFileBtn': analyzeCsvWithGemini,
        'geminiLiveAnalyzeBtn': analyzeLiveGradesWithGemini,
        'geminiClearBtn': clearGeminiResult
    };
    
    for (const [id, handler] of Object.entries(handlers)) {
        const el = document.getElementById(id);
        if (el) el.addEventListener('click', handler);
    }
    
    document.querySelectorAll('input[name="predictionMode"]').forEach(input => {
        input.addEventListener('change', updatePredictionModeUI);
    });
    
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('grade-select')) {
            courseGrades[e.target.dataset.courseId] = e.target.value;
            updateLiveStats();
            updatePrerequisites();
        }
    });
}

// ===== Models =====
async function loadModels() {
    const modelSelect = document.getElementById('modelSelect');
    try {
        const response = await fetch('/api/models');
        const data = await response.json();
        
        modelSelect.innerHTML = '<option value="">-- เลือกโมเดล AI --</option>';
        
        if (data.success && data.models?.length > 0) {
            data.models.forEach(model => {
                const accuracy = model.performance?.accuracy ? (model.performance.accuracy * 100).toFixed(1) : 'N/A';
                const option = document.createElement('option');
                option.value = model.filename;
                option.textContent = `${model.filename} (${accuracy}%)`;
                modelSelect.appendChild(option);
            });
            modelSelect.value = data.models[0].filename;
        }
    } catch (error) {
        modelSelect.innerHTML = '<option value="">ไม่สามารถโหลดโมเดลได้</option>';
    }
}

// ===== Term Management =====
function loadNextTerm() {
    if (loadedTermsCount >= allTermsData.length) {
        showAlert('โหลดครบทุกเทอมแล้ว', 'warning');
        return;
    }
    
    lockPreviousTerms();
    const termData = allTermsData[loadedTermsCount];
    loadedTermsCount++;
    
    createTermSection(termData, loadedTermsCount);
    updateLoadedTermsInfo();
    updateLiveStats();
    updatePrerequisites();
}

function loadAllTerms() {
    document.getElementById('termsContainer').innerHTML = '';
    loadedTermsCount = 0;
    courseGrades = {};
    
    while (loadedTermsCount < allTermsData.length) {
        loadNextTerm();
    }
    showAlert('โหลดทุกเทอมเรียบร้อย', 'success');
}

function createTermSection(termData, termNumber) {
    const container = document.getElementById('termsContainer');
    const section = document.createElement('div');
    section.className = 'term-card animate__animated animate__fadeInUp';
    section.id = `term-${termNumber}`;
    
    let coursesHtml = '';
    termData.ids.forEach(courseId => {
        const course = coursesData.find(c => c.id === courseId);
        if (course) {
            coursesHtml += createCourseCardHtml(course);
        }
    });
    
    section.innerHTML = `
        <div class="term-header">
            <h6 class="mb-0 fw-bold">ปี ${termData.year} เทอม ${termData.term}</h6>
            <span class="badge bg-light text-dark">${termData.ids.length} วิชา</span>
        </div>
        <div class="term-body">
            <div class="course-grid">${coursesHtml}</div>
        </div>
    `;
    container.appendChild(section);
}

function createCourseCardHtml(course, isFuture = false, isRepeated = false) {
    const prereqText = course.prereq?.length > 0 
        ? course.prereq.map(p => {
            const pc = coursesData.find(c => c.id === p);
            return pc ? pc.thaiName : p;
        }).join(', ')
        : 'ไม่มี';
    
    let className = 'course-card';
    if (isFuture) className += ' future';
    if (isRepeated) className += ' repeated';
    
    return `
        <div class="${className}" data-course-id="${course.id}">
            <div class="course-title">${course.thaiName}</div>
            <div class="course-id">${course.id}</div>
            <div class="course-credit">${course.credit} หน่วยกิต</div>
            <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                <i class="bi bi-link-45deg"></i> ${prereqText}
            </small>
            <select class="grade-select form-select form-select-sm" data-course-id="${course.id}">
                <option value="">-- เลือกเกรด --</option>
                ${Object.keys(gradeMapping).map(g => `<option value="${g}">${g}</option>`).join('')}
            </select>
        </div>
    `;
}

function lockPreviousTerms() {
    for (let i = 1; i < loadedTermsCount; i++) {
        const section = document.getElementById(`term-${i}`);
        if (section) {
            section.querySelectorAll('.grade-select').forEach(s => s.disabled = true);
            const header = section.querySelector('.term-header');
            if (header) header.classList.add('locked');
        }
    }
}

// ===== Stats =====
function updateLiveStats() {
    let totalPoints = 0, totalCredits = 0, passedCredits = 0, passedCount = 0, failedCount = 0;
    
    Object.entries(courseGrades).forEach(([courseId, grade]) => {
        if (grade) {
            const course = coursesData.find(c => c.id === courseId);
            if (course) {
                const gradePoint = gradeMapping[grade] || 0;
                if (grade !== 'W' && grade !== 'I') {
                    totalPoints += gradePoint * course.credit;
                    totalCredits += course.credit;
                }
                if (gradePoint > 0) {
                    passedCredits += course.credit;
                    passedCount++;
                } else if (grade === 'F') {
                    failedCount++;
                }
            }
        }
    });
    
    const gpa = totalCredits > 0 ? totalPoints / totalCredits : 0;
    const totalRequired = coursesData.reduce((sum, c) => sum + c.credit, 0);
    const progress = totalRequired > 0 ? (passedCredits / totalRequired) * 100 : 0;
    
    document.getElementById('statGPA').textContent = gpa.toFixed(2);
    document.getElementById('statCredits').textContent = passedCredits;
    document.getElementById('statPassed').textContent = passedCount;
    document.getElementById('statFailed').textContent = failedCount;
    document.getElementById('statProgress').textContent = Math.round(progress) + '%';
    
    const progressBar = document.getElementById('mainProgressBar');
    progressBar.style.width = Math.min(100, progress) + '%';
    progressBar.textContent = Math.round(progress) + '%';
    
    let blockedCount = document.querySelectorAll('.course-card.locked').length;
    document.getElementById('statBlocked').textContent = blockedCount;
}

function updateLoadedTermsInfo() {
    const info = document.getElementById('loadedTermsInfo');
    if (loadedTermsCount === 0) {
        info.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> ยังไม่ได้โหลดเทอม';
    } else {
        const lastTerm = allTermsData[loadedTermsCount - 1];
        info.innerHTML = `<i class="bi bi-check-circle-fill text-success me-1"></i> ปี ${lastTerm.year} เทอม ${lastTerm.term} (${loadedTermsCount}/${allTermsData.length})`;
    }
}

function updatePrerequisites() {
    document.querySelectorAll('.grade-select').forEach(select => {
        const courseCard = select.closest('.course-card');
        const courseId = select.dataset.courseId;
        const course = coursesData.find(c => c.id === courseId);
        if (!course) return;
        
        const oldWarning = courseCard.querySelector('.prerequisite-warning');
        if (oldWarning) oldWarning.remove();
        
        let isBlocked = false;
        let unmetPrereqs = [];
        
        if (course.prereq?.length > 0) {
            for (let prereqId of course.prereq) {
                const prereqGrade = courseGrades[prereqId];
                if (!prereqGrade || gradeMapping[prereqGrade] === 0) {
                    isBlocked = true;
                    const pc = coursesData.find(c => c.id === prereqId);
                    unmetPrereqs.push(pc ? pc.thaiName : prereqId);
                }
            }
        }
        
        if (isBlocked) {
            courseCard.classList.add('locked');
            select.disabled = true;
            select.value = '';
            delete courseGrades[courseId];
            
            const warning = document.createElement('div');
            warning.className = 'prerequisite-warning small text-danger mt-2';
            warning.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-1"></i> ต้องผ่าน: ${unmetPrereqs.join(', ')}`;
            courseCard.appendChild(warning);
        } else {
            courseCard.classList.remove('locked');
            select.disabled = false;
        }
    });
}

// ===== Sample Data =====
function fillSampleGrades() {
    const grades = ['A', 'B+', 'B', 'C+', 'C', 'D+', 'D'];
    document.querySelectorAll('.grade-select').forEach(select => {
        if (!select.disabled && !select.value) {
            const randomGrade = grades[Math.floor(Math.random() * grades.length)];
            select.value = randomGrade;
            courseGrades[select.dataset.courseId] = randomGrade;
        }
    });
    updateLiveStats();
    updatePrerequisites();
    showAlert('ใส่เกรดตัวอย่างเรียบร้อย', 'success');
}

function clearAllGrades() {
    if (!confirm('คุณแน่ใจหรือไม่ที่จะล้างเกรดทั้งหมด?')) return;
    
    document.querySelectorAll('.grade-select').forEach(select => {
        if (!select.disabled) select.value = '';
    });
    
    const newGrades = {};
    Object.entries(courseGrades).forEach(([id, grade]) => {
        const select = document.querySelector(`.grade-select[data-course-id="${id}"]`);
        if (select?.disabled) newGrades[id] = grade;
    });
    courseGrades = newGrades;
    
    updateLiveStats();
    updatePrerequisites();
    showAlert('ล้างเกรดเรียบร้อย', 'info');
}

function saveCurrentState() {
    const state = {
        studentName: document.getElementById('studentName').value,
        studentId: document.getElementById('studentId').value,
        loadedTermsCount,
        courseGrades,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem('studentPredictionState', JSON.stringify(state));
    showAlert('บันทึกสถานะเรียบร้อย', 'success');
}

// ===== Prediction =====
function getSelectedPredictionMode() {
    return document.querySelector('input[name="predictionMode"]:checked')?.value || 'normal';
}

function updatePredictionModeUI() {
    const mode = getSelectedPredictionMode();
    const config = document.getElementById('geminiModeConfig');
    config.style.display = mode === 'gemini' ? 'block' : 'none';
}

function updateGeminiStatus() {
    const badge = document.getElementById('geminiStatusBadge');
    const geminiRadio = document.getElementById('modeGemini');
    
    if (geminiEnabled) {
        badge.className = 'badge bg-success ms-auto';
        badge.textContent = 'พร้อมใช้งาน';
        if (geminiRadio) geminiRadio.disabled = false;
    } else {
        badge.className = 'badge bg-danger ms-auto';
        badge.textContent = 'ไม่พร้อมใช้งาน';
        if (geminiRadio) geminiRadio.disabled = true;
    }
}

async function analyzeAndPredict() {
    if (Object.keys(courseGrades).length === 0) {
        showAlert('กรุณากรอกเกรดอย่างน้อย 1 วิชา', 'warning');
        return;
    }
    
    const studentName = document.getElementById('studentName').value || 'นักศึกษา';
    const modelSelect = document.getElementById('modelSelect');
    let modelFilename = modelSelect?.value || '';
    
    if (!modelFilename) {
        try {
            const resp = await fetch('/api/models');
            const data = await resp.json();
            if (data.success && data.models?.length > 0) {
                modelFilename = data.models[0].filename;
            }
        } catch (e) {}
    }
    
    const mode = getSelectedPredictionMode();
    
    if (mode === 'gemini' && geminiEnabled) {
        await analyzeWithGemini(studentName, modelFilename);
        return;
    }
    
    showCustomLoadingModal('กำลังวิเคราะห์ด้วย AI...');
    currentAnalysisController = new AbortController();
    
    try {
        const response = await fetch('/api/analyze_curriculum', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                student_name: studentName,
                current_grades: courseGrades,
                loaded_terms_count: loadedTermsCount,
                model_filename: modelFilename
            }),
            signal: currentAnalysisController.signal
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result);
            showAlert('✅ วิเคราะห์เสร็จสิ้น', 'success');
        } else {
            showAlert('เกิดข้อผิดพลาด: ' + result.error, 'danger');
        }
    } catch (error) {
        if (error.name !== 'AbortError') {
            showAlert('เกิดข้อผิดพลาด: ' + error.message, 'danger');
        }
    } finally {
        hideCustomLoadingModal();
        currentAnalysisController = null;
    }
}

async function analyzeWithGemini(studentName, modelFilename) {
    if (!geminiEnabled) {
        showAlert('Gemini ไม่พร้อมใช้งาน', 'warning');
        return;
    }
    
    const goalInput = document.getElementById('geminiModeGoalInput');
    const payload = {
        student_name: studentName,
        course_grades: courseGrades,
        loaded_terms_count: loadedTermsCount,
        model_filename: modelFilename
    };
    if (goalInput?.value.trim()) {
        payload.analysis_goal = goalInput.value.trim();
    }
    
    showCustomLoadingModal('Gemini กำลังวิเคราะห์...');
    
    try {
        const response = await fetch('/api/gemini/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayGeminiResult(result);
            showAlert('✨ Gemini วิเคราะห์เสร็จสิ้น', 'success');
        } else {
            showAlert(result.error || 'Gemini ไม่สามารถวิเคราะห์ได้', 'danger');
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาด: ' + error.message, 'danger');
    } finally {
        hideCustomLoadingModal();
    }
}

// ===== Display Results =====
function displayResults(data) {
    const resultsSection = document.getElementById('resultsSection');
    resultsSection.classList.remove('d-none');
    
    const pred = data.prediction_result;
    const isPass = pred?.prediction === 'จบ';
    const probPass = pred ? Math.min(100, (pred.prob_pass * 100)).toFixed(1) : 50;
    const probFail = pred ? Math.min(100, (pred.prob_fail * 100)).toFixed(1) : 50;
    const confidence = pred ? Math.min(100, (pred.confidence * 100)).toFixed(1) : 50;
    
    // Result Hero
    const resultHero = document.getElementById('resultHero');
    resultHero.className = `result-hero ${isPass ? 'success' : 'danger'}`;
    resultHero.innerHTML = `
        <h2><i class="bi bi-${isPass ? 'check-circle-fill' : 'x-circle-fill'} me-2"></i>${isPass ? 'คาดว่าจะจบการศึกษา' : 'เสี่ยงไม่จบการศึกษา'}</h2>
        <p class="mb-0">ความมั่นใจ: <strong>${confidence}%</strong></p>
    `;
    
    // Probability Bar
    const probBar = document.getElementById('probabilityBar');
    probBar.innerHTML = `
        <div class="pass" style="width: ${probPass}%">โอกาสจบ ${probPass}%</div>
        <div class="fail" style="width: ${probFail}%">${probFail}%</div>
    `;
    
    // Stats Cards
    const statsContainer = document.getElementById('resultStats');
    statsContainer.innerHTML = `
        <div class="result-stat-card">
            <div class="icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-speedometer2"></i></div>
            <div class="value">${(data.avg_gpa || 0).toFixed(2)}</div>
            <div class="label">GPA เฉลี่ย</div>
        </div>
        <div class="result-stat-card">
            <div class="icon bg-success bg-opacity-10 text-success"><i class="bi bi-journal-check"></i></div>
            <div class="value">${data.completed_credits || 0}</div>
            <div class="label">หน่วยกิตที่ผ่าน</div>
        </div>
        <div class="result-stat-card">
            <div class="icon bg-info bg-opacity-10 text-info"><i class="bi bi-percent"></i></div>
            <div class="value">${(data.completion_rate || 0).toFixed(1)}%</div>
            <div class="label">ความคืบหน้า</div>
        </div>
        <div class="result-stat-card">
            <div class="icon bg-danger bg-opacity-10 text-danger"><i class="bi bi-x-circle"></i></div>
            <div class="value">${data.failed_courses?.length || 0}</div>
            <div class="label">วิชาที่ตก</div>
        </div>
    `;
    
    // AI Insights
    if (pred?.prediction_method === 'AI_MODEL' && pred?.feature_importance) {
        const aiCard = document.getElementById('aiInsightsCard');
        aiCard.style.display = 'block';
        
        document.getElementById('predictionMethodBadge').textContent = pred.prediction_method;
        
        // Models used
        const modelsList = document.getElementById('modelsUsedList');
        if (pred.models_used) {
            modelsList.innerHTML = pred.models_used.map(m => 
                `<span class="badge bg-primary me-1 mb-1">${m.toUpperCase()}</span>`
            ).join('');
        }
        
        // Feature importance
        const featureList = document.getElementById('featureImportanceList');
        const features = Object.entries(pred.feature_importance).slice(0, 5);
        featureList.innerHTML = features.map(([name, imp], i) => `
            <div class="feature-item">
                <span class="rank">${i + 1}</span>
                <span class="name">${name}</span>
                <div class="bar"><div class="bar-fill" style="width: ${(imp * 100).toFixed(0)}%"></div></div>
                <span class="value">${(imp * 100).toFixed(1)}%</span>
            </div>
        `).join('');
    } else {
        document.getElementById('aiInsightsCard').style.display = 'none';
    }
    
    // Problem Courses
    const problemDiv = document.getElementById('problemCourses');
    if (data.failed_courses?.length > 0) {
        problemDiv.innerHTML = data.failed_courses.map(c => 
            `<div class="d-flex align-items-center mb-2"><i class="bi bi-x-circle-fill text-danger me-2"></i>${c}</div>`
        ).join('');
    } else {
        problemDiv.innerHTML = '<div class="text-success text-center py-3"><i class="bi bi-check-circle-fill fs-3 mb-2"></i><p class="mb-0">ไม่มีวิชาที่ตก</p></div>';
    }
    
    // Blocked Courses
    const blockedDiv = document.getElementById('blockedCoursesDetail');
    if (data.blocked_courses_details?.length > 0) {
        blockedDiv.innerHTML = data.blocked_courses_details.map(c => `
            <div class="mb-2">
                <div class="fw-bold"><i class="bi bi-lock-fill text-warning me-2"></i>${c.name}</div>
                <small class="text-muted ms-4">ต้องผ่าน: ${c.unmet_prereqs.join(', ')}</small>
            </div>
        `).join('');
    } else {
        blockedDiv.innerHTML = '<div class="text-success text-center py-3"><i class="bi bi-unlock-fill fs-3 mb-2"></i><p class="mb-0">ไม่มีวิชาติดเงื่อนไข</p></div>';
    }
    
    // Recommendations
    const recsDiv = document.getElementById('personalRecommendations');
    if (data.recommendations?.length > 0) {
        recsDiv.innerHTML = data.recommendations.map(rec => {
            const type = rec.includes('เร่งด่วน') || rec.includes('ต่ำ') ? 'danger' : 
                        rec.includes('ควร') ? 'warning' : 'success';
            return `
                <div class="recommendation-item ${type}">
                    <span class="icon">${type === 'danger' ? '⚠️' : type === 'warning' ? '💡' : '✅'}</span>
                    <span>${rec}</span>
                </div>
            `;
        }).join('');
    }
    
    // Scroll to results
    setTimeout(() => resultsSection.scrollIntoView({ behavior: 'smooth' }), 100);
}

function displayGeminiResult(result) {
    const card = document.getElementById('geminiResultCard');
    card.classList.remove('d-none');
    
    const gemini = result.gemini || {};
    
    document.getElementById('geminiOutcomeLabel').textContent = gemini.prediction || 'วิเคราะห์';
    document.getElementById('geminiRiskLevel').textContent = gemini.risk_level || '-';
    
    const metricsDiv = document.getElementById('geminiKeyMetrics');
    metricsDiv.innerHTML = `
        <div class="gemini-metric">
            <div class="value">${gemini.estimated_gpa?.toFixed(2) || '-'}</div>
            <div class="label">GPA ประมาณ</div>
        </div>
        <div class="gemini-metric">
            <div class="value">${gemini.confidence || '-'}%</div>
            <div class="label">ความมั่นใจ</div>
        </div>
    `;
    
    const mkDiv = document.getElementById('geminiMarkdownResult');
    if (gemini.analysis_markdown) {
        mkDiv.innerHTML = typeof marked !== 'undefined' ? marked.parse(gemini.analysis_markdown) : gemini.analysis_markdown.replace(/\n/g, '<br>');
    }
    
    if (gemini.recommendations?.length > 0) {
        const recsContainer = document.getElementById('geminiRecommendationsContainer');
        const recsList = document.getElementById('geminiRecommendationsList');
        recsContainer.style.display = 'block';
        recsList.innerHTML = gemini.recommendations.map(r => `<li class="mb-1">• ${r}</li>`).join('');
    }
}

function clearGeminiResult() {
    document.getElementById('geminiResultCard').classList.add('d-none');
}

// ===== Gemini File Analysis =====
async function analyzeCsvWithGemini() {
    const fileInput = document.getElementById('geminiCsvInput');
    if (!fileInput.files.length) {
        showAlert('กรุณาเลือกไฟล์', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    const goalInput = document.getElementById('geminiFileGoalInput');
    if (goalInput?.value.trim()) {
        formData.append('analysis_goal', goalInput.value.trim());
    }
    
    const loadingDiv = document.getElementById('geminiLoadingState');
    loadingDiv.classList.remove('d-none');
    
    try {
        const response = await fetch('/api/gemini/analyze_file', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        
        if (result.success) {
            displayGeminiResult(result);
            showAlert('วิเคราะห์ไฟล์สำเร็จ', 'success');
        } else {
            showAlert(result.error, 'danger');
        }
    } catch (error) {
        showAlert(error.message, 'danger');
    } finally {
        loadingDiv.classList.add('d-none');
    }
}

async function analyzeLiveGradesWithGemini() {
    await analyzeWithGemini(
        document.getElementById('studentName').value,
        document.getElementById('modelSelect').value
    );
}

// ===== Modals =====
function openFutureCoursesModal() {
    const content = document.getElementById('futureCoursesContent');
    let courseIds = [];
    
    for (let i = loadedTermsCount; i < allTermsData.length; i++) {
        courseIds.push(...allTermsData[i].ids);
    }
    
    if (courseIds.length === 0) {
        content.innerHTML = '<p class="text-muted text-center py-4">ไม่มีวิชาอนาคตให้เลือก</p>';
    } else {
        content.innerHTML = '<div class="row g-3">' + courseIds.map(id => {
            const course = coursesData.find(c => c.id === id);
            if (!course) return '';
            return `
                <div class="col-md-6">
                    <div class="form-check p-3 border rounded bg-light">
                        <input class="form-check-input" type="checkbox" value="${course.id}" id="future-${course.id}">
                        <label class="form-check-label w-100" for="future-${course.id}">
                            <div class="fw-bold">${course.thaiName}</div>
                            <small class="text-muted">${course.id} (${course.credit} หน่วยกิต)</small>
                        </label>
                    </div>
                </div>
            `;
        }).join('') + '</div>';
    }
    
    new bootstrap.Modal(document.getElementById('futureCoursesModal')).show();
}

function addSelectedFutureCourses() {
    const checkboxes = document.querySelectorAll('#futureCoursesContent input:checked');
    if (checkboxes.length === 0) return;
    
    if (loadedTermsCount === 0) {
        showAlert('กรุณาโหลดเทอมก่อน', 'warning');
        return;
    }
    
    const grid = document.querySelector(`#term-${loadedTermsCount} .course-grid`);
    if (!grid) return;
    
    checkboxes.forEach(cb => {
        const course = coursesData.find(c => c.id === cb.value);
        if (course) {
            const temp = document.createElement('div');
            temp.innerHTML = createCourseCardHtml(course, true);
            grid.appendChild(temp.firstElementChild);
        }
    });
    
    bootstrap.Modal.getInstance(document.getElementById('futureCoursesModal')).hide();
    updateLiveStats();
    updatePrerequisites();
}

// ===== UI Helpers =====
function showCustomLoadingModal(text) {
    document.getElementById('customLoadingText').textContent = text;
    document.getElementById('customLoadingModal').classList.add('show');
}

function hideCustomLoadingModal() {
    document.getElementById('customLoadingModal').classList.remove('show');
}

function showAlert(message, type = 'info') {
    const container = document.getElementById('alertContainer');
    if (!container) return;
    
    const id = 'alert-' + Date.now();
    const icons = { success: 'check-circle', danger: 'x-circle', warning: 'exclamation-triangle', info: 'info-circle' };
    
    container.insertAdjacentHTML('beforeend', `
        <div id="${id}" class="alert alert-${type} alert-dismissible fade show shadow-sm border-0 rounded-3" role="alert">
            <i class="bi bi-${icons[type]}-fill me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    setTimeout(() => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('show');
            setTimeout(() => el.remove(), 300);
        }
    }, 5000);
}

// ===== Export Functions =====
function exportResults(format) {
    const studentName = document.getElementById('studentName').value || 'นักศึกษา';
    const gpa = document.getElementById('statGPA').textContent;
    const credits = document.getElementById('statCredits').textContent;
    
    let csvContent = 'data:text/csv;charset=utf-8,';
    csvContent += 'รายงานผลการวิเคราะห์\n\n';
    csvContent += `ชื่อ,${studentName}\n`;
    csvContent += `GPA,${gpa}\n`;
    csvContent += `หน่วยกิต,${credits}\n\n`;
    csvContent += 'รหัสวิชา,ชื่อวิชา,เกรด\n';
    
    Object.entries(courseGrades).forEach(([id, grade]) => {
        const course = coursesData.find(c => c.id === id);
        if (course && grade) {
            csvContent += `${id},${course.thaiName},${grade}\n`;
        }
    });
    
    const link = document.createElement('a');
    link.setAttribute('href', encodeURI(csvContent));
    link.setAttribute('download', `รายงาน_${studentName}_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('ส่งออกไฟล์สำเร็จ', 'success');
}

function printResults() {
    const resultsSection = document.getElementById('resultsSection');
    if (resultsSection.classList.contains('d-none')) {
        showAlert('กรุณาวิเคราะห์ข้อมูลก่อนพิมพ์', 'warning');
        return;
    }
    
    const studentName = document.getElementById('studentName').value || 'นักศึกษา';
    const gpa = document.getElementById('statGPA').textContent;
    const credits = document.getElementById('statCredits').textContent;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>รายงาน - ${studentName}</title>
            <style>
                body { font-family: 'Sarabun', sans-serif; padding: 40px; }
                h1 { color: #4f46e5; }
                .stat { display: inline-block; margin-right: 30px; }
                .stat-value { font-size: 24px; font-weight: bold; color: #4f46e5; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                th { background: #4f46e5; color: white; }
            </style>
        </head>
        <body>
            <h1>📊 รายงานผลการวิเคราะห์</h1>
            <p><strong>ชื่อ:</strong> ${studentName}</p>
            <div class="stat"><span class="stat-value">${gpa}</span><br>GPA</div>
            <div class="stat"><span class="stat-value">${credits}</span><br>หน่วยกิต</div>
            <table>
                <tr><th>รหัสวิชา</th><th>ชื่อวิชา</th><th>เกรด</th></tr>
                ${Object.entries(courseGrades).map(([id, grade]) => {
                    const c = coursesData.find(x => x.id === id);
                    return c && grade ? `<tr><td>${id}</td><td>${c.thaiName}</td><td>${grade}</td></tr>` : '';
                }).join('')}
            </table>
            <p style="margin-top: 30px; color: #999;">พิมพ์เมื่อ ${new Date().toLocaleString('th-TH')}</p>
        </body>
        </html>
    `);
    printWindow.document.close();
    setTimeout(() => { printWindow.focus(); printWindow.print(); }, 500);
}
</script>
{% endblock %}
