{% extends "base.html" %}

{% block title %}‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á - {{ super() }}{% endblock %}

{% block content %}
<div class="container">
    <div id="alertContainer"></div>

    <div class="row mb-5">
        <div class="col-12 text-center text-white">
            <h1 class="display-4 fw-bold mb-3">
                <i class="bi bi-cpu-fill"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
            </h1>
            <p class="lead text-white-50">
                Advanced Context-Aware Training System
            </p>
            <p class="text-white-50">
                ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤ ‚Ä¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á DNA ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å-‡∏á‡πà‡∏≤‡∏¢ ‚Ä¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏°‡∏¥‡∏ï‡∏¥
            </p>
        </div>
    </div>

    <!-- System Features Card -->
    <div class="card mb-4 border-0 shadow-lg">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-lg-12 mb-4">
                    <div class="alert alert-info border-0 shadow-sm">
                        <h5 class="alert-heading">
                            <i class="bi bi-stars me-2"></i> 
                            Advanced Context-Aware Training System
                        </h5>
                        <hr>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="feature-icon bg-primary text-white rounded-circle p-2 me-3">
                                        <i class="bi bi-diagram-3"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">üß¨ Course DNA Profiling</h6>
                                        <small class="text-muted">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå DNA ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="feature-icon bg-success text-white rounded-circle p-2 me-3">
                                        <i class="bi bi-camera"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">üì∏ Dynamic Snapshots</h6>
                                        <small class="text-muted">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="feature-icon bg-warning text-white rounded-circle p-2 me-3">
                                        <i class="bi bi-lightbulb"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">üéØ Contextual Learning</h6>
                                        <small class="text-muted">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏£‡∏¥‡∏ö‡∏ó</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="mb-0 mt-3">
                            <i class="bi bi-info-circle me-1"></i>
                            <small>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏é‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Training Card -->
    <div class="card mb-4 shadow-lg">
        <div class="card-body p-5">
            <!-- Upload Section -->
            <div class="row align-items-center mb-5 pb-4 border-bottom">
                <div class="col-lg-7 mb-4 mb-lg-0">
                    <h5 class="fw-bold mb-3 text-primary">
                        <i class="bi bi-cloud-arrow-up-fill me-2"></i> 
                        ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </h5>
                    <p class="text-muted mb-3">
                        ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (.csv, .xlsx)
                    </p>
                    
                    <div class="input-group input-group-lg mb-3">
                        <input class="form-control" type="file" id="fileUpload" accept=".csv, .xlsx, .xls">
                        <button class="btn btn-primary" id="uploadBtn" onclick="uploadFile()" disabled>
                            <span id="uploadSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                            <i class="bi bi-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                        </button>
                    </div>
                    
                    <div class="form-text text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: CSV, Excel (.xlsx, .xls) | ‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 100MB
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0">
                            <i class="bi bi-speedometer2 me-1"></i> 
                            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
                        </h6>
                        <span class="badge bg-secondary-subtle text-secondary" id="model-check-status">
                            <div class="spinner-border spinner-border-sm me-1" role="status"></div>
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...
                        </span>
                    </div>
                    <ul class="list-group list-group-flush border-top">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">
                            <div>
                                <i class="bi bi-cpu me-1"></i>
                                ‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
                            </div>
                            <div id="subject-model-status">
                                <span class="badge bg-secondary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
                            </div>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">
                            <div>
                                <i class="bi bi-database me-1"></i>
                                ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </div>
                            <div id="storage-status">
                                <span class="badge bg-secondary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Actions Section (Initially Hidden) -->
            <div id="actionsCard" class="d-none">
                <h5 class="fw-bold mb-4 text-primary">
                    <i class="bi bi-gear-fill me-2"></i> 
                    ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                </h5>
                
                <!-- File Info Display -->
                <div class="alert alert-light border mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1">
                                <strong>‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î:</strong> 
                                <span id="fileName" class="text-dark"></span>
                            </p>
                            <p class="mb-0" id="fileInfo"></p>
                        </div>
                        <div class="col-md-6">
                            <div id="dataPreview" class="text-end"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="row g-4">
                    <!-- Train Model Button -->
                    <div class="col-lg-4">
                        <div class="card h-100 border-primary shadow-sm">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="bi bi-cpu-fill text-primary" style="font-size: 3rem;"></i>
                                </div>
                                <h6 class="card-title">‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</h6>
                                <p class="card-text small text-muted">
                                    ‡πÉ‡∏ä‡πâ Advanced Context-Aware Training
                                </p>
                              <div class="text-start mb-3">
                                  <div class="form-check form-switch">
                                      <input class="form-check-input" type="checkbox" id="enableGeminiTraining" checked>
                                      <label class="form-check-label" for="enableGeminiTraining">
                                          ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Gemini ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ù‡∏∂‡∏Å
                                      </label>
                                      <span class="badge bg-secondary ms-2" id="geminiTrainingStatusBadge">
                                          <i class="bi bi-hourglass-split"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...
                                      </span>
                                  </div>
                                  <textarea class="form-control mt-2" id="geminiAnalysisGoalInput" rows="2"
                                            placeholder="‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ Gemini ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"></textarea>
                                  <small class="text-muted">
                                      Gemini ‡∏à‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏∂‡∏Å‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏µ‡πâ insight ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                                  </small>
                              </div>
                                <div class="d-grid">
                                    <button class="btn btn-primary" id="trainBtn" onclick="trainModel()">
                                        <span id="trainSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                                        <i class="bi bi-play-circle-fill"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Predict Button -->
                    <div class="col-lg-4">
                        <div class="card h-100 border-success shadow-sm">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="bi bi-magic text-success" style="font-size: 3rem;"></i>
                                </div>
                                <h6 class="card-title">‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h6>
                                <p class="card-text small text-muted">
                                    ‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•
                                </p>
                                <div class="d-grid">
                                    <button class="btn btn-success" id="predictBtn" onclick="predictData()" disabled>
                                        <span id="predictSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                                        <i class="bi bi-graph-up-arrow"></i> ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analyze Button -->
                    <div class="col-lg-4">
                        <div class="card h-100 border-info shadow-sm">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="bi bi-bar-chart-line-fill text-info" style="font-size: 3rem;"></i>
                                </div>
                                <h6 class="card-title">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</h6>
                                <p class="card-text small text-muted">
                                    ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞ Course DNA
                                </p>
                                <div class="d-grid">
                                    <button class="btn btn-info" id="analyzeBtn" onclick="analyzeSubjects()">
                                        <span id="analyzeSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                                        <i class="bi bi-search"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Training Progress (shown during training) -->
                <div id="trainingProgress" class="mt-4 d-none">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h6 class="mb-3">
                                <i class="bi bi-hourglass-split me-2"></i>
                                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•...
                            </h6>
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="progressBar" 
                                     role="progressbar" 
                                     style="width: 0%">
                                    0%
                                </div>
                            </div>
                            <small class="text-muted" id="progressText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Card -->
    <div id="resultsCard" class="card shadow-lg d-none">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-graph-up-arrow me-2"></i> 
                ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
            </h5>
        </div>
        <div class="card-body">
            <!-- Training Results -->
            <div id="trainingResults" class="d-none">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-trophy-fill me-2"></i>
                    ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•
                </h6>
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="display-4 text-success" id="accuracyDisplay">0%</div>
                            <small class="text-muted">Accuracy</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="display-4 text-info" id="precisionDisplay">0%</div>
                            <small class="text-muted">Precision</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="display-4 text-warning" id="recallDisplay">0%</div>
                            <small class="text-muted">Recall</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="display-4 text-primary" id="f1Display">0%</div>
                            <small class="text-muted">F1-Score</small>
                        </div>
                    </div>
                </div>
                
                <div id="trainingDetails" class="alert alert-light">
                    <!-- Training details will be inserted here -->
                </div>
                
                <div id="featureImportance" class="mt-4">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-list-ol me-2"></i>
                        Features ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                    </h6>
                    <div id="featureList"></div>
                </div>

                  <div id="geminiTrainingResult" class="mt-4 d-none">
                      <h6 class="fw-bold mb-3">
                          <i class="bi bi-gem me-2"></i>
                          Gemini Training Insights
                          <span class="badge bg-dark rounded-pill" id="geminiTrainingGoalBadge"></span>
                      </h6>
                      <div class="card border-dark-subtle shadow-sm">
                          <div class="card-body" id="geminiTrainingResultBody">
                              <p class="text-muted mb-0">Gemini ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
                          </div>
                      </div>
                  </div>
            </div>
            
            <!-- Prediction Results -->
            <div id="predictionResults" class="d-none">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-people-fill me-2"></i>
                    ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢
                </h6>
                <div id="summary" class="mb-4"></div>
                
                <ul class="nav nav-tabs mb-3" id="resultTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                                data-bs-target="#overview" type="button">
                            ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="details-tab" data-bs-toggle="tab" 
                                data-bs-target="#details" type="button">
                            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" 
                                data-bs-target="#recommendations" type="button">
                            ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="resultTabContent">
                    <div class="tab-pane fade show active" id="overview">
                        <div id="overviewContent"></div>
                    </div>
                    <div class="tab-pane fade" id="details">
                        <div id="results"></div>
                    </div>
                    <div class="tab-pane fade" id="recommendations">
                        <div id="recommendationsContent"></div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Results -->
            <div id="analysisResults" class="d-none">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-microscope me-2"></i>
                    ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Course DNA
                </h6>
                <div id="analysis-summary" class="mb-3"></div>
                <div id="analysis-recommendations" class="mb-3"></div>
                
                <div class="row" id="analysis-tables">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-danger">
                            <div class="card-header bg-danger text-white">
                                <i class="bi bi-x-circle-fill"></i> ‡∏ß‡∏¥‡∏ä‡∏≤ Killer Courses
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled" id="highFailSubjects"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-success">
                            <div class="card-header bg-success text-white">
                                <i class="bi bi-check-circle-fill"></i> ‡∏ß‡∏¥‡∏ä‡∏≤ Easy Courses
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled" id="easySubjects"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-award-fill"></i> Course Performance Distribution
                    </div>
                    <div class="card-body">
                        <canvas id="courseDistributionChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let currentFilename = '';
let trainingInterval = null;
let geminiAvailableForTraining = false;

// Helper Functions
function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : 'info-circle'}-fill me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    alertContainer.innerHTML = alertHtml;
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        const alert = alertContainer.querySelector('.alert');
        if (alert) {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
        }
    }, 5000);
}

function showLoading(message) {
    const alertContainer = document.getElementById('alertContainer');
    alertContainer.innerHTML = `
        <div class="alert alert-info mb-4" role="alert">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <strong>${message}</strong>
        </div>
    `;
}

function hideLoading() {
    document.getElementById('alertContainer').innerHTML = '';
}

function toggleSpinner(buttonId, show) {
    const button = document.getElementById(buttonId);
    const spinner = button.querySelector('.spinner-border');
    if (show) {
        spinner.classList.remove('d-none');
        button.disabled = true;
    } else {
        spinner.classList.add('d-none');
        button.disabled = false;
    }
}

function renderMarkdown(text) {
    if (!text) return '';
    try {
        if (window.marked) {
            const html = window.marked.parse(text);
            return window.DOMPurify ? DOMPurify.sanitize(html) : html;
        }
        return text.replace(/\n/g, '<br>');
    } catch (error) {
        console.error('Markdown rendering error:', error);
        return text.replace(/\n/g, '<br>');
    }
}

async function refreshGeminiTrainingStatus() {
    try {
        const response = await fetch('/api/config');
        const data = await response.json();
        if (data && data.success !== false) {
            geminiAvailableForTraining = Boolean(data.GEMINI_ENABLED);
        } else {
            geminiAvailableForTraining = false;
        }
    } catch (error) {
        console.warn('Cannot fetch Gemini status:', error);
        geminiAvailableForTraining = false;
    } finally {
        updateGeminiTrainingUI();
    }
}

function updateGeminiTrainingUI() {
    const toggle = document.getElementById('enableGeminiTraining');
    const badge = document.getElementById('geminiTrainingStatusBadge');
    const goalInput = document.getElementById('geminiAnalysisGoalInput');
    
    if (!toggle || !badge) return;
    
    if (!geminiAvailableForTraining) {
        toggle.checked = false;
        toggle.disabled = true;
        badge.className = 'badge bg-danger ms-2';
        badge.innerHTML = '<i class="bi bi-slash-circle"></i> Gemini ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà';
        if (goalInput) {
            goalInput.value = '';
            goalInput.disabled = true;
            goalInput.placeholder = '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Gemini API Key ‡∏Å‡πà‡∏≠‡∏ô';
        }
        return;
    }
    
    toggle.disabled = false;
    if (goalInput) {
        goalInput.disabled = !toggle.checked;
        if (!goalInput.value && toggle.checked) {
            goalInput.placeholder = '‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ Gemini ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)';
        }
    }
    
    if (toggle.checked) {
        badge.className = 'badge bg-success ms-2';
        badge.innerHTML = '<i class="bi bi-lightning-charge-fill"></i> ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
    } else {
        badge.className = 'badge bg-secondary ms-2';
        badge.innerHTML = '<i class="bi bi-pause-circle"></i> ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    checkSystemStatus();
    refreshGeminiTrainingStatus();
    
    // Check status every 10 seconds
    setInterval(checkSystemStatus, 10000);
    
    const geminiToggle = document.getElementById('enableGeminiTraining');
    if (geminiToggle) {
        geminiToggle.addEventListener('change', updateGeminiTrainingUI);
    }
    
    // Enable upload button when file is selected
    document.getElementById('fileUpload').addEventListener('change', function() {
        document.getElementById('uploadBtn').disabled = !this.files.length;
    });
});

// Check system status
async function checkSystemStatus() {
    try {
        // Check models
        const response = await fetch('/api/models');
        const data = await response.json();
        
        if (data.success && data.models && data.models.length > 0) {
            const subjectStatus = document.getElementById('subject-model-status');
            const advancedModels = data.models; // ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô advanced ‡πÅ‡∏•‡πâ‡∏ß
            
            subjectStatus.innerHTML = `
                <span class="badge bg-success">
                    <i class="bi bi-stars"></i> 
                    ${advancedModels.length} AI Models
                </span>
            `;
            
            // Enable predict button
            document.getElementById('predictBtn').disabled = false;
        } else {
            document.getElementById('subject-model-status').innerHTML = `
                <span class="badge bg-warning">
                    <i class="bi bi-exclamation-circle-fill"></i> 
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏°‡πÄ‡∏î‡∏• AI
                </span>
            `;
            document.getElementById('predictBtn').disabled = true;
        }
        
        // Check storage status (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        const storageResponse = await fetch('/api/storage/status');
        const storageData = await storageResponse.json();
        
        const storageStatus = document.getElementById('storage-status');
        if (storageData.connected) {
            storageStatus.innerHTML = `
                <span class="badge bg-success">
                    <i class="bi bi-check-circle-fill"></i> 
                    Cloud R2
                </span>
            `;
        } else {
            storageStatus.innerHTML = `
                <span class="badge bg-info">
                    <i class="bi bi-hdd-fill"></i> 
                    Local
                </span>
            `;
        }
        
    } catch (error) {
        console.error('Error checking status:', error);
    }
}
// Upload file
async function uploadFile() {
    const fileInput = document.getElementById('fileUpload');
    if (fileInput.files.length === 0) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }
    
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...');
    toggleSpinner('uploadBtn', true);
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();

        if (result.success) {
            currentFilename = result.filename;
            document.getElementById('fileName').textContent = result.filename;
            document.getElementById('fileInfo').innerHTML = `
                <span class="badge bg-light text-dark me-2">
                    <i class="bi bi-file-earmark-text"></i> ${result.rows} ‡πÅ‡∏ñ‡∏ß
                </span>
                <span class="badge bg-light text-dark me-2">
                    <i class="bi bi-table"></i> ${result.columns} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                </span>
            `;
            
            // Show sample columns
            if (result.sample_columns) {
                document.getElementById('dataPreview').innerHTML = `
                    <small class="text-muted">
                        ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ${result.sample_columns.slice(0, 5).join(', ')}...
                    </small>
                `;
            }
            
            document.getElementById('actionsCard').classList.remove('d-none');
            showAlert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•', 'success');
        } else {
            showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.error}`, 'danger');
        }
    } catch (error) {
        console.error('Upload error:', error);
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå', 'danger');
    } finally {
        hideLoading();
        toggleSpinner('uploadBtn', false);
    }
}

// Train model with Advanced Context-Aware System
async function trainModel() {
    if (!currentFilename) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }

    const trainBtn = document.getElementById('trainBtn');
    if (trainBtn.disabled) return;

    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Advanced AI Training...');
    toggleSpinner('trainBtn', true);
    
    // Show training progress
    document.getElementById('trainingProgress').classList.remove('d-none');
    simulateTrainingProgress();

    try {
        const geminiToggle = document.getElementById('enableGeminiTraining');
        const geminiGoalInput = document.getElementById('geminiAnalysisGoalInput');
        const shouldUseGemini = geminiToggle && geminiToggle.checked && geminiAvailableForTraining;
        const payload = {
            filename: currentFilename,
            enable_gemini_analysis: shouldUseGemini
        };
        if (shouldUseGemini && geminiGoalInput && geminiGoalInput.value.trim()) {
            payload.gemini_analysis_goal = geminiGoalInput.value.trim();
        }
        
        const response = await fetch('/train', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();

        if (result.success) {
            // Stop progress simulation
            if (trainingInterval) {
                clearInterval(trainingInterval);
                trainingInterval = null;
            }
            
            // Show success
            showAlert(`‚úÖ ‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.model_filename}`, 'success');
            
            // Display training results
            displayTrainingResults(result);
            
            // Update status after 1 second
            setTimeout(() => {
                checkSystemStatus();
            }, 1000);
            
        } else {
            showAlert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.error}`, 'danger');
        }
    } catch (error) {
        console.error('Training error:', error);
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'danger');
    } finally {
        hideLoading();
        toggleSpinner('trainBtn', false);
        document.getElementById('trainingProgress').classList.add('d-none');
        if (trainingInterval) {
            clearInterval(trainingInterval);
            trainingInterval = null;
        }
    }
}

// Simulate training progress
function simulateTrainingProgress() {
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    const stages = [
        { at: 10, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...' },
        { at: 25, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Course DNA Profiles...' },
        { at: 40, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Dynamic Snapshots...' },
        { at: 60, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Contextual Features...' },
        { at: 80, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏∂‡∏Å Ensemble Models...' },
        { at: 95, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' }
    ];
    
    trainingInterval = setInterval(() => {
        if (progress < 95) {
            progress += Math.random() * 5;
            progress = Math.min(95, progress);
            
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
            
            // Update stage text
            for (let stage of stages) {
                if (progress >= stage.at && progress < stage.at + 15) {
                    progressText.textContent = stage.text;
                    break;
                }
            }
        }
    }, 500);
}

// Display training results
function displayTrainingResults(result) {
    document.getElementById('resultsCard').classList.remove('d-none');
    document.getElementById('trainingResults').classList.remove('d-none');
    document.getElementById('predictionResults').classList.add('d-none');
    document.getElementById('analysisResults').classList.add('d-none');
    
    // Display metrics
    document.getElementById('accuracyDisplay').textContent = (result.accuracy * 100).toFixed(1) + '%';
    document.getElementById('precisionDisplay').textContent = (result.precision * 100).toFixed(1) + '%';
    document.getElementById('recallDisplay').textContent = (result.recall * 100).toFixed(1) + '%';
    document.getElementById('f1Display').textContent = (result.f1_score * 100).toFixed(1) + '%';
    
    // Display training details
    document.getElementById('trainingDetails').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p class="mb-1"><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•:</strong> ${result.model_filename}</p>
                <p class="mb-1"><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</strong> ${result.training_samples} samples</p>
                <p class="mb-1"><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Features:</strong> ${result.features_count} features</p>
            </div>
            <div class="col-md-6">
                <p class="mb-1"><strong>Course Profiles:</strong> ${result.course_profiles_count || 'N/A'} ‡∏ß‡∏¥‡∏ä‡∏≤</p>
                <p class="mb-1"><strong>Training Type:</strong> Advanced Context-Aware</p>
                <p class="mb-1"><strong>Storage:</strong> ${result.storage_provider === 'cloudflare_r2' ? 'Cloud R2' : 'Local'}</p>
            </div>
        </div>
    `;
    
    // Display feature importance
    if (result.feature_importances) {
        const featureList = document.getElementById('featureList');
        let featureHtml = '<div class="row">';
        
        const features = Object.entries(result.feature_importances)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
        
        features.forEach(([feature, importance], index) => {
            const percentage = (importance * 100).toFixed(2);
            featureHtml += `
                <div class="col-md-6 mb-2">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-2">${index + 1}</span>
                        <div class="flex-grow-1">
                            <small>${feature}</small>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <small class="ms-2">${percentage}%</small>
                    </div>
                </div>
            `;
        });
        
        featureHtml += '</div>';
        featureList.innerHTML = featureHtml;
    }
      
      displayGeminiTrainingResult(result.gemini_analysis);
    
    // Scroll to results
    document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
}
  
  function displayGeminiTrainingResult(analysis) {
      const container = document.getElementById('geminiTrainingResult');
      const body = document.getElementById('geminiTrainingResultBody');
      const goalBadge = document.getElementById('geminiTrainingGoalBadge');
      if (!container || !body) return;
      
      if (!analysis) {
          container.classList.add('d-none');
          body.innerHTML = '<p class="text-muted mb-0">Gemini ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>';
          return;
      }
      
      container.classList.remove('d-none');
      if (goalBadge) {
          if (analysis.analysis_goal) {
              goalBadge.style.display = 'inline-block';
              goalBadge.textContent = analysis.analysis_goal;
          } else {
              goalBadge.style.display = 'none';
          }
      }
      
      if (analysis.error) {
          body.innerHTML = `
              <div class="alert alert-warning mb-0">
                  <i class="bi bi-exclamation-triangle me-2"></i>${analysis.error}
              </div>
          `;
          return;
      }
      
      const summary = analysis.dataset_summary || {};
      const gemini = analysis.gemini || {};
      const trainingContext = analysis.training_context || {};
      const keyMetrics = gemini.key_metrics || [];
      const recommendations = gemini.recommendations || [];
      
      const datasetStatsHtml = `
          <div class="row text-center mb-3">
              <div class="col-md-3 mb-3 mb-md-0">
                  <div class="fs-3 fw-bold text-primary">${summary.row_count ?? '-'}</div>
                  <small class="text-muted">‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</small>
              </div>
              <div class="col-md-3 mb-3 mb-md-0">
                  <div class="fs-3 fw-bold text-primary">${summary.column_count ?? '-'}</div>
                  <small class="text-muted">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</small>
              </div>
              <div class="col-md-3 mb-3 mb-md-0">
                  <div class="fs-3 fw-bold text-primary">${trainingContext.prepared_samples ?? '-'}</div>
                  <small class="text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</small>
              </div>
              <div class="col-md-3">
                  <div class="fs-3 fw-bold text-primary">${trainingContext.feature_count ?? '-'}</div>
                  <small class="text-muted">Features</small>
              </div>
          </div>
      `;
      
      let modelMetricsHtml = '';
      const modelMetrics = trainingContext.model_metrics;
      if (modelMetrics) {
          if (typeof modelMetrics.accuracy === 'number') {
              modelMetricsHtml = `
                  <div class="mb-3">
                      <h6 class="text-muted mb-2"><i class="bi bi-speedometer2 me-1"></i>Performance</h6>
                      <div class="d-flex flex-wrap gap-3">
                          <span class="badge bg-success-subtle text-success-emphasis">Accuracy ${(modelMetrics.accuracy * 100).toFixed(1)}%</span>
                          <span class="badge bg-info-subtle text-info-emphasis">Precision ${(modelMetrics.precision * 100).toFixed(1)}%</span>
                          <span class="badge bg-warning-subtle text-warning-emphasis">Recall ${(modelMetrics.recall * 100).toFixed(1)}%</span>
                          <span class="badge bg-primary-subtle text-primary-emphasis">F1 ${(modelMetrics.f1_score * 100).toFixed(1)}%</span>
                      </div>
                  </div>
              `;
          } else {
              const perModel = Object.entries(modelMetrics).map(([name, metrics]) => `
                  <li>${name}: ${(metrics.accuracy * 100).toFixed(1)}% acc / ${(metrics.f1_score * 100).toFixed(1)}% F1</li>
              `).join('');
              modelMetricsHtml = `
                  <div class="mb-3">
                      <h6 class="text-muted mb-2"><i class="bi bi-bezier me-1"></i>‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•</h6>
                      <ul class="mb-0">${perModel}</ul>
                  </div>
              `;
          }
      }
      
      let keyMetricsHtml = '';
      if (keyMetrics.length > 0) {
          keyMetricsHtml = `
              <div class="row row-cols-1 row-cols-md-3 g-3 mb-3">
                  ${keyMetrics.map(metric => `
                      <div class="col">
                          <div class="p-3 rounded border bg-light h-100">
                              <div class="text-muted small">${metric.label || '-'}</div>
                              <div class="fw-bold fs-5">${metric.value || '-'}</div>
                              ${metric.trend ? `<small class="text-muted">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°: ${metric.trend}</small>` : ''}
                          </div>
                      </div>
                  `).join('')}
              </div>
          `;
      }
      
      let recommendationHtml = '';
      if (recommendations.length > 0) {
          recommendationHtml = `
              <div class="mt-3">
                  <h6 class="text-muted"><i class="bi bi-lightbulb me-1"></i>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å Gemini</h6>
                  <ul class="mb-0">
                      ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                  </ul>
              </div>
          `;
      }
      
      body.innerHTML = `
          ${datasetStatsHtml}
          ${modelMetricsHtml}
          ${keyMetricsHtml}
          <div class="mt-3 markdown-body">
              ${gemini.analysis_markdown ? renderMarkdown(gemini.analysis_markdown) : '<p class="text-muted mb-0">Gemini ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>'}
          </div>
          ${recommendationHtml}
          ${analysis.generated_at ? `<div class="text-end text-muted small mt-3">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(analysis.generated_at).toLocaleString()}</div>` : ''}
      `;
  }

// Predict data
async function predictData() {
    if (!currentFilename) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }
    
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ Advanced AI Model...');
    toggleSpinner('predictBtn', true);

    try {
        // Get available models
        const modelsResponse = await fetch('/api/models');
        const modelsData = await modelsResponse.json();
        
        if (!modelsData.success || modelsData.models.length === 0) {
            showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            hideLoading();
            toggleSpinner('predictBtn', false);
            return;
        }
        
        // ‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏£‡∏Å (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
        const modelFilename = modelsData.models[0].filename;
        console.log('Using Advanced AI model:', modelFilename);

        const response = await fetch('/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                filename: currentFilename, 
                model_filename: modelFilename 
            })
        });
        const result = await response.json();

        if (result.success) {
            displayPredictionResults(result.results, result.summary);
            showAlert(`‚úÖ AI ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Course DNA: ${result.course_profiles_used} profiles)`, 'success');
        } else {
            showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.error}`, 'danger');
        }
    } catch (error) {
        console.error('Prediction error:', error);
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢', 'danger');
    } finally {
        hideLoading();
        toggleSpinner('predictBtn', false);
    }
}

// Display prediction results
function displayPredictionResults(results, summary) {
    document.getElementById('resultsCard').classList.remove('d-none');
    document.getElementById('predictionResults').classList.remove('d-none');
    document.getElementById('trainingResults').classList.add('d-none');
    document.getElementById('analysisResults').classList.add('d-none');

    // Summary
    const summaryDiv = document.getElementById('summary');
    summaryDiv.innerHTML = `
        <div class="row text-center">
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body">
                        <h3 class="text-primary">${summary.total}</h3>
                        <small>‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body">
                        <h3 class="text-success">${summary.predicted_pass}</h3>
                        <small>‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö (${summary.pass_rate.toFixed(1)}%)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-body">
                        <h3 class="text-danger">${summary.predicted_fail}</h3>
                        <small>‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏à‡∏ö</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body">
                        <h3 class="text-warning">${summary.high_risk}</h3>
                        <small>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</small>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Overview content
    const overviewContent = document.getElementById('overviewContent');
    overviewContent.innerHTML = `
        <canvas id="predictionChart" height="100"></canvas>
    `;
    
    // Create chart
    setTimeout(() => {
        const ctx = document.getElementById('predictionChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö', '‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏à‡∏ö'],
                datasets: [{
                    data: [summary.predicted_pass, summary.predicted_fail],
                    backgroundColor: ['#28a745', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }, 100);

    // Details table
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                        <th>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</th>
                        <th>GPA</th>
                        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô</th>
                        <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
                        <th>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</th>
                    </tr>
                </thead>
                <tbody>
                    ${results.slice(0, 100).map(r => `
                        <tr>
                            <td>${r.‡∏ä‡∏∑‡πà‡∏≠}</td>
                            <td>
                                <span class="badge bg-${r.‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ === '‡∏à‡∏ö' ? 'success' : 'danger'}">
                                    ${r.‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢}
                                </span>
                            </td>
                            <td>${r.‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢.toFixed(2)}</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" 
                                         style="width: ${r.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô.‡∏à‡∏ö * 100}%">
                                        ${(r.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô.‡∏à‡∏ö * 100).toFixed(0)}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-${
                                    r.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á === '‡∏ï‡πà‡∏≥' ? 'success' :
                                    r.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á === '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' ? 'warning' : 'danger'
                                }">
                                    ${r.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="showRecommendations('${encodeURIComponent(JSON.stringify(r.‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥))}')">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    // Recommendations summary
    const recommendationsContent = document.getElementById('recommendationsContent');
    const allRecommendations = [...new Set(results.flatMap(r => r.‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥))];
    recommendationsContent.innerHTML = `
        <div class="row">
            ${allRecommendations.map(rec => `
                <div class="col-md-6 mb-3">
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb-fill me-2"></i>
                        ${rec}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
}

// Show individual recommendations
function showRecommendations(encodedRecs) {
    const recommendations = JSON.parse(decodeURIComponent(encodedRecs));
    let html = '<ul class="list-unstyled">';
    recommendations.forEach(rec => {
        html += `<li><i class="bi bi-check-circle text-success me-2"></i>${rec}</li>`;
    });
    html += '</ul>';
    
    // Use Bootstrap modal or alert
    showAlert(html, 'info');
}

// Analyze subjects with Course DNA
async function analyzeSubjects() {
    if (!currentFilename) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }

    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Course DNA ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤...');
    toggleSpinner('analyzeBtn', true);
    
    try {
        const response = await fetch('/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: currentFilename })
        });
        const result = await response.json();
        
        if (result.success) {
            displayAnalysisResults(result);
            showAlert('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Course DNA ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        } else {
            showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.error}`, 'danger');
        }
    } catch (error) {
        console.error('Analysis error:', error);
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', 'danger');
    } finally {
        hideLoading();
        toggleSpinner('analyzeBtn', false);
    }
}

// Display analysis results
function displayAnalysisResults(data) {
    document.getElementById('resultsCard').classList.remove('d-none');
    document.getElementById('analysisResults').classList.remove('d-none');
    document.getElementById('trainingResults').classList.add('d-none');
    document.getElementById('predictionResults').classList.add('d-none');
    
    // Summary
    const summaryDiv = document.getElementById('analysis-summary');
    summaryDiv.innerHTML = `
        <div class="alert alert-light">
            <div class="row">
                <div class="col-md-3">
                    <strong>‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${data.overall_stats.total_students} ‡∏Ñ‡∏ô
                </div>
                <div class="col-md-3">
                    <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${data.overall_stats.total_subjects} ‡∏ß‡∏¥‡∏ä‡∏≤
                </div>
                <div class="col-md-3">
                    <strong>GPA ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</strong> ${data.overall_stats.avg_gpa.toFixed(2)}
                </div>
                <div class="col-md-3">
                    <strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏Å‡∏£‡∏ß‡∏°:</strong> ${(data.overall_stats.overall_fail_rate * 100).toFixed(1)}%
                </div>
            </div>
        </div>
    `;

    // Recommendations
    const recommendationsDiv = document.getElementById('analysis-recommendations');
    if (data.recommendations && data.recommendations.length > 0) {
        recommendationsDiv.innerHTML = `
            <div class="alert alert-warning">
                <h6 class="alert-heading">
                    <i class="bi bi-lightbulb-fill me-2"></i>
                    ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Course DNA
                </h6>
                <ul class="mb-0">
                    ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    // Killer courses (high fail rate)
    const highFailList = document.getElementById('highFailSubjects');
    if (data.problem_subjects.high_fail_rate.length > 0) {
        highFailList.innerHTML = data.problem_subjects.high_fail_rate.slice(0, 10).map(s => `
            <li class="mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span>${s.subject}</span>
                    <div>
                        <span class="badge bg-danger">‡∏ï‡∏Å ${(s.fail_rate * 100).toFixed(1)}%</span>
                        <span class="badge bg-secondary ms-1">GPA ${s.average.toFixed(2)}</span>
                    </div>
                </div>
                <small class="text-muted">Difficulty Score: ${(s.fail_rate * 2 + (4 - s.average) / 4).toFixed(2)}</small>
            </li>
        `).join('');
    } else {
        highFailList.innerHTML = '<p class="text-muted mb-0">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ Killer</p>';
    }

    // Easy courses
    const easySubjectsList = document.getElementById('easySubjects');
    if (data.excellent_subjects && data.excellent_subjects.length > 0) {
        easySubjectsList.innerHTML = data.excellent_subjects.slice(0, 10).map(s => `
            <li class="mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span>${s.subject}</span>
                    <div>
                        <span class="badge bg-success">GPA ${s.average.toFixed(2)}</span>
                        <span class="badge bg-info ms-1">${s.num_students} ‡∏Ñ‡∏ô</span>
                    </div>
                </div>
                <small class="text-muted">Pass Rate: ${((1 - s.fail_rate) * 100).toFixed(1)}%</small>
            </li>
        `).join('');
    } else {
        easySubjectsList.innerHTML = '<p class="text-muted mb-0">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ Easy</p>';
    }

    // Create distribution chart
    setTimeout(() => {
        const ctx = document.getElementById('courseDistributionChart').getContext('2d');
        
        // Prepare data for chart
        const categories = Object.keys(data.category_summary || {});
        const avgGPAs = categories.map(cat => data.category_summary[cat].avg_gpa);
        const failRates = categories.map(cat => data.category_summary[cat].avg_fail_rate * 100);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [
                    {
                        label: 'GPA ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢',
                        data: avgGPAs,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏Å (%)',
                        data: failRates,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        max: 4
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        max: 100,
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }, 100);
    
    document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
