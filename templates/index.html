{% extends "base.html" %}

{% block title %}‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• AI - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤{% endblock %}

{% block custom_css %}
<style>
    /* Page Header */
    .page-header {
        padding: 2rem 0 1rem;
    }
    
    .page-header h1 {
        font-size: 2.25rem;
    }
    
    /* System Features Alert */
    .features-alert {
        background: white;
        border-radius: var(--radius-xl);
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-left: 4px solid var(--primary);
    }
    
    .feature-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 0;
    }
    
    .feature-item-icon {
        width: 50px;
        height: 50px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .feature-item h6 {
        margin-bottom: 0.25rem;
        font-weight: 600;
        color: var(--gray-800);
    }
    
    .feature-item small {
        color: var(--gray-500);
    }
    
    /* Upload Section */
    .upload-section {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        padding: 2rem;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--gray-200);
    }
    
    .section-number {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.25rem;
        flex-shrink: 0;
    }
    
    .section-title h5 {
        margin-bottom: 0.25rem;
        font-weight: 700;
        color: var(--gray-800);
    }
    
    .section-title small {
        color: var(--gray-500);
    }
    
    /* File Upload */
    .file-input-wrapper {
        position: relative;
    }
    
    .form-control[type="file"] {
        padding: 1rem;
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius-lg);
        background: var(--gray-50);
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .form-control[type="file"]:hover {
        border-color: var(--primary);
        background: var(--primary-bg);
    }
    
    .form-control[type="file"]:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.15);
    }
    
    /* Status Cards */
    .status-card {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        height: 100%;
    }
    
    .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .status-item:last-child {
        border-bottom: none;
    }
    
    .status-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--gray-600);
        font-weight: 500;
    }
    
    /* Actions Section */
    .actions-section {
        background: var(--gray-50);
        border-radius: var(--radius-xl);
        padding: 2rem;
        margin-top: 1.5rem;
    }
    
    .action-card {
        background: white;
        border-radius: var(--radius-xl);
        padding: 2rem;
        text-align: center;
        height: 100%;
        border: 2px solid var(--gray-200);
        transition: all 0.3s;
    }
    
    .action-card:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-lg);
    }
    
    .action-icon {
        width: 80px;
        height: 80px;
        border-radius: var(--radius-xl);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.25rem;
        font-size: 2.5rem;
    }
    
    .action-card h6 {
        font-weight: 700;
        color: var(--gray-800);
        margin-bottom: 0.75rem;
    }
    
    .action-card p {
        color: var(--gray-500);
        font-size: 0.9rem;
        margin-bottom: 1.25rem;
    }
    
    /* Training Progress */
    .training-progress {
        background: var(--primary-bg);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .training-progress h6 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--primary);
        margin-bottom: 1rem;
    }
    
    .progress {
        height: 1.5rem;
        border-radius: var(--radius);
        background: white;
    }
    
    .progress-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    /* Results Section */
    .results-section {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
        margin-top: 2rem;
    }
    
    .results-header {
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        padding: 1.5rem 2rem;
    }
    
    .results-body {
        padding: 2rem;
    }
    
    /* Metrics Grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .metric-card {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        text-align: center;
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    
    .metric-value.text-primary { color: var(--primary); }
    .metric-value.text-success { color: var(--success); }
    .metric-value.text-warning { color: var(--warning); }
    .metric-value.text-info { color: var(--info); }
    
    .metric-label {
        color: var(--gray-500);
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    /* Feature Importance */
    .feature-importance {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
    }
    
    .feature-bar {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }
    
    .feature-rank {
        width: 28px;
        height: 28px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
        flex-shrink: 0;
    }
    
    .feature-name {
        width: 200px;
        font-size: 0.875rem;
        color: var(--gray-700);
        flex-shrink: 0;
    }
    
    .feature-progress {
        flex-grow: 1;
        height: 20px;
    }
    
    .feature-value {
        width: 60px;
        text-align: right;
        font-weight: 600;
        color: var(--gray-600);
        font-size: 0.875rem;
    }
    
    /* Gemini Section */
    .gemini-section {
        background: linear-gradient(135deg, #1e1e2e, #2d2d3e);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .gemini-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #a78bfa;
        margin-bottom: 1rem;
    }
    
    .gemini-content {
        color: #e2e8f0;
        line-height: 1.7;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .feature-name {
            width: 120px;
        }
        
        .feature-bar {
            flex-wrap: wrap;
        }
    }
    
    /* Toggle Switch */
    .form-switch .form-check-input {
        width: 3rem;
        height: 1.5rem;
        cursor: pointer;
    }
    
    .form-switch .form-check-input:checked {
        background-color: var(--primary);
        border-color: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1><i class="bi bi-cpu-fill me-2"></i>‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</h1>
    <p class="lead">Advanced Context-Aware Training System</p>
</div>

<!-- System Features -->
<div class="features-alert">
    <h5 class="fw-bold text-primary mb-3">
        <i class="bi bi-stars me-2"></i>Advanced Context-Aware Training System
    </h5>
    <div class="row">
        <div class="col-md-4">
            <div class="feature-item">
                <div class="feature-item-icon bg-primary text-white">
                    <i class="bi bi-diagram-3"></i>
                </div>
                <div>
                    <h6>üß¨ Course DNA Profiling</h6>
                    <small>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå DNA ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="feature-item">
                <div class="feature-item-icon bg-success text-white">
                    <i class="bi bi-camera"></i>
                </div>
                <div>
                    <h6>üì∏ Dynamic Snapshots</h6>
                    <small>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="feature-item">
                <div class="feature-item-icon bg-warning text-white">
                    <i class="bi bi-lightbulb"></i>
                </div>
                <div>
                    <h6>üéØ Contextual Learning</h6>
                    <small>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Training Card -->
<div class="upload-section">
    <!-- Upload Section -->
    <div class="section-header">
        <div class="section-number">1</div>
        <div class="section-title">
            <h5>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
            <small>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (.csv, .xlsx)</small>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-7 mb-4 mb-lg-0">
            <div class="file-input-wrapper mb-3">
                <input class="form-control form-control-lg" type="file" id="fileUpload" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <button class="btn btn-primary btn-lg flex-grow-1" id="uploadBtn" onclick="uploadFile()" disabled>
                    <span id="uploadSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                    <i class="bi bi-cloud-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
                </button>
            </div>
            <small class="text-muted d-block mt-2">
                <i class="bi bi-info-circle me-1"></i>
                ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: CSV, Excel (.xlsx, .xls) | ‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 100MB
            </small>
        </div>
        
        <div class="col-lg-5">
            <div class="status-card">
                <h6 class="fw-bold text-gray-700 mb-3">
                    <i class="bi bi-speedometer2 me-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
                    <span class="badge bg-secondary-subtle text-secondary ms-2" id="model-check-status">
                        <i class="bi bi-hourglass-split me-1"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                    </span>
                </h6>
                <div class="status-item">
                    <span class="status-label">
                        <i class="bi bi-cpu"></i> ‡πÇ‡∏°‡πÄ‡∏î‡∏• AI
                    </span>
                    <span id="subject-model-status">
                        <span class="badge bg-secondary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">
                        <i class="bi bi-database"></i> ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </span>
                    <span id="storage-status">
                        <span class="badge bg-secondary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions Section -->
    <div id="actionsCard" class="actions-section d-none">
        <div class="section-header">
            <div class="section-number">2</div>
            <div class="section-title">
                <h5>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h5>
                <small>‡πÑ‡∏ü‡∏•‡πå: <strong id="fileName"></strong> | <span id="fileInfo"></span></small>
            </div>
        </div>
        
        <div class="row g-4">
            <!-- Train Model -->
            <div class="col-lg-4">
                <div class="action-card">
                    <div class="action-icon bg-primary text-white">
                        <i class="bi bi-cpu-fill"></i>
                    </div>
                    <h6>‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• AI</h6>
                    <p>‡πÉ‡∏ä‡πâ Advanced Context-Aware Training</p>
                    
                    <div class="text-start mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableGeminiTraining" checked>
                            <label class="form-check-label" for="enableGeminiTraining">
                                ‡πÉ‡∏ä‡πâ Gemini ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                            </label>
                            <span class="badge bg-secondary ms-2" id="geminiTrainingStatusBadge">
                                <i class="bi bi-hourglass-split"></i>
                            </span>
                        </div>
                        <textarea class="form-control form-control-sm mt-2" id="geminiAnalysisGoalInput" rows="2"
                                  placeholder="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"></textarea>
                    </div>
                    
                    <button class="btn btn-primary w-100" id="trainBtn" onclick="trainModel()">
                        <span id="trainSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                        <i class="bi bi-play-circle-fill"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•
                    </button>
                </div>
            </div>
            
            <!-- Predict -->
            <div class="col-lg-4">
                <div class="action-card">
                    <div class="action-icon bg-success text-white">
                        <i class="bi bi-magic"></i>
                    </div>
                    <h6>‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h6>
                    <p>‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•</p>
                    <button class="btn btn-success w-100" id="predictBtn" onclick="predictData()" disabled>
                        <span id="predictSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                        <i class="bi bi-graph-up-arrow"></i> ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•
                    </button>
                </div>
            </div>
            
            <!-- Analyze -->
            <div class="col-lg-4">
                <div class="action-card">
                    <div class="action-icon bg-info text-white">
                        <i class="bi bi-bar-chart-line-fill"></i>
                    </div>
                    <h6>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</h6>
                    <p>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞ Course DNA</p>
                    <button class="btn btn-info w-100" id="analyzeBtn" onclick="analyzeSubjects()">
                        <span id="analyzeSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                        <i class="bi bi-search"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Training Progress -->
        <div id="trainingProgress" class="training-progress d-none">
            <h6>
                <i class="bi bi-hourglass-split"></i>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•...
            </h6>
            <div class="progress mb-2">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     id="progressBar" 
                     role="progressbar" 
                     style="width: 0%">0%</div>
            </div>
            <small class="text-primary" id="progressText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</small>
        </div>
    </div>
</div>

<!-- Results Section -->
<div id="resultsCard" class="results-section d-none">
    <div class="results-header">
        <h5 class="mb-0">
            <i class="bi bi-graph-up-arrow me-2"></i>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        </h5>
    </div>
    <div class="results-body">
        <!-- Training Results -->
        <div id="trainingResults" class="d-none">
            <h5 class="fw-bold text-primary mb-4">
                <i class="bi bi-trophy-fill me-2"></i>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•
            </h5>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value text-success" id="accuracyDisplay">0%</div>
                    <div class="metric-label">Accuracy</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value text-primary" id="precisionDisplay">0%</div>
                    <div class="metric-label">Precision</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value text-warning" id="recallDisplay">0%</div>
                    <div class="metric-label">Recall</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value text-info" id="f1Display">0%</div>
                    <div class="metric-label">F1-Score</div>
                </div>
            </div>
            
            <div class="alert alert-light mb-4" id="trainingDetails"></div>
            
            <div id="featureImportance" class="feature-importance">
                <h6 class="fw-bold mb-3">
                    <i class="bi bi-list-ol me-2"></i>Features ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                </h6>
                <div id="featureList"></div>
            </div>
            
            <div id="geminiTrainingResult" class="gemini-section d-none">
                <div class="gemini-header">
                    <i class="bi bi-gem"></i>
                    <h6 class="mb-0">Gemini Training Insights</h6>
                    <span class="badge bg-purple ms-2" id="geminiTrainingGoalBadge"></span>
                </div>
                <div class="gemini-content" id="geminiTrainingResultBody"></div>
            </div>
        </div>
        
        <!-- Prediction Results -->
        <div id="predictionResults" class="d-none">
            <h5 class="fw-bold text-primary mb-4">
                <i class="bi bi-people-fill me-2"></i>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢
            </h5>
            <div id="summary" class="mb-4"></div>
            
            <ul class="nav nav-tabs mb-3" id="resultTabs">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#details">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#recommendations">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</button>
                </li>
            </ul>
            
            <div class="tab-content">
                <div class="tab-pane fade show active" id="overview">
                    <div id="overviewContent"></div>
                </div>
                <div class="tab-pane fade" id="details">
                    <div id="results"></div>
                </div>
                <div class="tab-pane fade" id="recommendations">
                    <div id="recommendationsContent"></div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Results -->
        <div id="analysisResults" class="d-none">
            <h5 class="fw-bold text-primary mb-4">
                <i class="bi bi-microscope me-2"></i>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Course DNA
            </h5>
            <div id="analysis-summary" class="mb-3"></div>
            <div id="analysis-recommendations" class="mb-3"></div>
            
            <div class="row mb-4" id="analysis-tables">
                <div class="col-md-6 mb-3">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <i class="bi bi-x-circle-fill me-1"></i> ‡∏ß‡∏¥‡∏ä‡∏≤ Killer Courses
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0" id="highFailSubjects"></ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <i class="bi bi-check-circle-fill me-1"></i> ‡∏ß‡∏¥‡∏ä‡∏≤ Easy Courses
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0" id="easySubjects"></ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-award-fill me-1"></i> Course Performance Distribution
                </div>
                <div class="card-body">
                    <canvas id="courseDistributionChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
// Global variables
let currentFilename = '';
let trainingInterval = null;
let geminiAvailableForTraining = false;

// Toggle Spinner
function toggleSpinner(buttonId, show) {
    const button = document.getElementById(buttonId);
    const spinner = button.querySelector('.spinner-border');
    if (show) {
        spinner.classList.remove('d-none');
        button.disabled = true;
    } else {
        spinner.classList.add('d-none');
        button.disabled = false;
    }
}

// Render Markdown
function renderMarkdown(text) {
    if (!text) return '';
    try {
        if (window.marked) {
            const html = window.marked.parse(text);
            return window.DOMPurify ? DOMPurify.sanitize(html) : html;
        }
        return text.replace(/\n/g, '<br>');
    } catch (error) {
        return text.replace(/\n/g, '<br>');
    }
}

// Gemini Status
async function refreshGeminiTrainingStatus() {
    try {
        const response = await fetch('/api/config');
        const data = await response.json();
        geminiAvailableForTraining = Boolean(data && data.GEMINI_ENABLED);
    } catch (error) {
        geminiAvailableForTraining = false;
    } finally {
        updateGeminiTrainingUI();
    }
}

function updateGeminiTrainingUI() {
    const toggle = document.getElementById('enableGeminiTraining');
    const badge = document.getElementById('geminiTrainingStatusBadge');
    const goalInput = document.getElementById('geminiAnalysisGoalInput');
    
    if (!toggle || !badge) return;
    
    if (!geminiAvailableForTraining) {
        toggle.checked = false;
        toggle.disabled = true;
        badge.className = 'badge bg-danger ms-2';
        badge.innerHTML = '<i class="bi bi-slash-circle"></i> ‡∏õ‡∏¥‡∏î';
        if (goalInput) {
            goalInput.disabled = true;
            goalInput.placeholder = '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Gemini API Key ‡∏Å‡πà‡∏≠‡∏ô';
        }
        return;
    }
    
    toggle.disabled = false;
    if (goalInput) {
        goalInput.disabled = !toggle.checked;
    }
    
    if (toggle.checked) {
        badge.className = 'badge bg-success ms-2';
        badge.innerHTML = '<i class="bi bi-check-circle"></i> ‡πÄ‡∏õ‡∏¥‡∏î';
    } else {
        badge.className = 'badge bg-secondary ms-2';
        badge.innerHTML = '<i class="bi bi-pause-circle"></i> ‡∏õ‡∏¥‡∏î';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    checkSystemStatus();
    refreshGeminiTrainingStatus();
    setInterval(checkSystemStatus, 10000);
    
    const geminiToggle = document.getElementById('enableGeminiTraining');
    if (geminiToggle) {
        geminiToggle.addEventListener('change', updateGeminiTrainingUI);
    }
    
    document.getElementById('fileUpload').addEventListener('change', function() {
        document.getElementById('uploadBtn').disabled = !this.files.length;
    });
});

// Check system status
async function checkSystemStatus() {
    try {
        const response = await fetch('/api/models');
        const data = await response.json();
        
        if (data.success && data.models && data.models.length > 0) {
            document.getElementById('subject-model-status').innerHTML = `
                <span class="badge bg-success">
                    <i class="bi bi-check-circle me-1"></i>${data.models.length} ‡πÇ‡∏°‡πÄ‡∏î‡∏•
                </span>
            `;
            document.getElementById('predictBtn').disabled = false;
        } else {
            document.getElementById('subject-model-status').innerHTML = `
                <span class="badge bg-warning">
                    <i class="bi bi-exclamation-circle me-1"></i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏°‡πÄ‡∏î‡∏•
                </span>
            `;
            document.getElementById('predictBtn').disabled = true;
        }
        
        const storageResponse = await fetch('/api/storage/status');
        const storageData = await storageResponse.json();
        
        if (storageData.connected) {
            document.getElementById('storage-status').innerHTML = `
                <span class="badge bg-success">
                    <i class="bi bi-cloud-check me-1"></i>Cloud R2
                </span>
            `;
        } else {
            document.getElementById('storage-status').innerHTML = `
                <span class="badge bg-info">
                    <i class="bi bi-hdd me-1"></i>Local
                </span>
            `;
        }
        
        document.getElementById('model-check-status').innerHTML = `
            <i class="bi bi-check-circle me-1"></i>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
        `;
        document.getElementById('model-check-status').className = 'badge bg-success-subtle text-success ms-2';
        
    } catch (error) {
        console.error('Error checking status:', error);
    }
}

// Upload file
async function uploadFile() {
    const fileInput = document.getElementById('fileUpload');
    if (fileInput.files.length === 0) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }
    
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...');
    toggleSpinner('uploadBtn', true);
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();

        if (result.success) {
            currentFilename = result.filename;
            document.getElementById('fileName').textContent = result.filename;
            document.getElementById('fileInfo').innerHTML = `
                <span class="badge bg-light text-dark me-2">
                    <i class="bi bi-file-earmark-text me-1"></i>${result.rows} ‡πÅ‡∏ñ‡∏ß
                </span>
                <span class="badge bg-light text-dark">
                    <i class="bi bi-table me-1"></i>${result.columns} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                </span>
            `;
            
            document.getElementById('actionsCard').classList.remove('d-none');
            showAlert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•', 'success');
        } else {
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå', 'danger');
    } finally {
        hideLoading();
        toggleSpinner('uploadBtn', false);
    }
}

// Train model
async function trainModel() {
    if (!currentFilename) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }

    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•...');
    toggleSpinner('trainBtn', true);
    
    document.getElementById('trainingProgress').classList.remove('d-none');
    simulateTrainingProgress();

    try {
        const geminiToggle = document.getElementById('enableGeminiTraining');
        const geminiGoalInput = document.getElementById('geminiAnalysisGoalInput');
        const shouldUseGemini = geminiToggle && geminiToggle.checked && geminiAvailableForTraining;
        
        const payload = {
            filename: currentFilename,
            enable_gemini_analysis: shouldUseGemini
        };
        
        if (shouldUseGemini && geminiGoalInput && geminiGoalInput.value.trim()) {
            payload.gemini_analysis_goal = geminiGoalInput.value.trim();
        }
        
        const response = await fetch('/train', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();

        if (result.success) {
            if (trainingInterval) {
                clearInterval(trainingInterval);
                trainingInterval = null;
            }
            
            showAlert('‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.model_filename, 'success');
            displayTrainingResults(result);
            
            setTimeout(() => checkSystemStatus(), 1000);
        } else {
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'danger');
    } finally {
        hideLoading();
        toggleSpinner('trainBtn', false);
        document.getElementById('trainingProgress').classList.add('d-none');
        if (trainingInterval) {
            clearInterval(trainingInterval);
            trainingInterval = null;
        }
    }
}

// Simulate training progress
function simulateTrainingProgress() {
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    const stages = [
        { at: 10, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...' },
        { at: 25, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Course DNA Profiles...' },
        { at: 40, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Dynamic Snapshots...' },
        { at: 60, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Contextual Features...' },
        { at: 80, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏∂‡∏Å Ensemble Models...' },
        { at: 95, text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' }
    ];
    
    trainingInterval = setInterval(() => {
        if (progress < 95) {
            progress += Math.random() * 5;
            progress = Math.min(95, progress);
            
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
            
            for (let stage of stages) {
                if (progress >= stage.at && progress < stage.at + 15) {
                    progressText.textContent = stage.text;
                    break;
                }
            }
        }
    }, 500);
}

// Display training results
function displayTrainingResults(result) {
    document.getElementById('resultsCard').classList.remove('d-none');
    document.getElementById('trainingResults').classList.remove('d-none');
    document.getElementById('predictionResults').classList.add('d-none');
    document.getElementById('analysisResults').classList.add('d-none');
    
    document.getElementById('accuracyDisplay').textContent = (result.accuracy * 100).toFixed(1) + '%';
    document.getElementById('precisionDisplay').textContent = (result.precision * 100).toFixed(1) + '%';
    document.getElementById('recallDisplay').textContent = (result.recall * 100).toFixed(1) + '%';
    document.getElementById('f1Display').textContent = (result.f1_score * 100).toFixed(1) + '%';
    
    document.getElementById('trainingDetails').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p class="mb-1"><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•:</strong> ${result.model_filename}</p>
                <p class="mb-1"><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</strong> ${result.training_samples} samples</p>
                <p class="mb-1"><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Features:</strong> ${result.features_count} features</p>
            </div>
            <div class="col-md-6">
                <p class="mb-1"><strong>Course Profiles:</strong> ${result.course_profiles_count || 'N/A'} ‡∏ß‡∏¥‡∏ä‡∏≤</p>
                <p class="mb-1"><strong>Training Type:</strong> Advanced Context-Aware</p>
                <p class="mb-1"><strong>Storage:</strong> ${result.storage_provider === 'cloudflare_r2' ? 'Cloud R2' : 'Local'}</p>
            </div>
        </div>
    `;
    
    if (result.feature_importances) {
        const featureList = document.getElementById('featureList');
        let featureHtml = '';
        
        const features = Object.entries(result.feature_importances)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
        
        features.forEach(([feature, importance], index) => {
            const percentage = (importance * 100).toFixed(2);
            featureHtml += `
                <div class="feature-bar">
                    <span class="feature-rank">${index + 1}</span>
                    <span class="feature-name">${feature}</span>
                    <div class="progress feature-progress">
                        <div class="progress-bar" style="width: ${percentage}%"></div>
                    </div>
                    <span class="feature-value">${percentage}%</span>
                </div>
            `;
        });
        
        featureList.innerHTML = featureHtml;
    }
    
    displayGeminiTrainingResult(result.gemini_analysis);
    document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
}

function displayGeminiTrainingResult(analysis) {
    const container = document.getElementById('geminiTrainingResult');
    const body = document.getElementById('geminiTrainingResultBody');
    const goalBadge = document.getElementById('geminiTrainingGoalBadge');
    
    if (!container || !body) return;
    
    if (!analysis) {
        container.classList.add('d-none');
        return;
    }
    
    container.classList.remove('d-none');
    
    if (goalBadge && analysis.analysis_goal) {
        goalBadge.style.display = 'inline-block';
        goalBadge.textContent = analysis.analysis_goal;
    } else if (goalBadge) {
        goalBadge.style.display = 'none';
    }
    
    if (analysis.error) {
        body.innerHTML = `<div class="alert alert-warning mb-0">${analysis.error}</div>`;
        return;
    }
    
    const gemini = analysis.gemini || {};
    body.innerHTML = gemini.analysis_markdown ? renderMarkdown(gemini.analysis_markdown) : '<p class="mb-0">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>';
}

// Predict data
async function predictData() {
    if (!currentFilename) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }
    
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•...');
    toggleSpinner('predictBtn', true);

    try {
        const modelsResponse = await fetch('/api/models');
        const modelsData = await modelsResponse.json();
        
        if (!modelsData.success || modelsData.models.length === 0) {
            showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ù‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            hideLoading();
            toggleSpinner('predictBtn', false);
            return;
        }
        
        const modelFilename = modelsData.models[0].filename;

        const response = await fetch('/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                filename: currentFilename, 
                model_filename: modelFilename 
            })
        });
        const result = await response.json();

        if (result.success) {
            displayPredictionResults(result.results, result.summary);
            showAlert('‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        } else {
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢', 'danger');
    } finally {
        hideLoading();
        toggleSpinner('predictBtn', false);
    }
}

// Display prediction results
function displayPredictionResults(results, summary) {
    document.getElementById('resultsCard').classList.remove('d-none');
    document.getElementById('predictionResults').classList.remove('d-none');
    document.getElementById('trainingResults').classList.add('d-none');
    document.getElementById('analysisResults').classList.add('d-none');

    document.getElementById('summary').innerHTML = `
        <div class="row g-3">
            <div class="col-md-3">
                <div class="card bg-primary text-white text-center p-3">
                    <div class="fs-2 fw-bold">${summary.total}</div>
                    <div>‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white text-center p-3">
                    <div class="fs-2 fw-bold">${summary.predicted_pass}</div>
                    <div>‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö (${summary.pass_rate.toFixed(1)}%)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white text-center p-3">
                    <div class="fs-2 fw-bold">${summary.predicted_fail}</div>
                    <div>‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏à‡∏ö</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white text-center p-3">
                    <div class="fs-2 fw-bold">${summary.high_risk}</div>
                    <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('overviewContent').innerHTML = `
        <div style="height: 300px;">
            <canvas id="predictionChart"></canvas>
        </div>
    `;
    
    setTimeout(() => {
        const ctx = document.getElementById('predictionChart').getContext('2d');
        const existingChart = Chart.getChart('predictionChart');
        if (existingChart) existingChart.destroy();
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏ö', '‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏à‡∏ö'],
                datasets: [{
                    data: [summary.predicted_pass, summary.predicted_fail],
                    backgroundColor: ['#059669', '#dc2626']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }, 100);

    document.getElementById('results').innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                        <th>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</th>
                        <th>GPA</th>
                        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô</th>
                        <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
                    </tr>
                </thead>
                <tbody>
                    ${results.slice(0, 50).map(r => `
                        <tr>
                            <td>${r.‡∏ä‡∏∑‡πà‡∏≠}</td>
                            <td><span class="badge bg-${r.‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ === '‡∏à‡∏ö' ? 'success' : 'danger'}">${r.‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢}</span></td>
                            <td>${r.‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢.toFixed(2)}</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" style="width: ${r.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô.‡∏à‡∏ö * 100}%">
                                        ${(r.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô.‡∏à‡∏ö * 100).toFixed(0)}%
                                    </div>
                                </div>
                            </td>
                            <td><span class="badge bg-${r.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á === '‡∏ï‡πà‡∏≥' ? 'success' : r.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á === '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' ? 'warning' : 'danger'}">${r.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    const allRecommendations = [...new Set(results.flatMap(r => r.‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥))];
    document.getElementById('recommendationsContent').innerHTML = `
        <div class="row">
            ${allRecommendations.map(rec => `
                <div class="col-md-6 mb-3">
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-lightbulb-fill me-2"></i>${rec}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
}

// Analyze subjects
async function analyzeSubjects() {
    if (!currentFilename) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }

    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Course DNA...');
    toggleSpinner('analyzeBtn', true);
    
    try {
        const response = await fetch('/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: currentFilename })
        });
        const result = await response.json();
        
        if (result.success) {
            displayAnalysisResults(result);
            showAlert('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Course DNA ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        } else {
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', 'danger');
    } finally {
        hideLoading();
        toggleSpinner('analyzeBtn', false);
    }
}

// Display analysis results
function displayAnalysisResults(data) {
    document.getElementById('resultsCard').classList.remove('d-none');
    document.getElementById('analysisResults').classList.remove('d-none');
    document.getElementById('trainingResults').classList.add('d-none');
    document.getElementById('predictionResults').classList.add('d-none');
    
    document.getElementById('analysis-summary').innerHTML = `
        <div class="alert alert-light">
            <div class="row text-center">
                <div class="col-md-3">
                    <strong class="d-block fs-4 text-primary">${data.overall_stats.total_students}</strong>
                    <small class="text-muted">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                </div>
                <div class="col-md-3">
                    <strong class="d-block fs-4 text-primary">${data.overall_stats.total_subjects}</strong>
                    <small class="text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤</small>
                </div>
                <div class="col-md-3">
                    <strong class="d-block fs-4 text-primary">${data.overall_stats.avg_gpa.toFixed(2)}</strong>
                    <small class="text-muted">GPA ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</small>
                </div>
                <div class="col-md-3">
                    <strong class="d-block fs-4 text-danger">${(data.overall_stats.overall_fail_rate * 100).toFixed(1)}%</strong>
                    <small class="text-muted">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏Å‡∏£‡∏ß‡∏°</small>
                </div>
            </div>
        </div>
    `;

    if (data.recommendations && data.recommendations.length > 0) {
        document.getElementById('analysis-recommendations').innerHTML = `
            <div class="alert alert-warning">
                <h6 class="alert-heading fw-bold">
                    <i class="bi bi-lightbulb-fill me-2"></i>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                </h6>
                <ul class="mb-0">
                    ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    const highFailList = document.getElementById('highFailSubjects');
    if (data.problem_subjects.high_fail_rate.length > 0) {
        highFailList.innerHTML = data.problem_subjects.high_fail_rate.slice(0, 10).map(s => `
            <li class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                <span>${s.subject}</span>
                <div>
                    <span class="badge bg-danger me-1">‡∏ï‡∏Å ${(s.fail_rate * 100).toFixed(1)}%</span>
                    <span class="badge bg-secondary">GPA ${s.average.toFixed(2)}</span>
                </div>
            </li>
        `).join('');
    } else {
        highFailList.innerHTML = '<p class="text-muted mb-0">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ Killer</p>';
    }

    const easySubjectsList = document.getElementById('easySubjects');
    if (data.excellent_subjects && data.excellent_subjects.length > 0) {
        easySubjectsList.innerHTML = data.excellent_subjects.slice(0, 10).map(s => `
            <li class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                <span>${s.subject}</span>
                <div>
                    <span class="badge bg-success me-1">GPA ${s.average.toFixed(2)}</span>
                    <span class="badge bg-info">${s.num_students} ‡∏Ñ‡∏ô</span>
                </div>
            </li>
        `).join('');
    } else {
        easySubjectsList.innerHTML = '<p class="text-muted mb-0">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ Easy</p>';
    }

    setTimeout(() => {
        const ctx = document.getElementById('courseDistributionChart').getContext('2d');
        const existingChart = Chart.getChart('courseDistributionChart');
        if (existingChart) existingChart.destroy();
        
        const categories = Object.keys(data.category_summary || {});
        const avgGPAs = categories.map(cat => data.category_summary[cat].avg_gpa);
        const failRates = categories.map(cat => data.category_summary[cat].avg_fail_rate * 100);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [
                    {
                        label: 'GPA ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢',
                        data: avgGPAs,
                        backgroundColor: 'rgba(30, 64, 175, 0.6)',
                        borderColor: '#1e40af',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏Å (%)',
                        data: failRates,
                        backgroundColor: 'rgba(220, 38, 38, 0.6)',
                        borderColor: '#dc2626',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { type: 'linear', display: true, position: 'left', max: 4 },
                    y1: { type: 'linear', display: true, position: 'right', max: 100, grid: { drawOnChartArea: false } }
                }
            }
        });
    }, 100);
    
    document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
