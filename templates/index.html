{% extends "base.html" %}

{% block title %}ฝึกโมเดล AI - ระบบทำนายความสำเร็จของนักศึกษา{% endblock %}

{% block custom_css %}
<style>
    /* Page Header */
    .page-header {
        padding: 3rem 0 2rem;
        text-align: center;
    }

    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: white;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 0.5rem;
    }

    .page-header .lead {
        color: rgba(255, 255, 255, 0.9);
        font-weight: 300;
    }

    /* System Features */
    .features-container {
        margin-bottom: 3rem;
    }

    .feature-box {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: transform 0.3s;
        height: 100%;
        box-shadow: var(--shadow);
    }

    .feature-box:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .feature-box-icon {
        width: 60px;
        height: 60px;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        flex-shrink: 0;
        color: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .feature-box h6 {
        margin-bottom: 0.25rem;
        font-weight: 700;
        color: var(--gray-800);
        font-size: 1.1rem;
    }

    .feature-box small {
        color: var(--gray-600);
        display: block;
        line-height: 1.4;
    }

    /* Upload Section */
    .upload-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        padding: 3rem;
        border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .section-number {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1.5rem;
        flex-shrink: 0;
        box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
    }

    .section-title h5 {
        margin-bottom: 0.25rem;
        font-weight: 700;
        color: var(--gray-800);
        font-size: 1.25rem;
    }

    .section-title small {
        color: var(--gray-500);
        font-size: 0.9rem;
    }

    /* File Upload */
    .file-upload-wrapper {
        position: relative;
        padding: 2rem;
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius-lg);
        background: var(--gray-50);
        text-align: center;
        transition: all 0.3s;
    }

    .file-upload-wrapper:hover {
        border-color: var(--primary);
        background: var(--primary-bg);
    }

    .file-upload-wrapper input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .upload-icon {
        font-size: 3rem;
        color: var(--gray-400);
        margin-bottom: 1rem;
        transition: color 0.3s;
    }

    .file-upload-wrapper:hover .upload-icon {
        color: var(--primary);
    }

    /* Status Cards */
    .status-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        height: 100%;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
    }

    .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--gray-100);
    }

    .status-item:last-child {
        border-bottom: none;
    }

    .status-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--gray-600);
        font-weight: 600;
    }

    /* Actions Section */
    .actions-section {
        background: #f8fafc;
        border-radius: var(--radius-xl);
        padding: 3rem;
        margin-top: 3rem;
        border: 1px solid var(--gray-200);
    }

    .action-card {
        background: white;
        border-radius: var(--radius-xl);
        padding: 2rem;
        text-align: center;
        height: 100%;
        border: 1px solid transparent;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: var(--shadow);
    }

    .action-card:hover {
        border-color: var(--primary);
        transform: translateY(-10px);
        box-shadow: var(--shadow-lg);
    }

    .action-icon {
        width: 80px;
        height: 80px;
        border-radius: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        font-size: 2.5rem;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .action-card h6 {
        font-weight: 700;
        color: var(--gray-800);
        margin-bottom: 0.75rem;
        font-size: 1.25rem;
    }

    .action-card p {
        color: var(--gray-500);
        font-size: 0.95rem;
        margin-bottom: 1.5rem;
        min-height: 44px;
    }

    /* Training Progress */
    .training-progress {
        background: white;
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-top: 2rem;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-200);
    }

    .training-progress h6 {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--primary);
        margin-bottom: 1.5rem;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .progress {
        height: 1.5rem;
        border-radius: 1rem;
        background: var(--gray-100);
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .progress-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.8rem;
        background: linear-gradient(90deg, var(--primary), var(--primary-light));
        box-shadow: 0 2px 5px rgba(79, 70, 229, 0.4);
    }

    /* Results Section */
    .results-section {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
        margin-top: 3rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .results-header {
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        padding: 1.5rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .results-body {
        padding: 2.5rem;
    }

    /* Metrics Grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .metric-card {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.3s;
        border: 1px solid var(--gray-200);
    }

    .metric-card:hover {
        transform: translateY(-5px);
        background: white;
        box-shadow: var(--shadow);
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .metric-value.text-primary {
        color: var(--primary);
    }

    .metric-value.text-success {
        color: var(--success);
    }

    .metric-value.text-warning {
        color: var(--warning);
    }

    .metric-value.text-info {
        color: var(--info);
    }

    .metric-label {
        color: var(--gray-500);
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Feature Importance */
    .feature-importance {
        background: white;
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
    }

    .feature-bar {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 0.5rem;
        border-radius: var(--radius);
        transition: background 0.2s;
    }

    .feature-bar:hover {
        background: var(--gray-50);
    }

    .feature-rank {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: 700;
        flex-shrink: 0;
        box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3);
    }

    .feature-name {
        width: 220px;
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--gray-700);
        flex-shrink: 0;
    }

    .feature-progress {
        flex-grow: 1;
        height: 12px;
        background: var(--gray-200);
        border-radius: 10px;
        overflow: hidden;
    }

    .feature-progress .progress-bar {
        height: 100%;
        border-radius: 10px;
    }

    .feature-value {
        width: 60px;
        text-align: right;
        font-weight: 700;
        color: var(--gray-600);
        font-size: 0.9rem;
    }

    /* Gemini Section */
    .gemini-section {
        background: linear-gradient(135deg, #1e1e2e, #2d2d3e);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-top: 2rem;
        color: #e2e8f0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .gemini-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #a78bfa;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .gemini-content {
        line-height: 1.8;
        font-size: 1.05rem;
    }

    /* Responsive */
    @media (max-width: 992px) {
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .feature-box {
            flex-direction: column;
            text-align: center;
        }

        .section-header {
            flex-direction: column;
            text-align: center;
        }

        .feature-name {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .feature-bar {
            flex-wrap: wrap;
        }
    }

    /* Toggle Switch */
    .form-switch .form-check-input {
        width: 3.5rem;
        height: 1.75rem;
        cursor: pointer;
        background-color: var(--gray-300);
        border-color: var(--gray-300);
    }

    .form-switch .form-check-input:checked {
        background-color: var(--primary);
        border-color: var(--primary);
    }

    /* Clickable Explain System */
    .clickable-explain {
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
    }
    .clickable-explain:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.15) !important;
    }
    .clickable-explain:active {
        transform: translateY(-1px);
    }
    .metric-card.clickable-explain::after {
        content: '\f431';
        font-family: 'bootstrap-icons';
        position: absolute;
        top: 8px;
        right: 10px;
        font-size: 0.75rem;
        color: var(--gray-400);
        transition: color 0.2s;
    }
    .metric-card.clickable-explain:hover::after {
        color: var(--primary);
    }
    tr.clickable-explain:hover {
        background-color: rgba(79, 70, 229, 0.06) !important;
    }
    .feature-bar.clickable-explain:hover {
        background: rgba(79, 70, 229, 0.06) !important;
    }

    /* Explain Modal */
    #explainModal .modal-content {
        border: none;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
    }
    #explainModal .modal-header {
        border-bottom: none;
        padding: 1.5rem 2rem;
        color: white;
    }
    #explainModal .modal-body {
        padding: 2rem;
    }
    #explainModal .modal-footer {
        border-top: 1px solid var(--gray-200);
        padding: 1rem 2rem;
    }
    .explain-section {
        background: var(--gray-50);
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid var(--gray-200);
    }
    .explain-section h6 {
        font-weight: 700;
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }
    .explain-formula {
        background: #1e1e2e;
        color: #a6e3a1;
        border-radius: 0.5rem;
        padding: 1rem 1.25rem;
        font-family: 'Fira Code', 'Consolas', monospace;
        font-size: 0.95rem;
        margin-top: 0.5rem;
        letter-spacing: 0.5px;
    }
    .explain-example {
        background: #faf5ff;
        border-left: 4px solid #8b5cf6;
        border-radius: 0 0.5rem 0.5rem 0;
        padding: 1rem 1.25rem;
        margin-top: 0.5rem;
        color: #4c1d95;
        line-height: 1.7;
    }
    .explain-interpretation {
        border-radius: 0.5rem;
        padding: 1rem 1.25rem;
        margin-top: 0.5rem;
        font-weight: 600;
        font-size: 1.05rem;
    }
    .explain-interpretation.good {
        background: #ecfdf5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }
    .explain-interpretation.medium {
        background: #fffbeb;
        color: #92400e;
        border: 1px solid #fde68a;
    }
    .explain-interpretation.bad {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    /* Dark mode support */
    [data-bs-theme="dark"] .explain-section {
        background: #1e1e2e;
        border-color: #333;
    }
    [data-bs-theme="dark"] .explain-example {
        background: #2d1f4e;
        color: #c4b5fd;
    }
    [data-bs-theme="dark"] .explain-interpretation.good {
        background: #064e3b;
        color: #6ee7b7;
        border-color: #065f46;
    }
    [data-bs-theme="dark"] .explain-interpretation.medium {
        background: #78350f;
        color: #fcd34d;
        border-color: #92400e;
    }
    [data-bs-theme="dark"] .explain-interpretation.bad {
        background: #7f1d1d;
        color: #fca5a5;
        border-color: #991b1b;
    }
    [data-bs-theme="dark"] #explainModal .modal-content {
        background: #1a1a2e;
    }
    [data-bs-theme="dark"] #explainModal .modal-footer {
        border-color: #333;
    }

    /* Model pros/cons table */
    .explain-pros-cons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 0.5rem;
    }
    .explain-pros-cons ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .explain-pros-cons li {
        padding: 0.3rem 0;
        font-size: 0.9rem;
    }
    @media (max-width: 576px) {
        .explain-pros-cons {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header" data-aos="fade-down">
    <h1><i class="bi bi-cpu-fill me-2"></i>ฝึกโมเดล AI ขั้นสูง</h1>
    <p class="lead">Advanced Context-Aware Training System</p>
</div>

<!-- System Features -->
<div class="features-container row g-4" data-aos="fade-up">
    <div class="col-md-4">
        <div class="feature-box">
            <div class="feature-box-icon bg-primary">
                <i class="bi bi-diagram-3"></i>
            </div>
            <div>
                <h6>Course DNA Profiling</h6>
                <small>วิเคราะห์ DNA และความยากของแต่ละวิชาอย่างละเอียด</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="feature-box">
            <div class="feature-box-icon bg-success">
                <i class="bi bi-camera"></i>
            </div>
            <div>
                <h6>Dynamic Snapshots</h6>
                <small>สร้างภาพถ่ายการเรียนทุกช่วงเวลาเพื่อติดตามพัฒนาการ</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="feature-box">
            <div class="feature-box-icon bg-warning">
                <i class="bi bi-lightbulb"></i>
            </div>
            <div>
                <h6>Contextual Learning</h6>
                <small>เรียนรู้และปรับตัวตามบริบทของข้อมูลแต่ละรุ่นปี</small>
            </div>
        </div>
    </div>
</div>

<!-- Main Training Card -->
<div class="upload-section" data-aos="fade-up" data-aos-delay="100">
    <!-- Upload Section -->
    <div class="section-header">
        <div class="section-number">1</div>
        <div class="section-title">
            <h5>อัปโหลดข้อมูล</h5>
            <small>นำเข้าไฟล์ข้อมูลผลการเรียนของนักศึกษา (.csv, .xlsx)</small>
        </div>
    </div>

    <div class="row g-5">
        <div class="col-lg-7">
            <div class="file-upload-wrapper mb-4">
                <div class="upload-icon">
                    <i class="bi bi-cloud-arrow-up"></i>
                </div>
                <h5 class="fw-bold mb-2">ลากไฟล์มาวางที่นี่ หรือ คลิกเพื่อเลือกไฟล์</h5>
                <p class="text-muted small mb-0">รองรับไฟล์ CSV, Excel (.xlsx, .xls) ขนาดสูงสุด 100MB</p>
                <input type="file" id="fileUpload" accept=".csv, .xlsx, .xls">
            </div>

            <div class="d-flex align-items-center gap-3">
                <div class="flex-grow-1">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-file-earmark-text"></i></span>
                        <input type="text" class="form-control" id="fileNameDisplay" placeholder="ยังไม่ได้เลือกไฟล์"
                            readonly style="background-color: white;">
                    </div>
                </div>
                <button class="btn btn-primary btn-lg px-4" id="uploadBtn" onclick="uploadFile()" disabled>
                    <span id="uploadSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                    <i class="bi bi-cloud-upload"></i> อัปโหลด
                </button>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="status-card">
                <h6 class="fw-bold text-gray-800 mb-3 pb-2 border-bottom">
                    <i class="bi bi-speedometer2 me-2 text-primary"></i>สถานะระบบ
                </h6>
                <div class="status-item">
                    <span class="status-label">
                        <i class="bi bi-cpu text-primary"></i> โมเดล AI
                    </span>
                    <span id="subject-model-status">
                        <span class="badge bg-secondary rounded-pill">กำลังตรวจสอบ...</span>
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">
                        <i class="bi bi-database text-info"></i> ที่เก็บข้อมูล
                    </span>
                    <span id="storage-status">
                        <span class="badge bg-secondary rounded-pill">กำลังตรวจสอบ...</span>
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">
                        <i class="bi bi-shield-check text-success"></i> ความพร้อม
                    </span>
                    <span id="model-check-status">
                        <span class="badge bg-secondary rounded-pill">รอการตรวจสอบ</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Section -->
    <div id="actionsCard" class="actions-section d-none animate__animated animate__fadeIn">
        <div class="section-header">
            <div class="section-number">2</div>
            <div class="section-title">
                <h5>เลือกการดำเนินการ</h5>
                <small>ไฟล์: <strong id="fileName" class="text-primary"></strong> | <span id="fileInfo"></span></small>
            </div>
        </div>

        <div class="row g-4 justify-content-center">
            <!-- Train Model -->
            <div class="col-lg-6">
                <div class="action-card h-100">
                    <div class="action-icon bg-primary text-white">
                        <i class="bi bi-cpu-fill"></i>
                    </div>
                    <h6>ฝึกโมเดล AI</h6>
                    <p>ใช้ Advanced Context-Aware Training เพื่อสร้างโมเดล</p>

                    <div class="text-start mb-4 p-3 bg-light rounded-3 border">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="enableGeminiTraining" checked>
                            <label class="form-check-label fw-semibold" for="enableGeminiTraining">
                                ใช้ Gemini Analysis
                            </label>
                            <span class="badge bg-secondary ms-2" id="geminiTrainingStatusBadge">
                                <i class="bi bi-hourglass-split"></i>
                            </span>
                        </div>
                        <textarea class="form-control form-control-sm mt-2" id="geminiAnalysisGoalInput" rows="2"
                            placeholder="ระบุเป้าหมายการวิเคราะห์ (Optional)"></textarea>
                    </div>

                    <button class="btn btn-primary w-100 rounded-pill py-2 mt-auto" id="trainBtn"
                        onclick="trainModel()">
                        <span id="trainSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                        <i class="bi bi-play-circle-fill"></i> เริ่มฝึกโมเดล
                    </button>
                </div>
            </div>
        </div>

        <!-- Training Progress -->
        <div id="trainingProgress" class="training-progress d-none animate__animated animate__fadeIn">
            <h6>
                <i class="bi bi-gear-wide-connected fa-spin me-2"></i>
                กำลังฝึกโมเดล...
            </h6>
            <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar"
                    style="width: 0%">0%</div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-primary fw-bold" id="progressText">กำลังเตรียมข้อมูล...</small>
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<div id="resultsCard" class="results-section d-none">
    <div class="results-header">
        <h5 class="mb-0 fw-bold">
            <i class="bi bi-graph-up-arrow me-2"></i>ผลลัพธ์การประมวลผล
        </h5>
        <button class="btn btn-sm btn-outline-light rounded-circle"
            onclick="document.getElementById('resultsCard').classList.add('d-none')"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="results-body">
        <!-- Training Results -->
        <div id="trainingResults" class="d-none animate__animated animate__fadeIn">
            <div class="text-center mb-5">
                <h4 class="fw-bold text-primary mb-2">
                    <i class="bi bi-trophy-fill me-2 text-warning"></i>ฝึกโมเดลสำเร็จ
                </h4>
                <p class="text-muted">โมเดลพร้อมใช้งานสำหรับการทำนายผล</p>
            </div>

            <div class="metrics-grid">
                <div class="metric-card clickable-explain" onclick="showMetricExplanation('accuracy')" data-bs-toggle="tooltip" data-bs-placement="top"
                    title="คลิกเพื่อดูคำอธิบาย — ความแม่นยำโดยรวม">
                    <div class="metric-value text-success" id="accuracyDisplay">0%</div>
                    <div class="metric-label">ความแม่นยำ</div>
                    <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">Accuracy — ทำนายถูกต้องทั้งหมด</small>
                </div>
                <div class="metric-card clickable-explain" onclick="showMetricExplanation('precision')" data-bs-toggle="tooltip" data-bs-placement="top"
                    title="คลิกเพื่อดูคำอธิบาย — ความแม่นเจาะจง">
                    <div class="metric-value text-primary" id="precisionDisplay">0%</div>
                    <div class="metric-label">ความแม่นเจาะจง</div>
                    <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">Precision — ทำนาย "จบ" แล้วจบจริง</small>
                </div>
                <div class="metric-card clickable-explain" onclick="showMetricExplanation('recall')" data-bs-toggle="tooltip" data-bs-placement="top"
                    title="คลิกเพื่อดูคำอธิบาย — ความครอบคลุม">
                    <div class="metric-value text-warning" id="recallDisplay">0%</div>
                    <div class="metric-label">ความครอบคลุม</div>
                    <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">Recall — จับคนจบได้ครบแค่ไหน</small>
                </div>
                <div class="metric-card clickable-explain" onclick="showMetricExplanation('f1_score')" data-bs-toggle="tooltip" data-bs-placement="top"
                    title="คลิกเพื่อดูคำอธิบาย — คะแนนสมดุล">
                    <div class="metric-value text-info" id="f1Display">0%</div>
                    <div class="metric-label">คะแนนสมดุล</div>
                    <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">F1-Score — สมดุลระหว่างแม่น+ครอบคลุม</small>
                </div>
            </div>

            <div id="trainingDetails" class="mb-4"></div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div id="featureImportance" class="feature-importance h-100">
                        <h6 class="fw-bold mb-4 pb-2 border-bottom">
                            <i class="bi bi-list-ol me-2 text-primary"></i>ปัจจัยที่มีผลมากที่สุด
                        </h6>
                        <p class="text-muted small mb-3">ปัจจัยที่โมเดลให้ความสำคัญสูงสุดในการทำนาย (ยิ่งสูงยิ่งสำคัญ)</p>
                        <div id="featureList"></div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div id="geminiTrainingResult" class="gemini-section d-none h-100">
                        <div class="gemini-header">
                            <i class="bi bi-stars"></i>
                            <h6 class="mb-0">การวิเคราะห์โดย Gemini AI</h6>
                            <span class="badge bg-primary ms-auto" id="geminiTrainingGoalBadge"></span>
                        </div>
                        <div class="gemini-content custom-scrollbar" id="geminiTrainingResultBody"
                            style="max-height: 400px; overflow-y: auto; padding-right: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prediction Results -->
        <div id="predictionResults" class="d-none animate__animated animate__fadeIn">
            <h5 class="fw-bold text-primary mb-4 pb-2 border-bottom">
                <i class="bi bi-people-fill me-2"></i>ผลการทำนาย
            </h5>
            <div id="summary" class="mb-5"></div>

            <ul class="nav nav-tabs nav-tabs-custom mb-4" id="resultTabs">
                <li class="nav-item">
                    <button class="nav-link active fw-bold" data-bs-toggle="tab"
                        data-bs-target="#overview">ภาพรวม</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold" data-bs-toggle="tab"
                        data-bs-target="#details">รายละเอียดรายคน</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold" data-bs-toggle="tab"
                        data-bs-target="#recommendations">คำแนะนำ</button>
                </li>
            </ul>

            <div class="tab-content p-3 border rounded-bottom bg-light">
                <div class="tab-pane fade show active" id="overview">
                    <div id="overviewContent" class="d-flex justify-content-center"></div>
                </div>
                <div class="tab-pane fade" id="details">
                    <div id="results"></div>
                </div>
                <div class="tab-pane fade" id="recommendations">
                    <div id="recommendationsContent"></div>
                </div>
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="analysisResults" class="d-none animate__animated animate__fadeIn">
            <h5 class="fw-bold text-primary mb-4 pb-2 border-bottom">
                <i class="bi bi-microscope me-2"></i>ผลการวิเคราะห์ Course DNA
            </h5>
            <div id="analysis-summary" class="mb-4"></div>
            <div id="analysis-recommendations" class="mb-4"></div>

            <div class="row mb-4" id="analysis-tables">
                <div class="col-md-6 mb-3">
                    <div class="card border-danger shadow-sm h-100">
                        <div class="card-header bg-danger text-white fw-bold">
                            <i class="bi bi-x-circle-fill me-1"></i> วิชาที่มีอัตราตกสูง (Killer Courses)
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0" id="highFailSubjects"></ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card border-success shadow-sm h-100">
                        <div class="card-header bg-success text-white fw-bold">
                            <i class="bi bi-check-circle-fill me-1"></i> วิชาที่มีผลการเรียนดี (Easy Courses)
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0" id="easySubjects"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-info text-white fw-bold">
                    <i class="bi bi-bar-chart-fill me-1"></i> การกระจายตัวของผลการเรียน (Course Performance)
                </div>
                <div class="card-body">
                    <div style="height: 400px;">
                        <canvas id="courseDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Explain Modal -->
<div class="modal fade" id="explainModal" tabindex="-1" aria-labelledby="explainModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" id="explainModalHeader" style="background: linear-gradient(135deg, #4f46e5, #7c3aed);">
                <h5 class="modal-title" id="explainModalLabel">
                    <span id="explainModalIcon" class="me-2"></span>
                    <span id="explainModalTitle">คำอธิบาย</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="explainModalBody">
            </div>
            <div class="modal-footer">
                <small class="text-muted me-auto"><i class="bi bi-info-circle me-1"></i>คลิกที่ตัวเลขผลลัพธ์อื่นเพื่อดูคำอธิบายเพิ่มเติม</small>
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
    // Global variables
    let currentFilename = '';
    let trainingInterval = null;
    let geminiAvailableForTraining = false;

    // File Upload Handling
    document.getElementById('fileUpload').addEventListener('change', function (e) {
        const file = e.target.files[0];
        handleFileSelection(file);
    });

    function handleFileSelection(file) {
        if (file) {
            document.getElementById('fileNameDisplay').value = file.name;
            document.getElementById('uploadBtn').disabled = false;

            // Visual feedback
            const wrapper = document.querySelector('.file-upload-wrapper');
            wrapper.style.borderColor = 'var(--primary)';
            wrapper.style.backgroundColor = 'var(--primary-bg)';
        } else {
            document.getElementById('fileNameDisplay').value = '';
            document.getElementById('uploadBtn').disabled = true;
        }
    }

    // Toggle Spinner
    function toggleSpinner(buttonId, show) {
        const button = document.getElementById(buttonId);
        const spinner = button.querySelector('.spinner-border');
        if (show) {
            spinner.classList.remove('d-none');
            button.disabled = true;
        } else {
            spinner.classList.add('d-none');
            button.disabled = false;
        }
    }

    // Render Markdown
    function renderMarkdown(text) {
        if (!text) return '';
        try {
            if (window.marked) {
                const html = window.marked.parse(text);
                return window.DOMPurify ? DOMPurify.sanitize(html) : html;
            }
            return text.replace(/\n/g, '<br>');
        } catch (error) {
            return text.replace(/\n/g, '<br>');
        }
    }

    // Gemini Status
    async function refreshGeminiTrainingStatus() {
        try {
            const response = await fetch('/api/config');
            const data = await response.json();
            geminiAvailableForTraining = Boolean(data && data.GEMINI_ENABLED);
        } catch (error) {
            geminiAvailableForTraining = false;
        } finally {
            updateGeminiTrainingUI();
        }
    }

    function updateGeminiTrainingUI() {
        const toggle = document.getElementById('enableGeminiTraining');
        const badge = document.getElementById('geminiTrainingStatusBadge');
        const goalInput = document.getElementById('geminiAnalysisGoalInput');

        if (!toggle || !badge) return;

        if (!geminiAvailableForTraining) {
            toggle.checked = false;
            toggle.disabled = true;
            badge.className = 'badge bg-danger ms-2';
            badge.innerHTML = '<i class="bi bi-slash-circle"></i> ไม่พร้อมใช้งาน';
            if (goalInput) {
                goalInput.disabled = true;
                goalInput.placeholder = 'ต้องตั้งค่า Gemini API Key ก่อน';
            }
            return;
        }

        toggle.disabled = false;
        if (goalInput) {
            goalInput.disabled = !toggle.checked;
        }

        if (toggle.checked) {
            badge.className = 'badge bg-success ms-2';
            badge.innerHTML = '<i class="bi bi-check-circle"></i> เปิดใช้งาน';
        } else {
            badge.className = 'badge bg-secondary ms-2';
            badge.innerHTML = '<i class="bi bi-pause-circle"></i> ปิดใช้งาน';
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        checkSystemStatus();
        refreshGeminiTrainingStatus();
        setInterval(checkSystemStatus, 10000);

        const geminiToggle = document.getElementById('enableGeminiTraining');
        if (geminiToggle) {
            geminiToggle.addEventListener('change', updateGeminiTrainingUI);
        }
    });

    // Check system status
    async function checkSystemStatus() {
        let modelOk = false;
        let storageOk = false;

        // ตรวจสอบโมเดล AI
        try {
            const response = await fetch('/api/models');
            const data = await response.json();

            if (data.success && data.models && data.models.length > 0) {
                document.getElementById('subject-model-status').innerHTML = `
                <span class="badge bg-success rounded-pill">
                    <i class="bi bi-check-circle me-1"></i>${data.models.length} โมเดลพร้อมใช้
                </span>`;
                const predictBtn = document.getElementById('predictBtn');
                if (predictBtn && !predictBtn.querySelector('.spinner-border:not(.d-none)')) {
                    predictBtn.disabled = false;
                }
                modelOk = true;
            } else {
                document.getElementById('subject-model-status').innerHTML = `
                <span class="badge bg-warning text-dark rounded-pill">
                    <i class="bi bi-exclamation-circle me-1"></i>ยังไม่มีโมเดล
                </span>`;
                const predictBtn = document.getElementById('predictBtn');
                if (predictBtn) predictBtn.disabled = true;
                modelOk = true; // ไม่มีโมเดลแต่ระบบปกติ
            }
        } catch (error) {
            console.error('Error checking models:', error);
            document.getElementById('subject-model-status').innerHTML = `
            <span class="badge bg-danger rounded-pill">
                <i class="bi bi-x-circle me-1"></i>ตรวจสอบไม่ได้
            </span>`;
        }

        // ตรวจสอบที่เก็บข้อมูล
        try {
            const storageResponse = await fetch('/api/storage/status');
            const storageData = await storageResponse.json();

            if (storageData.connected) {
                document.getElementById('storage-status').innerHTML = `
                <span class="badge bg-success rounded-pill">
                    <i class="bi bi-cloud-check me-1"></i>Cloud R2 เชื่อมต่อแล้ว
                </span>`;
            } else {
                document.getElementById('storage-status').innerHTML = `
                <span class="badge bg-info rounded-pill">
                    <i class="bi bi-hdd me-1"></i>เก็บในเครื่อง (Local)
                </span>`;
            }
            storageOk = true;
        } catch (error) {
            console.error('Error checking storage:', error);
            document.getElementById('storage-status').innerHTML = `
            <span class="badge bg-danger rounded-pill">
                <i class="bi bi-x-circle me-1"></i>ตรวจสอบไม่ได้
            </span>`;
        }

        // สรุปความพร้อมรวม
        if (modelOk && storageOk) {
            document.getElementById('model-check-status').innerHTML = `
            <span class="badge bg-success bg-opacity-25 text-success rounded-pill border border-success">
                <i class="bi bi-check-circle me-1"></i>ระบบพร้อมใช้งาน
            </span>`;
        } else {
            document.getElementById('model-check-status').innerHTML = `
            <span class="badge bg-warning text-dark rounded-pill">
                <i class="bi bi-exclamation-triangle me-1"></i>มีปัญหาบางส่วน
            </span>`;
        }
    }

    // Upload file
    async function uploadFile() {
        const fileInput = document.getElementById('fileUpload');
        if (fileInput.files.length === 0) {
            showAlert('กรุณาเลือกไฟล์ก่อน', 'warning');
            return;
        }

        showLoading('กำลังอัปโหลดไฟล์ขึ้นสู่ระบบ...');
        toggleSpinner('uploadBtn', true);

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                currentFilename = result.filename;
                document.getElementById('fileName').textContent = result.filename;
                document.getElementById('fileInfo').innerHTML = `
                <span class="badge bg-light text-dark border me-2">
                    <i class="bi bi-file-earmark-text me-1"></i>${result.rows} แถว
                </span>
                <span class="badge bg-light text-dark border">
                    <i class="bi bi-table me-1"></i>${result.columns} คอลัมน์
                </span>
            `;

                document.getElementById('actionsCard').classList.remove('d-none');
                // Smooth scroll to actions
                setTimeout(() => {
                    document.getElementById('actionsCard').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);

                showAlert('อัปโหลดไฟล์สำเร็จ! พร้อมสำหรับการดำเนินการ', 'success');
            } else {
                showAlert('เกิดข้อผิดพลาด: ' + result.error, 'danger');
            }
        } catch (error) {
            showAlert('เกิดข้อผิดพลาดในการอัปโหลดไฟล์', 'danger');
        } finally {
            hideLoading();
            toggleSpinner('uploadBtn', false);
        }
    }

    // Train model
    async function trainModel() {
        if (!currentFilename) {
            showAlert('กรุณาอัปโหลดไฟล์ก่อน', 'warning');
            return;
        }

        // Scroll to progress
        document.getElementById('trainingProgress').classList.remove('d-none');
        document.getElementById('trainingProgress').scrollIntoView({ behavior: 'smooth', block: 'center' });

        toggleSpinner('trainBtn', true);
        simulateTrainingProgress();

        try {
            const geminiToggle = document.getElementById('enableGeminiTraining');
            const geminiGoalInput = document.getElementById('geminiAnalysisGoalInput');
            const shouldUseGemini = geminiToggle && geminiToggle.checked && geminiAvailableForTraining;

            const payload = {
                filename: currentFilename,
                enable_gemini_analysis: shouldUseGemini
            };

            if (shouldUseGemini && geminiGoalInput && geminiGoalInput.value.trim()) {
                payload.gemini_analysis_goal = geminiGoalInput.value.trim();
            }

            const response = await fetch('/train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.success) {
                if (trainingInterval) {
                    clearInterval(trainingInterval);
                    trainingInterval = null;
                }
                // Fill progress bar
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressBar').textContent = '100%';

                const mName = result.model_filename || 'โมเดลใหม่';
                const mAcc = result.accuracy != null ? ` (ความแม่นยำ ${(result.accuracy*100).toFixed(1)}%)` : '';
                showAlert(`ฝึกโมเดล AI สำเร็จแล้ว: ${mName}${mAcc}`, 'success');
                displayTrainingResults(result);

                setTimeout(() => checkSystemStatus(), 1000);
            } else {
                showAlert('เกิดข้อผิดพลาด: ' + result.error, 'danger');
            }
        } catch (error) {
            showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'danger');
        } finally {
            toggleSpinner('trainBtn', false);
            document.getElementById('trainingProgress').classList.add('d-none');
            if (trainingInterval) {
                clearInterval(trainingInterval);
                trainingInterval = null;
            }
        }
    }

    // Simulate training progress
    function simulateTrainingProgress() {
        let progress = 0;
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        const stages = [
            { at: 10, text: 'กำลังวิเคราะห์ข้อมูลและลบข้อมูลซ้ำ...' },
            { at: 20, text: 'กำลังสร้างโปรไฟล์รายวิชา (Course DNA)...' },
            { at: 35, text: 'กำลังสร้าง Snapshots เรียงตามเทอม...' },
            { at: 50, text: 'กำลังคำนวณปัจจัย 28 ตัว...' },
            { at: 65, text: 'กำลังฝึกโมเดล AI 4 ตัวพร้อมกัน...' },
            { at: 80, text: 'กำลังเปรียบเทียบและเลือกโมเดลที่ดีที่สุด...' },
            { at: 90, text: 'กำลังวิเคราะห์ด้วย Gemini AI...' },
            { at: 95, text: 'กำลังบันทึกโมเดลและสรุปผลลัพธ์...' }
        ];

        trainingInterval = setInterval(() => {
            if (progress < 95) {
                progress += Math.random() * 3;
                progress = Math.min(95, progress);

                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';

                for (let stage of stages) {
                    if (progress >= stage.at && progress < stage.at + 15) {
                        progressText.textContent = stage.text;
                        break;
                    }
                }
            }
        }, 400);
    }

    // แปลชื่อ feature เป็นภาษาไทย
    const featureNamesTH = {
        'current_gpa': 'เกรดเฉลี่ยสะสม (GPA)',
        'gpa_std': 'ความผันผวนของเกรด',
        'min_grade': 'เกรดต่ำสุด',
        'max_grade': 'เกรดสูงสุด',
        'grade_range': 'ช่วงเกรด (สูงสุด-ต่ำสุด)',
        'high_grades': 'สัดส่วนเกรดสูง (A, B+)',
        'medium_grades': 'สัดส่วนเกรดกลาง (B, C+)',
        'low_grades': 'สัดส่วนเกรดต่ำ (C, D+, D, F)',
        'avg_course_difficulty': 'ความยากเฉลี่ยของวิชาที่เรียน',
        'avg_course_fail_rate': 'อัตราตกเฉลี่ยของวิชาที่เรียน',
        'num_killer_courses': 'จำนวนวิชาปราบเซียนที่เรียน',
        'num_easy_courses': 'จำนวนวิชาง่ายที่เรียน',
        'num_failed_courses': 'จำนวนวิชาที่สอบตก',
        'killer_course_ratio': 'สัดส่วนวิชาปราบเซียน',
        'gpa_gap': 'ผลต่าง GPA จริง vs คาดหวัง',
        'recent_trend': 'แนวโน้มเกรดล่าสุด',
        'progress_ratio': 'อัตราความก้าวหน้า',
        'consistency_score': 'ความสม่ำเสมอของเกรด',
        'academic_momentum': 'แรงผลักดันทางการเรียน',
        'risk_score': 'คะแนนความเสี่ยง',
        'credits_earned': 'หน่วยกิตสะสมที่ผ่าน',
        'graduation_progress': 'ความก้าวหน้าสู่การจบ',
        'credits_per_semester': 'หน่วยกิตต่อเทอม (pace)',
        'on_track_ratio': 'อยู่ในเกณฑ์หรือไม่ (vs 17 หน่วยกิต/เทอม)',
        'semester_progress': 'ความก้าวหน้าของเวลา (เทอม/8)',
        'weighted_difficulty': 'ความยากถ่วงน้ำหนักหน่วยกิต',
        'hard_course_gpa': 'GPA ในวิชายาก (สัญญาณสำคัญ)',
        'grade_variance_exposure': 'ความผันผวนของวิชาที่เรียน',
        'num_retake_courses': 'จำนวนวิชาที่เรียนซ้ำ',
        'retake_f_count': 'จำนวนวิชาที่เคยได้ F แล้วเรียนซ้ำ',
        'retake_ratio': 'สัดส่วนวิชาเรียนซ้ำ',
        'avg_retake_improvement': 'เกรดดีขึ้นเฉลี่ยจากการเรียนซ้ำ'
    };

    function getThaiFeatureName(engName) {
        return featureNamesTH[engName] || engName;
    }

    // ===== Interactive Explain System =====
    let lastTrainingResult = null;

    // Metric Explanations Data
    const metricExplanations = {
        accuracy: {
            icon: '🎯',
            title: 'ความแม่นยำ (Accuracy)',
            color: '#10b981',
            meaning: 'วัดว่าโมเดลทำนายถูกต้อง (ทั้งทำนายว่าจบแล้วจบจริง + ทำนายว่าไม่จบแล้วไม่จบจริง) คิดเป็นกี่เปอร์เซ็นต์จากทั้งหมด',
            formula: 'Accuracy = (TP + TN) / Total\n= (ทำนายจบถูก + ทำนายไม่จบถูก) / ทั้งหมด',
            generateExample(result) {
                if (!result || result.accuracy == null) return 'ไม่มีข้อมูลตัวอย่าง';
                const total = result.training_samples || 5000;
                const correct = Math.round(total * result.accuracy);
                const wrong = total - correct;
                return `จากตัวอย่างทั้งหมด ${total.toLocaleString()} ตัวอย่าง\nโมเดลทำนายถูกต้อง ${correct.toLocaleString()} ตัวอย่าง\nทำนายผิด ${wrong.toLocaleString()} ตัวอย่าง\n→ Accuracy = ${correct.toLocaleString()} / ${total.toLocaleString()} = ${(result.accuracy * 100).toFixed(1)}%`;
            },
            getInterpretation(value) {
                if (value >= 0.9) return { level: 'good', emoji: '😊', text: 'ดีมาก — โมเดลเชื่อถือได้สูง สามารถใช้ทำนายได้อย่างมั่นใจ' };
                if (value >= 0.75) return { level: 'medium', emoji: '🤔', text: 'พอใช้ — โมเดลยังมีความผิดพลาดบ้าง ควรใช้ประกอบการตัดสินใจ' };
                return { level: 'bad', emoji: '⚠️', text: 'ต้องปรับปรุง — โมเดลยังทำนายผิดมาก อาจต้องเพิ่มข้อมูลหรือปรับปัจจัย' };
            }
        },
        precision: {
            icon: '🔬',
            title: 'ความแม่นเจาะจง (Precision)',
            color: '#4f46e5',
            meaning: 'วัดว่าเมื่อโมเดลทำนายว่า "จบการศึกษา" มีกี่เปอร์เซ็นต์ที่จบจริง เน้นความถูกต้องของการทำนาย "จบ"',
            formula: 'Precision = TP / (TP + FP)\n= ทำนายจบถูก / (ทำนายจบถูก + ทำนายจบแต่จริงไม่จบ)',
            generateExample(result) {
                if (!result || result.precision == null) return 'ไม่มีข้อมูลตัวอย่าง';
                const predicted_pos = 100;
                const tp = Math.round(predicted_pos * result.precision);
                const fp = predicted_pos - tp;
                return `สมมติโมเดลทำนายว่า "จบ" ทั้งหมด ${predicted_pos} คน\nจบจริง ${tp} คน (ทำนายถูก)\nไม่จบจริง ${fp} คน (ทำนายผิด)\n→ Precision = ${tp} / ${predicted_pos} = ${(result.precision * 100).toFixed(1)}%`;
            },
            getInterpretation(value) {
                if (value >= 0.9) return { level: 'good', emoji: '😊', text: 'ดีมาก — เมื่อทำนายว่าจบ เชื่อถือได้สูง แทบไม่มี False Positive' };
                if (value >= 0.75) return { level: 'medium', emoji: '🤔', text: 'พอใช้ — บางครั้งทำนายว่าจบแต่จริง ๆ ไม่จบ ควรพิจารณาเพิ่มเติม' };
                return { level: 'bad', emoji: '⚠️', text: 'ต้องปรับปรุง — ทำนายว่าจบแต่ไม่จบจริงค่อนข้างมาก' };
            }
        },
        recall: {
            icon: '🔍',
            title: 'ความครอบคลุม (Recall)',
            color: '#f59e0b',
            meaning: 'วัดว่าจากนักศึกษาที่จบจริงทั้งหมด โมเดลสามารถจับได้กี่เปอร์เซ็นต์ เน้นว่า "ไม่พลาดคนที่จบ"',
            formula: 'Recall = TP / (TP + FN)\n= ทำนายจบถูก / (ทำนายจบถูก + จบจริงแต่ทำนายว่าไม่จบ)',
            generateExample(result) {
                if (!result || result.recall == null) return 'ไม่มีข้อมูลตัวอย่าง';
                const actual_pos = 100;
                const tp = Math.round(actual_pos * result.recall);
                const fn = actual_pos - tp;
                return `สมมติมีนักศึกษาที่จบจริง ${actual_pos} คน\nโมเดลจับได้ ${tp} คน (ทำนายถูก)\nพลาดไป ${fn} คน (จบจริงแต่ทำนายว่าไม่จบ)\n→ Recall = ${tp} / ${actual_pos} = ${(result.recall * 100).toFixed(1)}%`;
            },
            getInterpretation(value) {
                if (value >= 0.9) return { level: 'good', emoji: '😊', text: 'ดีมาก — จับนักศึกษาที่จะจบได้เกือบครบ แทบไม่พลาด' };
                if (value >= 0.75) return { level: 'medium', emoji: '🤔', text: 'พอใช้ — ยังพลาดนักศึกษาที่จบจริงไปบ้าง อาจต้องปรับเกณฑ์' };
                return { level: 'bad', emoji: '⚠️', text: 'ต้องปรับปรุง — พลาดนักศึกษาที่จบจริงไปค่อนข้างมาก' };
            }
        },
        f1_score: {
            icon: '⚖️',
            title: 'คะแนนสมดุล (F1-Score)',
            color: '#06b6d4',
            meaning: 'ค่าเฉลี่ยฮาร์โมนิกของ Precision และ Recall ยิ่งสูงแปลว่าโมเดลทั้งแม่นและครอบคลุมอย่างสมดุล',
            formula: 'F1 = 2 × (Precision × Recall) / (Precision + Recall)\n= ค่าสมดุลระหว่างความแม่นเจาะจงและความครอบคลุม',
            generateExample(result) {
                if (!result || result.f1_score == null) return 'ไม่มีข้อมูลตัวอย่าง';
                const p = result.precision != null ? (result.precision * 100).toFixed(1) : '?';
                const r = result.recall != null ? (result.recall * 100).toFixed(1) : '?';
                return `Precision = ${p}% | Recall = ${r}%\nF1 = 2 × (${p} × ${r}) / (${p} + ${r})\n→ F1-Score = ${(result.f1_score * 100).toFixed(1)}%\n\nถ้า Precision สูงแต่ Recall ต่ำ (หรือกลับกัน) F1 จะต่ำ\nต้องทั้งสองค่าสูงพร้อมกัน F1 ถึงจะสูง`;
            },
            getInterpretation(value) {
                if (value >= 0.9) return { level: 'good', emoji: '😊', text: 'ดีมาก — โมเดลสมดุลทั้งแม่นและครอบคลุม ผลลัพธ์เชื่อถือได้' };
                if (value >= 0.75) return { level: 'medium', emoji: '🤔', text: 'พอใช้ — โมเดลอาจแม่นด้านใดด้านหนึ่งแต่ยังไม่สมดุลเต็มที่' };
                return { level: 'bad', emoji: '⚠️', text: 'ต้องปรับปรุง — โมเดลขาดสมดุลระหว่างความแม่นและความครอบคลุม' };
            }
        }
    };

    // Model Explanations Data
    const modelExplanations = {
        'RandomForest': {
            icon: '🌲',
            title: 'Random Forest (ป่าสุ่ม)',
            color: '#10b981',
            description: 'สร้างต้นไม้ตัดสินใจหลายร้อยต้น แต่ละต้นเรียนรู้จากข้อมูลคนละส่วน แล้วโหวตผลลัพธ์รวมกัน',
            analogy: 'เปรียบเหมือนถามอาจารย์ 100 คน ว่านักศึกษาคนนี้จะจบไหม แล้วโหวตเสียงข้างมาก — ถึงอาจารย์บางคนตัดสินผิด แต่เสียงส่วนใหญ่มักถูก',
            pros: ['แม่นยำสูงในข้อมูลหลากหลาย', 'ไม่ค่อย Overfit (ท่องจำมากเกินไป)', 'บอก Feature Importance ได้', 'ทนทานต่อ Outlier และ Noise'],
            cons: ['ช้ากว่าโมเดลง่าย ๆ', 'เป็น Black-box ตีความยาก', 'ใช้ RAM มากเมื่อมีหลายต้น', 'ไม่เก่ง Extrapolation (ข้อมูลนอกช่วง)']
        }
    };

    // Feature Details Data (Thai)
    const featureDetailsTH = {
        'current_gpa': { meaning: 'เกรดเฉลี่ยสะสมล่าสุดของนักศึกษา', why: 'เป็นตัวชี้วัดผลการเรียนโดยรวมที่สำคัญที่สุด GPA สูงมักสัมพันธ์กับโอกาสจบสูง', insight: 'นักศึกษาที่มี GPA ต่ำกว่า 2.0 มีความเสี่ยงสูงที่จะไม่จบการศึกษา' },
        'gpa_std': { meaning: 'ค่าเบี่ยงเบนมาตรฐานของเกรดในแต่ละวิชา วัดว่าเกรดผันผวนแค่ไหน', why: 'เกรดที่ผันผวนมากอาจบ่งบอกว่านักศึกษาไม่สม่ำเสมอ หรือเจอวิชาที่ไม่ถนัด', insight: 'ค่าสูง = เกรดไม่คงที่ บางวิชาดีมากบางวิชาแย่มาก / ค่าต่ำ = เกรดสม่ำเสมอ' },
        'min_grade': { meaning: 'เกรดต่ำสุดที่เคยได้ในทุกวิชาที่เรียน', why: 'เกรดต่ำสุดบ่งบอกจุดอ่อนที่สุดของนักศึกษา ถ้าต่ำมาก (0 = F) อาจเป็นสัญญาณเตือน', insight: 'นักศึกษาที่เคยได้ F แม้แต่วิชาเดียว มีความเสี่ยงที่สูงขึ้นอย่างชัดเจน' },
        'max_grade': { meaning: 'เกรดสูงสุดที่เคยได้ในทุกวิชาที่เรียน', why: 'แสดงศักยภาพสูงสุดของนักศึกษา ถ้าสูงมากแสดงว่ามีความสามารถ', insight: 'เกรดสูงสุดที่ต่ำ อาจหมายถึงนักศึกษาไม่เคยทำได้ดีเลยในวิชาใด' },
        'grade_range': { meaning: 'ช่วงห่างระหว่างเกรดสูงสุดและต่ำสุด (Max - Min)', why: 'ช่วงกว้างมากแสดงว่ามีความไม่สม่ำเสมอสูง อาจถนัดบางวิชาแต่ไม่ถนัดบางวิชา', insight: 'ช่วงแคบ + GPA สูง = สม่ำเสมอดี / ช่วงกว้าง = ต้องดูว่าตกวิชาไหน' },
        'high_grades': { meaning: 'สัดส่วนวิชาที่ได้เกรดสูง (A, B+) จากทั้งหมด', why: 'สัดส่วนเกรดสูงมากแสดงว่านักศึกษาเรียนดีโดยรวม', insight: 'ถ้าสัดส่วนเกรดสูงมากกว่า 50% มักจะจบการศึกษาได้สำเร็จ' },
        'medium_grades': { meaning: 'สัดส่วนวิชาที่ได้เกรดกลาง (B, C+) จากทั้งหมด', why: 'เกรดกลางบอกว่านักศึกษาผ่านได้แต่ไม่โดดเด่น อาจต้องพัฒนาเพิ่ม', insight: 'สัดส่วนเกรดกลางสูงมาก อาจทำให้ GPA ไม่ถึงเกณฑ์จบ' },
        'low_grades': { meaning: 'สัดส่วนวิชาที่ได้เกรดต่ำ (C, D+, D, F) จากทั้งหมด', why: 'เป็นสัญญาณเตือนสำคัญ ยิ่งมากยิ่งเสี่ยงไม่จบ', insight: 'สัดส่วนเกรดต่ำมากกว่า 30% ถือว่าอยู่ในกลุ่มเสี่ยงสูง' },
        'avg_course_difficulty': { meaning: 'ค่าเฉลี่ยความยากของวิชาที่นักศึกษาเรียน คำนวณจาก Course DNA', why: 'ถ้าเรียนวิชายากเยอะแล้วเกรดยังดี แสดงว่าเก่งจริง', insight: 'นักศึกษาที่เรียนวิชายากแต่ GPA สูง มีแนวโน้มจบสูงมาก' },
        'avg_course_fail_rate': { meaning: 'อัตราตกเฉลี่ยของวิชาที่นักศึกษาเรียน', why: 'ถ้าวิชาที่เรียนมีคนตกเยอะ โอกาสที่จะตกตามก็สูง', insight: 'ค่าสูง = เรียนวิชาที่คนตกเยอะ (ปราบเซียน) ต้องระวัง' },
        'num_killer_courses': { meaning: 'จำนวนวิชาปราบเซียน (วิชาที่มีอัตราตกสูง) ที่นักศึกษาลงเรียน', why: 'วิชาปราบเซียนเป็นอุปสรรคสำคัญ ยิ่งเจอเยอะยิ่งเสี่ยง', insight: 'ถ้าผ่านวิชาปราบเซียนได้หมด โอกาสจบจะสูงมาก' },
        'num_easy_courses': { meaning: 'จำนวนวิชาง่าย (วิชาที่คนส่วนใหญ่ได้เกรดสูง) ที่ลงเรียน', why: 'วิชาง่ายช่วยพยุง GPA ได้', insight: 'ถ้ามีวิชาง่ายมากแต่ GPA ยังต่ำ อาจเป็นสัญญาณไม่ดี' },
        'num_failed_courses': { meaning: 'จำนวนวิชาทั้งหมดที่สอบตก (ได้ F หรือ W)', why: 'จำนวนวิชาที่ตกเป็นตัวชี้วัดสำคัญของความเสี่ยง', insight: 'ตก 1-2 วิชา อาจแก้ไขได้ แต่ตกมากกว่า 3 วิชา ต้องเฝ้าระวัง' },
        'killer_course_ratio': { meaning: 'สัดส่วนวิชาปราบเซียนเทียบกับวิชาทั้งหมดที่เรียน', why: 'วัดว่านักศึกษาต้องเผชิญกับวิชายากมากแค่ไหน', insight: 'สัดส่วนสูง = ต้องสู้กับวิชายากเยอะ อาจต้องการความช่วยเหลือเพิ่ม' },
        'gpa_gap': { meaning: 'ผลต่างระหว่าง GPA จริงกับ GPA ที่คาดหวังจากความยากวิชาที่เรียน', why: 'ถ้า GPA จริงสูงกว่าที่คาด แสดงว่าเก่งกว่าค่าเฉลี่ย ถ้าต่ำกว่าแสดงว่ามีปัญหา', insight: 'ค่าบวก = ทำได้ดีกว่าที่คาด / ค่าลบ = ทำได้แย่กว่าที่คาด' },
        'recent_trend': { meaning: 'แนวโน้มเกรดในช่วงล่าสุด ว่ากำลังดีขึ้นหรือแย่ลง', why: 'แม้ GPA อาจต่ำ แต่ถ้าแนวโน้มดีขึ้น ก็มีโอกาสกลับมาได้', insight: 'ค่าบวก = เกรดกำลังดีขึ้น (สัญญาณดี) / ค่าลบ = เกรดกำลังตก (สัญญาณเตือน)' },
        'progress_ratio': { meaning: 'อัตราส่วนหน่วยกิตที่ผ่านเทียบกับที่ลงทะเบียน', why: 'วัดว่านักศึกษาผ่านวิชาที่ลงไปได้กี่เปอร์เซ็นต์', insight: 'ค่าต่ำ = ตกหรือถอนวิชาบ่อย ไม่ก้าวหน้าตามแผน' },
        'consistency_score': { meaning: 'คะแนนความสม่ำเสมอของเกรดในแต่ละเทอม', why: 'ความสม่ำเสมอบอกว่านักศึกษามีวินัยในการเรียนหรือไม่', insight: 'ค่าสูง = เกรดคงที่ทุกเทอม / ค่าต่ำ = เกรดขึ้นลงมาก' },
        'academic_momentum': { meaning: 'แรงผลักดันทางการเรียน คำนวณจากทั้งแนวโน้มเกรดและจำนวนหน่วยกิตที่ลง', why: 'วัดว่านักศึกษากำลังมีพลังในการเรียนหรือกำลังหมดแรง', insight: 'ค่าบวกสูง = กำลังมาแรง เรียนดีขึ้นเรื่อย ๆ / ค่าลบ = กำลังถดถอย' },
        'risk_score': { meaning: 'คะแนนความเสี่ยงรวม คำนวณจากหลายปัจจัยประกอบกัน', why: 'สรุปความเสี่ยงเป็นตัวเลขเดียว ง่ายต่อการจัดอันดับ', insight: 'ค่าสูง = เสี่ยงมาก ต้องการความช่วยเหลือเร่งด่วน' },
        'credits_earned': { meaning: 'จำนวนหน่วยกิตสะสมที่ผ่านแล้ว', why: 'ถ้าหน่วยกิตน้อยเมื่อเทียบกับเทอมที่เรียน อาจจบไม่ทัน', insight: 'ต้องเทียบกับจำนวนเทอมที่เรียน เฉลี่ยควรได้ ~17 หน่วยกิต/เทอม' },
        'graduation_progress': { meaning: 'ความก้าวหน้าสู่การจบ คิดเป็นเปอร์เซ็นต์ของหน่วยกิตที่ต้องเรียนทั้งหมด', why: 'บอกว่านักศึกษาเดินทางมาถึงจุดไหนแล้วในหลักสูตร', insight: 'ค่ายิ่งสูงยิ่งใกล้จบ แต่ต้องดู GPA ประกอบด้วย' },
        'credits_per_semester': { meaning: 'จำนวนหน่วยกิตเฉลี่ยที่ลงทะเบียนต่อเทอม', why: 'ลงน้อยเกินไปอาจจบไม่ทัน ลงมากเกินไปอาจเรียนไม่ไหว', insight: 'ค่าที่เหมาะสมอยู่ที่ 15-21 หน่วยกิต/เทอม' },
        'on_track_ratio': { meaning: 'อัตราส่วนที่บอกว่านักศึกษาเรียนทันแผนหรือไม่ (เทียบกับ 17 หน่วยกิต/เทอม)', why: 'ค่ามากกว่า 1 = เร็วกว่าแผน / น้อยกว่า 1 = ช้ากว่าแผน', insight: 'ถ้าต่ำกว่า 0.8 อาจต้องพิจารณาเรียนซัมเมอร์เพื่อให้ทัน' },
        'semester_progress': { meaning: 'ความก้าวหน้าของเวลา คำนวณจาก เทอมที่เรียนแล้ว / 8 เทอม', why: 'เทียบกับ graduation_progress เพื่อดูว่าก้าวหน้าทันเวลาหรือไม่', insight: 'ถ้า semester_progress > graduation_progress แสดงว่าเวลาเดินเร็วกว่าหน่วยกิต' },
        'weighted_difficulty': { meaning: 'ค่าความยากถ่วงน้ำหนักด้วยหน่วยกิต วิชาที่มีหน่วยกิตมากจะมีผลมากกว่า', why: 'วิชายาก 3 หน่วยกิต กระทบมากกว่าวิชายาก 1 หน่วยกิต', insight: 'ค่าสูง = เรียนวิชายากที่มีหน่วยกิตมาก ความกดดันสูง' },
        'hard_course_gpa': { meaning: 'เกรดเฉลี่ยเฉพาะในวิชาที่ยาก (ปราบเซียน)', why: 'เป็นสัญญาณสำคัญ ถ้าทำเกรดดีในวิชายากได้ แสดงว่ามีศักยภาพสูง', insight: 'GPA ในวิชายาก ≥ 2.5 = น่าจะรับมือได้ / < 2.0 = ต้องระวัง' },
        'grade_variance_exposure': { meaning: 'ค่าความผันผวนของผลการเรียนในวิชาที่เรียน วัดว่าวิชาเหล่านั้นมีเกรดกระจายมากแค่ไหน', why: 'วิชาที่มีเกรดกระจายมากอาจทำให้ผลลัพธ์คาดเดาได้ยาก', insight: 'ค่าสูง = เรียนวิชาที่ผลการเรียนหลากหลาย ผลลัพธ์ไม่แน่นอน' },
        'num_retake_courses': { meaning: 'จำนวนวิชาที่นักศึกษาต้องลงเรียนซ้ำ (เคยสอบตกหรือถอนแล้วลงใหม่)', why: 'เรียนซ้ำเยอะ = มีปัญหาการเรียนสะสม เป็นสัญญาณเตือนสำคัญว่าอาจจบไม่ทัน', insight: 'เรียนซ้ำ 1-2 วิชา ยังพอแก้ไขได้ แต่ 5+ วิชา ถือว่าเสี่ยงสูงมาก' },
        'retake_f_count': { meaning: 'จำนวนวิชาที่เคยได้เกรด F แล้วต้องเรียนซ้ำ', why: 'F คือสัญญาณอันตรายที่สุด — แสดงว่าไม่ผ่านวิชาเลย ต่างจาก W ที่อาจถอนด้วยเหตุผลอื่น', insight: 'F 3+ วิชา มีโอกาสไม่จบสูงมาก เพราะต้องเสียเวลาเรียนซ้ำทำให้ล่าช้า' },
        'retake_ratio': { meaning: 'สัดส่วนวิชาที่เรียนซ้ำเทียบกับวิชาทั้งหมดที่เรียน', why: 'Normalize จำนวน retake ตามจำนวนวิชา นศ.ที่เรียน 50 วิชาซ้ำ 5 = 10% ต่างจากเรียน 20 วิชาซ้ำ 5 = 25%', insight: 'สัดส่วน > 20% ถือว่าสูงมาก ควรได้รับการดูแลเป็นพิเศษ' },
        'avg_retake_improvement': { meaning: 'เกรดที่ดีขึ้นเฉลี่ยจากการเรียนซ้ำ เช่น F→B+ = ดีขึ้น 3.5 แต้ม', why: 'วัดว่านักศึกษาแก้ตัวได้ดีแค่ไหน — เรียนซ้ำแล้วเกรดดีขึ้นมากแสดงว่ามีศักยภาพฟื้นตัว', insight: 'ค่าสูง (> 2.0) = แก้ตัวได้ดี มีโอกาสจบ / ค่าต่ำ (< 1.0) = เรียนซ้ำแล้วก็ยังไม่ดีขึ้น' }
    };

    // Show Metric Explanation Modal
    function showMetricExplanation(key) {
        const info = metricExplanations[key];
        if (!info) return;
        const result = lastTrainingResult;
        const value = result ? result[key] : null;
        const pct = value != null ? (value * 100).toFixed(1) : '—';

        const interp = value != null ? info.getInterpretation(value) : null;
        const example = info.generateExample(result);

        let html = `
            <div class="explain-section">
                <h6>💬 ความหมาย</h6>
                <p class="mb-0">${info.meaning}</p>
            </div>
            <div class="explain-section">
                <h6>🧮 สูตรคำนวณ</h6>
                <div class="explain-formula">${info.formula.replace(/\n/g, '<br>')}</div>
            </div>
            <div class="explain-section">
                <h6>💡 ตัวอย่างจากข้อมูลจริง</h6>
                <div class="explain-example">${example.replace(/\n/g, '<br>')}</div>
            </div>`;

        if (interp) {
            html += `
            <div class="explain-section">
                <h6>⚡ การตีความ: ${pct}%</h6>
                <div class="explain-interpretation ${interp.level}">
                    ${interp.emoji} ${interp.text}
                </div>
            </div>`;
        }

        document.getElementById('explainModalIcon').textContent = info.icon;
        document.getElementById('explainModalTitle').textContent = info.title;
        document.getElementById('explainModalHeader').style.background = `linear-gradient(135deg, ${info.color}, ${info.color}cc)`;
        document.getElementById('explainModalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('explainModal')).show();
    }

    // Show Model Explanation Modal
    function showModelExplanation(name) {
        const info = modelExplanations[name];
        if (!info) return;
        const result = lastTrainingResult;
        const isBest = result && result.best_model_name === name;
        const metrics = result && result.all_model_results ? result.all_model_results[name] : null;

        let html = '';

        if (isBest) {
            html += `<div class="alert alert-success border-success mb-3"><i class="bi bi-trophy-fill me-2 text-warning"></i><strong>โมเดลนี้ถูกเลือกเป็นดีที่สุด!</strong></div>`;
        }

        html += `
            <div class="explain-section">
                <h6>ℹ️ คืออะไร?</h6>
                <p>${info.description}</p>
                <div class="explain-example">${info.analogy}</div>
            </div>`;

        if (metrics) {
            html += `
            <div class="explain-section">
                <h6>📊 ผลลัพธ์ของโมเดลนี้</h6>
                <div class="row text-center g-2 mt-2">
                    <div class="col-3"><div class="p-2 bg-light rounded-3"><div class="fw-bold text-success fs-5">${(metrics.accuracy*100).toFixed(1)}%</div><small class="text-muted">Accuracy</small></div></div>
                    <div class="col-3"><div class="p-2 bg-light rounded-3"><div class="fw-bold text-primary fs-5">${(metrics.precision*100).toFixed(1)}%</div><small class="text-muted">Precision</small></div></div>
                    <div class="col-3"><div class="p-2 bg-light rounded-3"><div class="fw-bold text-warning fs-5">${(metrics.recall*100).toFixed(1)}%</div><small class="text-muted">Recall</small></div></div>
                    <div class="col-3"><div class="p-2 bg-light rounded-3"><div class="fw-bold text-info fs-5">${(metrics.f1_score*100).toFixed(1)}%</div><small class="text-muted">F1-Score</small></div></div>
                </div>
            </div>`;
        }

        html += `
            <div class="explain-section">
                <h6>💪 จุดเด่นและจุดด้อย</h6>
                <div class="explain-pros-cons">
                    <div>
                        <h6 class="text-success mb-2">👍 จุดเด่น</h6>
                        <ul>${info.pros.map(p => `<li>• ${p}</li>`).join('')}</ul>
                    </div>
                    <div>
                        <h6 class="text-danger mb-2">👎 จุดด้อย</h6>
                        <ul>${info.cons.map(c => `<li>• ${c}</li>`).join('')}</ul>
                    </div>
                </div>
            </div>`;

        document.getElementById('explainModalIcon').textContent = info.icon;
        document.getElementById('explainModalTitle').textContent = info.title;
        document.getElementById('explainModalHeader').style.background = `linear-gradient(135deg, ${info.color}, ${info.color}cc)`;
        document.getElementById('explainModalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('explainModal')).show();
    }

    // Show Feature Explanation Modal
    function showFeatureExplanation(key, importance, rank) {
        const info = featureDetailsTH[key];
        const thaiName = getThaiFeatureName(key);
        const pct = (importance * 100).toFixed(2);

        let html = `
            <div class="explain-section">
                <h6>ℹ️ คืออะไร?</h6>
                <p class="mb-0">${info ? info.meaning : 'ปัจจัยที่ใช้ในการทำนาย'}</p>
            </div>
            <div class="explain-section">
                <h6>📊 ค่าความสำคัญ</h6>
                <div class="d-flex align-items-center gap-3 mt-2">
                    <span class="badge bg-primary rounded-pill fs-6 px-3 py-2">อันดับ #${rank}</span>
                    <div class="flex-grow-1">
                        <div class="progress" style="height: 20px; border-radius: 10px;">
                            <div class="progress-bar bg-primary" style="width: ${Math.min(importance / 0.3 * 100, 100)}%; border-radius: 10px;">${pct}%</div>
                        </div>
                    </div>
                </div>
            </div>`;

        if (info && info.why) {
            html += `
            <div class="explain-section">
                <h6>🤔 ทำไมถึงสำคัญ?</h6>
                <p class="mb-0">${info.why}</p>
            </div>`;
        }

        if (info && info.insight) {
            html += `
            <div class="explain-section">
                <h6>💡 ข้อมูลเชิงลึก</h6>
                <div class="explain-example">${info.insight}</div>
            </div>`;
        }

        document.getElementById('explainModalIcon').textContent = '📌';
        document.getElementById('explainModalTitle').textContent = thaiName;
        document.getElementById('explainModalHeader').style.background = 'linear-gradient(135deg, #8b5cf6, #a78bfa)';
        document.getElementById('explainModalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('explainModal')).show();
    }

    // Display training results
    function displayTrainingResults(result) {
        lastTrainingResult = result;
        document.getElementById('resultsCard').classList.remove('d-none');
        document.getElementById('trainingResults').classList.remove('d-none');
        document.getElementById('predictionResults').classList.add('d-none');
        document.getElementById('analysisResults').classList.add('d-none');

        const acc = result.accuracy != null ? (result.accuracy * 100).toFixed(1) : '—';
        const prec = result.precision != null ? (result.precision * 100).toFixed(1) : '—';
        const rec = result.recall != null ? (result.recall * 100).toFixed(1) : '—';
        const f1 = result.f1_score != null ? (result.f1_score * 100).toFixed(1) : '—';

        document.getElementById('accuracyDisplay').textContent = acc + '%';
        document.getElementById('precisionDisplay').textContent = prec + '%';
        document.getElementById('recallDisplay').textContent = rec + '%';
        document.getElementById('f1Display').textContent = f1 + '%';

        // สร้างรายละเอียดการเทรน
        const modelName = result.model_filename || '—';
        const samples = result.training_samples || 0;
        const featCount = result.features_count || result.features || 0;
        const cpCount = result.course_profiles_count || 0;
        const bestModel = result.best_model_name || '';
        const labelDist = result.label_distribution || {};
        const studentsCount = result.students_count || '';
        const coursesCount = result.courses_count || '';
        const trainingType = result.training_type || '';

        // แสดง label distribution
        let labelHtml = '';
        if (labelDist && Object.keys(labelDist).length > 0) {
            const grad = labelDist[1] || labelDist['1'] || 0;
            const notGrad = labelDist[0] || labelDist['0'] || 0;
            const total = grad + notGrad;
            const gradPct = total > 0 ? ((grad / total) * 100).toFixed(1) : 0;
            labelHtml = `
                <div class="d-flex justify-content-center gap-3 mb-2">
                    <span class="badge bg-success px-3 py-2"><i class="bi bi-mortarboard-fill me-1"></i> จบการศึกษา ${grad} คน (${gradPct}%)</span>
                    <span class="badge bg-danger px-3 py-2"><i class="bi bi-exclamation-triangle-fill me-1"></i> ไม่จบ ${notGrad} คน (${(100 - gradPct).toFixed(1)}%)</span>
                </div>`;
        }

        // แสดง retake analysis (ถ้ามี)
        let retakeHtml = '';
        const retake = result.retake_analysis;
        if (retake && retake.students_with_retakes > 0) {
            let topRetakersHtml = '';
            if (retake.top_retakers && retake.top_retakers.length > 0) {
                topRetakersHtml = `
                    <div class="mt-3">
                        <h6 class="fw-bold mb-2"><i class="bi bi-person-exclamation me-1"></i> นศ.ที่เรียนซ้ำมากที่สุด (5+ วิชา)</h6>
                        <div class="table-responsive"><table class="table table-sm table-bordered text-center mb-0">
                            <thead class="table-light"><tr><th>รหัสนศ.</th><th>วิชาซ้ำ</th><th>เคยได้ F</th><th>เคยถอน W</th><th>เกรดดีขึ้นเฉลี่ย</th></tr></thead>
                            <tbody>`;
                retake.top_retakers.forEach(s => {
                    const impClass = s.avg_retake_improvement >= 2.0 ? 'text-success' : s.avg_retake_improvement >= 1.0 ? 'text-warning' : 'text-danger';
                    topRetakersHtml += `<tr>
                        <td class="text-start"><code>${s.student_id}</code></td>
                        <td><span class="badge bg-primary">${s.num_retake_courses}</span></td>
                        <td>${s.retake_f_count > 0 ? '<span class="badge bg-danger">' + s.retake_f_count + '</span>' : '<span class="text-muted">0</span>'}</td>
                        <td>${s.retake_w_count > 0 ? '<span class="badge bg-warning text-dark">' + s.retake_w_count + '</span>' : '<span class="text-muted">0</span>'}</td>
                        <td class="${impClass} fw-bold">${s.avg_retake_improvement > 0 ? '+' : ''}${s.avg_retake_improvement.toFixed(2)}</td>
                    </tr>`;
                });
                topRetakersHtml += '</tbody></table></div>';
            }

            retakeHtml = `
            <div class="card border-warning shadow-sm mb-4">
                <div class="card-header bg-warning bg-opacity-10 border-warning">
                    <h6 class="mb-0 fw-bold"><i class="bi bi-arrow-repeat me-2"></i>Retake Analysis (การเรียนซ้ำ)</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center g-3 mb-3">
                        <div class="col-6 col-md-3">
                            <div class="p-2 bg-light rounded-3">
                                <div class="fs-4 fw-bold text-primary">${retake.students_with_retakes}</div>
                                <small class="text-muted">นศ.มีเรียนซ้ำ</small>
                                <div><span class="badge bg-primary">${retake.retake_percentage}%</span> <small class="text-muted">ของทั้งหมด</small></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-2 bg-light rounded-3">
                                <div class="fs-4 fw-bold text-danger">${retake.total_f_retakes}</div>
                                <small class="text-muted">เคยได้ F (เรียนซ้ำ)</small>
                                <div><span class="badge bg-danger">F</span> <small class="text-muted">+ W ${retake.total_w_retakes}</small></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-2 bg-light rounded-3">
                                <div class="fs-4 fw-bold text-warning">${retake.avg_retake_per_student}</div>
                                <small class="text-muted">วิชาซ้ำ/คน (เฉลี่ย)</small>
                                <div><small class="text-muted">สูงสุด ${retake.max_retake_courses} วิชา</small></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-2 bg-light rounded-3">
                                <div class="fs-4 fw-bold ${retake.avg_improvement >= 2.0 ? 'text-success' : retake.avg_improvement >= 1.0 ? 'text-warning' : 'text-danger'}">${retake.avg_improvement > 0 ? '+' : ''}${retake.avg_improvement}</div>
                                <small class="text-muted">เกรดดีขึ้นเฉลี่ย</small>
                                <div><small class="text-muted">จากการเรียนซ้ำ</small></div>
                            </div>
                        </div>
                    </div>
                    ${topRetakersHtml}
                </div>
            </div>`;
        }

        // แสดงผลโมเดลทั้งหมด (ถ้ามี)
        let allModelsHtml = '';
        if (result.all_model_results) {
            allModelsHtml = '<h6 class="fw-bold mt-3 mb-2"><i class="bi bi-bar-chart-line me-1"></i> ผลเปรียบเทียบทุกโมเดล</h6><div class="table-responsive"><table class="table table-sm table-bordered text-center mb-0"><thead class="table-light"><tr><th>โมเดล</th><th>ความแม่นยำ</th><th>ความแม่นเจาะจง</th><th>ความครอบคลุม</th><th>คะแนนสมดุล</th></tr></thead><tbody>';
            for (const [name, metrics] of Object.entries(result.all_model_results)) {
                const isBest = name === bestModel;
                const rowClass = isBest ? 'table-success fw-bold clickable-explain' : 'clickable-explain';
                const badge = isBest ? ' <span class="badge bg-warning text-dark ms-1">ดีที่สุด</span>' : '';
                allModelsHtml += `<tr class="${rowClass}" onclick="showModelExplanation('${name}')" style="cursor:pointer;" title="คลิกเพื่อดูคำอธิบายโมเดล"><td class="text-start">${name}${badge}</td><td>${(metrics.accuracy*100).toFixed(1)}%</td><td>${(metrics.precision*100).toFixed(1)}%</td><td>${(metrics.recall*100).toFixed(1)}%</td><td>${(metrics.f1_score*100).toFixed(1)}%</td></tr>`;
            }
            allModelsHtml += '</tbody></table></div>';
        }

        document.getElementById('trainingDetails').innerHTML = `
        ${retakeHtml}
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                ${labelHtml}
                <div class="row text-center g-3 mt-2">
                    <div class="col-6 col-md-3">
                        <div class="p-2 bg-light rounded-3">
                            <i class="bi bi-file-earmark-code text-primary d-block mb-1" style="font-size:1.3rem;"></i>
                            <small class="text-muted d-block">ชื่อโมเดล</small>
                            <span class="fw-bold small text-truncate d-block" title="${modelName}">${modelName}</span>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="p-2 bg-light rounded-3">
                            <i class="bi bi-database text-success d-block mb-1" style="font-size:1.3rem;"></i>
                            <small class="text-muted d-block">ตัวอย่างเทรน</small>
                            <span class="fw-bold">${samples.toLocaleString()} <small class="text-muted">snapshots</small></span>
                            ${studentsCount ? `<br><small class="text-muted">จาก ${studentsCount} นักศึกษา</small>` : ''}
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="p-2 bg-light rounded-3">
                            <i class="bi bi-sliders text-warning d-block mb-1" style="font-size:1.3rem;"></i>
                            <small class="text-muted d-block">จำนวนปัจจัย</small>
                            <span class="fw-bold">${featCount} <small class="text-muted">ปัจจัย</small></span>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="p-2 bg-light rounded-3">
                            <i class="bi bi-book text-info d-block mb-1" style="font-size:1.3rem;"></i>
                            <small class="text-muted d-block">โปรไฟล์รายวิชา</small>
                            <span class="fw-bold">${cpCount || '—'} <small class="text-muted">วิชา</small></span>
                            ${coursesCount ? `<br><small class="text-muted">(Course DNA)</small>` : ''}
                        </div>
                    </div>
                </div>
                ${allModelsHtml}
            </div>
        </div>
    `;

        if (result.feature_importances && Object.keys(result.feature_importances).length > 0) {
            const featureList = document.getElementById('featureList');
            let featureHtml = '';

            const features = Object.entries(result.feature_importances)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const maxImp = features.length > 0 ? features[0][1] : 1;

            features.forEach(([feature, importance], index) => {
                const percentage = (importance * 100).toFixed(2);
                const barWidth = ((importance / maxImp) * 100).toFixed(1);
                const thaiName = getThaiFeatureName(feature);
                featureHtml += `
                <div class="feature-bar clickable-explain" onclick="showFeatureExplanation('${feature}', ${importance}, ${index + 1})" title="คลิกเพื่อดูคำอธิบาย: ${thaiName}">
                    <span class="feature-rank">${index + 1}</span>
                    <span class="feature-name text-truncate" title="${feature}">${thaiName}</span>
                    <div class="feature-progress">
                        <div class="progress-bar bg-primary" style="width: ${barWidth}%"></div>
                    </div>
                    <span class="feature-value">${percentage}%</span>
                </div>
            `;
            });

            featureList.innerHTML = featureHtml;
            document.getElementById('featureImportance').classList.remove('d-none');
        } else {
            document.getElementById('featureImportance').classList.add('d-none');
        }

        displayGeminiTrainingResult(result.gemini_analysis);

        // เปิด tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

        setTimeout(() => {
            document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
        }, 200);
    }

    function displayGeminiTrainingResult(analysis) {
        const container = document.getElementById('geminiTrainingResult');
        const body = document.getElementById('geminiTrainingResultBody');
        const goalBadge = document.getElementById('geminiTrainingGoalBadge');

        if (!container || !body) return;

        if (!analysis) {
            container.classList.add('d-none');
            return;
        }

        container.classList.remove('d-none');

        if (goalBadge && analysis.analysis_goal) {
            goalBadge.style.display = 'inline-block';
            goalBadge.textContent = analysis.analysis_goal;
        } else if (goalBadge) {
            goalBadge.style.display = 'none';
        }

        if (analysis.error) {
            body.innerHTML = `<div class="alert alert-warning mb-0">${analysis.error}</div>`;
            return;
        }

        const gemini = analysis.gemini || {};
        body.innerHTML = gemini.analysis_markdown ? renderMarkdown(gemini.analysis_markdown) : '<p class="mb-0 text-muted">ไม่มีข้อมูลเพิ่มเติมจาก Gemini</p>';
    }

    // Predict data
    async function predictData() {
        if (!currentFilename) {
            showAlert('กรุณาอัปโหลดไฟล์ข้อมูลก่อน', 'warning');
            return;
        }

        showLoading('กำลังทำนายผลการเรียน...');
        toggleSpinner('predictBtn', true);

        try {
            const modelsResponse = await fetch('/api/models');
            const modelsData = await modelsResponse.json();

            if (!modelsData.success || modelsData.models.length === 0) {
                showAlert('ไม่พบโมเดล AI กรุณาฝึกโมเดลก่อน', 'warning');
                hideLoading();
                toggleSpinner('predictBtn', false);
                return;
            }

            const modelFilename = modelsData.models[0].filename;

            const response = await fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filename: currentFilename,
                    model_filename: modelFilename
                })
            });
            const result = await response.json();

            if (result.success) {
                displayPredictionResults(result.results, result.summary);
                showAlert('ทำนายผลสำเร็จ!', 'success');
            } else {
                showAlert('เกิดข้อผิดพลาด: ' + result.error, 'danger');
            }
        } catch (error) {
            showAlert('เกิดข้อผิดพลาดในการทำนาย', 'danger');
        } finally {
            hideLoading();
            toggleSpinner('predictBtn', false);
        }
    }

    // Display prediction results
    function displayPredictionResults(results, summary) {
        document.getElementById('resultsCard').classList.remove('d-none');
        document.getElementById('predictionResults').classList.remove('d-none');
        document.getElementById('trainingResults').classList.add('d-none');
        document.getElementById('analysisResults').classList.add('d-none');

        document.getElementById('summary').innerHTML = `
        <div class="row g-3">
            <div class="col-md-3">
                <div class="card bg-primary text-white text-center p-3 h-100 shadow-sm">
                    <div class="fs-1 fw-bold">${summary.total}</div>
                    <div class="small opacity-75">นักศึกษาทั้งหมด</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white text-center p-3 h-100 shadow-sm">
                    <div class="fs-1 fw-bold">${summary.predicted_pass}</div>
                    <div class="small opacity-75">คาดว่าจะจบ (${summary.pass_rate.toFixed(1)}%)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white text-center p-3 h-100 shadow-sm">
                    <div class="fs-1 fw-bold">${summary.predicted_fail}</div>
                    <div class="small opacity-75">คาดว่าไม่จบ</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white text-center p-3 h-100 shadow-sm">
                    <div class="fs-1 fw-bold">${summary.high_risk}</div>
                    <div class="small opacity-75">ความเสี่ยงสูง</div>
                </div>
            </div>
        </div>
    `;

        document.getElementById('overviewContent').innerHTML = `
        <div style="height: 350px; width: 100%; max-width: 500px;">
            <canvas id="predictionChart"></canvas>
        </div>
    `;

        setTimeout(() => {
            const ctx = document.getElementById('predictionChart').getContext('2d');
            const existingChart = Chart.getChart('predictionChart');
            if (existingChart) existingChart.destroy();

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['คาดว่าจะจบ', 'คาดว่าไม่จบ'],
                    datasets: [{
                        data: [summary.predicted_pass, summary.predicted_fail],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20 } }
                    }
                }
            });
        }, 100);

        document.getElementById('results').innerHTML = `
        <div class="table-responsive rounded border">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="py-3 ps-3">ชื่อ</th>
                        <th class="py-3">การทำนาย</th>
                        <th class="py-3">GPA</th>
                        <th class="py-3">ความน่าจะเป็น</th>
                        <th class="py-3 pe-3">ระดับความเสี่ยง</th>
                    </tr>
                </thead>
                <tbody>
                    ${results.slice(0, 50).map(r => `
                        <tr>
                            <td class="ps-3 fw-medium">${r.ชื่อ}</td>
                            <td><span class="badge bg-${r.การทำนาย === 'จบ' ? 'success' : 'danger'} rounded-pill px-3">${r.การทำนาย}</span></td>
                            <td class="font-monospace">${r.เกรดเฉลี่ย.toFixed(2)}</td>
                            <td>
                                <div class="progress" style="height: 8px; width: 120px;">
                                    <div class="progress-bar bg-success" style="width: ${r.ความน่าจะเป็น.จบ * 100}%"></div>
                                </div>
                                <small class="text-muted" style="font-size: 0.7rem;">${(r.ความน่าจะเป็น.จบ * 100).toFixed(0)}%</small>
                            </td>
                            <td class="pe-3"><span class="badge bg-${r.ระดับความเสี่ยง === 'ต่ำ' ? 'success' : r.ระดับความเสี่ยง === 'ปานกลาง' ? 'warning' : 'danger'} rounded-pill">${r.ระดับความเสี่ยง}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <small class="text-muted mt-2 d-block">* แสดงผล 50 รายการแรก</small>
    `;

        const allRecommendations = [...new Set(results.flatMap(r => r.คำแนะนำ))];
        document.getElementById('recommendationsContent').innerHTML = `
        <div class="row g-3">
            ${allRecommendations.map(rec => `
                <div class="col-md-6">
                    <div class="alert alert-info mb-0 border-0 shadow-sm d-flex align-items-center h-100">
                        <i class="bi bi-lightbulb-fill me-3 fs-4"></i>
                        <div>${rec}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;

        setTimeout(() => {
            document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
        }, 200);
    }

    // Analyze subjects
    async function analyzeSubjects() {
        if (!currentFilename) {
            showAlert('กรุณาอัปโหลดไฟล์ข้อมูลก่อน', 'warning');
            return;
        }

        showLoading('กำลังวิเคราะห์ Course DNA...');
        toggleSpinner('analyzeBtn', true);

        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: currentFilename })
            });
            const result = await response.json();

            if (result.success) {
                displayAnalysisResults(result);
                showAlert('วิเคราะห์ Course DNA สำเร็จ!', 'success');
            } else {
                showAlert('เกิดข้อผิดพลาด: ' + result.error, 'danger');
            }
        } catch (error) {
            showAlert('เกิดข้อผิดพลาดในการวิเคราะห์', 'danger');
        } finally {
            hideLoading();
            toggleSpinner('analyzeBtn', false);
        }
    }

    // Display analysis results
    function displayAnalysisResults(data) {
        document.getElementById('resultsCard').classList.remove('d-none');
        document.getElementById('analysisResults').classList.remove('d-none');
        document.getElementById('trainingResults').classList.add('d-none');
        document.getElementById('predictionResults').classList.add('d-none');

        document.getElementById('analysis-summary').innerHTML = `
        <div class="alert alert-light border shadow-sm">
            <div class="row text-center">
                <div class="col-md-3">
                    <strong class="d-block display-6 fw-bold text-primary">${data.overall_stats.total_students}</strong>
                    <small class="text-muted text-uppercase fw-bold">นักศึกษาทั้งหมด</small>
                </div>
                <div class="col-md-3">
                    <strong class="d-block display-6 fw-bold text-primary">${data.overall_stats.total_subjects}</strong>
                    <small class="text-muted text-uppercase fw-bold">จำนวนวิชา</small>
                </div>
                <div class="col-md-3">
                    <strong class="d-block display-6 fw-bold text-primary">${data.overall_stats.avg_gpa.toFixed(2)}</strong>
                    <small class="text-muted text-uppercase fw-bold">GPA เฉลี่ย</small>
                </div>
                <div class="col-md-3">
                    <strong class="d-block display-6 fw-bold text-danger">${(data.overall_stats.overall_fail_rate * 100).toFixed(1)}%</strong>
                    <small class="text-muted text-uppercase fw-bold">อัตราตกรวม</small>
                </div>
            </div>
        </div>
    `;

        if (data.recommendations && data.recommendations.length > 0) {
            document.getElementById('analysis-recommendations').innerHTML = `
            <div class="alert alert-warning border-warning shadow-sm">
                <h6 class="alert-heading fw-bold mb-3">
                    <i class="bi bi-lightbulb-fill me-2"></i>คำแนะนำจากการวิเคราะห์
                </h6>
                <ul class="mb-0 ps-3">
                    ${data.recommendations.map(rec => `<li class="mb-1">${rec}</li>`).join('')}
                </ul>
            </div>
        `;
        }

        const highFailList = document.getElementById('highFailSubjects');
        if (data.problem_subjects.high_fail_rate.length > 0) {
            highFailList.innerHTML = data.problem_subjects.high_fail_rate.slice(0, 10).map(s => `
            <li class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                <span class="fw-medium">${s.subject}</span>
                <div>
                    <span class="badge bg-danger me-1">ตก ${(s.fail_rate * 100).toFixed(1)}%</span>
                    <span class="badge bg-secondary">GPA ${s.average.toFixed(2)}</span>
                </div>
            </li>
        `).join('');
        } else {
            highFailList.innerHTML = '<p class="text-muted mb-0 fst-italic">ไม่พบวิชาที่มีอัตราตกสูงผิดปกติ</p>';
        }

        const easySubjectsList = document.getElementById('easySubjects');
        if (data.excellent_subjects && data.excellent_subjects.length > 0) {
            easySubjectsList.innerHTML = data.excellent_subjects.slice(0, 10).map(s => `
            <li class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                <span class="fw-medium">${s.subject}</span>
                <div>
                    <span class="badge bg-success me-1">GPA ${s.average.toFixed(2)}</span>
                    <span class="badge bg-info">${s.num_students} คน</span>
                </div>
            </li>
        `).join('');
        } else {
            easySubjectsList.innerHTML = '<p class="text-muted mb-0 fst-italic">ไม่พบวิชาที่มีผลการเรียนดีเยี่ยม</p>';
        }

        setTimeout(() => {
            const ctx = document.getElementById('courseDistributionChart').getContext('2d');
            const existingChart = Chart.getChart('courseDistributionChart');
            if (existingChart) existingChart.destroy();

            const categories = Object.keys(data.category_summary || {});
            const avgGPAs = categories.map(cat => data.category_summary[cat].avg_gpa);
            const failRates = categories.map(cat => data.category_summary[cat].avg_fail_rate * 100);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [
                        {
                            label: 'GPA เฉลี่ย',
                            data: avgGPAs,
                            backgroundColor: 'rgba(79, 70, 229, 0.7)',
                            borderColor: '#4f46e5',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'อัตราตก (%)',
                            data: failRates,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', max: 4, title: { display: true, text: 'GPA' } },
                        y1: { type: 'linear', display: true, position: 'right', max: 100, grid: { drawOnChartArea: false }, title: { display: true, text: 'Fail Rate (%)' } }
                    }
                }
            });
        }, 100);

        setTimeout(() => {
            document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
        }, 200);
    }
</script>
{% endblock %}