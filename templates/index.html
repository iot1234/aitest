{% extends "base.html" %}

{% block title %}ฝึกโมเดล AI - ระบบทำนายความสำเร็จของนักศึกษา{% endblock %}

{% block custom_css %}
<style>
    /* Page Header */
    .page-header {
        padding: 3rem 0 2rem;
        text-align: center;
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: white;
        text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 0.5rem;
    }
    
    .page-header .lead {
        color: rgba(255,255,255,0.9);
        font-weight: 300;
    }
    
    /* System Features */
    .features-container {
        margin-bottom: 3rem;
    }
    
    .feature-box {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: transform 0.3s;
        height: 100%;
        box-shadow: var(--shadow);
    }
    
    .feature-box:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }
    
    .feature-box-icon {
        width: 60px;
        height: 60px;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        flex-shrink: 0;
        color: white;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .feature-box h6 {
        margin-bottom: 0.25rem;
        font-weight: 700;
        color: var(--gray-800);
        font-size: 1.1rem;
    }
    
    .feature-box small {
        color: var(--gray-600);
        display: block;
        line-height: 1.4;
    }
    
    /* Upload Section */
    .upload-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        padding: 3rem;
        border: 1px solid rgba(255,255,255,0.5);
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .section-number {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1.5rem;
        flex-shrink: 0;
        box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
    }
    
    .section-title h5 {
        margin-bottom: 0.25rem;
        font-weight: 700;
        color: var(--gray-800);
        font-size: 1.25rem;
    }
    
    .section-title small {
        color: var(--gray-500);
        font-size: 0.9rem;
    }
    
    /* File Upload */
    .file-upload-wrapper {
        position: relative;
        padding: 2rem;
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius-lg);
        background: var(--gray-50);
        text-align: center;
        transition: all 0.3s;
    }
    
    .file-upload-wrapper:hover {
        border-color: var(--primary);
        background: var(--primary-bg);
    }
    
    .file-upload-wrapper input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }
    
    .upload-icon {
        font-size: 3rem;
        color: var(--gray-400);
        margin-bottom: 1rem;
        transition: color 0.3s;
    }
    
    .file-upload-wrapper:hover .upload-icon {
        color: var(--primary);
    }
    
    /* Status Cards */
    .status-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        height: 100%;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
    }
    
    .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--gray-100);
    }
    
    .status-item:last-child {
        border-bottom: none;
    }
    
    .status-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--gray-600);
        font-weight: 600;
    }
    
    /* Actions Section */
    .actions-section {
        background: #f8fafc;
        border-radius: var(--radius-xl);
        padding: 3rem;
        margin-top: 3rem;
        border: 1px solid var(--gray-200);
    }
    
    .action-card {
        background: white;
        border-radius: var(--radius-xl);
        padding: 2rem;
        text-align: center;
        height: 100%;
        border: 1px solid transparent;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: var(--shadow);
    }
    
    .action-card:hover {
        border-color: var(--primary);
        transform: translateY(-10px);
        box-shadow: var(--shadow-lg);
    }
    
    .action-icon {
        width: 80px;
        height: 80px;
        border-radius: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        font-size: 2.5rem;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .action-card h6 {
        font-weight: 700;
        color: var(--gray-800);
        margin-bottom: 0.75rem;
        font-size: 1.25rem;
    }
    
    .action-card p {
        color: var(--gray-500);
        font-size: 0.95rem;
        margin-bottom: 1.5rem;
        min-height: 44px;
    }
    
    /* Training Progress */
    .training-progress {
        background: white;
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-top: 2rem;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-200);
    }
    
    .training-progress h6 {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--primary);
        margin-bottom: 1.5rem;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .progress {
        height: 1.5rem;
        border-radius: 1rem;
        background: var(--gray-100);
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .progress-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.8rem;
        background: linear-gradient(90deg, var(--primary), var(--primary-light));
        box-shadow: 0 2px 5px rgba(79, 70, 229, 0.4);
    }
    
    /* Results Section */
    .results-section {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
        margin-top: 3rem;
        border: 1px solid rgba(0,0,0,0.05);
    }
    
    .results-header {
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        padding: 1.5rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .results-body {
        padding: 2.5rem;
    }
    
    /* Metrics Grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }
    
    .metric-card {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.3s;
        border: 1px solid var(--gray-200);
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        background: white;
        box-shadow: var(--shadow);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .metric-value.text-primary { color: var(--primary); }
    .metric-value.text-success { color: var(--success); }
    .metric-value.text-warning { color: var(--warning); }
    .metric-value.text-info { color: var(--info); }
    
    .metric-label {
        color: var(--gray-500);
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Feature Importance */
    .feature-importance {
        background: white;
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
    }
    
    .feature-bar {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 0.5rem;
        border-radius: var(--radius);
        transition: background 0.2s;
    }
    
    .feature-bar:hover {
        background: var(--gray-50);
    }
    
    .feature-rank {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: 700;
        flex-shrink: 0;
        box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3);
    }
    
    .feature-name {
        width: 220px;
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--gray-700);
        flex-shrink: 0;
    }
    
    .feature-progress {
        flex-grow: 1;
        height: 12px;
        background: var(--gray-200);
        border-radius: 10px;
        overflow: hidden;
    }
    
    .feature-progress .progress-bar {
        height: 100%;
        border-radius: 10px;
    }
    
    .feature-value {
        width: 60px;
        text-align: right;
        font-weight: 700;
        color: var(--gray-600);
        font-size: 0.9rem;
    }
    
    /* Gemini Section */
    .gemini-section {
        background: linear-gradient(135deg, #1e1e2e, #2d2d3e);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-top: 2rem;
        color: #e2e8f0;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .gemini-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #a78bfa;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .gemini-content {
        line-height: 1.8;
        font-size: 1.05rem;
    }
    
    /* Responsive */
    @media (max-width: 992px) {
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .feature-box { flex-direction: column; text-align: center; }
        .section-header { flex-direction: column; text-align: center; }
        .feature-name { width: 100%; margin-bottom: 0.5rem; }
        .feature-bar { flex-wrap: wrap; }
    }
    
    /* Toggle Switch */
    .form-switch .form-check-input {
        width: 3.5rem;
        height: 1.75rem;
        cursor: pointer;
        background-color: var(--gray-300);
        border-color: var(--gray-300);
    }
    
    .form-switch .form-check-input:checked {
        background-color: var(--primary);
        border-color: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header" data-aos="fade-down">
    <h1><i class="bi bi-cpu-fill me-2"></i>ฝึกโมเดล AI ขั้นสูง</h1>
    <p class="lead">Advanced Context-Aware Training System</p>
</div>

<!-- System Features -->
<div class="features-container row g-4" data-aos="fade-up">
    <div class="col-md-4">
        <div class="feature-box">
            <div class="feature-box-icon bg-primary">
                <i class="bi bi-diagram-3"></i>
            </div>
            <div>
                <h6>Course DNA Profiling</h6>
                <small>วิเคราะห์ DNA และความยากของแต่ละวิชาอย่างละเอียด</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="feature-box">
            <div class="feature-box-icon bg-success">
                <i class="bi bi-camera"></i>
            </div>
            <div>
                <h6>Dynamic Snapshots</h6>
                <small>สร้างภาพถ่ายการเรียนทุกช่วงเวลาเพื่อติดตามพัฒนาการ</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="feature-box">
            <div class="feature-box-icon bg-warning">
                <i class="bi bi-lightbulb"></i>
            </div>
            <div>
                <h6>Contextual Learning</h6>
                <small>เรียนรู้และปรับตัวตามบริบทของข้อมูลแต่ละรุ่นปี</small>
            </div>
        </div>
    </div>
</div>

<!-- Main Training Card -->
<div class="upload-section" data-aos="fade-up" data-aos-delay="100">
    <!-- Upload Section -->
    <div class="section-header">
        <div class="section-number">1</div>
        <div class="section-title">
            <h5>อัปโหลดข้อมูล</h5>
            <small>นำเข้าไฟล์ข้อมูลผลการเรียนของนักศึกษา (.csv, .xlsx)</small>
        </div>
    </div>
    
    <div class="row g-5">
        <div class="col-lg-7">
            <div class="file-upload-wrapper mb-4">
                <div class="upload-icon">
                    <i class="bi bi-cloud-arrow-up"></i>
                </div>
                <h5 class="fw-bold mb-2">ลากไฟล์มาวางที่นี่ หรือ คลิกเพื่อเลือกไฟล์</h5>
                <p class="text-muted small mb-0">รองรับไฟล์ CSV, Excel (.xlsx, .xls) ขนาดสูงสุด 100MB</p>
                <input type="file" id="fileUpload" accept=".csv, .xlsx, .xls">
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <div class="flex-grow-1">
                     <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-file-earmark-text"></i></span>
                        <input type="text" class="form-control" id="fileNameDisplay" placeholder="ยังไม่ได้เลือกไฟล์" readonly style="background-color: white;">
                    </div>
                </div>
                <button class="btn btn-primary btn-lg px-4" id="uploadBtn" onclick="uploadFile()" disabled>
                    <span id="uploadSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                    <i class="bi bi-cloud-upload"></i> อัปโหลด
                </button>
            </div>
        </div>
        
        <div class="col-lg-5">
            <div class="status-card">
                <h6 class="fw-bold text-gray-800 mb-3 pb-2 border-bottom">
                    <i class="bi bi-speedometer2 me-2 text-primary"></i>สถานะระบบ
                </h6>
                <div class="status-item">
                    <span class="status-label">
                        <i class="bi bi-cpu text-primary"></i> โมเดล AI
                    </span>
                    <span id="subject-model-status">
                        <span class="badge bg-secondary rounded-pill">กำลังตรวจสอบ...</span>
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">
                        <i class="bi bi-database text-info"></i> ที่เก็บข้อมูล
                    </span>
                    <span id="storage-status">
                        <span class="badge bg-secondary rounded-pill">กำลังตรวจสอบ...</span>
                    </span>
                </div>
                 <div class="status-item">
                    <span class="status-label">
                        <i class="bi bi-shield-check text-success"></i> ความพร้อม
                    </span>
                    <span id="model-check-status">
                         <span class="badge bg-secondary rounded-pill">รอการตรวจสอบ</span>
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions Section -->
    <div id="actionsCard" class="actions-section d-none animate__animated animate__fadeIn">
        <div class="section-header">
            <div class="section-number">2</div>
            <div class="section-title">
                <h5>เลือกการดำเนินการ</h5>
                <small>ไฟล์: <strong id="fileName" class="text-primary"></strong> | <span id="fileInfo"></span></small>
            </div>
        </div>
        
        <div class="row g-4">
            <!-- Train Model -->
            <div class="col-lg-4">
                <div class="action-card">
                    <div class="action-icon bg-primary text-white">
                        <i class="bi bi-cpu-fill"></i>
                    </div>
                    <h6>ฝึกโมเดล AI</h6>
                    <p>ใช้ Advanced Context-Aware Training เพื่อสร้างโมเดล</p>
                    
                    <div class="text-start mb-4 p-3 bg-light rounded-3 border">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="enableGeminiTraining" checked>
                            <label class="form-check-label fw-semibold" for="enableGeminiTraining">
                                ใช้ Gemini Analysis
                            </label>
                            <span class="badge bg-secondary ms-2" id="geminiTrainingStatusBadge">
                                <i class="bi bi-hourglass-split"></i>
                            </span>
                        </div>
                        <textarea class="form-control form-control-sm mt-2" id="geminiAnalysisGoalInput" rows="2"
                                  placeholder="ระบุเป้าหมายการวิเคราะห์ (Optional)"></textarea>
                    </div>
                    
                    <button class="btn btn-primary w-100 rounded-pill py-2" id="trainBtn" onclick="trainModel()">
                        <span id="trainSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                        <i class="bi bi-play-circle-fill"></i> เริ่มฝึกโมเดล
                    </button>
                </div>
            </div>
            
            <!-- Predict -->
            <div class="col-lg-4">
                <div class="action-card">
                    <div class="action-icon bg-success text-white">
                        <i class="bi bi-magic"></i>
                    </div>
                    <h6>ทำนายผลการเรียน</h6>
                    <p>ใช้โมเดลที่ฝึกแล้วทำนายผลจากข้อมูลชุดนี้</p>
                    <button class="btn btn-success w-100 rounded-pill py-2 mt-auto" id="predictBtn" onclick="predictData()" disabled>
                        <span id="predictSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                        <i class="bi bi-graph-up-arrow"></i> ทำนายผล
                    </button>
                </div>
            </div>
            
            <!-- Analyze -->
            <div class="col-lg-4">
                <div class="action-card">
                    <div class="action-icon bg-info text-white">
                        <i class="bi bi-bar-chart-line-fill"></i>
                    </div>
                    <h6>วิเคราะห์ข้อมูลเชิงลึก</h6>
                    <p>วิเคราะห์รายวิชาและ Course DNA Profile</p>
                    <button class="btn btn-info w-100 rounded-pill py-2 mt-auto" id="analyzeBtn" onclick="analyzeSubjects()">
                        <span id="analyzeSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                        <i class="bi bi-search"></i> วิเคราะห์
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Training Progress -->
        <div id="trainingProgress" class="training-progress d-none animate__animated animate__fadeIn">
            <h6>
                <i class="bi bi-gear-wide-connected fa-spin me-2"></i>
                กำลังฝึกโมเดล...
            </h6>
            <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     id="progressBar" 
                     role="progressbar" 
                     style="width: 0%">0%</div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                 <small class="text-primary fw-bold" id="progressText">กำลังเตรียมข้อมูล...</small>
                 <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<div id="resultsCard" class="results-section d-none">
    <div class="results-header">
        <h5 class="mb-0 fw-bold">
            <i class="bi bi-graph-up-arrow me-2"></i>ผลลัพธ์การประมวลผล
        </h5>
        <button class="btn btn-sm btn-outline-light rounded-circle" onclick="document.getElementById('resultsCard').classList.add('d-none')"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="results-body">
        <!-- Training Results -->
        <div id="trainingResults" class="d-none animate__animated animate__fadeIn">
            <div class="text-center mb-5">
                <h4 class="fw-bold text-primary mb-2">
                    <i class="bi bi-trophy-fill me-2 text-warning"></i>ฝึกโมเดลสำเร็จ
                </h4>
                <p class="text-muted">โมเดลพร้อมใช้งานสำหรับการทำนายผล</p>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value text-success" id="accuracyDisplay">0%</div>
                    <div class="metric-label">Accuracy</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value text-primary" id="precisionDisplay">0%</div>
                    <div class="metric-label">Precision</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value text-warning" id="recallDisplay">0%</div>
                    <div class="metric-label">Recall</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value text-info" id="f1Display">0%</div>
                    <div class="metric-label">F1-Score</div>
                </div>
            </div>
            
            <div class="alert alert-light border mb-4 shadow-sm" id="trainingDetails"></div>
            
            <div class="row">
                <div class="col-lg-6 mb-4">
                     <div id="featureImportance" class="feature-importance h-100">
                        <h6 class="fw-bold mb-4 pb-2 border-bottom">
                            <i class="bi bi-list-ol me-2 text-primary"></i>Features ที่สำคัญที่สุด
                        </h6>
                        <div id="featureList"></div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div id="geminiTrainingResult" class="gemini-section d-none h-100">
                        <div class="gemini-header">
                            <i class="bi bi-stars"></i>
                            <h6 class="mb-0">Gemini Insights</h6>
                            <span class="badge bg-primary ms-auto" id="geminiTrainingGoalBadge"></span>
                        </div>
                        <div class="gemini-content custom-scrollbar" id="geminiTrainingResultBody" style="max-height: 400px; overflow-y: auto; padding-right: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Prediction Results -->
        <div id="predictionResults" class="d-none animate__animated animate__fadeIn">
            <h5 class="fw-bold text-primary mb-4 pb-2 border-bottom">
                <i class="bi bi-people-fill me-2"></i>ผลการทำนาย
            </h5>
            <div id="summary" class="mb-5"></div>
            
            <ul class="nav nav-tabs nav-tabs-custom mb-4" id="resultTabs">
                <li class="nav-item">
                    <button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#overview">ภาพรวม</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#details">รายละเอียดรายคน</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#recommendations">คำแนะนำ</button>
                </li>
            </ul>
            
            <div class="tab-content p-3 border rounded-bottom bg-light">
                <div class="tab-pane fade show active" id="overview">
                    <div id="overviewContent" class="d-flex justify-content-center"></div>
                </div>
                <div class="tab-pane fade" id="details">
                    <div id="results"></div>
                </div>
                <div class="tab-pane fade" id="recommendations">
                    <div id="recommendationsContent"></div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Results -->
        <div id="analysisResults" class="d-none animate__animated animate__fadeIn">
            <h5 class="fw-bold text-primary mb-4 pb-2 border-bottom">
                <i class="bi bi-microscope me-2"></i>ผลการวิเคราะห์ Course DNA
            </h5>
            <div id="analysis-summary" class="mb-4"></div>
            <div id="analysis-recommendations" class="mb-4"></div>
            
            <div class="row mb-4" id="analysis-tables">
                <div class="col-md-6 mb-3">
                    <div class="card border-danger shadow-sm h-100">
                        <div class="card-header bg-danger text-white fw-bold">
                            <i class="bi bi-x-circle-fill me-1"></i> วิชาที่มีอัตราตกสูง (Killer Courses)
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0" id="highFailSubjects"></ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card border-success shadow-sm h-100">
                        <div class="card-header bg-success text-white fw-bold">
                            <i class="bi bi-check-circle-fill me-1"></i> วิชาที่มีผลการเรียนดี (Easy Courses)
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0" id="easySubjects"></ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white fw-bold">
                    <i class="bi bi-bar-chart-fill me-1"></i> การกระจายตัวของผลการเรียน (Course Performance)
                </div>
                <div class="card-body">
                    <div style="height: 400px;">
                        <canvas id="courseDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
// Global variables
let currentFilename = '';
let trainingInterval = null;
let geminiAvailableForTraining = false;

// File Upload Handling
document.getElementById('fileUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    handleFileSelection(file);
});

function handleFileSelection(file) {
    if (file) {
        document.getElementById('fileNameDisplay').value = file.name;
        document.getElementById('uploadBtn').disabled = false;
        
        // Visual feedback
        const wrapper = document.querySelector('.file-upload-wrapper');
        wrapper.style.borderColor = 'var(--primary)';
        wrapper.style.backgroundColor = 'var(--primary-bg)';
    } else {
        document.getElementById('fileNameDisplay').value = '';
        document.getElementById('uploadBtn').disabled = true;
    }
}

// Toggle Spinner
function toggleSpinner(buttonId, show) {
    const button = document.getElementById(buttonId);
    const spinner = button.querySelector('.spinner-border');
    if (show) {
        spinner.classList.remove('d-none');
        button.disabled = true;
    } else {
        spinner.classList.add('d-none');
        button.disabled = false;
    }
}

// Render Markdown
function renderMarkdown(text) {
    if (!text) return '';
    try {
        if (window.marked) {
            const html = window.marked.parse(text);
            return window.DOMPurify ? DOMPurify.sanitize(html) : html;
        }
        return text.replace(/\n/g, '<br>');
    } catch (error) {
        return text.replace(/\n/g, '<br>');
    }
}

// Gemini Status
async function refreshGeminiTrainingStatus() {
    try {
        const response = await fetch('/api/config');
        const data = await response.json();
        geminiAvailableForTraining = Boolean(data && data.GEMINI_ENABLED);
    } catch (error) {
        geminiAvailableForTraining = false;
    } finally {
        updateGeminiTrainingUI();
    }
}

function updateGeminiTrainingUI() {
    const toggle = document.getElementById('enableGeminiTraining');
    const badge = document.getElementById('geminiTrainingStatusBadge');
    const goalInput = document.getElementById('geminiAnalysisGoalInput');
    
    if (!toggle || !badge) return;
    
    if (!geminiAvailableForTraining) {
        toggle.checked = false;
        toggle.disabled = true;
        badge.className = 'badge bg-danger ms-2';
        badge.innerHTML = '<i class="bi bi-slash-circle"></i> ไม่พร้อมใช้งาน';
        if (goalInput) {
            goalInput.disabled = true;
            goalInput.placeholder = 'ต้องตั้งค่า Gemini API Key ก่อน';
        }
        return;
    }
    
    toggle.disabled = false;
    if (goalInput) {
        goalInput.disabled = !toggle.checked;
    }
    
    if (toggle.checked) {
        badge.className = 'badge bg-success ms-2';
        badge.innerHTML = '<i class="bi bi-check-circle"></i> เปิดใช้งาน';
    } else {
        badge.className = 'badge bg-secondary ms-2';
        badge.innerHTML = '<i class="bi bi-pause-circle"></i> ปิดใช้งาน';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    checkSystemStatus();
    refreshGeminiTrainingStatus();
    setInterval(checkSystemStatus, 10000);
    
    const geminiToggle = document.getElementById('enableGeminiTraining');
    if (geminiToggle) {
        geminiToggle.addEventListener('change', updateGeminiTrainingUI);
    }
});

// Check system status
async function checkSystemStatus() {
    try {
        const response = await fetch('/api/models');
        const data = await response.json();
        
        if (data.success && data.models && data.models.length > 0) {
            document.getElementById('subject-model-status').innerHTML = `
                <span class="badge bg-success rounded-pill">
                    <i class="bi bi-check-circle me-1"></i>${data.models.length} โมเดลพร้อมใช้
                </span>
            `;
            const predictBtn = document.getElementById('predictBtn');
            if (predictBtn && !predictBtn.querySelector('.spinner-border:not(.d-none)')) {
                 predictBtn.disabled = false;
            }
        } else {
            document.getElementById('subject-model-status').innerHTML = `
                <span class="badge bg-warning text-dark rounded-pill">
                    <i class="bi bi-exclamation-circle me-1"></i>ยังไม่มีโมเดล
                </span>
            `;
            const predictBtn = document.getElementById('predictBtn');
            if(predictBtn) predictBtn.disabled = true;
        }
        
        const storageResponse = await fetch('/api/storage/status');
        const storageData = await storageResponse.json();
        
        if (storageData.connected) {
            document.getElementById('storage-status').innerHTML = `
                <span class="badge bg-success rounded-pill">
                    <i class="bi bi-cloud-check me-1"></i>Cloud R2 Connected
                </span>
            `;
        } else {
            document.getElementById('storage-status').innerHTML = `
                <span class="badge bg-info rounded-pill">
                    <i class="bi bi-hdd me-1"></i>Local Storage
                </span>
            `;
        }
        
        document.getElementById('model-check-status').innerHTML = `
            <span class="badge bg-success bg-opacity-25 text-success rounded-pill border border-success">
                <i class="bi bi-check-circle me-1"></i>ระบบปกติ
            </span>
        `;
        
    } catch (error) {
        console.error('Error checking status:', error);
    }
}

// Upload file
async function uploadFile() {
    const fileInput = document.getElementById('fileUpload');
    if (fileInput.files.length === 0) {
        showAlert('กรุณาเลือกไฟล์ก่อน', 'warning');
        return;
    }
    
    showLoading('กำลังอัปโหลดไฟล์ขึ้นสู่ระบบ...');
    toggleSpinner('uploadBtn', true);
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();

        if (result.success) {
            currentFilename = result.filename;
            document.getElementById('fileName').textContent = result.filename;
            document.getElementById('fileInfo').innerHTML = `
                <span class="badge bg-light text-dark border me-2">
                    <i class="bi bi-file-earmark-text me-1"></i>${result.rows} แถว
                </span>
                <span class="badge bg-light text-dark border">
                    <i class="bi bi-table me-1"></i>${result.columns} คอลัมน์
                </span>
            `;
            
            document.getElementById('actionsCard').classList.remove('d-none');
            // Smooth scroll to actions
            setTimeout(() => {
                document.getElementById('actionsCard').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
            
            showAlert('อัปโหลดไฟล์สำเร็จ! พร้อมสำหรับการดำเนินการ', 'success');
        } else {
            showAlert('เกิดข้อผิดพลาด: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาดในการอัปโหลดไฟล์', 'danger');
    } finally {
        hideLoading();
        toggleSpinner('uploadBtn', false);
    }
}

// Train model
async function trainModel() {
    if (!currentFilename) {
        showAlert('กรุณาอัปโหลดไฟล์ก่อน', 'warning');
        return;
    }

    // Scroll to progress
    document.getElementById('trainingProgress').classList.remove('d-none');
    document.getElementById('trainingProgress').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    toggleSpinner('trainBtn', true);
    simulateTrainingProgress();

    try {
        const geminiToggle = document.getElementById('enableGeminiTraining');
        const geminiGoalInput = document.getElementById('geminiAnalysisGoalInput');
        const shouldUseGemini = geminiToggle && geminiToggle.checked && geminiAvailableForTraining;
        
        const payload = {
            filename: currentFilename,
            enable_gemini_analysis: shouldUseGemini
        };
        
        if (shouldUseGemini && geminiGoalInput && geminiGoalInput.value.trim()) {
            payload.gemini_analysis_goal = geminiGoalInput.value.trim();
        }
        
        const response = await fetch('/train', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();

        if (result.success) {
            if (trainingInterval) {
                clearInterval(trainingInterval);
                trainingInterval = null;
            }
            // Fill progress bar
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressBar').textContent = '100%';
            
            showAlert('ฝึกโมเดล AI สำเร็จ: ' + result.model_filename, 'success');
            displayTrainingResults(result);
            
            setTimeout(() => checkSystemStatus(), 1000);
        } else {
            showAlert('เกิดข้อผิดพลาด: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'danger');
    } finally {
        toggleSpinner('trainBtn', false);
        document.getElementById('trainingProgress').classList.add('d-none');
        if (trainingInterval) {
            clearInterval(trainingInterval);
            trainingInterval = null;
        }
    }
}

// Simulate training progress
function simulateTrainingProgress() {
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    const stages = [
        { at: 10, text: 'กำลังวิเคราะห์ข้อมูล (Analyzing Data)...' },
        { at: 25, text: 'กำลังสร้าง Course DNA Profiles...' },
        { at: 40, text: 'กำลังสร้าง Dynamic Snapshots...' },
        { at: 60, text: 'กำลังสร้าง Contextual Features...' },
        { at: 80, text: 'กำลังฝึก Ensemble Models...' },
        { at: 95, text: 'กำลังประเมินผลและบันทึก (Finalizing)...' }
    ];
    
    trainingInterval = setInterval(() => {
        if (progress < 95) {
            progress += Math.random() * 3;
            progress = Math.min(95, progress);
            
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
            
            for (let stage of stages) {
                if (progress >= stage.at && progress < stage.at + 15) {
                    progressText.textContent = stage.text;
                    break;
                }
            }
        }
    }, 400);
}

// Display training results
function displayTrainingResults(result) {
    document.getElementById('resultsCard').classList.remove('d-none');
    document.getElementById('trainingResults').classList.remove('d-none');
    document.getElementById('predictionResults').classList.add('d-none');
    document.getElementById('analysisResults').classList.add('d-none');
    
    document.getElementById('accuracyDisplay').textContent = (result.accuracy * 100).toFixed(1) + '%';
    document.getElementById('precisionDisplay').textContent = (result.precision * 100).toFixed(1) + '%';
    document.getElementById('recallDisplay').textContent = (result.recall * 100).toFixed(1) + '%';
    document.getElementById('f1Display').textContent = (result.f1_score * 100).toFixed(1) + '%';
    
    document.getElementById('trainingDetails').innerHTML = `
        <div class="row text-center p-3">
            <div class="col-md-3 border-end">
                <small class="text-muted d-block">ชื่อโมเดล</small>
                <span class="fw-bold text-truncate d-block" title="${result.model_filename}">${result.model_filename}</span>
            </div>
            <div class="col-md-3 border-end">
                <small class="text-muted d-block">จำนวนตัวอย่าง</small>
                <span class="fw-bold">${result.training_samples} samples</span>
            </div>
            <div class="col-md-3 border-end">
                <small class="text-muted d-block">Features</small>
                <span class="fw-bold">${result.features_count}</span>
            </div>
            <div class="col-md-3">
                <small class="text-muted d-block">Course Profiles</small>
                <span class="fw-bold">${result.course_profiles_count || 'N/A'} วิชา</span>
            </div>
        </div>
    `;
    
    if (result.feature_importances) {
        const featureList = document.getElementById('featureList');
        let featureHtml = '';
        
        const features = Object.entries(result.feature_importances)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
        
        features.forEach(([feature, importance], index) => {
            const percentage = (importance * 100).toFixed(2);
            featureHtml += `
                <div class="feature-bar">
                    <span class="feature-rank">${index + 1}</span>
                    <span class="feature-name text-truncate" title="${feature}">${feature}</span>
                    <div class="feature-progress">
                        <div class="progress-bar bg-primary" style="width: ${percentage}%"></div>
                    </div>
                    <span class="feature-value">${percentage}%</span>
                </div>
            `;
        });
        
        featureList.innerHTML = featureHtml;
    }
    
    displayGeminiTrainingResult(result.gemini_analysis);
    setTimeout(() => {
        document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
    }, 200);
}

function displayGeminiTrainingResult(analysis) {
    const container = document.getElementById('geminiTrainingResult');
    const body = document.getElementById('geminiTrainingResultBody');
    const goalBadge = document.getElementById('geminiTrainingGoalBadge');
    
    if (!container || !body) return;
    
    if (!analysis) {
        container.classList.add('d-none');
        return;
    }
    
    container.classList.remove('d-none');
    
    if (goalBadge && analysis.analysis_goal) {
        goalBadge.style.display = 'inline-block';
        goalBadge.textContent = analysis.analysis_goal;
    } else if (goalBadge) {
        goalBadge.style.display = 'none';
    }
    
    if (analysis.error) {
        body.innerHTML = `<div class="alert alert-warning mb-0">${analysis.error}</div>`;
        return;
    }
    
    const gemini = analysis.gemini || {};
    body.innerHTML = gemini.analysis_markdown ? renderMarkdown(gemini.analysis_markdown) : '<p class="mb-0 text-muted">ไม่มีข้อมูลเพิ่มเติมจาก Gemini</p>';
}

// Predict data
async function predictData() {
    if (!currentFilename) {
        showAlert('กรุณาอัปโหลดไฟล์ข้อมูลก่อน', 'warning');
        return;
    }
    
    showLoading('กำลังทำนายผลการเรียน...');
    toggleSpinner('predictBtn', true);

    try {
        const modelsResponse = await fetch('/api/models');
        const modelsData = await modelsResponse.json();
        
        if (!modelsData.success || modelsData.models.length === 0) {
            showAlert('ไม่พบโมเดล AI กรุณาฝึกโมเดลก่อน', 'warning');
            hideLoading();
            toggleSpinner('predictBtn', false);
            return;
        }
        
        const modelFilename = modelsData.models[0].filename;

        const response = await fetch('/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                filename: currentFilename, 
                model_filename: modelFilename 
            })
        });
        const result = await response.json();

        if (result.success) {
            displayPredictionResults(result.results, result.summary);
            showAlert('ทำนายผลสำเร็จ!', 'success');
        } else {
            showAlert('เกิดข้อผิดพลาด: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาดในการทำนาย', 'danger');
    } finally {
        hideLoading();
        toggleSpinner('predictBtn', false);
    }
}

// Display prediction results
function displayPredictionResults(results, summary) {
    document.getElementById('resultsCard').classList.remove('d-none');
    document.getElementById('predictionResults').classList.remove('d-none');
    document.getElementById('trainingResults').classList.add('d-none');
    document.getElementById('analysisResults').classList.add('d-none');

    document.getElementById('summary').innerHTML = `
        <div class="row g-3">
            <div class="col-md-3">
                <div class="card bg-primary text-white text-center p-3 h-100 shadow-sm">
                    <div class="fs-1 fw-bold">${summary.total}</div>
                    <div class="small opacity-75">นักศึกษาทั้งหมด</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white text-center p-3 h-100 shadow-sm">
                    <div class="fs-1 fw-bold">${summary.predicted_pass}</div>
                    <div class="small opacity-75">คาดว่าจะจบ (${summary.pass_rate.toFixed(1)}%)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white text-center p-3 h-100 shadow-sm">
                    <div class="fs-1 fw-bold">${summary.predicted_fail}</div>
                    <div class="small opacity-75">คาดว่าไม่จบ</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white text-center p-3 h-100 shadow-sm">
                    <div class="fs-1 fw-bold">${summary.high_risk}</div>
                    <div class="small opacity-75">ความเสี่ยงสูง</div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('overviewContent').innerHTML = `
        <div style="height: 350px; width: 100%; max-width: 500px;">
            <canvas id="predictionChart"></canvas>
        </div>
    `;
    
    setTimeout(() => {
        const ctx = document.getElementById('predictionChart').getContext('2d');
        const existingChart = Chart.getChart('predictionChart');
        if (existingChart) existingChart.destroy();
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['คาดว่าจะจบ', 'คาดว่าไม่จบ'],
                datasets: [{
                    data: [summary.predicted_pass, summary.predicted_fail],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 20 } }
                }
            }
        });
    }, 100);

    document.getElementById('results').innerHTML = `
        <div class="table-responsive rounded border">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="py-3 ps-3">ชื่อ</th>
                        <th class="py-3">การทำนาย</th>
                        <th class="py-3">GPA</th>
                        <th class="py-3">ความน่าจะเป็น</th>
                        <th class="py-3 pe-3">ระดับความเสี่ยง</th>
                    </tr>
                </thead>
                <tbody>
                    ${results.slice(0, 50).map(r => `
                        <tr>
                            <td class="ps-3 fw-medium">${r.ชื่อ}</td>
                            <td><span class="badge bg-${r.การทำนาย === 'จบ' ? 'success' : 'danger'} rounded-pill px-3">${r.การทำนาย}</span></td>
                            <td class="font-monospace">${r.เกรดเฉลี่ย.toFixed(2)}</td>
                            <td>
                                <div class="progress" style="height: 8px; width: 120px;">
                                    <div class="progress-bar bg-success" style="width: ${r.ความน่าจะเป็น.จบ * 100}%"></div>
                                </div>
                                <small class="text-muted" style="font-size: 0.7rem;">${(r.ความน่าจะเป็น.จบ * 100).toFixed(0)}%</small>
                            </td>
                            <td class="pe-3"><span class="badge bg-${r.ระดับความเสี่ยง === 'ต่ำ' ? 'success' : r.ระดับความเสี่ยง === 'ปานกลาง' ? 'warning' : 'danger'} rounded-pill">${r.ระดับความเสี่ยง}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <small class="text-muted mt-2 d-block">* แสดงผล 50 รายการแรก</small>
    `;

    const allRecommendations = [...new Set(results.flatMap(r => r.คำแนะนำ))];
    document.getElementById('recommendationsContent').innerHTML = `
        <div class="row g-3">
            ${allRecommendations.map(rec => `
                <div class="col-md-6">
                    <div class="alert alert-info mb-0 border-0 shadow-sm d-flex align-items-center h-100">
                        <i class="bi bi-lightbulb-fill me-3 fs-4"></i>
                        <div>${rec}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    setTimeout(() => {
        document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
    }, 200);
}

// Analyze subjects
async function analyzeSubjects() {
    if (!currentFilename) {
        showAlert('กรุณาอัปโหลดไฟล์ข้อมูลก่อน', 'warning');
        return;
    }

    showLoading('กำลังวิเคราะห์ Course DNA...');
    toggleSpinner('analyzeBtn', true);
    
    try {
        const response = await fetch('/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: currentFilename })
        });
        const result = await response.json();
        
        if (result.success) {
            displayAnalysisResults(result);
            showAlert('วิเคราะห์ Course DNA สำเร็จ!', 'success');
        } else {
            showAlert('เกิดข้อผิดพลาด: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาดในการวิเคราะห์', 'danger');
    } finally {
        hideLoading();
        toggleSpinner('analyzeBtn', false);
    }
}

// Display analysis results
function displayAnalysisResults(data) {
    document.getElementById('resultsCard').classList.remove('d-none');
    document.getElementById('analysisResults').classList.remove('d-none');
    document.getElementById('trainingResults').classList.add('d-none');
    document.getElementById('predictionResults').classList.add('d-none');
    
    document.getElementById('analysis-summary').innerHTML = `
        <div class="alert alert-light border shadow-sm">
            <div class="row text-center">
                <div class="col-md-3">
                    <strong class="d-block display-6 fw-bold text-primary">${data.overall_stats.total_students}</strong>
                    <small class="text-muted text-uppercase fw-bold">นักศึกษาทั้งหมด</small>
                </div>
                <div class="col-md-3">
                    <strong class="d-block display-6 fw-bold text-primary">${data.overall_stats.total_subjects}</strong>
                    <small class="text-muted text-uppercase fw-bold">จำนวนวิชา</small>
                </div>
                <div class="col-md-3">
                    <strong class="d-block display-6 fw-bold text-primary">${data.overall_stats.avg_gpa.toFixed(2)}</strong>
                    <small class="text-muted text-uppercase fw-bold">GPA เฉลี่ย</small>
                </div>
                <div class="col-md-3">
                    <strong class="d-block display-6 fw-bold text-danger">${(data.overall_stats.overall_fail_rate * 100).toFixed(1)}%</strong>
                    <small class="text-muted text-uppercase fw-bold">อัตราตกรวม</small>
                </div>
            </div>
        </div>
    `;

    if (data.recommendations && data.recommendations.length > 0) {
        document.getElementById('analysis-recommendations').innerHTML = `
            <div class="alert alert-warning border-warning shadow-sm">
                <h6 class="alert-heading fw-bold mb-3">
                    <i class="bi bi-lightbulb-fill me-2"></i>คำแนะนำจากการวิเคราะห์
                </h6>
                <ul class="mb-0 ps-3">
                    ${data.recommendations.map(rec => `<li class="mb-1">${rec}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    const highFailList = document.getElementById('highFailSubjects');
    if (data.problem_subjects.high_fail_rate.length > 0) {
        highFailList.innerHTML = data.problem_subjects.high_fail_rate.slice(0, 10).map(s => `
            <li class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                <span class="fw-medium">${s.subject}</span>
                <div>
                    <span class="badge bg-danger me-1">ตก ${(s.fail_rate * 100).toFixed(1)}%</span>
                    <span class="badge bg-secondary">GPA ${s.average.toFixed(2)}</span>
                </div>
            </li>
        `).join('');
    } else {
        highFailList.innerHTML = '<p class="text-muted mb-0 fst-italic">ไม่พบวิชาที่มีอัตราตกสูงผิดปกติ</p>';
    }

    const easySubjectsList = document.getElementById('easySubjects');
    if (data.excellent_subjects && data.excellent_subjects.length > 0) {
        easySubjectsList.innerHTML = data.excellent_subjects.slice(0, 10).map(s => `
            <li class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                <span class="fw-medium">${s.subject}</span>
                <div>
                    <span class="badge bg-success me-1">GPA ${s.average.toFixed(2)}</span>
                    <span class="badge bg-info">${s.num_students} คน</span>
                </div>
            </li>
        `).join('');
    } else {
        easySubjectsList.innerHTML = '<p class="text-muted mb-0 fst-italic">ไม่พบวิชาที่มีผลการเรียนดีเยี่ยม</p>';
    }

    setTimeout(() => {
        const ctx = document.getElementById('courseDistributionChart').getContext('2d');
        const existingChart = Chart.getChart('courseDistributionChart');
        if (existingChart) existingChart.destroy();
        
        const categories = Object.keys(data.category_summary || {});
        const avgGPAs = categories.map(cat => data.category_summary[cat].avg_gpa);
        const failRates = categories.map(cat => data.category_summary[cat].avg_fail_rate * 100);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [
                    {
                        label: 'GPA เฉลี่ย',
                        data: avgGPAs,
                        backgroundColor: 'rgba(79, 70, 229, 0.7)',
                        borderColor: '#4f46e5',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'อัตราตก (%)',
                        data: failRates,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { type: 'linear', display: true, position: 'left', max: 4, title: { display: true, text: 'GPA' } },
                    y1: { type: 'linear', display: true, position: 'right', max: 100, grid: { drawOnChartArea: false }, title: { display: true, text: 'Fail Rate (%)' } }
                }
            }
        });
    }, 100);
    
    setTimeout(() => {
        document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
    }, 200);
}
</script>
{% endblock %}
