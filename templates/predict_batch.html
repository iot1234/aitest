{% extends "base.html" %}

{% block title %}ทำนายแบบกลุ่ม - ระบบทำนายความสำเร็จของนักศึกษา{% endblock %}

{% block custom_css %}
<style>
    :root {
        --gradient-primary: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
        --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --gradient-danger: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --gradient-dark: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        --glass-bg: rgba(255,255,255,0.95);
        --glass-border: rgba(255,255,255,0.3);
    }

    .hero-header {
        background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
        border-radius: 24px;
        padding: 3rem 2rem;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(14, 165, 233, 0.4);
    }
    .hero-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: pulse 4s ease-in-out infinite;
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.1); opacity: 0.3; }
    }
    .hero-header h1 { font-size: 2.5rem; font-weight: 800; color: white; position: relative; z-index: 1; text-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .hero-header p { color: rgba(255,255,255,0.9); font-size: 1.1rem; position: relative; z-index: 1; }

    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        border: 1px solid var(--glass-border);
        transition: all 0.3s ease;
    }
    .glass-card:hover {
        box-shadow: 0 12px 40px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }

    /* Steps indicator */
    .steps-indicator {
        display: flex;
        justify-content: center;
        gap: 0;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    .step-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--gray-400, #9ca3af);
        transition: all 0.3s;
    }
    .step-item.active { color: #0ea5e9; background: rgba(14, 165, 233, 0.1); }
    .step-item.completed { color: #10b981; background: rgba(16, 185, 129, 0.1); }
    .step-item .step-num {
        width: 28px; height: 28px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.8rem; font-weight: 700;
        background: var(--gray-200, #e5e7eb);
        color: var(--gray-500, #6b7280);
    }
    .step-item.active .step-num { background: #0ea5e9; color: white; }
    .step-item.completed .step-num { background: #10b981; color: white; }
    .step-connector { width: 40px; height: 2px; background: var(--gray-200, #e5e7eb); align-self: center; }
    .step-connector.completed { background: #10b981; }

    /* Upload zone */
    .upload-zone {
        border: 3px dashed var(--gray-300, #d1d5db);
        border-radius: 20px;
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(255,255,255,0.95);
    }
    .upload-zone:hover, .upload-zone.dragover {
        border-color: #0ea5e9;
        background: rgba(14, 165, 233, 0.05);
        transform: translateY(-2px);
    }
    .upload-zone .icon { font-size: 4rem; color: var(--gray-400, #9ca3af); margin-bottom: 1rem; }
    .upload-zone.has-file { border-color: #10b981; border-style: solid; background: rgba(16, 185, 129, 0.05); }
    .upload-zone.has-file .icon { color: #10b981; }

    /* Settings panel */
    .settings-panel {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 20px;
        padding: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }
    .settings-panel::before {
        content: '';
        position: absolute;
        top: 0; right: 0;
        width: 300px; height: 300px;
        background: radial-gradient(circle, rgba(14,165,233,0.3) 0%, transparent 70%);
        pointer-events: none;
    }
    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    .setting-item {
        background: rgba(255,255,255,0.06);
        border-radius: 14px;
        padding: 1.25rem;
        border: 1px solid rgba(255,255,255,0.08);
    }
    .setting-item label {
        display: block;
        font-weight: 600;
        font-size: 0.85rem;
        color: rgba(255,255,255,0.8);
        margin-bottom: 0.5rem;
    }
    .setting-item select, .setting-item input[type="text"] {
        width: 100%;
        padding: 0.6rem 0.8rem;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.15);
        background: rgba(255,255,255,0.08);
        color: white;
        font-size: 0.9rem;
    }
    .setting-item select option { background: #1a1a2e; color: white; }

    /* Template download buttons */
    .template-btn-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .template-btn {
        flex: 1;
        min-width: 200px;
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.5rem;
        border-radius: 16px;
        border: 2px solid var(--gray-200, #e5e7eb);
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        color: inherit;
    }
    .template-btn:hover {
        border-color: #0ea5e9;
        background: rgba(14, 165, 233, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        color: inherit;
    }
    .template-btn .icon-box {
        width: 48px; height: 48px;
        border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.4rem;
        flex-shrink: 0;
    }
    .template-btn .icon-box.wide { background: rgba(14, 165, 233, 0.1); color: #0ea5e9; }
    .template-btn .icon-box.long { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
    .template-btn .text-content strong { display: block; font-size: 0.95rem; }
    .template-btn .text-content small { color: var(--gray-500, #6b7280); font-size: 0.8rem; }

    /* File info */
    .file-info-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.5rem;
        background: rgba(16, 185, 129, 0.08);
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: 14px;
    }
    .file-info-card .fi-icon { font-size: 1.5rem; color: #10b981; }
    .file-info-card .remove-btn { color: #ef4444; cursor: pointer; margin-left: auto; font-size: 1.2rem; }
    .file-info-card .remove-btn:hover { color: #dc2626; }

    /* Results */
    .results-table th { background: var(--gray-50, #f9fafb); font-weight: 700; white-space: nowrap; font-size: 0.85rem; }
    .results-table td { vertical-align: middle; font-size: 0.9rem; }
    .risk-badge { padding: 0.3rem 0.7rem; border-radius: 20px; font-size: 0.78rem; font-weight: 600; display: inline-block; }
    .risk-high { background: #fee2e2; color: #dc2626; }
    .risk-medium { background: #fef3c7; color: #d97706; }
    .risk-low { background: #d1fae5; color: #059669; }

    .summary-card { text-align: center; padding: 1.5rem 1rem; border-radius: 16px; }
    .summary-card .number { font-size: 2.2rem; font-weight: 800; line-height: 1; }
    .summary-card .label { font-size: 0.8rem; color: var(--gray-500, #6b7280); font-weight: 600; margin-top: 0.5rem; }

    .student-detail { display: none; background: var(--gray-50, #f9fafb); }
    .student-detail.show { display: table-row; }
    .detail-cell { padding: 1rem 1.5rem; }

    .chart-container { max-width: 380px; margin: 0 auto; }

    /* Result hero */
    .result-hero {
        text-align: center;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
    }
    .result-hero.success { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #10b981; }
    .result-hero.warning { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border: 2px solid #f59e0b; }
    .result-hero.danger { background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%); border: 2px solid #ef4444; }
    .result-hero h2 { font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem; }
    .result-hero.success h2 { color: #059669; }
    .result-hero.warning h2 { color: #d97706; }
    .result-hero.danger h2 { color: #dc2626; }

    /* Probability bar */
    .probability-bar {
        height: 40px;
        border-radius: 20px;
        overflow: hidden;
        display: flex;
        margin: 1.5rem 0;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .probability-bar .pass {
        background: var(--gradient-success);
        display: flex; align-items: center; justify-content: center;
        color: white; font-weight: 700;
        transition: width 1s ease;
    }
    .probability-bar .fail {
        background: var(--gradient-danger);
        display: flex; align-items: center; justify-content: center;
        color: white; font-weight: 700;
        transition: width 1s ease;
    }

    /* Search and filter */
    .filter-bar {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }
    .search-box {
        flex: 1;
        min-width: 200px;
        position: relative;
    }
    .search-box input {
        width: 100%;
        padding: 0.7rem 1rem 0.7rem 2.5rem;
        border: 2px solid var(--gray-200, #e5e7eb);
        border-radius: 12px;
        font-size: 0.9rem;
        transition: all 0.3s;
    }
    .search-box input:focus {
        border-color: #0ea5e9;
        box-shadow: 0 0 0 4px rgba(14,165,233,0.1);
        outline: none;
    }
    .search-box i {
        position: absolute;
        left: 0.8rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400, #9ca3af);
    }
    .filter-select {
        padding: 0.7rem 1rem;
        border: 2px solid var(--gray-200, #e5e7eb);
        border-radius: 12px;
        font-size: 0.9rem;
        min-width: 150px;
    }

    /* Action buttons */
    .btn-predict {
        background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
        color: white;
        padding: 1rem 3rem;
        font-size: 1.1rem;
        border-radius: 50px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .btn-predict:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(14,165,233,0.4);
        color: white;
    }

    /* Format info cards */
    .format-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    .format-card {
        border-radius: 16px;
        padding: 1.5rem;
        border: 2px solid var(--gray-200, #e5e7eb);
    }
    .format-card h6 { font-weight: 700; margin-bottom: 1rem; }
    .format-card .badge-tag { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; }

    /* Detected format badge */
    .format-detected {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        background: rgba(14, 165, 233, 0.1);
        color: #0ea5e9;
    }

    @media (max-width: 768px) {
        .format-info { grid-template-columns: 1fr; }
        .hero-header h1 { font-size: 1.75rem; }
        .glass-card { padding: 1.5rem !important; }
    }

    /* Dark mode */
    [data-theme="dark"] .glass-card { background: rgba(30,30,40,0.95); border-color: rgba(255,255,255,0.05); }
    [data-theme="dark"] .upload-zone { background: rgba(30,30,40,0.95); border-color: rgba(255,255,255,0.15); }
    [data-theme="dark"] .results-table th { background: rgba(255,255,255,0.05); }
    [data-theme="dark"] .student-detail { background: rgba(255,255,255,0.03); }
    [data-theme="dark"] .template-btn { background: rgba(30,30,40,0.95); border-color: rgba(255,255,255,0.1); color: #e5e7eb; }
    [data-theme="dark"] .search-box input, [data-theme="dark"] .filter-select {
        background: rgba(30,30,40,0.95); border-color: rgba(255,255,255,0.15); color: #e5e7eb;
    }
    [data-theme="dark"] .format-card { border-color: rgba(255,255,255,0.1); }
    [data-theme="dark"] .file-info-card { background: rgba(16,185,129,0.12); border-color: rgba(16,185,129,0.3); }
</style>
{% endblock %}

{% block content %}

<!-- Hero Header -->
<div class="hero-header" data-aos="fade-down">
    <h1><i class="bi bi-people-fill me-2"></i>ระบบทำนายแบบกลุ่ม</h1>
    <p>อัปโหลดไฟล์ข้อมูลผลการเรียน (CSV/Excel) เพื่อทำนายความสำเร็จของนักศึกษาหลายคนพร้อมกัน</p>
</div>

<!-- Steps Indicator -->
<div class="steps-indicator" data-aos="fade-up">
    <div class="step-item active" id="step1Indicator">
        <span class="step-num">1</span> ตั้งค่า
    </div>
    <div class="step-connector" id="conn1"></div>
    <div class="step-item" id="step2Indicator">
        <span class="step-num">2</span> อัปโหลดไฟล์
    </div>
    <div class="step-connector" id="conn2"></div>
    <div class="step-item" id="step3Indicator">
        <span class="step-num">3</span> ผลลัพธ์
    </div>
</div>

<!-- Step 1: Settings -->
<div id="settingsSection">
    <div class="settings-panel mb-4" data-aos="fade-up">
        <div class="d-flex align-items-center gap-2 mb-3" style="position:relative;z-index:1;">
            <i class="bi bi-gear-fill fs-4" style="color: #67e8f9;"></i>
            <h5 class="fw-bold mb-0" style="color: white;">ตั้งค่าการทำนาย</h5>
        </div>
        <div class="settings-grid" style="position:relative;z-index:1;">
            <div class="setting-item">
                <label><i class="bi bi-cpu me-1"></i> โมเดล AI</label>
                <select id="modelSelect">
                    <option value="">กำลังโหลด...</option>
                </select>
            </div>
            <div class="setting-item">
                <label><i class="bi bi-sort-down me-1"></i> เรียงผลลัพธ์ตาม</label>
                <select id="sortBy">
                    <option value="risk_desc">ความเสี่ยง สูง → ต่ำ</option>
                    <option value="risk_asc">ความเสี่ยง ต่ำ → สูง</option>
                    <option value="gpa_desc">GPA สูง → ต่ำ</option>
                    <option value="gpa_asc">GPA ต่ำ → สูง</option>
                    <option value="prob_desc">ความน่าจะเป็น สูง → ต่ำ</option>
                    <option value="prob_asc">ความน่าจะเป็น ต่ำ → สูง</option>
                    <option value="name_asc">ชื่อ ก → ฮ</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Step 2: File Upload -->
    <div class="glass-card p-4 mb-4" data-aos="fade-up" data-aos-delay="100">
        <h5 class="fw-bold mb-3"><i class="bi bi-cloud-arrow-up me-2 text-info"></i>อัปโหลดไฟล์ข้อมูลนักศึกษา</h5>

        <!-- Template Downloads -->
        <div class="mb-4">
            <p class="text-muted mb-2"><i class="bi bi-lightbulb me-1"></i> ดาวน์โหลดเทมเพลตเพื่อใช้เป็นตัวอย่างรูปแบบไฟล์:</p>
            <div class="template-btn-group">
                <a href="/api/batch_template/wide" class="template-btn" download>
                    <div class="icon-box wide"><i class="bi bi-table"></i></div>
                    <div class="text-content">
                        <strong>Wide Format (แนะนำ)</strong>
                        <small>รหัสวิชาเป็นหัวคอลัมน์ เหมือนตารางผลการเรียน</small>
                    </div>
                    <i class="bi bi-download ms-auto text-muted"></i>
                </a>
                <a href="/api/batch_template/long" class="template-btn" download>
                    <div class="icon-box long"><i class="bi bi-list-ul"></i></div>
                    <div class="text-content">
                        <strong>Long Format</strong>
                        <small>แต่ละแถว = 1 วิชาของ 1 นักศึกษา</small>
                    </div>
                    <i class="bi bi-download ms-auto text-muted"></i>
                </a>
            </div>
        </div>

        <!-- Upload Zone -->
        <div class="upload-zone" id="uploadZone">
            <div class="icon"><i class="bi bi-file-earmark-arrow-up"></i></div>
            <h5 class="fw-bold">ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์</h5>
            <p class="text-muted mb-2">รองรับ CSV, XLSX, XLS (สูงสุด 500 นักศึกษา)</p>
            <p class="text-muted small mb-0">
                <span class="badge bg-info bg-opacity-10 text-info me-1">Wide Format</span> รหัสวิชาเป็นหัวคอลัมน์
                <span class="mx-2">|</span>
                <span class="badge" style="background:rgba(168,85,247,0.1);color:#a855f7;">Long Format</span> STUDENT_ID, COURSE_CODE, GRADE
            </p>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="d-none">
        </div>

        <!-- File Info -->
        <div id="fileInfo" class="mt-3 d-none">
            <div class="file-info-card">
                <i class="bi bi-file-earmark-check fi-icon"></i>
                <div>
                    <div class="fw-bold" id="fileInfoName">ชื่อไฟล์</div>
                    <small class="text-muted" id="fileInfoSize">ขนาดไฟล์</small>
                </div>
                <span class="remove-btn" onclick="removeFile()" title="ลบไฟล์">
                    <i class="bi bi-x-circle-fill"></i>
                </span>
            </div>
        </div>

        <!-- Run Prediction Button -->
        <div class="text-center mt-4" id="predictBtnSection" style="display:none;">
            <button class="btn-predict" onclick="runBatchPrediction()">
                <i class="bi bi-lightning-charge-fill me-2"></i> เริ่มทำนายแบบกลุ่ม
            </button>
        </div>
    </div>

    <!-- Format Guide (collapsible) -->
    <div class="glass-card p-4 mb-4" data-aos="fade-up" data-aos-delay="150">
        <a class="text-decoration-none d-block" data-bs-toggle="collapse" href="#formatGuide" role="button">
            <h5 class="fw-bold mb-0">
                <i class="bi bi-question-circle me-2 text-warning"></i>รูปแบบไฟล์ที่รองรับ (ระบบตรวจจับอัตโนมัติ)
                <i class="bi bi-chevron-down float-end"></i>
            </h5>
        </a>
        <div class="collapse mt-3" id="formatGuide">
            <div class="format-info">
                <div class="format-card" style="border-color: rgba(14,165,233,0.3); background: rgba(14,165,233,0.03);">
                    <h6><i class="bi bi-table me-1 text-info"></i> Wide Format <span class="badge-tag" style="background:rgba(14,165,233,0.1);color:#0ea5e9;">แนะนำ</span></h6>
                    <p class="small text-muted mb-2">เหมือนตารางผลการเรียน — หัวคอลัมน์คือรหัสวิชา ค่าเกรดอยู่ในเซลล์</p>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm mb-0" style="font-size:0.8rem;">
                            <thead class="table-light">
                                <tr><th>STUDENT_ID</th><th>STUDENT_NAME</th><th>GPA</th><th>03-407-100-101</th><th>02-005-011-109</th><th>...</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>6301001</td><td>สมชาย</td><td>2.85</td><td>B+</td><td>C+</td><td>...</td></tr>
                                <tr><td>6301002</td><td>สมหญิง</td><td>3.20</td><td>A</td><td>B</td><td>...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="format-card" style="border-color: rgba(168,85,247,0.3); background: rgba(168,85,247,0.03);">
                    <h6><i class="bi bi-list-ul me-1" style="color:#a855f7;"></i> Long Format</h6>
                    <p class="small text-muted mb-2">แต่ละแถวคือ 1 วิชาของ 1 นักศึกษา</p>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm mb-0" style="font-size:0.8rem;">
                            <thead class="table-light">
                                <tr><th>STUDENT_ID</th><th>COURSE_CODE</th><th>GRADE</th><th>CREDIT</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>6301001</td><td>03-407-100-101</td><td>B+</td><td>3</td></tr>
                                <tr><td>6301001</td><td>02-005-011-109</td><td>C+</td><td>3</td></tr>
                                <tr><td>6301002</td><td>03-407-100-101</td><td>A</td><td>3</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <p class="text-muted small mt-3 mb-0">
                <i class="bi bi-info-circle me-1"></i> ระบบจะตรวจจับรูปแบบไฟล์อัตโนมัติ ไม่ต้องระบุเอง &bull; เกรดที่รองรับ: A, B+, B, C+, C, D+, D, F, W, I, WF
            </p>
        </div>
    </div>
</div>

<!-- Results Section -->
<div id="resultsSection" class="d-none">

    <!-- Detected Format Info -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3" data-aos="fade-up">
        <div class="format-detected" id="detectedFormatBadge">
            <i class="bi bi-check-circle-fill"></i>
            <span id="detectedFormatText">ตรวจพบรูปแบบ: Wide Format</span>
        </div>
        <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="resetForm()">
            <i class="bi bi-arrow-counterclockwise me-1"></i> ทำนายใหม่
        </button>
    </div>

    <!-- Summary Hero -->
    <div id="resultHero" class="result-hero" data-aos="fade-up"></div>

    <!-- Summary Stats -->
    <div class="glass-card p-4 mb-4" data-aos="fade-up">
        <h5 class="fw-bold mb-4"><i class="bi bi-bar-chart me-2 text-primary"></i>สรุปผลการทำนาย</h5>
        <div class="row g-3" id="summaryCards"></div>
        <div class="probability-bar mt-4" id="summaryProbBar"></div>
    </div>

    <!-- Charts -->
    <div class="row g-4 mb-4">
        <div class="col-md-4" data-aos="fade-right">
            <div class="glass-card p-4 h-100">
                <h6 class="fw-bold mb-3"><i class="bi bi-pie-chart me-2 text-success"></i>สัดส่วนผ่าน/ไม่ผ่าน</h6>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4" data-aos="fade-up">
            <div class="glass-card p-4 h-100">
                <h6 class="fw-bold mb-3"><i class="bi bi-bar-chart-line me-2 text-info"></i>การกระจายความน่าจะเป็น</h6>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4" data-aos="fade-left">
            <div class="glass-card p-4 h-100">
                <h6 class="fw-bold mb-3"><i class="bi bi-exclamation-triangle me-2 text-warning"></i>ระดับความเสี่ยง</h6>
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter & Search & Table -->
    <div class="glass-card p-4 mb-4" data-aos="fade-up">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <h5 class="fw-bold mb-0"><i class="bi bi-table me-2"></i>ผลลัพธ์รายบุคคล</h5>
            <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm rounded-pill" onclick="downloadCSV()">
                    <i class="bi bi-download me-1"></i> ดาวน์โหลด CSV
                </button>
                <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="printResults()">
                    <i class="bi bi-printer me-1"></i> พิมพ์
                </button>
            </div>
        </div>
        <div class="filter-bar mb-3">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="searchInput" placeholder="ค้นหารหัสนักศึกษา / ชื่อ..." oninput="filterResults()">
            </div>
            <select class="filter-select" id="filterRisk" onchange="filterResults()">
                <option value="all">ทุกระดับความเสี่ยง</option>
                <option value="สูง">เสี่ยงสูง</option>
                <option value="ปานกลาง">ปานกลาง</option>
                <option value="ต่ำ">เสี่ยงต่ำ</option>
            </select>
            <select class="filter-select" id="filterPrediction" onchange="filterResults()">
                <option value="all">ทุกสถานะ</option>
                <option value="ผ่าน">ผ่าน</option>
                <option value="ไม่ผ่าน">ไม่ผ่าน</option>
            </select>
        </div>
        <div class="small text-muted mb-2">
            แสดง <span id="filteredCount" class="fw-bold">0</span> จาก <span id="totalCount" class="fw-bold">0</span> คน
        </div>

        <div class="results-table">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="resultsTable">
                    <thead>
                        <tr>
                            <th class="ps-3">#</th>
                            <th>รหัสนักศึกษา</th>
                            <th>ชื่อ</th>
                            <th>GPA</th>
                            <th>ความน่าจะเป็น</th>
                            <th>สถานะ</th>
                            <th>ระดับความเสี่ยง</th>
                            <th>คำแนะนำ</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Errors -->
    <div id="errorsSection" class="d-none mb-4">
        <div class="glass-card p-4" style="border-left: 4px solid #f59e0b;">
            <h6 class="fw-bold text-warning mb-2"><i class="bi bi-exclamation-triangle me-2"></i>ข้อผิดพลาดบางส่วน</h6>
            <ul id="errorsList" class="mb-0 small"></ul>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
// =========================================================
// STATE
// =========================================================
let batchResults = null;
let allResults = [];
let pieChartInstance = null;
let barChartInstance = null;
let riskChartInstance = null;
const coursesData = {{ coursesData|safe }};
const allTermsData = {{ allTermsData|safe }};
const courseLookup = {};
coursesData.forEach(c => { courseLookup[c.id] = c; });

// =========================================================
// INITIALIZATION
// =========================================================
document.addEventListener('DOMContentLoaded', function() {
    loadModels();
    setupUploadZone();
});

// =========================================================
// MODEL LOADING
// =========================================================
async function loadModels() {
    try {
        const res = await fetch('/api/models');
        const data = await res.json();
        const select = document.getElementById('modelSelect');
        select.innerHTML = '<option value="">-- เลือกโมเดล AI --</option>';
        if (data.success && data.models && data.models.length > 0) {
            data.models.forEach(m => {
                const acc = m.performance && m.performance.accuracy
                    ? ` (Accuracy: ${(m.performance.accuracy * 100).toFixed(1)}%)` : '';
                const opt = document.createElement('option');
                opt.value = m.filename;
                opt.textContent = m.filename + acc;
                select.appendChild(opt);
            });
            if (data.models.length === 1) select.selectedIndex = 1;
        } else {
            select.innerHTML = '<option value="">ไม่พบโมเดล — กรุณาฝึกโมเดลก่อน</option>';
        }
    } catch (e) {
        console.error('Error loading models:', e);
        document.getElementById('modelSelect').innerHTML = '<option value="">เกิดข้อผิดพลาดในการโหลดโมเดล</option>';
    }
}

// =========================================================
// (Threshold slider removed — use model's default 0.5)
// =========================================================

// =========================================================
// FILE UPLOAD
// =========================================================
function setupUploadZone() {
    const zone = document.getElementById('uploadZone');
    const input = document.getElementById('fileInput');

    zone.addEventListener('click', () => input.click());
    zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            input.files = e.dataTransfer.files;
            handleFileSelected(e.dataTransfer.files[0]);
        }
    });
    input.addEventListener('change', (e) => {
        if (e.target.files.length) handleFileSelected(e.target.files[0]);
    });
}

function handleFileSelected(file) {
    const info = document.getElementById('fileInfo');
    const nameEl = document.getElementById('fileInfoName');
    const sizeEl = document.getElementById('fileInfoSize');
    const btnSection = document.getElementById('predictBtnSection');
    const zone = document.getElementById('uploadZone');

    const sizeStr = file.size < 1024 * 1024
        ? (file.size / 1024).toFixed(1) + ' KB'
        : (file.size / 1024 / 1024).toFixed(2) + ' MB';

    nameEl.textContent = file.name;
    sizeEl.textContent = sizeStr;
    info.classList.remove('d-none');
    btnSection.style.display = 'block';
    zone.classList.add('has-file');
    updateSteps(2);
}

function removeFile() {
    document.getElementById('fileInput').value = '';
    document.getElementById('fileInfo').classList.add('d-none');
    document.getElementById('predictBtnSection').style.display = 'none';
    document.getElementById('uploadZone').classList.remove('has-file');
    updateSteps(1);
}

// =========================================================
// STEP INDICATOR
// =========================================================
function updateSteps(currentStep) {
    for (let i = 1; i <= 3; i++) {
        const step = document.getElementById(`step${i}Indicator`);
        step.classList.remove('active', 'completed');
        if (i < currentStep) step.classList.add('completed');
        else if (i === currentStep) step.classList.add('active');
    }
    const c1 = document.getElementById('conn1');
    const c2 = document.getElementById('conn2');
    c1.classList.toggle('completed', currentStep >= 2);
    c2.classList.toggle('completed', currentStep >= 3);
}

// =========================================================
// BATCH PREDICTION
// =========================================================
async function runBatchPrediction() {
    const modelFile = document.getElementById('modelSelect').value;
    const fileInput = document.getElementById('fileInput');

    if (!modelFile) {
        showAlert('กรุณาเลือกโมเดล AI ก่อนทำนาย', 'warning');
        return;
    }
    if (!fileInput.files.length) {
        showAlert('กรุณาเลือกไฟล์ข้อมูลนักศึกษา', 'warning');
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('model_filename', modelFile);

    showLoading('กำลังวิเคราะห์ข้อมูลและทำนายผลการเรียน...');

    try {
        const res = await fetch('/api/predict_batch', { method: 'POST', body: formData });
        const data = await res.json();
        hideLoading();

        if (data.success) {
            batchResults = data;
            allResults = data.results || [];

            // Use model's prediction and risk_level directly (same as individual prediction)
            recalcSummary();
            renderResults(batchResults);
            updateSteps(3);
            document.getElementById('resultsSection').classList.remove('d-none');
            setTimeout(() => {
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 200);
        } else {
            let errMsg = data.error || 'เกิดข้อผิดพลาด';
            if (data.detected_columns) {
                errMsg += '\n\nคอลัมน์ที่พบในไฟล์: ' + data.detected_columns.join(', ');
            }
            if (data.hint) {
                errMsg += '\n\n' + data.hint;
            }
            showAlert(errMsg, 'danger');
        }
    } catch (e) {
        hideLoading();
        showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + e.message, 'danger');
    }
}

function recalcSummary() {
    if (!allResults.length) return;
    const passed = allResults.filter(r => r.prediction === 'ผ่าน');
    const failed = allResults.filter(r => r.prediction === 'ไม่ผ่าน');
    const gpas = allResults.map(r => r.gpa);
    const probs = allResults.map(r => r.probability);

    batchResults.summary = {
        total_students: allResults.length,
        pass_count: passed.length,
        pass_percentage: Math.round(passed.length / allResults.length * 1000) / 10,
        fail_count: failed.length,
        fail_percentage: Math.round(failed.length / allResults.length * 1000) / 10,
        avg_gpa: Math.round(gpas.reduce((a,b) => a+b, 0) / gpas.length * 100) / 100,
        min_gpa: Math.round(Math.min(...gpas) * 100) / 100,
        max_gpa: Math.round(Math.max(...gpas) * 100) / 100,
        avg_probability: Math.round(probs.reduce((a,b) => a+b, 0) / probs.length * 10000) / 10000,
        risk_distribution: {
            high: allResults.filter(r => r.risk_level === 'สูง').length,
            medium: allResults.filter(r => r.risk_level === 'ปานกลาง').length,
            low: allResults.filter(r => r.risk_level === 'ต่ำ').length
        },
        probability_distribution: calcProbDist(probs)
    };
}

function calcProbDist(probs) {
    const bins = [
        {range: '0-20%', min: 0, max: 0.2, count: 0},
        {range: '21-40%', min: 0.2, max: 0.4, count: 0},
        {range: '41-60%', min: 0.4, max: 0.6, count: 0},
        {range: '61-80%', min: 0.6, max: 0.8, count: 0},
        {range: '81-100%', min: 0.8, max: 1.01, count: 0},
    ];
    probs.forEach(p => {
        for (const b of bins) {
            if (p >= b.min && p < b.max) { b.count++; break; }
        }
    });
    return bins.map(b => ({range: b.range, count: b.count}));
}

// =========================================================
// RENDER RESULTS
// =========================================================
function renderResults(data) {
    if (data.detected_format) {
        document.getElementById('detectedFormatText').textContent = 'ตรวจพบรูปแบบ: ' + data.detected_format;
    }
    renderResultHero(data.summary);
    renderSummaryCards(data.summary);
    renderSummaryProbBar(data.summary);
    renderPieChart(data.summary);
    renderBarChart(data.summary);
    renderRiskChart(data.summary);
    sortAndRenderTable();
    renderErrors(data.errors);
}

function renderResultHero(s) {
    const hero = document.getElementById('resultHero');
    const passRate = s.pass_percentage;
    let heroClass, icon, title, subtitle;
    if (passRate >= 70) {
        heroClass = 'success'; icon = 'check-circle-fill';
        title = 'ผลลัพธ์ดี';
        subtitle = `นักศึกษาส่วนใหญ่ (${passRate}%) มีแนวโน้มจบการศึกษา`;
    } else if (passRate >= 40) {
        heroClass = 'warning'; icon = 'exclamation-triangle-fill';
        title = 'ต้องระวัง';
        subtitle = `มีนักศึกษาเสี่ยง ${s.fail_count} คน จาก ${s.total_students} คน`;
    } else {
        heroClass = 'danger'; icon = 'x-circle-fill';
        title = 'สถานการณ์น่าเป็นห่วง';
        subtitle = `นักศึกษาส่วนใหญ่ (${s.fail_percentage}%) มีความเสี่ยงที่จะไม่จบการศึกษา`;
    }
    hero.className = `result-hero ${heroClass}`;
    hero.innerHTML = `
        <i class="bi bi-${icon} fs-1 text-${heroClass === 'success' ? 'success' : heroClass === 'warning' ? 'warning' : 'danger'}"></i>
        <h2>${title}</h2>
        <p class="mb-0">${subtitle}</p>
    `;
}

function renderSummaryCards(s) {
    document.getElementById('summaryCards').innerHTML = `
        <div class="col-6 col-md-2"><div class="summary-card glass-card">
            <div class="number text-primary">${s.total_students}</div>
            <div class="label">นักศึกษาทั้งหมด</div>
        </div></div>
        <div class="col-6 col-md-2"><div class="summary-card glass-card">
            <div class="number text-success">${s.pass_count}</div>
            <div class="label">ผ่าน (${s.pass_percentage}%)</div>
        </div></div>
        <div class="col-6 col-md-2"><div class="summary-card glass-card">
            <div class="number text-danger">${s.fail_count}</div>
            <div class="label">ไม่ผ่าน (${s.fail_percentage}%)</div>
        </div></div>
        <div class="col-6 col-md-2"><div class="summary-card glass-card">
            <div class="number text-info">${s.avg_gpa}</div>
            <div class="label">GPA เฉลี่ย</div>
        </div></div>
        <div class="col-6 col-md-2"><div class="summary-card glass-card">
            <div class="number text-warning">${(s.avg_probability * 100).toFixed(1)}%</div>
            <div class="label">ความน่าจะเป็นเฉลี่ย</div>
        </div></div>
        <div class="col-6 col-md-2"><div class="summary-card glass-card">
            <div class="number text-danger">${s.risk_distribution.high}</div>
            <div class="label">เสี่ยงสูง</div>
        </div></div>
    `;
}

function renderSummaryProbBar(s) {
    const bar = document.getElementById('summaryProbBar');
    bar.innerHTML = `
        <div class="pass" style="width: ${s.pass_percentage}%">${s.pass_percentage > 10 ? 'ผ่าน ' + s.pass_percentage + '%' : ''}</div>
        <div class="fail" style="width: ${s.fail_percentage}%">${s.fail_percentage > 10 ? 'ไม่ผ่าน ' + s.fail_percentage + '%' : ''}</div>
    `;
}

function renderPieChart(s) {
    if (pieChartInstance) pieChartInstance.destroy();
    pieChartInstance = new Chart(document.getElementById('pieChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['ผ่าน (จบการศึกษา)', 'ไม่ผ่าน (เสี่ยง)'],
            datasets: [{ data: [s.pass_count, s.fail_count], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0, hoverOffset: 10 }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } },
                tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed} คน (${(ctx.parsed / s.total_students * 100).toFixed(1)}%)` } }
            }
        }
    });
}

function renderBarChart(s) {
    if (barChartInstance) barChartInstance.destroy();
    const dist = s.probability_distribution;
    barChartInstance = new Chart(document.getElementById('barChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: dist.map(d => d.range),
            datasets: [{ label: 'จำนวนนักศึกษา', data: dist.map(d => d.count),
                backgroundColor: ['#ef4444', '#f59e0b', '#eab308', '#22c55e', '#10b981'],
                borderRadius: 8, borderSkipped: false }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } }, x: { grid: { display: false } } }
        }
    });
}

function renderRiskChart(s) {
    if (riskChartInstance) riskChartInstance.destroy();
    riskChartInstance = new Chart(document.getElementById('riskChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['เสี่ยงสูง', 'ปานกลาง', 'เสี่ยงต่ำ'],
            datasets: [{ data: [s.risk_distribution.high, s.risk_distribution.medium, s.risk_distribution.low],
                backgroundColor: ['#ef4444', '#f59e0b', '#10b981'], borderWidth: 0, hoverOffset: 10 }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } } }
        }
    });
}

// =========================================================
// SORTING
// =========================================================
function sortAndRenderTable() {
    const sortBy = document.getElementById('sortBy').value;
    const sorted = [...allResults];
    switch (sortBy) {
        case 'risk_desc': sorted.sort((a, b) => riskOrder(a.risk_level) - riskOrder(b.risk_level)); break;
        case 'risk_asc': sorted.sort((a, b) => riskOrder(b.risk_level) - riskOrder(a.risk_level)); break;
        case 'gpa_desc': sorted.sort((a, b) => b.gpa - a.gpa); break;
        case 'gpa_asc': sorted.sort((a, b) => a.gpa - b.gpa); break;
        case 'prob_desc': sorted.sort((a, b) => b.probability - a.probability); break;
        case 'prob_asc': sorted.sort((a, b) => a.probability - b.probability); break;
        case 'name_asc': sorted.sort((a, b) => (a.student_name || '').localeCompare(b.student_name || '')); break;
    }
    renderResultsTable(sorted);
}

function riskOrder(risk) {
    if (risk === 'สูง') return 0;
    if (risk === 'ปานกลาง') return 1;
    return 2;
}

document.getElementById('sortBy').addEventListener('change', () => {
    if (allResults.length) sortAndRenderTable();
});

// =========================================================
// FILTER / SEARCH
// =========================================================
function filterResults() {
    const query = document.getElementById('searchInput').value.trim().toLowerCase();
    const riskFilter = document.getElementById('filterRisk').value;
    const predFilter = document.getElementById('filterPrediction').value;
    const rows = document.querySelectorAll('#resultsBody tr.main-row');
    let visible = 0;

    rows.forEach(row => {
        const sid = row.dataset.studentId.toLowerCase();
        const name = (row.dataset.studentName || '').toLowerCase();
        const risk = row.dataset.riskLevel;
        const pred = row.dataset.prediction;
        const matchSearch = !query || sid.includes(query) || name.includes(query);
        const matchRisk = riskFilter === 'all' || risk === riskFilter;
        const matchPred = predFilter === 'all' || pred === predFilter;
        const show = matchSearch && matchRisk && matchPred;
        row.style.display = show ? '' : 'none';
        const detailRow = row.nextElementSibling;
        if (detailRow && detailRow.classList.contains('student-detail')) {
            if (!show) { detailRow.style.display = 'none'; detailRow.classList.remove('show'); }
            else { detailRow.style.display = ''; }
        }
        if (show) visible++;
    });
    document.getElementById('filteredCount').textContent = visible;
}

// =========================================================
// RESULTS TABLE
// =========================================================
function renderResultsTable(results) {
    const tbody = document.getElementById('resultsBody');
    tbody.innerHTML = '';
    document.getElementById('totalCount').textContent = results.length;
    document.getElementById('filteredCount').textContent = results.length;

    results.forEach((r, i) => {
        const isPass = r.prediction === 'ผ่าน';
        const statusColor = isPass ? 'success' : 'danger';
        const statusIcon = isPass ? 'check-circle-fill' : 'x-circle-fill';
        const riskClass = r.risk_level === 'สูง' ? 'risk-high' : r.risk_level === 'ปานกลาง' ? 'risk-medium' : 'risk-low';
        const prob = (r.probability * 100).toFixed(1);

        const mainRow = document.createElement('tr');
        mainRow.className = 'main-row';
        mainRow.style.cursor = 'pointer';
        mainRow.dataset.studentId = r.student_id;
        mainRow.dataset.studentName = r.student_name || '';
        mainRow.dataset.riskLevel = r.risk_level;
        mainRow.dataset.prediction = r.prediction;
        mainRow.onclick = () => toggleDetail(i);
        mainRow.innerHTML = `
            <td class="ps-3 fw-bold text-muted">${i + 1}</td>
            <td class="fw-bold">${r.student_id}</td>
            <td>${r.student_name || '-'}</td>
            <td><span class="fw-bold ${r.gpa < 2.0 ? 'text-danger' : r.gpa >= 3.0 ? 'text-success' : ''}">${r.gpa.toFixed(2)}</span></td>
            <td>
                <div class="d-flex align-items-center gap-2">
                    <div class="progress flex-grow-1" style="height: 8px; min-width: 60px;">
                        <div class="progress-bar bg-${statusColor}" style="width: ${prob}%"></div>
                    </div>
                    <span class="fw-bold" style="min-width: 50px;">${prob}%</span>
                </div>
            </td>
            <td><span class="badge bg-${statusColor}"><i class="bi bi-${statusIcon} me-1"></i>${r.prediction}</span></td>
            <td><span class="risk-badge ${riskClass}">${r.risk_level}</span></td>
            <td class="small text-muted" style="max-width: 200px;">${r.recommendation}</td>
            <td><i class="bi bi-chevron-down text-muted"></i></td>
        `;
        tbody.appendChild(mainRow);

        // Build reasons list HTML
        const reasonsHtml = (r.reasons && r.reasons.length > 0)
            ? r.reasons.map(reason => `<li class="small">${reason}</li>`).join('')
            : '<li class="small text-muted">ไม่มีข้อมูลเพิ่มเติม</li>';

        const termsText = r.loaded_terms_count ? `${r.loaded_terms_count} เทอม` : 'ไม่ระบุ';

        const detailRow = document.createElement('tr');
        detailRow.className = 'student-detail';
        detailRow.id = `detail-${i}`;
        detailRow.innerHTML = `
            <td colspan="9" class="detail-cell">
                <div class="row g-3 mb-3">
                    <div class="col-md-2"><strong>หน่วยกิตรวม:</strong> ${r.total_credits}</div>
                    <div class="col-md-2"><strong>วิชาทั้งหมด:</strong> ${r.total_courses} วิชา</div>
                    <div class="col-md-2"><strong>วิชาตก (F):</strong> <span class="text-danger fw-bold">${r.failed_count}</span></div>
                    <div class="col-md-2"><strong>ความมั่นใจ:</strong> ${(r.confidence * 100).toFixed(1)}%</div>
                    <div class="col-md-2"><strong>เทอมที่เรียน:</strong> ${termsText}</div>
                </div>
                <div class="mb-3">
                    <strong>เหตุผล:</strong>
                    <ul class="mb-0 mt-1">${reasonsHtml}</ul>
                </div>
                <div class="text-center">
                    <button class="btn btn-outline-primary btn-sm" id="gemini-btn-${i}" onclick="analyzeWithGemini(${i})">
                        <i class="bi bi-stars me-1"></i> วิเคราะห์ AI เชิงลึก (Gemini)
                    </button>
                </div>
                <div id="gemini-result-${i}" class="mt-3" style="display:none;"></div>
            </td>
        `;
        tbody.appendChild(detailRow);
    });
}

function toggleDetail(index) {
    const row = document.getElementById(`detail-${index}`);
    if (row) row.classList.toggle('show');
}

// =========================================================
// GEMINI AI ANALYSIS PER STUDENT
// =========================================================
async function analyzeWithGemini(index) {
    const r = allResults[index];
    if (!r) return;

    const btn = document.getElementById(`gemini-btn-${index}`);
    const resultDiv = document.getElementById(`gemini-result-${index}`);
    const modelFile = document.getElementById('modelSelect').value;

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> กำลังวิเคราะห์ด้วย Gemini AI...';
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<div class="text-center text-muted"><span class="spinner-border spinner-border-sm me-1"></span> กำลังวิเคราะห์ กรุณารอ...</div>';

    try {
        const res = await fetch('/api/batch_gemini_analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                student_id: r.student_id,
                student_name: r.student_name || '',
                grades: r.grades || {},
                loaded_terms_count: r.loaded_terms_count || 0,
                model_filename: modelFile,
                probability: r.probability,
                prediction: r.prediction,
                confidence: r.confidence,
                risk_level: r.risk_level
            })
        });

        const data = await res.json();

        if (data.success && data.gemini) {
            const g = data.gemini;
            const gp = g.graduation_prediction || {};
            const gpIcon = gp.will_graduate ? '✅' : '❌';
            const gpColor = gp.will_graduate ? 'success' : 'danger';

            let html = `
                <div class="card border-${gpColor}">
                    <div class="card-header bg-${gpColor} bg-opacity-10">
                        <h6 class="mb-0">${gpIcon} ผลวิเคราะห์ AI: ${gp.prediction_text || (gp.will_graduate ? 'คาดว่าจะจบ' : 'คาดว่าจะไม่จบ')}</h6>
                        <small class="text-muted">ความมั่นใจ: ${gp.confidence_percent || 0}%</small>
                    </div>
                    <div class="card-body">`;

            // Reasons
            if (gp.reason_why_graduate) {
                html += `<div class="mb-2"><strong class="text-success">เหตุผลที่จบได้:</strong> ${gp.reason_why_graduate}</div>`;
            }
            if (gp.reason_why_not_graduate) {
                html += `<div class="mb-2"><strong class="text-danger">เหตุผลที่ไม่จบ:</strong> ${gp.reason_why_not_graduate}</div>`;
            }

            // Analysis markdown
            if (g.analysis_markdown) {
                html += `<div class="mb-2 small" style="white-space: pre-wrap; line-height: 1.6;">${g.analysis_markdown}</div>`;
            }

            // Key metrics
            if (g.key_metrics && g.key_metrics.length > 0) {
                html += `<div class="mb-2"><strong>ตัวชี้วัดสำคัญ:</strong><div class="row g-2 mt-1">`;
                g.key_metrics.forEach(m => {
                    const trendIcon = m.trend === 'positive' ? '📈' : m.trend === 'negative' ? '📉' : '➡️';
                    html += `<div class="col-md-4"><span class="badge bg-light text-dark">${trendIcon} ${m.label}: ${m.value}</span></div>`;
                });
                html += `</div></div>`;
            }

            // Recommendations
            if (g.recommendations && g.recommendations.length > 0) {
                html += `<div><strong>คำแนะนำ:</strong><ul class="mb-0 mt-1">`;
                g.recommendations.forEach(rec => {
                    html += `<li class="small">${rec}</li>`;
                });
                html += `</ul></div>`;
            }

            html += `</div></div>`;
            resultDiv.innerHTML = html;
            btn.innerHTML = '<i class="bi bi-check-circle me-1"></i> วิเคราะห์แล้ว';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success');
        } else {
            resultDiv.innerHTML = `<div class="alert alert-warning mb-0 small">${data.error || 'ไม่สามารถวิเคราะห์ได้'}</div>`;
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-stars me-1"></i> ลองวิเคราะห์อีกครั้ง';
        }
    } catch (e) {
        resultDiv.innerHTML = `<div class="alert alert-danger mb-0 small">เกิดข้อผิดพลาด: ${e.message}</div>`;
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-stars me-1"></i> ลองวิเคราะห์อีกครั้ง';
    }
}

function renderErrors(errors) {
    if (!errors || errors.length === 0) {
        document.getElementById('errorsSection').classList.add('d-none');
        return;
    }
    document.getElementById('errorsList').innerHTML = errors.map(e =>
        `<li><strong>${e.student_id}:</strong> ${e.error}</li>`
    ).join('');
    document.getElementById('errorsSection').classList.remove('d-none');
}

// =========================================================
// DOWNLOAD CSV
// =========================================================
function downloadCSV() {
    if (!batchResults || !allResults.length) return;
    const headers = ['STUDENT_ID', 'STUDENT_NAME', 'GPA', 'TOTAL_CREDITS', 'TOTAL_COURSES', 'FAILED_COUNT',
                     'PROBABILITY', 'PREDICTION', 'CONFIDENCE', 'RISK_LEVEL', 'RECOMMENDATION'];
    let csv = '\uFEFF' + headers.join(',') + '\n';
    allResults.forEach(r => {
        csv += [
            r.student_id,
            '"' + (r.student_name || '').replace(/"/g, '""') + '"',
            r.gpa, r.total_credits, r.total_courses, r.failed_count,
            (r.probability * 100).toFixed(2) + '%',
            r.prediction,
            (r.confidence * 100).toFixed(2) + '%',
            r.risk_level,
            '"' + r.recommendation.replace(/"/g, '""') + '"'
        ].join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `batch_prediction_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// =========================================================
// PRINT & RESET
// =========================================================
function printResults() { window.print(); }

function resetForm() {
    document.getElementById('resultsSection').classList.add('d-none');
    removeFile();
    batchResults = null;
    allResults = [];
    document.getElementById('searchInput').value = '';
    document.getElementById('filterRisk').value = 'all';
    document.getElementById('filterPrediction').value = 'all';
    updateSteps(1);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
{% endblock %}
