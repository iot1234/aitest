{% extends "base.html" %}

{% block title %}ตั้งค่าระบบ — Admin{% endblock %}

{% block content %}
<div class="container py-4 py-md-5" style="max-width: 1000px;">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-gear-fill text-primary me-2"></i>ตั้งค่าระบบ</h2>
            <p class="text-muted mb-0">จัดการคีย์ AI, Cloud Storage และการเชื่อมต่อจากหลังบ้าน</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('main_page') }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-house me-1"></i>หน้าหลัก</a>
            <a href="{{ url_for('admin_change_password') }}" class="btn btn-outline-warning btn-sm"><i class="bi bi-key me-1"></i>เปลี่ยนรหัสผ่าน</a>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger btn-sm"><i class="bi bi-box-arrow-right me-1"></i>ออกจากระบบ</a>
        </div>
    </div>

    <!-- System Status Overview -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100" style="min-height:auto;">
                <div class="card-body p-3 d-flex align-items-center gap-3">
                    {% if mongo_connected %}
                    <div class="rounded-circle bg-success bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-database-fill-check text-success fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-success">MongoDB</div>
                        <small class="text-muted">เชื่อมต่อสำเร็จ</small>
                    </div>
                    {% else %}
                    <div class="rounded-circle bg-danger bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-database-fill-x text-danger fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-danger">MongoDB</div>
                        <small class="text-muted">{{ mongo_error or 'ไม่พร้อมใช้งาน' }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100" style="min-height:auto;">
                <div class="card-body p-3 d-flex align-items-center gap-3">
                    {% if gemini_ready %}
                    <div class="rounded-circle bg-success bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-stars text-success fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-success">Gemini AI</div>
                        <small class="text-muted">{{ gemini_model or 'พร้อมใช้งาน' }}</small>
                    </div>
                    {% else %}
                    <div class="rounded-circle bg-warning bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-stars text-warning fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-warning">Gemini AI</div>
                        <small class="text-muted">ยังไม่ได้ตั้งค่า API Key</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100" style="min-height:auto;">
                <div class="card-body p-3 d-flex align-items-center gap-3">
                    {% if r2_connected %}
                    <div class="rounded-circle bg-success bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-cloud-check-fill text-success fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-success">Cloudflare R2</div>
                        <small class="text-muted">Bucket: {{ r2_bucket or '—' }}</small>
                    </div>
                    {% else %}
                    <div class="rounded-circle bg-warning bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-cloud-slash-fill text-warning fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-warning">Cloudflare R2</div>
                        <small class="text-muted">ใช้ Local Storage</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if is_fallback %}
    <div class="alert alert-warning mb-4">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>โหมด Fallback:</strong> MongoDB ไม่พร้อม — ค่าที่บันทึกจะใช้ได้เฉพาะ runtime นี้เท่านั้น (รีสตาร์ทแล้วหายไป)
        <br><small>ตั้งค่า <code>MONGODB_URI</code> ใน Environment Variables เพื่อบันทึกถาวร</small>
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success mb-4">
        <i class="bi bi-check-circle-fill me-2"></i>{{ success }}
    </div>
    {% endif %}

    <!-- Settings Form -->
    <form method="post" action="{{ url_for('admin_settings') }}" id="settingsForm">

        <!-- Gemini AI Section -->
        <div class="card shadow-sm border-0 rounded-4 mb-4" style="min-height:auto;">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-stars text-primary fs-4 me-2"></i>
                    <h5 class="mb-0">Gemini AI Settings</h5>
                </div>
                <p class="text-muted small mb-3">ตั้งค่า Google Gemini API สำหรับวิเคราะห์และทำนายผลด้วย AI</p>

                <div class="mb-3">
                    <label class="form-label">GEMINI_API_KEY <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <input type="password" name="gemini_api_key" id="gemini_api_key" class="form-control"
                               value="{{ gemini_api_key or '' }}"
                               placeholder="ใส่ API Key จาก Google AI Studio">
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('gemini_api_key')">
                            <i class="bi bi-eye" id="gemini_api_key_icon"></i>
                        </button>
                    </div>
                    {% if gemini_api_key_masked %}
                    <small class="text-muted">ค่าปัจจุบัน: <code>{{ gemini_api_key_masked }}</code></small>
                    {% endif %}
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">GEMINI_MODEL_NAME</label>
                        <input type="text" name="gemini_model_name" class="form-control"
                               value="{{ gemini_model_name or 'gemini-3-flash-preview' }}"
                               placeholder="เช่น gemini-3-flash-preview">
                        <small class="text-muted">โมเดลหลักที่ใช้</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">GEMINI_MODEL_FALLBACKS</label>
                        <input type="text" name="gemini_model_fallbacks" class="form-control"
                               value="{{ gemini_model_fallbacks or '' }}"
                               placeholder="gemini-2.5-flash, gemini-2.0-flash">
                        <small class="text-muted">โมเดลสำรอง (คั่นด้วย comma)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cloudflare R2 Section -->
        <div class="card shadow-sm border-0 rounded-4 mb-4" style="min-height:auto;">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-cloud-arrow-up-fill text-info fs-4 me-2"></i>
                    <h5 class="mb-0">Cloudflare R2 Storage</h5>
                </div>
                <p class="text-muted small mb-3">ตั้งค่า Cloudflare R2 สำหรับเก็บโมเดลและไฟล์บน Cloud (ถ้าไม่ตั้งจะใช้ Local Storage)</p>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">CLOUDFLARE_R2_ACCESS_KEY_ID <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" name="r2_access_key" id="r2_access_key" class="form-control"
                                   value="{{ r2_access_key or '' }}" placeholder="ใส่ Access Key ID">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('r2_access_key')">
                                <i class="bi bi-eye" id="r2_access_key_icon"></i>
                            </button>
                        </div>
                        {% if r2_access_key_masked %}
                        <small class="text-muted">ค่าปัจจุบัน: <code>{{ r2_access_key_masked }}</code></small>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">CLOUDFLARE_R2_SECRET_ACCESS_KEY <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" name="r2_secret_key" id="r2_secret_key" class="form-control"
                                   value="{{ r2_secret_key or '' }}" placeholder="ใส่ Secret Key">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('r2_secret_key')">
                                <i class="bi bi-eye" id="r2_secret_key_icon"></i>
                            </button>
                        </div>
                        {% if r2_secret_key_masked %}
                        <small class="text-muted">ค่าปัจจุบัน: <code>{{ r2_secret_key_masked }}</code></small>
                        {% endif %}
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">CLOUDFLARE_R2_ENDPOINT</label>
                        <input type="text" name="r2_endpoint" class="form-control"
                               value="{{ r2_endpoint or '' }}"
                               placeholder="https://&lt;account-id&gt;.r2.cloudflarestorage.com">
                        <small class="text-muted">R2 Endpoint URL</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CLOUDFLARE_R2_BUCKET_NAME</label>
                        <input type="text" name="r2_bucket_name" class="form-control"
                               value="{{ r2_bucket_name or '' }}" placeholder="pjai">
                        <small class="text-muted">ชื่อ Bucket</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card shadow-sm border-0 rounded-4 mb-4" style="min-height:auto;">
            <div class="card-body p-4">
                <div class="d-flex gap-2 flex-wrap">
                    <button type="submit" class="btn btn-primary" id="btnSave">
                        <i class="bi bi-floppy me-1"></i> บันทึกและรีโหลดค่า Runtime
                    </button>
                    <button type="button" id="btnTestConnections" class="btn btn-outline-success">
                        <i class="bi bi-plug me-1"></i> ทดสอบการเชื่อมต่อทั้งหมด
                    </button>
                </div>

                <div id="connectionTestResult" class="mt-3 d-none"></div>
            </div>
        </div>

    </form>

    <!-- Info Box -->
    <div class="card bg-light border-0 rounded-4" style="min-height:auto;">
        <div class="card-body p-4">
            <h6 class="mb-2"><i class="bi bi-info-circle me-1 text-primary"></i> คำแนะนำ</h6>
            <ul class="mb-0 small text-muted">
                <li><strong>MONGODB_URI</strong> ต้องตั้งค่าผ่าน Environment Variable ของ Server (เช่น Railway, .env) — ไม่สามารถตั้งจากหน้านี้ได้</li>
                <li>คีย์ทั้งหมดจะถูกบันทึกลง MongoDB และโหลดอัตโนมัติเมื่อ Server เริ่มทำงาน</li>
                <li>หลังบันทึก ระบบจะรีโหลด Gemini API และ R2 Storage ทันที</li>
                <li>ถ้าไม่ตั้งค่า R2 ระบบจะใช้ Local Storage แทน (ข้อมูลอาจหายเมื่อ deploy ใหม่)</li>
                <li>กดปุ่ม "ทดสอบการเชื่อมต่อ" เพื่อตรวจสอบว่าค่าที่ตั้งถูกต้องหรือไม่</li>
            </ul>
        </div>
    </div>

</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
// Toggle password visibility
function togglePassword(fieldId) {
    const input = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');
    if (!input || !icon) return;
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

// Test connections
document.getElementById('btnTestConnections')?.addEventListener('click', async () => {
    const resultBox = document.getElementById('connectionTestResult');
    resultBox.className = 'alert alert-info mt-3';
    resultBox.classList.remove('d-none');
    resultBox.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>กำลังทดสอบการเชื่อมต่อ... (อาจใช้เวลาสักครู่)';

    try {
        const resp = await fetch('/api/admin/test-connections', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });

        if (resp.status === 401 || resp.status === 403) {
            resultBox.className = 'alert alert-danger mt-3';
            resultBox.innerHTML = '<i class="bi bi-shield-x me-2"></i>Session หมดอายุ — กรุณา <a href="/admin/login">เข้าสู่ระบบใหม่</a>';
            return;
        }

        const data = await resp.json();

        const statusIcon = (ok) => ok ? '✅' : '❌';
        const mongo = `${statusIcon(data.mongo?.connected)} <strong>MongoDB:</strong> ${data.mongo?.connected ? 'เชื่อมต่อสำเร็จ' : (data.mongo?.message || 'เชื่อมต่อไม่ได้')}`;
        const r2 = `${statusIcon(data.r2?.connected)} <strong>Cloudflare R2:</strong> ${data.r2?.connected ? data.r2.message : (data.r2?.message || 'เชื่อมต่อไม่ได้')}`;
        const gemini = `${statusIcon(data.gemini?.connected)} <strong>Gemini AI:</strong> ${data.gemini?.connected ? data.gemini.message : (data.gemini?.message || 'เชื่อมต่อไม่ได้')}`;

        resultBox.className = `alert ${data.success ? 'alert-success' : 'alert-warning'} mt-3`;
        resultBox.innerHTML = `${mongo}<br>${r2}<br>${gemini}`;
    } catch (e) {
        resultBox.className = 'alert alert-danger mt-3';
        resultBox.innerHTML = `<i class="bi bi-x-circle me-2"></i>ทดสอบไม่สำเร็จ: ${e.message}`;
    }
});

// Save button loading state
document.getElementById('settingsForm')?.addEventListener('submit', function() {
    const btn = document.getElementById('btnSave');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> กำลังบันทึก...';
    }
});
</script>
{% endblock %}
