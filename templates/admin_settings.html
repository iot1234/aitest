{% extends "base.html" %}

{% block title %}‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ‚Äî Admin{% endblock %}

{% block custom_css %}
{{ super() }}
<style>
@keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 py-md-5" style="max-width: 1000px;">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-gear-fill text-primary me-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <p class="text-muted mb-0">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå AI, Cloud Storage ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('main_page') }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-house me-1"></i>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
            <a href="{{ url_for('admin_change_password') }}" class="btn btn-outline-warning btn-sm"><i class="bi bi-key me-1"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</a>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger btn-sm"><i class="bi bi-box-arrow-right me-1"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
    </div>

    <!-- System Status Overview -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100" style="min-height:auto;">
                <div class="card-body p-3 d-flex align-items-center gap-3">
                    {% if mongo_connected %}
                    <div class="rounded-circle bg-success bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-database-fill-check text-success fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-success">MongoDB</div>
                        <small class="text-muted">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</small>
                    </div>
                    {% else %}
                    <div class="rounded-circle bg-danger bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-database-fill-x text-danger fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-danger">MongoDB</div>
                        <small class="text-muted">{{ mongo_error or '‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100" style="min-height:auto;">
                <div class="card-body p-3 d-flex align-items-center gap-3">
                    {% if gemini_ready %}
                    <div class="rounded-circle bg-success bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-stars text-success fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-success">Gemini AI</div>
                        <small class="text-muted">{{ gemini_model or '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' }}</small>
                    </div>
                    {% else %}
                    <div class="rounded-circle bg-warning bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-stars text-warning fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-warning">Gemini AI</div>
                        <small class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100" style="min-height:auto;">
                <div class="card-body p-3 d-flex align-items-center gap-3">
                    {% if r2_connected %}
                    <div class="rounded-circle bg-success bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-cloud-check-fill text-success fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-success">Cloudflare R2</div>
                        <small class="text-muted">Bucket: {{ r2_bucket or '‚Äî' }}</small>
                    </div>
                    {% else %}
                    <div class="rounded-circle bg-warning bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width:48px;height:48px;min-width:48px;">
                        <i class="bi bi-cloud-slash-fill text-warning fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-warning">Cloudflare R2</div>
                        <small class="text-muted">‡πÉ‡∏ä‡πâ Local Storage</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if is_fallback %}
    <div class="alert alert-warning mb-4">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>‡πÇ‡∏´‡∏°‡∏î Fallback:</strong> MongoDB ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‚Äî ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ runtime ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)
        <br><small>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ <code>MONGODB_URI</code> ‡πÉ‡∏ô Environment Variables ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£</small>
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success mb-4">
        <i class="bi bi-check-circle-fill me-2"></i>{{ success }}
    </div>
    {% endif %}

    <!-- Settings Form -->
    <form method="post" action="{{ url_for('admin_settings') }}" id="settingsForm">

        <!-- Gemini AI Section -->
        <div class="card shadow-sm border-0 rounded-4 mb-4" style="min-height:auto;">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-stars text-primary fs-4 me-2"></i>
                    <h5 class="mb-0">Gemini AI Settings</h5>
                </div>
                <p class="text-muted small mb-3">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Gemini API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ AI</p>

                <div class="mb-3">
                    <label class="form-label">GEMINI_API_KEY <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <input type="password" name="gemini_api_key" id="gemini_api_key" class="form-control"
                               value="{{ gemini_api_key or '' }}"
                               placeholder="‡πÉ‡∏™‡πà API Key ‡∏à‡∏≤‡∏Å Google AI Studio">
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('gemini_api_key')">
                            <i class="bi bi-eye" id="gemini_api_key_icon"></i>
                        </button>
                    </div>
                    {% if gemini_api_key_masked %}
                    <small class="text-muted">‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <code>{{ gemini_api_key_masked }}</code></small>
                    {% endif %}
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">GEMINI_MODEL_NAME <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <select name="gemini_model_name" id="gemini_model_name" class="form-select">
                                {% for m in gemini_known_models %}
                                <option value="{{ m.id }}" {% if gemini_model_name == m.id %}selected{% endif %}>
                                    {{ m.name }} ‚Äî {{ m.desc }}
                                </option>
                                {% endfor %}
                                {% if gemini_model_name and gemini_model_name not in gemini_known_models|map(attribute='id')|list %}
                                <option value="{{ gemini_model_name }}" selected>{{ gemini_model_name }} (custom)</option>
                                {% endif %}
                            </select>
                            <button class="btn btn-outline-info" type="button" id="btnLoadModels" title="‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏≤‡∏Å Google API">
                                <i class="bi bi-arrow-clockwise" id="loadModelsIcon"></i>
                            </button>
                        </div>
                        <small class="text-muted">‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ ‚Äî ‡∏Å‡∏î <i class="bi bi-arrow-clockwise"></i> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å API</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">GEMINI_MODEL_FALLBACKS</label>
                        <input type="text" name="gemini_model_fallbacks" class="form-control"
                               value="{{ gemini_model_fallbacks or '' }}"
                               placeholder="gemini-2.5-flash, gemini-2.0-flash">
                        <small class="text-muted">‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma) ‚Äî ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cloudflare R2 Section -->
        <div class="card shadow-sm border-0 rounded-4 mb-4" style="min-height:auto;">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-cloud-arrow-up-fill text-info fs-4 me-2"></i>
                    <h5 class="mb-0">Cloudflare R2 Storage</h5>
                </div>
                <p class="text-muted small mb-3">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Cloudflare R2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô Cloud (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ Local Storage)</p>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">CLOUDFLARE_R2_ACCESS_KEY_ID <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" name="r2_access_key" id="r2_access_key" class="form-control"
                                   value="{{ r2_access_key or '' }}" placeholder="‡πÉ‡∏™‡πà Access Key ID">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('r2_access_key')">
                                <i class="bi bi-eye" id="r2_access_key_icon"></i>
                            </button>
                        </div>
                        {% if r2_access_key_masked %}
                        <small class="text-muted">‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <code>{{ r2_access_key_masked }}</code></small>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">CLOUDFLARE_R2_SECRET_ACCESS_KEY <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" name="r2_secret_key" id="r2_secret_key" class="form-control"
                                   value="{{ r2_secret_key or '' }}" placeholder="‡πÉ‡∏™‡πà Secret Key">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('r2_secret_key')">
                                <i class="bi bi-eye" id="r2_secret_key_icon"></i>
                            </button>
                        </div>
                        {% if r2_secret_key_masked %}
                        <small class="text-muted">‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <code>{{ r2_secret_key_masked }}</code></small>
                        {% endif %}
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">CLOUDFLARE_R2_ENDPOINT</label>
                        <input type="text" name="r2_endpoint" class="form-control"
                               value="{{ r2_endpoint or '' }}"
                               placeholder="https://&lt;account-id&gt;.r2.cloudflarestorage.com">
                        <small class="text-muted">R2 Endpoint URL</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CLOUDFLARE_R2_BUCKET_NAME</label>
                        <input type="text" name="r2_bucket_name" class="form-control"
                               value="{{ r2_bucket_name or '' }}" placeholder="pjai">
                        <small class="text-muted">‡∏ä‡∏∑‡πà‡∏≠ Bucket</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card shadow-sm border-0 rounded-4 mb-4 border-primary" style="min-height:auto;border-left:4px solid var(--primary) !important;">
            <div class="card-body p-4">
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <button type="submit" class="btn btn-primary btn-lg" id="btnSave">
                        <i class="bi bi-floppy me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î Runtime
                    </button>
                    <button type="button" id="btnTestConnections" class="btn btn-outline-success">
                        <i class="bi bi-plug me-1"></i> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
                    </button>
                </div>
                <small class="text-muted d-block mt-2">
                    <i class="bi bi-info-circle me-1"></i>‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ save ‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á Gemini ‡πÅ‡∏•‡∏∞ R2 ‡∏•‡∏á MongoDB ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                </small>

                <div id="connectionTestResult" class="mt-3 d-none"></div>
            </div>
        </div>

    </form>

    <!-- Info Box -->
    <div class="card bg-light border-0 rounded-4" style="min-height:auto;">
        <div class="card-body p-4">
            <h6 class="mb-2"><i class="bi bi-info-circle me-1 text-primary"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h6>
            <ul class="mb-0 small text-muted">
                <li><strong>MONGODB_URI</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô Environment Variable ‡∏Ç‡∏≠‡∏á Server (‡πÄ‡∏ä‡πà‡∏ô Railway, .env) ‚Äî ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ</li>
                <li>‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á MongoDB ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ Server ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</li>
                <li>‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î Gemini API ‡πÅ‡∏•‡∏∞ R2 Storage ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
                <li>‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ R2 ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ Local Storage ‡πÅ‡∏ó‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏´‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠ deploy ‡πÉ‡∏´‡∏°‡πà)</li>
                <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</li>
            </ul>
        </div>
    </div>

</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
// Toggle password visibility
function togglePassword(fieldId) {
    const input = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');
    if (!input || !icon) return;
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

// Test connections
document.getElementById('btnTestConnections')?.addEventListener('click', async () => {
    const resultBox = document.getElementById('connectionTestResult');
    resultBox.className = 'alert alert-info mt-3';
    resultBox.classList.remove('d-none');
    resultBox.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠... (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)';

    try {
        const resp = await fetch('/api/admin/test-connections', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });

        if (resp.status === 401 || resp.status === 403) {
            resultBox.className = 'alert alert-danger mt-3';
            resultBox.innerHTML = '<i class="bi bi-shield-x me-2"></i>Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ <a href="/admin/login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà</a>';
            return;
        }

        const data = await resp.json();

        const statusIcon = (ok) => ok ? '‚úÖ' : '‚ùå';
        const mongo = `${statusIcon(data.mongo?.connected)} <strong>MongoDB:</strong> ${data.mongo?.connected ? '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : (data.mongo?.message || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ')}`;
        const r2 = `${statusIcon(data.r2?.connected)} <strong>Cloudflare R2:</strong> ${data.r2?.connected ? data.r2.message : (data.r2?.message || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ')}`;

        let geminiHtml = `${statusIcon(data.gemini?.connected)} <strong>Gemini AI:</strong> ${data.gemini?.message || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'}`;
        // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        if (!data.gemini?.connected && data.gemini?.suggested_model) {
            geminiHtml += `<br><button class="btn btn-sm btn-warning mt-1" onclick="applySuggestedModel('${data.gemini.suggested_model}')">
                <i class="bi bi-arrow-repeat me-1"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${data.gemini.suggested_model}</button>`;
        }

        resultBox.className = `alert ${data.success ? 'alert-success' : 'alert-warning'} mt-3`;
        resultBox.innerHTML = `${mongo}<br>${r2}<br>${geminiHtml}`;
    } catch (e) {
        resultBox.className = 'alert alert-danger mt-3';
        resultBox.innerHTML = `<i class="bi bi-x-circle me-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${e.message}`;
    }
});

// Apply suggested model ‚Äî ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô dropdown ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function applySuggestedModel(modelId) {
    const select = document.getElementById('gemini_model_name');
    if (select) {
        // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô dropdown ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
        let found = false;
        for (const opt of select.options) {
            if (opt.value === modelId) {
                opt.selected = true;
                found = true;
                break;
            }
        }
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô dropdown ‡∏Å‡πá‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        if (!found) {
            const opt = new Option(modelId + ' (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)', modelId, true, true);
            select.add(opt);
        }
    }
    // ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    const form = document.getElementById('settingsForm');
    if (form) form.submit();
}

// Save button loading state
document.getElementById('settingsForm')?.addEventListener('submit', function() {
    const btn = document.getElementById('btnSave');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    }
});

// Load live Gemini models from API
document.getElementById('btnLoadModels')?.addEventListener('click', async () => {
    const icon = document.getElementById('loadModelsIcon');
    const select = document.getElementById('gemini_model_name');
    if (!select) return;

    // Spinning animation
    icon.className = 'bi bi-arrow-clockwise';
    icon.style.animation = 'spin 1s linear infinite';

    try {
        const resp = await fetch('/api/admin/gemini-models');
        if (resp.status === 401 || resp.status === 403) {
            alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
            return;
        }
        const data = await resp.json();
        const currentVal = select.value;

        // Clear existing options
        select.innerHTML = '';

        // Build a set to avoid duplicates
        const added = new Set();

        // Add live models first (from API) ‚Äî these are guaranteed to work
        if (data.live_models && data.live_models.length > 0) {
            const liveGroup = document.createElement('optgroup');
            liveGroup.label = 'üü¢ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å API)';
            data.live_models.forEach(m => {
                if (added.has(m.id)) return;
                added.add(m.id);
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = `${m.display_name || m.id}`;
                if (m.id === currentVal) opt.selected = true;
                liveGroup.appendChild(opt);
            });
            select.appendChild(liveGroup);
        }

        // Add known models that weren't in live list
        if (data.known_models && data.known_models.length > 0) {
            const knownGroup = document.createElement('optgroup');
            knownGroup.label = 'üìã ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å';
            data.known_models.forEach(m => {
                if (added.has(m.id)) return;
                added.add(m.id);
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = `${m.name} ‚Äî ${m.desc}`;
                if (m.id === currentVal) opt.selected = true;
                knownGroup.appendChild(opt);
            });
            if (knownGroup.children.length > 0) select.appendChild(knownGroup);
        }

        // Keep current value if not in any list
        if (currentVal && !added.has(currentVal)) {
            const opt = document.createElement('option');
            opt.value = currentVal;
            opt.textContent = `${currentVal} (custom)`;
            opt.selected = true;
            select.appendChild(opt);
        }

        if (data.live_error) {
            alert('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏≤‡∏Å API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.live_error);
        }
    } catch (e) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
    } finally {
        icon.style.animation = '';
        icon.className = 'bi bi-arrow-clockwise';
    }
});
</script>
{% endblock %}
