{% extends "base.html" %}

{% block title %}วิเคราะห์หลักสูตร - ระบบทำนายความสำเร็จของนักศึกษา{% endblock %}

{% block custom_css %}
<style>
    /* Form Card */
    .form-card {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
    }
    
    .form-card-header {
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        padding: 1.25rem 1.5rem;
    }
    
    .form-card-header h5 {
        margin: 0;
        font-weight: 700;
    }
    
    .form-card-body {
        padding: 2rem;
    }
    
    /* Progress Section */
    .progress-section {
        background: var(--primary-bg);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin: 1.5rem 0;
        border: 2px solid rgba(30, 64, 175, 0.1);
    }
    
    .progress-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .progress-stat {
        text-align: center;
    }
    
    .progress-stat-value {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--primary);
        line-height: 1;
        margin-bottom: 0.25rem;
    }
    
    .progress-stat-label {
        font-size: 0.8rem;
        color: var(--gray-500);
        font-weight: 500;
    }
    
    /* Subject Card */
    .subject-card {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 1rem;
        transition: all 0.2s;
        height: 100%;
    }
    
    .subject-card:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-md);
    }
    
    .subject-card h6 {
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }
    
    .subject-card .subject-meta {
        font-size: 0.8rem;
        color: var(--gray-500);
        margin-bottom: 0.75rem;
    }
    
    /* Results Section */
    .results-section {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
        margin-top: 2rem;
    }
    
    /* Summary Card */
    .summary-card {
        background: linear-gradient(135deg, var(--success), var(--success-light));
        color: white;
        padding: 2rem;
        border-radius: var(--radius-xl);
    }
    
    .summary-card.danger {
        background: linear-gradient(135deg, var(--danger), var(--danger-light));
    }
    
    .summary-card.warning {
        background: linear-gradient(135deg, var(--warning), var(--warning-light));
    }
    
    /* Progress Ring */
    .progress-ring-container {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .progress-ring {
        position: relative;
        width: 140px;
        height: 140px;
    }
    
    .progress-ring svg {
        width: 140px;
        height: 140px;
        transform: rotate(-90deg);
    }
    
    .progress-ring circle {
        fill: none;
        stroke-width: 12;
    }
    
    .progress-ring circle.bg {
        stroke: rgba(255,255,255,0.3);
    }
    
    .progress-ring circle.progress {
        stroke: white;
        stroke-dasharray: 377;
        stroke-dashoffset: 377;
        transition: stroke-dashoffset 0.5s ease;
        stroke-linecap: round;
    }
    
    .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.75rem;
        font-weight: 800;
        color: white;
    }
    
    /* Info Cards */
    .info-card {
        background: white;
        border-radius: var(--radius-lg);
        overflow: hidden;
        height: 100%;
    }
    
    .info-card-header {
        padding: 1rem 1.25rem;
        font-weight: 700;
        color: white;
    }
    
    .info-card-header.bg-danger { background: linear-gradient(135deg, var(--danger), var(--danger-light)); }
    .info-card-header.bg-warning { background: linear-gradient(135deg, var(--warning), var(--warning-light)); }
    .info-card-header.bg-primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); }
    
    .info-card-body {
        padding: 1.25rem;
    }
    
    /* Analysis Method */
    .analysis-method {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .method-option {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .method-option:hover {
        background: white;
    }
    
    .method-option input {
        margin-right: 0.75rem;
    }
    
    .method-option .form-check-label {
        cursor: pointer;
        font-weight: 500;
    }
    
    /* Gemini Card */
    .gemini-card {
        background: linear-gradient(135deg, #1e1e2e, #2d2d3e);
        border-radius: var(--radius-xl);
        padding: 1.5rem;
        color: white;
        margin-top: 1.5rem;
    }
    
    .gemini-card h6 {
        color: #a78bfa;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .gemini-content {
        color: #e2e8f0;
        line-height: 1.7;
    }
    
    @media (max-width: 768px) {
        .progress-stats {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1><i class="bi bi-diagram-3-fill me-2"></i>วิเคราะห์หลักสูตร</h1>
    <p class="lead">วิเคราะห์ความคืบหน้าการเรียนตามหลักสูตรและเงื่อนไข prerequisite</p>
</div>

<!-- Form Card -->
<div class="form-card">
    <div class="form-card-header">
        <h5><i class="bi bi-pencil-square me-2"></i>กรอกข้อมูลสำหรับการวิเคราะห์</h5>
    </div>
    <div class="form-card-body">
        <form id="advancedPredictionForm">
            <!-- Basic Info -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label for="studentName" class="form-label">ชื่อ-นามสกุล</label>
                    <input type="text" class="form-control" id="studentName" placeholder="เช่น นายสมชาย ใจดี">
                </div>
                <div class="col-md-6">
                    <label for="modelSelect" class="form-label">เลือกโมเดล</label>
                    <select class="form-select" id="modelSelect">
                        <option value="">กำลังโหลดรายการโมเดล...</option>
                    </select>
                </div>
            </div>
            
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label for="currentYear" class="form-label">ปีการศึกษา</label>
                    <select class="form-select" id="currentYear">
                        <option value="1">ปี 1</option>
                        <option value="2" selected>ปี 2</option>
                        <option value="3">ปี 3</option>
                        <option value="4">ปี 4</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="currentTerm" class="form-label">เทอม</label>
                    <select class="form-select" id="currentTerm">
                        <option value="1" selected>เทอม 1</option>
                        <option value="2">เทอม 2</option>
                    </select>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div class="progress-section">
                <div class="progress-stats">
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="completedSubjects">0</div>
                        <div class="progress-stat-label">วิชาที่เรียนแล้ว</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="totalSubjects">0</div>
                        <div class="progress-stat-label">วิชาทั้งหมดในแผน</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="currentGPA">0.00</div>
                        <div class="progress-stat-label">GPA ปัจจุบัน</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="completionRate">0%</div>
                        <div class="progress-stat-label">ความคืบหน้า</div>
                    </div>
                </div>
                <div class="progress" style="height: 1rem;">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Subject Tabs -->
            <h5 class="fw-bold mb-3">
                <i class="bi bi-journal-text me-2"></i>เกรดรายวิชา
            </h5>
            <ul class="nav nav-tabs mb-3" id="subjectTabs"></ul>
            <div class="tab-content" id="subjectTabContent"></div>
            
            <!-- Analysis Method -->
            <div class="analysis-method">
                <label class="form-label fw-bold">
                    <i class="bi bi-gear me-1"></i> เลือกวิธีการวิเคราะห์
                </label>
                <div class="method-option">
                    <input class="form-check-input" type="radio" name="analysisMethod" id="methodNormal" value="normal" checked>
                    <label class="form-check-label" for="methodNormal">
                        <i class="bi bi-cpu me-1 text-primary"></i> วิเคราะห์ด้วยโมเดล AI ปกติ
                    </label>
                </div>
                <div class="method-option">
                    <input class="form-check-input" type="radio" name="analysisMethod" id="methodGemini" value="gemini">
                    <label class="form-check-label" for="methodGemini">
                        <i class="bi bi-stars me-1 text-warning"></i> วิเคราะห์ด้วย Gemini AI
                    </label>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="d-grid mt-4">
                <button type="submit" class="btn btn-primary btn-lg" id="predictBtn" disabled>
                    <span id="predictSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                    <i class="bi bi-magic me-1"></i> เริ่มการวิเคราะห์
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Results Section -->
<div id="resultsSection" class="results-section d-none">
    <!-- Summary Card -->
    <div class="summary-card" id="summaryCard">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="progress-ring-container">
                    <div class="progress-ring">
                        <svg>
                            <circle class="bg" cx="70" cy="70" r="60"></circle>
                            <circle class="progress" cx="70" cy="70" r="60" id="resultsCompletionRing"></circle>
                        </svg>
                        <div class="progress-text" id="resultsCompletionRate">0%</div>
                    </div>
                </div>
                <h6 class="text-center text-white mt-2">ความคืบหน้าหลักสูตร</h6>
            </div>
            <div class="col-md-8">
                <h3 class="mb-3" id="resultsGraduationStatus"></h3>
                <div class="row">
                    <div class="col-6">
                        <p class="mb-1"><strong>นักศึกษา:</strong> <span id="resultsStudentName">-</span></p>
                        <p class="mb-0"><strong>GPA ปัจจุบัน:</strong> <span id="resultsCurrentGPA">-</span></p>
                    </div>
                    <div class="col-6">
                        <p class="mb-1"><strong>คาดการณ์:</strong> <span id="resultsPrediction">-</span></p>
                        <p class="mb-0"><strong>ความเสี่ยง:</strong> <span id="resultsRiskLevel" class="badge">-</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="p-4">
        <!-- Info Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="info-card">
                    <div class="info-card-header bg-danger">
                        <i class="bi bi-x-circle-fill me-2"></i>วิชาที่ตก (เกรด F)
                    </div>
                    <div class="info-card-body" id="failedCourses">
                        <p class="text-muted mb-0">ไม่พบวิชาที่ตก</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-card">
                    <div class="info-card-header bg-warning">
                        <i class="bi bi-slash-circle-fill me-2"></i>วิชาที่ถูกบล็อก
                    </div>
                    <div class="info-card-body" id="blockedCourses">
                        <p class="text-muted mb-0">ไม่พบวิชาที่ถูกบล็อก</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recommendations -->
        <div class="info-card">
            <div class="info-card-header bg-primary">
                <i class="bi bi-lightbulb-fill me-2"></i>คำแนะนำ
            </div>
            <div class="info-card-body" id="recommendations">
                <p class="text-muted mb-0">ไม่มีคำแนะนำเฉพาะ</p>
            </div>
        </div>
        
        <!-- Gemini Analysis -->
        <div id="geminiAnalysisContainer"></div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
let coursesData = [];
let allTermsData = [];
let gradeMapping = {};

document.addEventListener('DOMContentLoaded', function() {
    initializeAdvancedTest();
});

async function initializeAdvancedTest() {
    try {
        showLoading('กำลังโหลดข้อมูล...');
        const configResponse = await fetch('/api/config');
        const configData = await configResponse.json();
        
        if (configData.success !== false) {
            coursesData = configData.COURSES_DATA || [];
            allTermsData = configData.ALL_TERMS_DATA || [];
            gradeMapping = configData.GRADE_MAPPING || {};
            
            await loadModels();
            generateSubjectTabs();
            setupEventListeners();
            updateProgress();
        } else {
            showAlert('ไม่สามารถโหลดข้อมูลหลักสูตรได้', 'danger');
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'danger');
    } finally {
        hideLoading();
    }
}

async function loadModels() {
    try {
        const response = await fetch('/api/models');
        const data = await response.json();
        const modelSelect = document.getElementById('modelSelect');
        
        if (data.success && data.models.length > 0) {
            const subjectModels = data.models.filter(m => m.data_format === 'subject_based');
            
            if (subjectModels.length > 0) {
                modelSelect.innerHTML = '<option value="">-- เลือกโมเดล --</option>';
                subjectModels.forEach(model => {
                    const accuracy = model.performance.accuracy ? (model.performance.accuracy * 100).toFixed(1) : 'N/A';
                    const option = document.createElement('option');
                    option.value = model.filename;
                    option.textContent = `${model.filename} (${accuracy}%)`;
                    modelSelect.appendChild(option);
                });
                document.getElementById('predictBtn').disabled = false;
            } else {
                modelSelect.innerHTML = '<option value="">ไม่พบโมเดลที่เหมาะสม</option>';
            }
        } else {
            modelSelect.innerHTML = '<option value="">ไม่พบโมเดลที่ใช้งานได้</option>';
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาดในการโหลดโมเดล', 'danger');
    }
}

function generateSubjectTabs() {
    const tabsContainer = document.getElementById('subjectTabs');
    const contentContainer = document.getElementById('subjectTabContent');
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';
    
    allTermsData.forEach((term, index) => {
        const tab = document.createElement('li');
        tab.className = 'nav-item';
        tab.innerHTML = `<button class="nav-link ${index === 0 ? 'active' : ''}" data-bs-toggle="tab" data-bs-target="#term${index}">ปี ${term.year} เทอม ${term.term}</button>`;
        tabsContainer.appendChild(tab);
        
        const content = document.createElement('div');
        content.className = `tab-pane fade ${index === 0 ? 'show active' : ''}`;
        content.id = `term${index}`;
        content.innerHTML = generateSubjectGrid(term.ids);
        contentContainer.appendChild(content);
    });
}

function generateSubjectGrid(courseIds) {
    let html = '<div class="row g-3">';
    courseIds.forEach(courseId => {
        const course = coursesData.find(c => c.id === courseId);
        if (!course) return;
        
        html += `
            <div class="col-md-6 col-lg-4">
                <div class="subject-card">
                    <h6>${course.thaiName}</h6>
                    <div class="subject-meta">${course.id} | ${course.credit} หน่วยกิต</div>
                    <select class="form-select form-select-sm subject-grade" data-course-id="${course.id}" onchange="updateProgress()">
                        <option value="">-- เลือกเกรด --</option>
                        ${Object.keys(gradeMapping).map(grade => `<option value="${grade}">${grade}</option>`).join('')}
                    </select>
                </div>
            </div>
        `;
    });
    html += '</div>';
    return html;
}

function setupEventListeners() {
    const form = document.getElementById('advancedPredictionForm');
    if (form) form.addEventListener('submit', handleAdvancedPrediction);
}

function updateProgress() {
    const gradeSelects = document.querySelectorAll('.subject-grade');
    let completedCount = 0;
    let totalPoints = 0;
    let totalCredits = 0;
    
    gradeSelects.forEach(select => {
        if (select.value) {
            completedCount++;
            const courseId = select.dataset.courseId;
            const course = coursesData.find(c => c.id === courseId);
            
            if (course && gradeMapping[select.value] !== undefined) {
                totalPoints += gradeMapping[select.value] * course.credit;
                totalCredits += course.credit;
            }
        }
    });
    
    const totalSubjects = gradeSelects.length;
    const currentGPA = totalCredits > 0 ? totalPoints / totalCredits : 0;
    const completionRate = totalSubjects > 0 ? (completedCount / totalSubjects) * 100 : 0;
    
    document.getElementById('completedSubjects').textContent = completedCount;
    document.getElementById('totalSubjects').textContent = totalSubjects;
    document.getElementById('currentGPA').textContent = currentGPA.toFixed(2);
    document.getElementById('completionRate').textContent = completionRate.toFixed(0) + '%';
    
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = completionRate + '%';
    progressBar.className = 'progress-bar ' + (currentGPA >= 3.0 ? 'bg-success' : currentGPA >= 2.0 ? 'bg-warning' : 'bg-danger');
}

async function handleAdvancedPrediction(event) {
    event.preventDefault();
    
    const analysisMethod = document.querySelector('input[name="analysisMethod"]:checked').value;
    const studentName = document.getElementById('studentName').value || 'นักศึกษา';
    const modelFilename = document.getElementById('modelSelect').value;
    const currentYear = parseInt(document.getElementById('currentYear').value);
    const currentTerm = parseInt(document.getElementById('currentTerm').value);
    const loadedTermsCount = (currentYear - 1) * 2 + currentTerm;
    
    const grades = {};
    document.querySelectorAll('.subject-grade').forEach(select => {
        if (select.value) grades[select.dataset.courseId] = select.value;
    });
    
    if (Object.keys(grades).length === 0) {
        showAlert('กรุณากรอกเกรดอย่างน้อย 1 วิชา', 'warning');
        return;
    }
    
    showLoading(analysisMethod === 'gemini' ? 'กำลังวิเคราะห์ด้วย Gemini...' : 'กำลังวิเคราะห์หลักสูตร...');
    
    try {
        const endpoint = analysisMethod === 'gemini' ? '/api/gemini/predict' : '/api/analyze_curriculum';
        const payload = analysisMethod === 'gemini' 
            ? { student_name: studentName, course_grades: grades, loaded_terms_count: loadedTermsCount, model_filename: modelFilename, analysis_goal: 'วิเคราะห์แนวโน้มการจบการศึกษาและให้คำแนะนำ' }
            : { student_name: studentName, current_grades: grades, loaded_terms_count: loadedTermsCount, model_filename: modelFilename };
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (analysisMethod === 'gemini') {
                const geminiResult = {
                    success: true,
                    student_name: studentName,
                    avg_gpa: result.analysis?.estimated_gpa || 0,
                    completion_rate: 0,
                    graduation_status: result.gemini?.outcome_summary?.status || 'ไม่ทราบ',
                    prediction_result: {
                        prediction: result.gemini?.outcome_summary?.status || 'ไม่ทราบ',
                        confidence: result.gemini?.outcome_summary?.confidence || 0.5,
                        risk_level: result.gemini?.risk_level || 'ไม่ทราบ'
                    },
                    failed_courses: [],
                    blocked_courses_details: [],
                    recommendations: result.gemini?.recommendations || [],
                    gemini_analysis: result.gemini,
                    analysis_method: 'gemini'
                };
                displayAdvancedResults(geminiResult);
            } else {
                result.analysis_method = 'normal';
                displayAdvancedResults(result);
            }
            showAlert('วิเคราะห์สำเร็จ!', 'success');
        } else {
            showAlert('เกิดข้อผิดพลาด: ' + (result.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'danger');
    } finally {
        hideLoading();
    }
}

function displayAdvancedResults(data) {
    const resultsSection = document.getElementById('resultsSection');
    resultsSection.classList.remove('d-none');
    resultsSection.scrollIntoView({ behavior: 'smooth' });
    
    // Update summary card color based on risk
    const summaryCard = document.getElementById('summaryCard');
    const riskLevel = data.prediction_result?.risk_level || '';
    summaryCard.className = 'summary-card ' + (riskLevel === 'สูง' || riskLevel === 'high' ? 'danger' : riskLevel === 'ปานกลาง' || riskLevel === 'moderate' ? 'warning' : '');
    
    document.getElementById('resultsStudentName').textContent = data.student_name;
    document.getElementById('resultsCurrentGPA').textContent = data.avg_gpa ? data.avg_gpa.toFixed(2) : '0.00';
    document.getElementById('resultsGraduationStatus').textContent = data.graduation_status || 'ไม่ทราบ';
    
    updateProgressRingForResults(data.completion_rate || 0);
    
    if (data.prediction_result) {
        document.getElementById('resultsPrediction').textContent = 
            data.prediction_result.prediction + ' (' + (data.prediction_result.confidence * 100).toFixed(1) + '%)';
        
        const riskBadge = document.getElementById('resultsRiskLevel');
        riskBadge.textContent = data.prediction_result.risk_level || 'ไม่ทราบ';
        riskBadge.className = 'badge bg-' + getRiskColor(data.prediction_result.risk_level);
    }
    
    // Failed Courses
    const failedCoursesContainer = document.getElementById('failedCourses');
    if (data.failed_courses && data.failed_courses.length > 0) {
        failedCoursesContainer.innerHTML = '<ul class="list-unstyled mb-0">' + 
            data.failed_courses.map(name => `<li><i class="bi bi-x-circle-fill text-danger me-2"></i>${name}</li>`).join('') + '</ul>';
    } else {
        failedCoursesContainer.innerHTML = '<p class="text-muted mb-0">ไม่พบวิชาที่ตก</p>';
    }
    
    // Blocked Courses
    const blockedCoursesContainer = document.getElementById('blockedCourses');
    if (data.blocked_courses_details && data.blocked_courses_details.length > 0) {
        blockedCoursesContainer.innerHTML = '<ul class="list-unstyled mb-0">' + 
            data.blocked_courses_details.map(course => `<li><i class="bi bi-slash-circle-fill text-warning me-2"></i>${course.name} (ขาด: ${course.unmet_prereqs.join(', ')})</li>`).join('') + '</ul>';
    } else {
        blockedCoursesContainer.innerHTML = '<p class="text-muted mb-0">ไม่พบวิชาที่ถูกบล็อก</p>';
    }
    
    // Recommendations
    const recommendationsContainer = document.getElementById('recommendations');
    if (data.recommendations && data.recommendations.length > 0) {
        recommendationsContainer.innerHTML = '<ul class="list-unstyled mb-0">' + 
            data.recommendations.map(rec => `<li><i class="bi bi-check-circle-fill text-success me-2"></i>${rec}</li>`).join('') + '</ul>';
    } else {
        recommendationsContainer.innerHTML = '<p class="text-muted mb-0">ไม่มีคำแนะนำเฉพาะ</p>';
    }
    
    // Gemini Analysis
    if (data.analysis_method === 'gemini' && data.gemini_analysis) {
        displayGeminiAnalysis(data.gemini_analysis);
    } else {
        document.getElementById('geminiAnalysisContainer').innerHTML = '';
    }
}

function updateProgressRingForResults(percentage) {
    const circle = document.getElementById('resultsCompletionRing');
    const percentageText = document.getElementById('resultsCompletionRate');
    
    if (circle) {
        const circumference = 2 * Math.PI * 60;
        const offset = circumference - (percentage / 100) * circumference;
        circle.style.strokeDasharray = circumference;
        circle.style.strokeDashoffset = offset;
    }
    
    if (percentageText) {
        percentageText.textContent = Math.round(percentage) + '%';
    }
}

function getRiskColor(riskLevel) {
    const colors = {
        'ต่ำ': 'success', 'ปานกลาง': 'warning', 'สูง': 'danger',
        'very_low': 'success', 'low': 'success', 'moderate': 'warning',
        'high': 'danger', 'very_high': 'danger'
    };
    return colors[riskLevel] || 'secondary';
}

function displayGeminiAnalysis(geminiData) {
    const container = document.getElementById('geminiAnalysisContainer');
    
    let html = `
        <div class="gemini-card">
            <h6><i class="bi bi-stars"></i> การวิเคราะห์จาก Gemini AI</h6>
            <div class="gemini-content">
    `;
    
    if (geminiData.analysis_markdown) {
        html += `<div class="mb-3">${geminiData.analysis_markdown.replace(/\n/g, '<br>')}</div>`;
    }
    
    if (geminiData.key_metrics && geminiData.key_metrics.length > 0) {
        html += '<div class="row g-2 mb-3">';
        geminiData.key_metrics.forEach(metric => {
            html += `
                <div class="col-6 col-md-4">
                    <div class="p-2 bg-white bg-opacity-10 rounded">
                        <small class="text-white-50">${metric.label}</small>
                        <div class="fw-bold">${metric.value}</div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    }
    
    html += '</div></div>';
    container.innerHTML = html;
}
</script>
{% endblock %}
